<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  <link rel="prev" href="https://xtid.github.io/2020/vue%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E7%AE%80%E4%BB%8B/" />
  <link rel="next" href="https://xtid.github.io/2020/vue%E9%87%8C%E9%9D%A2compile%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/" />
  <link rel="canonical" href="https://xtid.github.io/2020/vue2.x%E9%87%8C%E9%9D%A2%E7%9A%84%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š | ğŸ˜³
       
  </title>
  <meta name="title" content="Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š | ğŸ˜³">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xtid.github.io"
    },
    "articleSection" : "posts",
    "name" : "Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š",
    "headline" : "Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š",
    "description" : "Vue2.xçš„æ•°æ®ç»‘å®šæ˜¯é€šè¿‡æ•°æ®åŠ«æŒçš„æ–¹å¼æ¥å®ç°çš„ï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„ä¾¿æ˜¯Object.defineProperty()ï¼Œè€ŒVue3.0é‡Œé¢æ•°æ®ç»‘",
    "inLanguage" : "zh-CN",
    "author" : "",
    "creator" : "",
    "publisher": "",
    "accountablePerson" : "",
    "copyrightHolder" : "",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-29 22:13:21 \x2b0800 CST",
    "dateModified" : "2020-07-29 22:13:21 \x2b0800 CST",
    "url" : "https:\/\/xtid.github.io\/2020\/vue2.x%E9%87%8C%E9%9D%A2%E7%9A%84%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A\/",
    "wordCount" : "2256",
    "keywords" : [  "ğŸ˜³"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ˜³</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ˜³</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xtid.github.io" rel="author"></a> with â™¥ 
                <span class="post-time">
                on <time datetime=2020-07-29 itemprop="datePublished">July 29, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://xtid.github.io/categories/%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/"> æºç ç†è§£ </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>Vue2.xçš„æ•°æ®ç»‘å®šæ˜¯é€šè¿‡æ•°æ®åŠ«æŒçš„æ–¹å¼æ¥å®ç°çš„ï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„ä¾¿æ˜¯<code>Object.defineProperty()</code>ï¼Œè€ŒVue3.0é‡Œé¢æ•°æ®ç»‘å®šæ˜¯é€šè¿‡<code>Proxy</code>å®ç°çš„</p>

<p>Vue2.xçš„åŒå‘æ•°æ®ç»‘å®šï¼Œæœ‰ä¸‰ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„éƒ¨åˆ†</p>

<p><code>Observer</code>ï¼šé€šè¿‡<code>Object.defineProperty</code>æ¥åšæ•°æ®åŠ«æŒï¼Œé€’å½’åœ°ç›‘å¬å¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§ï¼Œåœ¨å±æ€§å€¼æ”¹å˜çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”çš„<code>Watcher</code></p>

<p><code>Watcher</code>ï¼šè®¢é˜…è€…ï¼Œå½“ç›‘å¬çš„æ•°æ®å€¼ä¿®æ”¹æ—¶ï¼Œæ‰§è¡Œé€šçŸ¥<code>Dep</code>æ‰§è¡Œå¯¹åº”çš„å“åº”çš„å›è°ƒå‡½æ•°</p>

<p><code>Dep</code>ï¼šå°†<code>Observer</code>å’Œ<code>Watcher</code>å…³è”èµ·æ¥ï¼Œè¿™ä¸ªåŒå‘æ•°æ®ç»‘å®šå®ç°çš„è®¾è®¡æ¨¡å¼ä¸ºå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œ<code>Dep</code>å°±ç›¸å½“äºå‘å¸ƒè®¢é˜…æ¨¡å¼çš„ä¸­é—´å¯¹è±¡</p>

<p>Observer</p>

<pre><code class="language-javascript">export class Observer {
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that have this object as root $data

  constructor (value: any) {
    this.value = value
    this.dep = new Dep()
    this.vmCount = 0
    // é€šè¿‡Object.definePropertyè®¾ç½®_ob_å€¼ï¼Œä½¿ç”¨_ob_å¯ä»¥ç›´æ¥æ‹¿åˆ°Observerå¯¹è±¡
    def(value, '__ob__', this)
    if (Array.isArray(value)) {
      if (hasProto) {
        protoAugment(value, arrayMethods)
      } else {
        copyAugment(value, arrayMethods, arrayKeys)
      }
      // å¦‚æœæ˜¯æ•°ç»„ï¼Œè°ƒç”¨observeArrayå¤„ç†
      this.observeArray(value)
    } else {
      // å¦‚æœæ˜¯å…¶ä»–å¯¹è±¡è°ƒç”¨walkå¤„ç†
      this.walk(value)
    }
  }

  walk (obj: Object) {
    const keys = Object.keys(obj)
    // éå†å¯¹è±¡å±æ€§ï¼Œå¯¹æ¯ä¸ªå±æ€§æ·»åŠ æ•°æ®é‚¦æ•°æ®ç»‘å®š
    for (let i = 0; i &lt; keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }

  observeArray (items: Array&lt;any&gt;) {
    // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™å¾ªç¯éå†æ•°ç»„ï¼Œè°ƒç”¨observe
    for (let i = 0, l = items.length; i &lt; l; i++) {
      observe(items[i])
    }
  }
}
</code></pre>

<p><code>defineReactive</code></p>

<pre><code class="language-javascript">export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  const dep = new Dep()
	
  // è·å–objä¸Šå¯¹åº”å±æ€§keyçš„æè¿°ç¬¦ï¼Œå¦‚æœconfigurableä¸ºfalseï¼Œå±æ€§ä¸èƒ½æ”¹å˜ï¼Œreturn
  const property = Object.getOwnPropertyDescriptor(obj, key)
  if (property &amp;&amp; property.configurable === false) {
    return
  }

  const getter = property &amp;&amp; property.get
  const setter = property &amp;&amp; property.set
  if ((!getter || setter) &amp;&amp; arguments.length === 2) {
    val = obj[key]
  }

  let childOb = !shallow &amp;&amp; observe(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      // è·å–è¿™ä¸ªå€¼
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        // å°†å½“å‰depæ·»åŠ åˆ°targetä¸­ï¼Œç„¶åå°†depæ·»åŠ åˆ°subsä¸­	
        dep.depend()
        if (childOb) 
          childOb.dep.depend()
          if (Array.isArray(value)) {
						// å¦‚æœä¼ å…¥çš„å€¼ä¸ºæ•°ç»„ï¼Œéå†è¿™ä¸ªæ•°ç»„ï¼Œå¯¹æ¯ä¸€ä¸ªå…ƒç´ depend
            dependArray(value)
          }
        }
      }
      return value
    },
    set: function reactiveSetter (newVal) {
    	// è·å–å¯¹è±¡åŸæ¥çš„å€¼
      const value = getter ? getter.call(obj) : val
      // å¦‚æœæ–°è®¾ç½®çš„å€¼å’ŒåŸæ¥çš„å€¼ä¸€æ ·ï¼Œç›´æ¥return
      if (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) {
        return
      }
    	// æ‰“å°é”™è¯¯
      if (process.env.NODE_ENV !== 'production' &amp;&amp; customSetter) {
        customSetter()
      }
    	// è‹¥å±æ€§ä¸Šè®¾ç½®äº†getteræ²¡è®¾ç½®setterï¼Œreturn
      if (getter &amp;&amp; !setter) return
      if (setter) {
        setter.call(obj, newVal)
      } else {
        // è®¾ç½®æ–°çš„å€¼
        val = newVal
      }
    	// åˆ›å»ºä¸€ä¸ªæ–°çš„observeï¼Œå¹¶è§¦å‘å¯¹åº”çš„æ›´æ–°äº‹ä»¶
      childOb = !shallow &amp;&amp; observe(newVal)
      dep.notify()
    }
  })
}
</code></pre>

<p><code>observe</code>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è¿”å›ä¸å¯¹è±¡ç›¸å…³çš„<code>Observer</code>å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ª<code>Observer</code>å¯¹è±¡å¹¶è¿”å›</p>

<p>defineReactiveä¸­è¿˜æœ‰å‡ ä¸ªæ–¹æ³•ï¼Œ<code>protoAugment</code>å’Œ<code>copyAugment</code></p>

<pre><code class="language-javascript">var arrayProto = Array.prototype
var arrayMethods = Object.create(arrayProto)
function protoAugment (target, src) {
  target.__proto__ = src;
}
protoAugment(value, arrayMethods)
</code></pre>

<p>å¯¹äºæ•°ç»„å¯¹è±¡æ¥è¯´åœ¨å½“å‰ç¯å¢ƒå¦‚æœèƒ½ä½¿ç”¨<code>__proto__</code>å¯¹è±¡(<code>__proto__ in {}</code>)ï¼Œåˆ™è°ƒç”¨<code>protoAugment</code>ï¼Œå…¶å®å°±æ˜¯å°†å½“å‰çš„æ•°ç»„å¯¹è±¡<code>__proto__</code>æŒ‡å‘æ•°ç»„åŸå‹å¯¹è±¡ï¼Œç„¶åå¯¹äº<code>push</code>ã€<code>pop</code>ã€<code>shift</code>ã€<code>unshift</code>ã€<code>splice</code>ã€<code>sort</code>ã€<code>reverse</code>è¿™äº›æ“ä½œæ•°ç»„çš„æ–¹æ³•ï¼Œéå†ï¼Œæ·»åŠ åˆ°<code>arrayMethods</code>ä¸Šï¼Œæ“ä½œä¹‹åï¼Œè°ƒç”¨<code>ob.dep.notify()</code>è§¦å‘æ›´æ–°</p>

<p><code>copyAugment</code>åˆ™æ˜¯åœ¨å¾ªç¯ä¸­æŠŠ<code>arrayMethods</code>ä¸Šçš„<code>arrayKeys</code>æ–¹æ³•æ·»åŠ åˆ°<code>value</code>ä¸Š</p>

<p>Dep</p>

<p><code>Dep</code>çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç®€å•çš„ä¿å­˜äº†ä¸€ä¸ª<code>Wacher</code>æ•°ç»„ï¼Œæœ‰ä¸€äº›å¢åˆ çš„æ–¹æ³•ï¼Œæœ€å<code>notify</code>è°ƒç”¨å¯¹åº”<code>Wacher</code>æ›´æ–°çš„æ–¹æ³•</p>

<pre><code class="language-javascript">export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array&lt;Watcher&gt;;

  constructor () {
    this.id = uid++
    this.subs = []
  }

  addSub (sub: Watcher) {
    this.subs.push(sub)
  }

  removeSub (sub: Watcher) {
    remove(this.subs, sub)
  }

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    const subs = this.subs.slice()
    if (process.env.NODE_ENV !== 'production' &amp;&amp; !config.async) {
      subs.sort((a, b) =&gt; a.id - b.id)
    }
    for (let i = 0, l = subs.length; i &lt; l; i++) {
      subs[i].update()
    }
  }
}
</code></pre>

<p>Watcher</p>

<pre><code class="language-javascript">export default class Watcher {
	......
  constructor (
    vm: Component,
    expOrFn: string | Function,
    cb: Function,
    options?: ?Object,
    isRenderWatcher?: boolean
  ) {
    this.vm = vm
    if (isRenderWatcher) {
      vm._watcher = this
    }
    vm._watchers.push(this)
    // åˆ›å»ºWatcheræ—¶ä¼ çš„options
    // å¦‚ä¹‹å‰è°ƒç”¨updateComponetæ–¹æ³•æ—¶ï¼Œä¼ å…¥beforeæ¥è°ƒç”¨beforeUpdateé’©å­å‡½æ•°
    if (options) {
      this.deep = !!options.deep
      this.user = !!options.user
      this.lazy = !!options.lazy
      this.sync = !!options.sync
      this.before = options.before
    } else {
      this.deep = this.user = this.lazy = this.sync = false
    }
    this.cb = cb
    this.id = ++uid 
    this.active = true
    this.dirty = this.lazy 
    this.deps = []
    this.newDeps = []
    this.depIds = new Set()
    this.newDepIds = new Set()
    this.expression = process.env.NODE_ENV !== 'production'
      ? expOrFn.toString()
      : ''
    
    // è®¾ç½®getter
    // å¦‚æœä¼ å…¥expOrFnæ˜¯ä¸€ä¸ªå‡½æ•°
    if (typeof expOrFn === 'function') {
      this.getter = expOrFn
    } else {
      // å¦‚æœä¼ å…¥çš„ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡parsePathè§£æï¼Œèµ‹å€¼ç»™getter
      this.getter = parsePath(expOrFn)
      if (!this.getter) {
        // å¦‚æœè§£æå‡ºæ¥çš„getterä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè®¾ç½®ä¸ºç©º noopï¼Œå¹¶æ‰“å°é”™è¯¯
        this.getter = noop
        process.env.NODE_ENV !== 'production' &amp;&amp; warn(
          `Failed watching path: &quot;${expOrFn}&quot; ` +
          'Watcher only accepts simple dot-delimited paths. ' +
          'For full control, use a function instead.',
          vm
        )
      }
    }
    this.value = this.lazy
      ? undefined
      : this.get()
  }

  /**
   * Evaluate the getter, and re-collect dependencies.
   */
  get () {
    // è®¾ç½®Dep.tartgetä¸ºå½“å‰watcherï¼Œè¿™æ ·å®ƒå°±æœ‰addSubã€removeSubç­‰æ–¹æ³•
    pushTarget(this)
    let value
    const vm = this.vm
    try {
      // å¾—åˆ°è°ƒç”¨getterçš„value
      value = this.getter.call(vm, vm)
    } catch (e) {
      if (this.user) {
        handleError(e, vm, `getter for watcher &quot;${this.expression}&quot;`)
      } else {
        throw e
      }
    } finally {
      if (this.deep) {
        traverse(value)
      }
      // æ¸…æ¥šDepï¼Œç§»å‡ºtargeté˜Ÿåˆ—ï¼Œé‡æ–°è®¾ç½®Dep.targetå€¼
      popTarget()
      this.cleanupDeps()
    }
    
    // åœ¨è¿›è¡Œæ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ï¼Œvalueä¸ºundefined
    return value
  }
	
	......
	
  // åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œè°ƒç”¨dep.notifyï¼Œä¼šè§¦å‘updateæ–¹æ³•
  update () {
    if (this.lazy) {
      this.dirty = true
    } else if (this.sync) {
      // è‹¥ç”ŸæˆWatcherä¼ å…¥é…ç½®sync
      // åœ¨æ›´æ–°çš„æ—¶å€™ç›´æ¥è°ƒç”¨runæ–¹æ³•ï¼Œè°ƒç”¨å›æ‰æ–¹æ³•
      this.run()
    } else {
      // å¦‚æœä¸æ˜¯syncé…ç½®ï¼Œå¤„ç†Watcheré˜Ÿåˆ—
      // queueWatcheræ–¹æ³•é‡Œä¼šä½¿ç”¨ä¸€ä¸ªidæ¥è¡¨ç¤ºWatcherçš„ä¼˜å…ˆçº§ï¼Œä¾æ¬¡æ‰§è¡Œä¸Šé¢çš„runæ–¹æ³•
      // æ›´æ–°çš„æ—¶å€™å¦‚æœwatcheråˆ—è¡¨æ­£åœ¨æ›´æ–°ï¼Œåˆ™æŠŠæ–°çš„watcheræ·»åŠ åˆ°å¯¹åº”çš„ä½ç½®ï¼Œå¹¶æ›´æ–°
      // å¦åˆ™ï¼Œåœ¨ä¸‹ä¸€ä¸ªnextTickä¸­æ‰§è¡ŒflushSchedulerQueue
      queueWatcher(this)
    }
  }

  run () {
    if (this.active) {
      const value = this.get()
      if (
        value !== this.value ||
        isObject(value) ||
        this.deep
      ) {
        const oldValue = this.value
        this.value = value
        if (this.user) {
          try {
            this.cb.call(this.vm, value, oldValue)
          } catch (e) {
            handleError(e, this.vm, `callback for watcher &quot;${this.expression}&quot;`)
          }
        } else {
          // å›è°ƒ
          this.cb.call(this.vm, value, oldValue)
        }
      }
    }
  }
	
	......
}

</code></pre>

    </div>

    

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> Â· 
                <span><a href="https://xtid.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xtid.github.io/2020/vue%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E7%AE%80%E4%BB%8B/" class="prev" rel="prev" title="Vueçš„åˆå§‹åŒ–æ¸²æŸ“è¿‡ç¨‹ç®€ä»‹"><i class="iconfont icon-left"></i>&nbsp;Vueçš„åˆå§‹åŒ–æ¸²æŸ“è¿‡ç¨‹ç®€ä»‹</a>
         
        
        <a href="https://xtid.github.io/2020/vue%E9%87%8C%E9%9D%A2compile%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/" class="next" rel="next" title="Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘">Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
