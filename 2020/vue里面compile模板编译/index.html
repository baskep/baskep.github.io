<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  <link rel="prev" href="https://xtid.github.io/2020/vue2.x%E9%87%8C%E9%9D%A2%E7%9A%84%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A/" />
  <link rel="next" href="https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84vnode/" />
  <link rel="canonical" href="https://xtid.github.io/2020/vue%E9%87%8C%E9%9D%A2compile%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon.ico">
  <link rel="icon" sizes="16x16" href="/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘ | ğŸ˜³
       
  </title>
  <meta name="title" content="Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘ | ğŸ˜³">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xtid.github.io"
    },
    "articleSection" : "posts",
    "name" : "Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘",
    "headline" : "Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘",
    "description" : "1.complieç®€è¿° complieé˜¶æ®µä¸»è¦æ˜¯å°†Vueä»£ç é€šè¿‡ä¸€ç³»åˆ—è½¬æ¢ï¼Œæœ€ç»ˆç”Ÿæˆå¯¹åº”çš„renderå­—ç¬¦ä¸²ï¼Œç„¶åVueé€šè¿‡renderå­—ç¬¦ä¸²",
    "inLanguage" : "zh-CN",
    "author" : "",
    "creator" : "",
    "publisher": "",
    "accountablePerson" : "",
    "copyrightHolder" : "",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-30 22:16:42 \x2b0800 CST",
    "dateModified" : "2020-07-30 22:16:42 \x2b0800 CST",
    "url" : "https:\/\/xtid.github.io\/2020\/vue%E9%87%8C%E9%9D%A2compile%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91\/",
    "wordCount" : "3561",
    "keywords" : [  "ğŸ˜³"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ˜³</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ˜³</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xtid.github.io" rel="author"></a> with â™¥ 
                <span class="post-time">
                on <time datetime=2020-07-30 itemprop="datePublished">July 30, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://xtid.github.io/categories/%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/"> æºç ç†è§£ </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>1.complieç®€è¿°</p>

<p><code>complie</code>é˜¶æ®µä¸»è¦æ˜¯å°†<code>Vue</code>ä»£ç é€šè¿‡ä¸€ç³»åˆ—è½¬æ¢ï¼Œæœ€ç»ˆç”Ÿæˆå¯¹åº”çš„<code>render</code>å­—ç¬¦ä¸²ï¼Œç„¶å<code>Vue</code>é€šè¿‡<code>render</code>å­—ç¬¦ä¸²é‡Œé¢çš„å…³é”®è¯æˆ–è€…è¯´å®šä¹‰ï¼Œå¯¹é¡µé¢å†…å®¹è¿›è¡Œå¢åˆ æ”¹ï¼Œ<code>Vue</code>å¯¹è±¡ä¸Šæœ‰ä¸€ä¸ªå…¨å±€å‡½æ•°<code>compile</code></p>

<pre><code class="language-java">import { compileToFunctions } from './compiler/index'
......
Vue.compile = compileToFunctions
</code></pre>

<p>å¯ä»¥çœ‹å‡ºï¼Œä»–æ˜¯å¼•ç”¨çš„<code>./compiler/index</code>æ¨¡å—å¯¼å‡ºçš„<code>compileToFunctions</code></p>

<pre><code class="language-javascript">import { baseOptions } from './options'
import { createCompiler } from 'compiler/index'
const { compile, compileToFunctions } = createCompiler(baseOptions)
export { compile, compileToFunctions }

</code></pre>

<p><code>baseOptions</code>ï¼Œå¯¹è§£ææ¨¡æ¿çš„ä¸€äº›é€‰é¡¹è¿›è¡ŒåŸºæœ¬çš„å®šä¹‰ï¼Œè§„å®šå¦‚æœè§£ææ¨¡æ¿ä¸­çš„å„ç§æ ‡ç­¾æˆ–ä»£ç </p>

<pre><code class="language-javascript">export const baseOptions: CompilerOptions = {
  expectHTML: true,
  modules,
  directives,
  isPreTag,
  isUnaryTag,
  mustUseProp,
  canBeLeftOpenTag,
  isReservedTag,
  getTagNamespace,
  staticKeys: genStaticKeys(modules)
}
</code></pre>

<p><code>expectHTML</code>ï¼šä¸º<code>true</code>æ—¶ï¼Œè§£æ<code>HTML</code>çš„ç»“æŸæ ‡ç­¾</p>

<p><code>modules</code>ï¼šåŒ…æ‹¬<code>klass</code>å’Œ<code>style</code>ï¼Œå¯¹æ¨¡æ¿ä¸­ç±»å’Œæ ·å¼çš„è§£æã€‚</p>

<p><code>directives</code>ï¼šè¿™é‡ŒåŒ…æ‹¬<code>model</code>ï¼ˆ<code>v-model</code>ï¼‰ã€<code>html</code>ï¼ˆ<code>v-html</code>ï¼‰ã€<code>text</code>(<code>v-text</code>)ä¸‰ä¸ªæŒ‡ä»¤</p>

<p><code>isPreTag</code>ï¼šæ˜¯å¦æ˜¯<code>pre</code>æ ‡ç­¾</p>

<p><code>isUnaryTag</code>ï¼šæ˜¯å¦æ˜¯å•æ ‡ç­¾ï¼Œæ¯”å¦‚<code>img</code>ã€<code>input</code>ã€<code>iframe</code>ç­‰</p>

<p><code>mustUseProp</code>ï¼šéœ€è¦ä½¿ç”¨<code>props</code>ç»‘å®šçš„å±æ€§ï¼Œæ¯”å¦‚<code>value</code>ã€<code>selected</code>ç­‰</p>

<p><code>canBeLeftOpenTag</code>ï¼šå¯ä»¥ä¸é—­åˆçš„æ ‡ç­¾ï¼Œæ¯”å¦‚<code>tr</code>ã€<code>td</code>ç­‰</p>

<p><code>isReservedTag</code>ï¼šæ˜¯å¦æ˜¯ä¿ç•™æ ‡ç­¾ï¼Œ<code>html</code>æ ‡ç­¾å’Œ<code>SVG</code>æ ‡ç­¾</p>

<p><code>getTagNamespace</code>ï¼šè·å–å‘½åç©ºé—´ï¼Œ<code>svg</code>å’Œ<code>math</code></p>

<p><code>staticKeys</code>ï¼šé™æ€å…³é”®è¯ï¼ŒåŒ…æ‹¬<code>staticClass,staticStyle</code></p>

<p>ç„¶åæ˜¯<code>createCompiler</code></p>

<pre><code class="language-javascript">export function createCompilerCreator (baseCompile: Function): Function {
  // æ¥å—ä¸€ä¸ªåŸºæœ¬çš„CompilerOptions
  return function createCompiler (baseOptions: CompilerOptions) {
    function compile (
      template: string,
      options?: CompilerOptions
    ): CompiledResult {
      // finalOptionsç»§æ‰¿è‡ªbaseOptions
      const finalOptions = Object.create(baseOptions)
      const errors = []
      const tips = []

      let warn = (msg, range, tip) =&gt; {
        (tip ? tips : errors).push(msg)
      }

      if (options) {
        if (process.env.NODE_ENV !== 'production' &amp;&amp; options.outputSourceRange) {
          // $flow-disable-line
          const leadingSpaceLength = template.match(/^\s*/)[0].length

          warn = (msg, range, tip) =&gt; {
            const data: WarningMessage = { msg }
            if (range) {
              if (range.start != null) {
                data.start = range.start + leadingSpaceLength
              }
              if (range.end != null) {
                data.end = range.end + leadingSpaceLength
              }
            }
            (tip ? tips : errors).push(data)
          }
        }
        // åˆå¹¶modules
        if (options.modules) {
          finalOptions.modules =
            (baseOptions.modules || []).concat(options.modules)
        }
        // åˆå¹¶directives
        if (options.directives) {
          finalOptions.directives = extend(
            Object.create(baseOptions.directives || null),
            options.directives
          )
        }
        
        // é¢å¤–ä¼ å…¥çš„optionsï¼Œåˆå¹¶
        for (const key in options) {
          if (key !== 'modules' &amp;&amp; key !== 'directives') {
            finalOptions[key] = options[key]
          }
        }
      }
	
      // æ”¶é›†åˆ°çš„é”™è¯¯æ—¥å¿—
      finalOptions.warn = warn

      const compiled = baseCompile(template.trim(), finalOptions)
      if (process.env.NODE_ENV !== 'production') {
        detectErrors(compiled.ast, warn)
      }
      compiled.errors = errors
      compiled.tips = tips
      // è¿”å›renderå­—ç¬¦ä¸²
      return compiled
    }

    return {
      compile,
      compileToFunctions: createCompileToFunctionFn(compile)
    }
  }
}
</code></pre>

<p>å¯¼å‡ºçš„æ¨¡å—<code>compileToFunctions</code>ä¸º<code>createCompileToFunctionFn</code>æ‰§è¡Œè¿”å›çš„ç»“æœ</p>

<p><code>createCompileToFunctionFn</code>ä»£ç </p>

<pre><code class="language-javascript">export function createCompileToFunctionFn (compile: Function): Function {
  const cache = Object.create(null)

  return function compileToFunctions (
    template: string,
    options?: CompilerOptions,
    vm?: Component
  ): CompiledFunctionResult {
    // æ‹¿åˆ°optionsï¼Œå¹¶ä¸”åˆ é™¤é”™è¯¯æ—¥å¿—ç­‰æ•°æ®
    options = extend({}, options)
    const warn = options.warn || baseWarn
    delete options.warn
		
    ......

		// å¦‚æœæœ‰ç¼“å­˜ï¼Œæ‹¿åˆ°ç¼“å­˜ä¸­çš„ç¼–è¯‘ç»“æœ
    const key = options.delimiters
      ? String(options.delimiters) + template
      : template
    if (cache[key]) {
      return cache[key]
    }

    // ç¼–è¯‘çš„ç»“æœ
    const compiled = compile(template, options)

 		......

    const res = {}
    const fnGenErrors = []
    // renderå­—ç¬¦ä¸²
    res.render = createFunction(compiled.render, fnGenErrors)
    // å°†renderå­—ç¬¦ä¸²ä¸­çš„æ ‡è¯†ç¬¦è½¬ä¸ºå‡½æ•°ï¼Œå¦‚_cã€_m
    res.staticRenderFns = compiled.staticRenderFns.map(code =&gt; {
      return createFunction(code, fnGenErrors)
    })

		......

    return (cache[key] = res)
  }
}

</code></pre>

<p>2.ç”Ÿæˆast</p>

<p>åœ¨<code>src/compiler/parser/index.js</code>ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†å„ç§</p>

<pre><code class="language-javascript">// åŒ¹é…@æˆ–v-onå¼€å¤´çš„å±æ€§
export const onRE = /^@|^v-on:/
// æ˜¯åŒ¹é…v-æˆ–@æˆ–:å¼€å¤´çš„å±æ€§
export const dirRE = /^v-|^@|^:|^\./ 
// åŒ¹é…v-forä¸­çš„å±æ€§å€¼ï¼Œæ¯”å¦‚item in itemsã€(item, index) of items
export const forAliasRE = /([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/ 
// æ˜¯å¯¹forAliasREä¸­æ•è·çš„ç¬¬ä¸€éƒ¨åˆ†å†…å®¹ï¼Œè¿›è¡Œæ‹†è§£ï¼Œv-forä¸­in|ofå‰æœ€åå¯ä»¥æœ‰ä¸‰ä¸ªé€—å·åˆ†éš”çš„å‚æ•°
export const forIteratorRE = /,([^,\}\]]*)(?:,([^,\}\]]*))?$/
// å»æ‰å­—ç¬¦ä¸² '(item, index)' ä¸­çš„å·¦å³æ‹¬å·
const stripParensRE = /^\(|\)$/g
// ç”¨æ¥åŒ¹é…æŒ‡ä»¤ç¼–å†™ä¸­çš„å‚æ•°
const argRE = /:(.*)$/
// åŒ¹é…ä»¥å­—ç¬¦:æˆ–å­—ç¬¦ä¸² v-bind: å¼€å¤´çš„å­—ç¬¦ä¸²
export const bindRE = /^:|^\.|^v-bind:/
</code></pre>

<p><code>parse</code>ï¼Œé‡Œé¢è§£æçš„æ–¹æ³•ä¸»è¦æ˜¯<code>parseHTML</code>ï¼Œ</p>

<pre><code class="language-javascript">export function parse (
	template: string,
	options: CompilerOptions
  ): ASTElement | void {
	warn = options.warn || baseWarn
  
	......
	parseHTML()
  return root
}

// src/compiler/parser/html-parser.js

export function parseHTML (html, options) {
  const stack = []
  const expectHTML = options.expectHTML
  const isUnaryTag = options.isUnaryTag || no
  const canBeLeftOpenTag = options.canBeLeftOpenTag || no
  let index = 0
  let last, lastTag
  while (html) {}

  function advance (n) {
    ...
  }

  function parseStartTag () {
    ...
  }

  function handleStartTag (match) {
    ...
  }

	function parseEndTag (tagName, start, end) {
  	...
  }
}
</code></pre>

<p>åœ¨<code>parseHTML</code>çš„<code>while</code>å¾ªç¯é‡Œ</p>

<pre><code class="language-javascript">// advanceè¿™ä¸ªæ–¹æ³•ï¼Œç”¨äºæˆªå–ä¼ å…¥çš„å­—ç¬¦ä¸²
// è¿‡æ»¤æ‰æ³¨é‡Šï¼Œdoctypeç­‰
if (comment.test(html)) {
  const commentEnd = html.indexOf('--&gt;')

  if (commentEnd &gt;= 0) {
    advance(commentEnd + 3)
    continue
  }
}

// è¿‡æ»¤æ–‡æ¡£ç±»å‹æ ‡ç¤ºçš„å­—ç¬¦ä¸²
const doctypeMatch = html.match(doctype)
if (doctypeMatch) {
  advance(doctypeMatch[0].length)
  continue
}

// åŒ¹é…ç»“æŸçš„æ ‡ç­¾
const endTagMatch = html.match(endTag)
if (endTagMatch) {
  const curIndex = index
  advance(endTagMatch[0].length)
  parseEndTag(endTagMatch[1], curIndex, index)
  continue
}

// åŒ¹é…å¼€å§‹æ ‡ç­¾
// ä¼ å…¥handleStartTagå¤„ç†å®Œåï¼Œä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«æ ‡ç­¾å„ç§å±æ€§çš„å¯¹è±¡
const startTagMatch = parseStartTag()
if (startTagMatch) {
  handleStartTag(startTagMatch)
  continue
}

</code></pre>

<p>åç»­ä¼šè°ƒç”¨<code>parse</code>é‡Œè°ƒç”¨<code>parseHTML</code>ä¼ å…¥çš„<code>start</code>çš„æ–¹æ³•</p>

<pre><code class="language-javascript">start () {
  // å®šä¹‰åŸºæœ¬çš„astç»“æ„
  createASTElement()
  // è§£æv-preã€v-ifã€v-forã€v-onceã€slotã€keyã€refç­‰æŒ‡ä»¤
  processPre()
  processFor()
  ......
}
</code></pre>

<p>å¤„ç†å®Œåä¼šè°ƒç”¨<code>parse</code>é‡Œè°ƒç”¨<code>parseHTML</code>ä¼ å…¥çš„<code>end</code>çš„æ–¹æ³•</p>

<p>1ã€å–å‡º<code>stack</code>ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</p>

<p>2ã€å–å‡ºè¯¥å…ƒç´ çš„æœ€åä¸€ä¸ªå­å…ƒç´ ã€‚</p>

<p>3ã€å¦‚æœæœ€åä¸€ä¸ªå­å…ƒç´ æ˜¯çº¯æ–‡æœ¬<code>' '</code>åˆ™åˆ é™¤ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ¨¡æ¿ä¸€èˆ¬éƒ½ä¼šç¼©è¿›ï¼Œéƒ½ä¼šæœ‰æ¢è¡Œï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ¸…é™¤æ¢è¡Œç­‰æ·»åŠ çš„å†…å®¹ã€‚</p>

<p>4ã€<code>stack</code>é•¿åº¦å‡ä¸€</p>

<p>5ã€<code>currentParent</code>å˜ä¸ºæ ˆä¸­æœ€åä¸€ä¸ªå…ƒç´ </p>

<p>6ã€ å¤„ç†<code>v-pre</code>æˆ–<code>pre</code>çš„ç»“æŸæ ‡ç­¾</p>

<pre><code class="language-javascript">end (tag, start, end) {
  const element = stack[stack.length - 1]
  if (!inPre) {
    const lastNode = element.children[element.children.length - 1]
    if (lastNode &amp;&amp; lastNode.type === 3 &amp;&amp; lastNode.text === ' ') {
      element.children.pop()
    }
  }
  stack.length -= 1
  currentParent = stack[stack.length - 1]
  if (process.env.NODE_ENV !== 'production' &amp;&amp; options.outputSourceRange) {
    element.end = end
  }
  closeElement(element)
},
</code></pre>

<p>æœ€åï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«åç§°ã€ç±»å‹ã€å±æ€§ã€çˆ¶å­èŠ‚ç‚¹ä¿¡æ¯çš„ä¸€ä¸ª<code>ast</code>è¯­æ³•æ ‘ï¼Œå¦‚</p>

<pre><code class="language-javascript">const element = {
  type: 1,
  tag: '',
  attrsList: [],
  attrsMap: {},
  parent: {},
  children: []
};
</code></pre>

<p>3.ä¼˜åŒ–é™æ€å†…å®¹ï¼Œæ‰“å¼€<code>src/compiler/index</code>ï¼Œçœ‹åˆ°è°ƒç”¨<code>const ast = parse(template.trim(), options)</code>ç”Ÿæˆ<code>ast</code>åï¼Œè°ƒç”¨<code>optimize</code>ï¼Œä¼ å…¥<code>ast</code> ï¼Œæ‰“å¼€<code>optimisze</code>æºç </p>

<pre><code class="language-javascript">// è·å–åŸºæœ¬é™æ€keyçš„ä¸€ä¸ªé›†åˆ
const genStaticKeysCached = cached(genStaticKeys)
export function optimize (root: ?ASTElement, options: CompilerOptions) {
  if (!root) return
  // å¦‚æœastä¸Šæœ‰staticKeysé€‰é¡¹
  isStaticKey = genStaticKeysCached(options.staticKeys || '')
  // æ˜¯ä¸æ˜¯å¹³å°ä¿ç•™tagï¼Œå¦‚HTML æ ‡ç­¾
  isPlatformReservedTag = options.isReservedTag || no
  // æ ‡è®°æ‰€æœ‰é™æ€å’Œéé™æ€èŠ‚ç‚¹
  markStatic(root)
  // æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹
  markStaticRoots(root, false)
}

function genStaticKeys (keys: string): Function {
  return makeMap(
    'type,tag,attrsList,attrsMap,plain,parent,children,attrs,start,end,rawAttrsMap,has$Slot' +
    (keys ? ',' + keys : '')
  )
}
</code></pre>

<p><code>markStatic</code>æ ‡è®°æ‰€æœ‰é™æ€å’Œéé™æ€èŠ‚ç‚¹</p>

<pre><code class="language-javascript">function markStatic (node: ASTNode) {
  // åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºé™æ€èŠ‚ç‚¹
  // é™æ€èŠ‚ç‚¹åŒ…æ‹¬æ™®é€šå…ƒç´ ã€çº¯æ–‡æœ¬å…ƒç´ ã€v-preã€v-once
  node.static = isStatic(node)
 	// å¦‚æœtypeä¸º1ï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹ä¸ºå…ƒç´ èŠ‚ç‚¹
  if (node.type === 1) {
    if (
      // å¦‚æœä¸æ˜¯ä¿ç•™æ ‡ç­¾ï¼Œå³è‡ªå®šä¹‰æ ‡ç­¾æ—¶
      !isPlatformReservedTag(node.tag) &amp;&amp;
      // å¦‚æœä¸æ˜¯componentæ ‡ç­¾
      !node.component &amp;&amp;
      // å¦‚æœæ ‡ç­¾ä¸æ˜¯slot
      node.tag !== 'slot' &amp;&amp;
      // ä¸æ˜¯ä¸€ä¸ªå†…è”æ¨¡æ¿å®¹å™¨ï¼Ÿï¼Ÿ
      node.attrsMap['inline-template'] == null
    ) {
      // ç›´æ¥returnï¼Œä¸å¯¹å­èŠ‚ç‚¹åšå¤„ç†ï¼Œåä¹‹ï¼Œé€’å½’å¯¹å­èŠ‚ç‚¹åšæ ‡è®°
      return
    }
  	......
  }
}
  
function isStatic (node: ASTNode): boolean {
  // è¡¨è¾¾å¼
  if (node.type === 2) {
    return false
  }
  // text
  if (node.type === 3) { 
    return true
  }
  return !!(node.pre || (
    // æ²¡æœ‰ä»»ä½•æŒ‡ä»¤æˆ–äº‹ä»¶ç»‘å®š
    !node.hasBindings &amp;&amp; 
    // æ²¡æœ‰if å’Œ for æŒ‡ä»¤
    !node.if &amp;&amp; !node.for &amp;&amp; 
    // ä¸æ˜¯å†…ç½®æ ‡ç­¾ï¼Œå¦‚slot
    !isBuiltInTag(node.tag) &amp;&amp;
    // å¹³å°ä¿ç•™æ ‡ç­¾ï¼Œå¦‚HTML
    isPlatformReservedTag(node.tag) &amp;&amp; 
    // ä¸æ˜¯templateæ ‡ç­¾çš„ç›´æ¥å­å…ƒç´ ä¸”æ²¡æœ‰åŒ…å«åœ¨forå¾ªç¯ä¸­
    !isDirectChildOfTemplateFor(node) &amp;&amp;
    // ç»“ç‚¹åŒ…å«çš„å±æ€§åªèƒ½æœ‰isStaticKeyä¸­æŒ‡å®šçš„å‡ ä¸ª
    Object.keys(node).every(isStaticKey)
  ))
}
</code></pre>

<p><code>markStaticRoots</code>æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹</p>

<pre><code class="language-javascript">function markStaticRoots (node: ASTNode, isInFor: boolean) {
  // åªå¤„ç†å…ƒç´ èŠ‚ç‚¹ç±»å‹
  if (node.type === 1) {
    if (node.static || node.once) {
      node.staticInFor = isInFor
    }
    // æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹çš„æ¡ä»¶ä¸ºæœ¬èº«staticæ ‡è®°ä¸ºtrue
    // å¹¶ä¸”è¯¥ç»“ç‚¹ä¸æ˜¯åªæœ‰ä¸€ä¸ªé™æ€æ–‡æœ¬å­èŠ‚ç‚¹
    if (node.static &amp;&amp; node.children.length &amp;&amp; !(
      node.children.length === 1 &amp;&amp;
      node.children[0].type === 3
    )) {
      node.staticRoot = true
      return
    } else {
      node.staticRoot = false
    }
		......
  }
}
</code></pre>

<p>4.ç”Ÿæˆrenderå­—ç¬¦ä¸²</p>

<p>åœ¨æ ‡è®°å®Œé™æ€èŠ‚ç‚¹ä¹‹åï¼Œä¼šè°ƒç”¨<code>generate</code>æ–¹æ³•æ¥ç”Ÿæˆrenderå­—ç¬¦ä¸²ï¼Œç”Ÿæˆçš„å­—ç¬¦ä¸²ä¸­</p>

<p><code>_c</code> è¯¥æ–¹æ³•å¯¹åº”çš„æ˜¯<code>createElement</code>æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒçš„å«ä¹‰æ˜¯åˆ›å»ºä¸€ä¸ªå…ƒç´ ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦å®šä¹‰çš„å…ƒç´ æ ‡ç­¾åã€ç¬¬äºŒä¸ªå‚æ•°æ˜¯å…ƒç´ ä¸Šæ·»åŠ çš„å±æ€§ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å­å…ƒç´ æ•°ç»„ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å­å…ƒç´ æ•°ç»„è¿›è¡Œå½’ä¸€åŒ–å¤„ç†çš„çº§åˆ«ã€‚</p>

<p><code>_v</code> è¯¥æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡æœ¬ç»“ç‚¹ã€‚</p>

<p><code>_s</code> æ˜¯æŠŠä¸€ä¸ªå€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</p>

<p><code>_m</code> æ˜¯æ¸²æŸ“é™æ€å†…å®¹ï¼Œå®ƒæ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘æœ€ç»ˆç”Ÿæˆçš„<code>staticRenderFns</code>æ•°ç»„ä¸­å¯¹åº”çš„å†…å®¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ ‡è¯†å…ƒç´ æ˜¯å¦åŒ…è£¹åœ¨<code>for</code>å¾ªç¯å†…ã€‚</p>

<pre><code class="language-javascript">export function generate (
  ast: ASTElement | void,
  options: CompilerOptions
): CodegenResult {
  const state = new CodegenState(options)
  // å¦‚æœastä¸ºç©ºï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºçš„divèŠ‚ç‚¹
  // æœ‰è¿‡æœ‰å€¼ï¼Œè°ƒç”¨genElement
  const code = ast ? genElement(ast, state) : '_c(&quot;div&quot;)'
  // è¿”å›renderå­—ç¬¦ä¸²
  return {
    render: `with(this){return ${code}}`,
    staticRenderFns: state.staticRenderFns
  }
}
</code></pre>

<p><code>genElement</code>ä¼šé€šè¿‡èŠ‚ç‚¹ä¸Šçš„æ ‡å¿—æ¥åˆ¤æ–­ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•æ¥ç”Ÿæˆrenderå­—ç¬¦ä¸²ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹<code>genStatic</code></p>

<pre><code class="language-javascript">export function genElement (el: ASTElement, state: CodegenState): string {
  // preçš„çŠ¶æ€ç”¨æ¥åˆ¤æ–­æ˜¯å¦è·³è¿‡å½“å‰è§£æ
  if (el.parent) {
    el.pre = el.pre || el.parent.pre
  }
	
  if (el.staticRoot &amp;&amp; !el.staticProcessed) {
    return genStatic(el, state)
  } 
  ...... 
		else {
      let data
      // å¦‚æœèŠ‚ç‚¹æ²¡å…¶ä»–å±æ€§æˆ–è€…è·³è¿‡è§£æï¼Œç›´æ¥genData
      // genDataè¿™ä¸ªæ–¹æ³•ä¼šç»™èŠ‚ç‚¹æ·»åŠ å„ç§å±æ€§
      if (!el.plain || (el.pre &amp;&amp; state.maybeComponent(el))) {
        data = genData(el, state)
      }
			
      // å¦‚æœä¸æ˜¯å†…éƒ¨æ¨¡æ¿ï¼Œè°ƒç”¨genChildrenï¼Œè¿”å›å¯¹åº”çš„å­—ç¬¦ä¸²
      const children = el.inlineTemplate ? null : genChildren(el, state, true)
      code = `_c('${el.tag}'${
        data ? `,${data}` : '' 
      }${
        children ? `,${children}` : '' 
      })`
    }
    for (let i = 0; i &lt; state.transforms.length; i++) {
      code = state.transforms[i](el, code)
    }
    return code
  }
}

function genStatic (el: ASTElement, state: CodegenState): string {
  el.staticProcessed = true
  // æš‚å­˜pre
  const originalPreState = state.pre
  // å¦‚æœå½“å‰èŠ‚ç‚¹preä¸ºtrueï¼Œæ›´æ”¹preçš„çŠ¶æ€
  if (el.pre) {
    state.pre = el.pre
  }
  // é€šè¿‡é€’å½’å¤„ç†é™æ€æ ¹èŠ‚ç‚¹åŠå…¶å­å†…å®¹ï¼Œæ·»åŠ åˆ°staticRenderFns
  state.staticRenderFns.push(`with(this){return ${genElement(el, state)}}`)
  // æ¢å¤preçŠ¶æ€
  state.pre = originalPreState
  return `_m(${
    state.staticRenderFns.length - 1
  }${
    el.staticInFor ? ',true' : ''
  })`
}
</code></pre>

<p>æœ€åè¿”å›çš„ç»“æœå°±åŒ…å«<code>render</code>å­—ç¬¦ä¸²ä»¥åŠ<code>staticRenderFns</code>é™æ€èŠ‚ç‚¹</p>

    </div>

    

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> Â· 
                <span><a href="https://xtid.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xtid.github.io/2020/vue2.x%E9%87%8C%E9%9D%A2%E7%9A%84%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A/" class="prev" rel="prev" title="Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š"><i class="iconfont icon-left"></i>&nbsp;Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š</a>
         
        
        <a href="https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84vnode/" class="next" rel="next" title="Vueä¸­çš„VNode">Vueä¸­çš„VNode&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
