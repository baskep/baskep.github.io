<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  <link rel="prev" href="https://xtid.github.io/2020/%E7%99%BD%E5%B1%8F%E6%97%B6%E9%97%B4/" />
  <link rel="next" href="https://xtid.github.io/2020/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAurl%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%91%88%E7%8E%B0%E7%9A%84%E8%BF%87%E7%A8%8B/" />
  <link rel="canonical" href="https://xtid.github.io/2020/%E6%B5%85%E8%B0%88%E5%89%8D%E7%AB%AF%E7%BB%9F%E8%AE%A1/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon.ico">
  <link rel="icon" sizes="16x16" href="/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           浅谈前端统计 | 👨🏻‍💻
       
  </title>
  <meta name="title" content="浅谈前端统计 | 👨🏻‍💻">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xtid.github.io"
    },
    "articleSection" : "posts",
    "name" : "浅谈前端统计",
    "headline" : "浅谈前端统计",
    "description" : "监控系统在现在的项目中是必不可少的，它具有性能监控、错误监控以及数据上报等功能。通过对的错误监控、用户正常行为的收集，从而指定对应的优化方案",
    "inLanguage" : "zh-CN",
    "author" : "",
    "creator" : "",
    "publisher": "",
    "accountablePerson" : "",
    "copyrightHolder" : "",
    "copyrightYear" : "2020",
    "datePublished": "2020-10-28 21:45:40 \x2b0800 CST",
    "dateModified" : "2020-10-28 21:45:40 \x2b0800 CST",
    "url" : "https:\/\/xtid.github.io\/2020\/%E6%B5%85%E8%B0%88%E5%89%8D%E7%AB%AF%E7%BB%9F%E8%AE%A1\/",
    "wordCount" : "1864",
    "keywords" : [  "👨🏻‍💻"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">👨🏻‍💻</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">👨🏻‍💻</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">浅谈前端统计</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xtid.github.io" rel="author"></a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-10-28 itemprop="datePublished">October 28, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://xtid.github.io/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/"> 日常学习 </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>监控系统在现在的项目中是必不可少的，它具有性能监控、错误监控以及数据上报等功能。通过对的错误监控、用户正常行为的收集，从而指定对应的优化方案、营销策略以及项目的迭代。 试想，如果没有这些监控系统，那么线上的运行的项目出问题了，定位是比较困难的，这时候修复起来就比较劳神了。我记录下我所了解的，常见的方式。</p>

<p>1.错误监控</p>

<p>我们对于错误的处理，在<code>js</code>中很常见的错误捕获<code>try catch</code>、<code>promise中的catch</code>等等。在window对象上有一个方法<code>onerror</code>，可以拿到当前报错的信息，我们就可以将这个信息拿到然后提交到我们自己的监控系统，还有个很重要的原因，不处理这些错误，导致页面挂了停止加载，那损失可就大了。对于抛出的错误，它有几个属性</p>

<pre><code class="language-javascript">// 定义一个错误对象
const defaults = {
  msg: '', // 错误的具体信息
  url: '', // 错误所在的url
  line: '', // 错误所在的行
  col: '', // 错误所在的列
  nowTime: '' // 时间
}
</code></pre>

<p>然后实现<code>window.onerror</code>方法</p>

<pre><code class="language-javascript">window.onerror = function (msg, url, line, col, error) {
  col = col || (window.event &amp;&amp; window.event.errorCharacter) || 0

  defaults.url = url
  defaults.line = line
  defaults.col = col
  defaults.nowTime = new Date().getTime()

  if (error &amp;&amp; error.stack) {
    // 如果浏览器有错误堆栈信息，直接使用
    defaults.msg = error.stack.toString()
  } else if (arguments.callee) {
    // 通过callee拿堆栈信息
    let ext = []
    let fn = arguments.callee.caller
    // 最多拿到三层
    let floor = 3
    while (fn &amp;&amp; (--floor &gt; 0)) {
      ext.push(fn.toString())
      if (fn === fn.caller) {
        break
      }
      fn = fn.caller
    }
    ext = ext.join(',')
    defaults.msg = error &amp;&amp; error.stack &amp;&amp; error.stack.toString()
  }
  let str = ''
  // 格式化这些错误信息
  for (const i in defaults) {
    if (!defaults[i]) {
      defaults[i] = 'null'
    }
    str += '&amp;' + i + '=' + defaults[i].toString()
  }
  // 确定错误是由哪位用户引起的，这一步有些时候可以不用
  let userinfo = // 拿到用户信息
  if (typeof userinfo === 'object') {
    userinfo = JSON.stringify(userinfo)
  }
  if (userinfo) userinfo = encodeURIComponent(userinfo)
  str = encodeURIComponent(str.replace('&amp;', '').replace('\n', '').replace(/\s/g, ''))
	
  // 避免出现跨域错误
  new Image().src = 'api地址?msg=' + str + '&amp;userinfo=' + userinfo
}
</code></pre>

<p>这种方式的缺陷在于，没办法处理<code>promise</code>中未处理的错误，对于<code>promise</code>，推荐使用<code>unhandledrejection</code>事情处理</p>

<pre><code class="language-javascript">window.addEventListener('unhandledrejection', event =&gt; {
  let error = event.reason &amp;&amp; event.reason.message
  if (!error) {
    error = typeof event.reason === 'object' ? JSON.stringify(event.reason) : event.reason
  }

  (new Image()).src = 'api地址?msg=' + encodeURIComponent(error)
})

</code></pre>

<p>2.埋点</p>

<p>埋点是一种常见的统计用户行为的方式或工具。通过在页面设置埋点，来统计用户对于某个页面、广告、功能的使用频率、喜好，然后通过对埋点的数据统计，确定好页面或功能的迭代。简单的做法，设置一个全局方法用来提交埋点点击的行为，在需要的地方调用这个方法。</p>

<pre><code class="language-javascript">// 定义一个全局方法
// 传入的point为埋点数据
function clickPoint(point = {}) {
  const { id, name } = point
  cosnt userInfo = // 通过对应的操作拿到用户信息
  // 基础参数
  const basicParams = {
    id: id || '',
    name: name || ''
  }
  // 用户信息
 	const userParams = {
  	name: userInfo.name || ''
    ......
 	}
  // 合并参数
  const params = {
    ...basicParams,
    ...userParams
  }
  let str = ''
  for (const i in params) {
    if (!params[i]) {
      params[i] = 'null'
    }
    str += '&amp;' + i + '=' + params[i].toString()
  }
  new Image().src = 'api地址?msg=' + str
}
</code></pre>

<p>通常这样来统计页面上某个功能、某个广告的点击量，获取对应的统计数据。还有一种比较常见的方式，为需要添加埋点的<code>html</code>标签上加上某个约定好的自定义属性，如<code>&lt;div data-link=&quot;111&quot;&gt;&lt;/div&gt;</code>，这个<code>111</code>就是就是实现生成好或者规划好的埋点。然后给这种属性添加全局的点击事件，点击后同样的将对应的数据提交到自己的后台系统去。有些时候为了方便查阅或者直观的观看统计数据，还可以在页面渲染的时候，为含有<code>data-link</code>属性的标签生成对应的一些图标或者文字标签，使用<code>absolute</code>定位显示在对应的元素上，当然这种方式在你添加买点埋点属性的时候，需要给这个元素设置相应的<code>position css</code>属性；当然也可能设置一些热力图啊等其它形式，反正都是实现同一个效果的。</p>

<p>3.白屏时间</p>

<p>这个之前说过，就不说废话了，白屏时间的统计是非常重要的。比如有些时候，只有某个用户的某个设备出现了页面加载过长，页面没内容，发现这个问题后，通过判断错误日志和白屏时间才能更快的定位问题。</p>

<pre><code class="language-javascript">window.logInfo = {}
window.logInfo.openTime = window.performance &amp;&amp; window.performance.timing.navigationStart || 0
window.logInfo.whiteScreenTime = +new Date() - window.logInfo.openTime
window.logInfo.mobile = mobileType()

// 使用 DOMContentLoaded 统计页面有内容的时间
document.addEventListener('DOMContentLoaded', function () {
  window.logInfo.readyTime = +new Date() - window.logInfo.openTime
})
window.onload = function () {
  window.logInfo.allloadTime = +new Date() - window.logInfo.openTime
  window.logInfo.nowTime = new Date().getTime()
  let timname = {
    whiteScreenTime: '白屏时间',
    readyTime: '用户可操作时间',
    allloadTime: '总下载时间',
    mobile: '使用设备',
    nowTime: '时间',
  }
  let logStr = ''
  for (const i in timname) {
    if (i === 'mobile') {
      logStr += '&amp;' + i + '=' + window.logInfo[i]
    } else {
      logStr += '&amp;' + i + '=' + window.logInfo[i]
    }
  }
  // 这里如果需要的话，还可以把用户的一些信息收集出来
  (new Image()).src = 'api地址?msg=' + logStr
}

function mobileType() {
  const u = navigator.userAgent
  // 移动终端浏览器版本信息
  const type = {
    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), // ios终端
    iPad: u.indexOf('iPad') &gt; -1, // 是否iPad
    android: u.indexOf('Android') &gt; -1 || u.indexOf('Linux') &gt; -1, // android终端或者uc浏览器
    iPhone: u.indexOf('iPhone') &gt; -1 || u.indexOf('Mac') &gt; -1, // 是否为iPhone或者QQHD浏览器
    trident: u.indexOf('Trident') &gt; -1, // IE内核
    presto: u.indexOf('Presto') &gt; -1, // opera内核
    webKit: u.indexOf('AppleWebKit') &gt; -1, // 苹果、谷歌内核
    gecko: u.indexOf('Gecko') &gt; -1 &amp;&amp; u.indexOf('KHTML') === -1, // 火狐内核
    mobile: !!u.match(/AppleWebKit.*Mobile/i) || !!u.match(/MIDP|SymbianOS|NOKIA|SAMSUNG|LG|NEC|TCL|Alcatel|BIRD|DBTEL|Dopod|PHILIPS|HAIER|LENOVO|MOT-|Nokia|SonyEricsson|SIE-|Amoi|ZTE/), // 是否为移动终端
    webApp: u.indexOf('Safari') === -1 // 是否web应该程序，没有头部与底部
  }
  const lists = Object.keys(type)
  for (const i = 0; i &lt; lists.length; i++) {
    if (type[lists[i]]) {
      return lists[i]
    }
  }
}
</code></pre>

    </div>

    

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://xtid.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xtid.github.io/2020/%E7%99%BD%E5%B1%8F%E6%97%B6%E9%97%B4/" class="prev" rel="prev" title="白屏时间"><i class="iconfont icon-left"></i>&nbsp;白屏时间</a>
         
        
        <a href="https://xtid.github.io/2020/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAurl%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%91%88%E7%8E%B0%E7%9A%84%E8%BF%87%E7%A8%8B/" class="next" rel="next" title="输入一个URL到页面呈现的过程">输入一个URL到页面呈现的过程&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
