<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  <link rel="prev" href="https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84vnode/" />
  <link rel="next" href="https://xtid.github.io/2020/babel%E7%AE%80%E4%BB%8B/" />
  <link rel="canonical" href="https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84patch/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon.ico">
  <link rel="icon" sizes="16x16" href="/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Vueä¸­çš„patch | ğŸ‘¨ğŸ»â€ğŸ’»
       
  </title>
  <meta name="title" content="Vueä¸­çš„patch | ğŸ‘¨ğŸ»â€ğŸ’»">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xtid.github.io"
    },
    "articleSection" : "posts",
    "name" : "Vueä¸­çš„patch",
    "headline" : "Vueä¸­çš„patch",
    "description" : "åœ¨ç”Ÿæˆvnodeä¹‹åï¼Œå¯ä»¥é€šè¿‡patchæ–¹æ³•åˆ›å»ºDOMå…ƒç´ ã€è¿›è¡Œdiffæ›´æ–°DOMå…ƒç´ ã€é”€æ¯DOMå…ƒç´  1.é¦–å…ˆæ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶ï¼Œç”Ÿæˆäº†vno",
    "inLanguage" : "zh-CN",
    "author" : "",
    "creator" : "",
    "publisher": "",
    "accountablePerson" : "",
    "copyrightHolder" : "",
    "copyrightYear" : "2020",
    "datePublished": "2020-08-13 00:12:17 \x2b0800 CST",
    "dateModified" : "2020-08-13 00:12:17 \x2b0800 CST",
    "url" : "https:\/\/xtid.github.io\/2020\/vue%E4%B8%AD%E7%9A%84patch\/",
    "wordCount" : "3866",
    "keywords" : [  "ğŸ‘¨ğŸ»â€ğŸ’»"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ‘¨ğŸ»â€ğŸ’»</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ‘¨ğŸ»â€ğŸ’»</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Vueä¸­çš„patch</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xtid.github.io" rel="author"></a> with â™¥ 
                <span class="post-time">
                on <time datetime=2020-08-13 itemprop="datePublished">August 13, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://xtid.github.io/categories/%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3/"> æºç ç†è§£ </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p>åœ¨ç”Ÿæˆ<code>vnode</code>ä¹‹åï¼Œå¯ä»¥é€šè¿‡<code>patch</code>æ–¹æ³•åˆ›å»º<code>DOM</code>å…ƒç´ ã€è¿›è¡Œ<code>diff</code>æ›´æ–°<code>DOM</code>å…ƒç´ ã€é”€æ¯<code>DOM</code>å…ƒç´ </p>

<p>1.é¦–å…ˆæ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶ï¼Œç”Ÿæˆäº†<code>vnode</code>åï¼Œåœ¨<code>_update</code>æ–¹æ³•ä¸­è°ƒç”¨<code>patch</code></p>

<pre><code class="language-javascript">vm.$el = vm.__patch__(
  vm.$el, vnode, hydrating, false
  // undefined
  vm.$options._parentElm,
  // undefined
  vm.$options._refElm
);
</code></pre>

<p>æ­¤æ—¶<code>vm.$el</code>æ˜¯æŒ‚è½½çš„æ ¹å…ƒç´ ï¼Œ<code>vnode</code>æ˜¯æ ¹å…ƒç´ å¯¹åº”çš„è™šæ‹Ÿ<code>Dom</code>å…ƒç´ </p>

<p><code>patch</code>æ–¹æ³•</p>

<pre><code class="language-javascript">  return function patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {
    // å¦‚æœæ›´æ–°åçš„VNodeä¸å­˜åœ¨
    // ç›´æ¥é”€æ¯æ—§çš„èŠ‚ç‚¹
    if (isUndef(vnode)) {
      if (isDef(oldVnode)) { invokeDestroyHook(oldVnode); }
      return
    }

    var isInitialPatch = false;
    var insertedVnodeQueue = [];
		
    if (isUndef(oldVnode)) {
      // å¦‚æœæ—§èŠ‚ç‚¹ä¸å­˜åœ¨
      // åˆ›å»ºVNodeå¯¹åº”çš„å…ƒç´ 
      isInitialPatch = true;
      createElm(vnode, insertedVnodeQueue, parentElm, refElm);
    } else {
      // oldValueæ˜¯å¦æ˜¯çœŸå®çš„DOMå…ƒç´ 
      var isRealElement = isDef(oldVnode.nodeType);
      // æ–°æ—§èŠ‚ç‚¹ç›¸åŒ
      if (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) {
        patchVnode(oldVnode, vnode, insertedVnodeQueue, removeOnly);
      } else {
        if (isRealElement) {
          // oldVNodeç±»å‹ä¸ºå…ƒç´ ç±»å‹
          if (oldVnode.nodeType === 1 &amp;&amp; oldVnode.hasAttribute(SSR_ATTR)) {
            oldVnode.removeAttribute(SSR_ATTR);
            hydrating = true;
          }
      		......
          // åˆ›å»ºä¸€ä¸ªdivç©ºå…ƒç´ 
          oldVnode = emptyNodeAt(oldVnode);
        }
				// oldElmä»£è¡¨çœŸå®çš„DOMå…ƒç´ 
        var oldElm = oldVnode.elm;
        var parentElm$1 = nodeOps.parentNode(oldElm);

        createElm(
          vnode,
          insertedVnodeQueue,
          oldElm._leaveCb ? null : parentElm$1,
          nodeOps.nextSibling(oldElm)
        );
				......
        if (isDef(parentElm$1)) {
          removeVnodes(parentElm$1, [oldVnode], 0, 0);
        } else if (isDef(oldVnode.tag)) {
          invokeDestroyHook(oldVnode);
        }
      }
    }

    invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);
    return vnode.elm
  }
}
</code></pre>

<p>å…¶ä¸­è°ƒç”¨äº†ä¸€ä¸ªé‡è¦çš„æ–¹æ³•<code>createElm</code></p>

<pre><code class="language-javascript">  function createElm (
    vnode,
    insertedVnodeQueue,
    parentElm,
    refElm,
    nested,
    ownerArray,
    index
  ) {
		......
    // VNodeå¦‚æœæ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œè°ƒç”¨createComponent
    if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) {
      return
    }

    var data = vnode.data;
    var children = vnode.children;
    var tag = vnode.tag;
    // å¦‚æœtagæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†éå¹³å°æ ‡ç­¾ï¼Œä¹Ÿéè‡ªå®šä¹‰ç»„ä»¶ï¼ŒæŠ›é”™
    if (isDef(tag)) {
      if (process.env.NODE_ENV !== 'production') {
        if (data &amp;&amp; data.pre) {
          creatingElmInVPre++;
        }
        if (isUnknownElement$$1(vnode, creatingElmInVPre)) {
          warn(
            'Unknown custom element: &lt;' + tag + '&gt; - did you ' +
            'register the component correctly? For recursive components, ' +
            'make sure to provide the &quot;name&quot; option.',
            vnode.context
          );
        }
      }
			
      // setScopeç”¨æˆ·è®¾ç½®scoped CSS
      vnode.elm = vnode.ns
        ? nodeOps.createElementNS(vnode.ns, tag)
        : nodeOps.createElement(tag, vnode);
      setScope(vnode);

        var appendAsTree = isDef(data) &amp;&amp; isTrue(data.appendAsTree);
        if (!appendAsTree) {
          if (isDef(data)) {
            // è°ƒç”¨invokeCreateHooks
            // æ­¤æ–¹æ³•ä¼šå¤„ç†directivesã€refã€attrsã€classã€domPropsã€onã€styleå’Œshowç­‰ä¸€äº›å±æ€§
            // å¦‚æœVNodeä¸Šæœ‰å¯¹åº”çš„ç‹—å­å‡½æ•°åˆ™ä¼šç›´æ¥æ‰§è¡Œ
            // å¦‚æœæœ‰insertæ–¹æ³•ï¼Œåˆ™æŠŠVNodeæ·»åŠ åˆ°insertedVnodeQueueæ•°ç»„
            invokeCreateHooks(vnode, insertedVnodeQueue);
          }
          insert(parentElm, vnode.elm, refElm);
        }
      	// é€’å½’å¤„ç†å­èŠ‚ç‚¹
        createChildren(vnode, children, insertedVnodeQueue);
        if (appendAsTree) {
          if (isDef(data)) {
            invokeCreateHooks(vnode, insertedVnodeQueue);
          }
          insert(parentElm, vnode.elm, refElm);
        }
      }

      if (process.env.NODE_ENV !== 'production' &amp;&amp; data &amp;&amp; data.pre) {
        creatingElmInVPre--;
      }
    } else if (isTrue(vnode.isComment)) {
      // å¦‚æœéä¿ç•™æ ‡ç­¾ï¼Œéè‡ªå®šä¹‰ç»„ä»¶ï¼Œå¹¶ä¸”æ˜¯æ³¨é‡ŠèŠ‚ç‚¹
      vnode.elm = nodeOps.createComment(vnode.text);
      insert(parentElm, vnode.elm, refElm);
    } else {
      // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
      vnode.elm = nodeOps.createTextNode(vnode.text);
      insert(parentElm, vnode.elm, refElm);
    }
  }
</code></pre>

<p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œ<code>parentElm</code>æŒ‡çš„æ˜¯<code>body</code>ï¼Œ<code>refElm</code>æ˜¯å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ </p>

<p>2.ä¸Šé¢è¯´çš„æ˜¯<code>Vue</code>ç¬¬ä¸€æ¬¡åŠ è½½é¡µé¢æ—¶patchçš„æ“ä½œï¼Œè¿˜æœ‰å½“é¡µé¢ç»‘å®šçš„æ•°æ®ä¿®æ”¹åï¼Œ<code>Vue</code>å¯¹é¡µé¢çš„æ›´æ–°ï¼Œå…¶æ ¸å¿ƒä¹Ÿå°±æ˜¯<code>diff</code>ç®—æ³•äº†
åœ¨é¡µé¢ç»‘å®šçš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œ<code>watcher</code>ä¼šè°ƒç”¨<code>updateComponent</code>ï¼Œç„¶åè°ƒç”¨<code>vm._render</code>ç”Ÿæˆæœ€æ–°çš„<code>vnode</code>ï¼Œ
ç„¶å<code>vm._update</code>ä¼šè®²æ–°æ—§<code>vnode</code>ä¼ å…¥<code>patch</code>æ–¹æ³•ä¸­è¿›è¡Œdiffå¤„ç†ï¼Œå…¶å®æ€»ä½“æµç¨‹è¿˜æ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ä¼ å…¥çš„å‚æ•°ä¸åŒ</p>

<pre><code class="language-javascript">return function patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {
  ......

  let isInitialPatch = false;
  const insertedVnodeQueue = [];

  if (isUndef(oldVnode)) {
    isInitialPatch = true;
    createElm(vnode, insertedVnodeQueue, parentElm, refElm);
  } else {
     // oldValueæ˜¯ä¸æ˜¯vnodeçœŸå®çš„domå…ƒç´ 
    const isRealElement = isDef(oldVnode.nodeType);
    // åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€vnode
    // å¦‚æœæ˜¯ç»Ÿä¸€vnodeï¼Œè°ƒç”¨patchVnode
    // sameVnodeåˆ¤æ–­ä¾æ®ä¸ºä¸¤ä¸ªvnodeçš„keyç›¸åŒï¼Œtagåç›¸åŒï¼Œtypeï¼Œdataï¼Œattrså¦‚æœæœ‰çš„è¯å¿…é¡»ç›¸åŒ
    // å¦‚æœå¯ä»¥å¤ç”¨ï¼ŒpatchVnode
    if (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) {
      patchVnode(oldVnode, vnode, insertedVnodeQueue, removeOnly);
    } else {
      ......
    }
  }

  invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);
  return vnode.elm
}
</code></pre>

<p><code>patchVnode</code></p>

<pre><code class="language-javascript">
function patchVnode (oldVnode, vnode, insertedVnodeQueue, removeOnly) {
  // å¦‚æœæ–°æ—§vnodeç›¸åŒï¼Œreturn
  if (oldVnode === vnode) {
    return
  }                           
  // vnodeåº”çš„domæŒ‡å‘oldVnodeçš„dom             
  const elm = vnode.elm = oldVnode.elm;

  ......

  // å¦‚æœæ–°æ—§èŠ‚ç‚¹éƒ½æ˜¯é™æ€æ ¹èŠ‚ç‚¹
  // keyä¹Ÿç›¸åŒ
  // å¦‚æœrenderStaticæˆ–è€…markOnce
  if (isTrue(vnode.isStatic) &amp;&amp;
    isTrue(oldVnode.isStatic) &amp;&amp;
    vnode.key === oldVnode.key &amp;&amp;
    (isTrue(vnode.isCloned) || isTrue(vnode.isOnce))
  ) {
    vnode.componentInstance = oldVnode.componentInstance;
    return
  }

  let i;
  const data = vnode.data;
  // è°ƒç”¨prepatché’©å­å‡½æ•°
  if (isDef(data) &amp;&amp; isDef(i = data.hook) &amp;&amp; isDef(i = i.prepatch)) {
    i(oldVnode, vnode);
  }

  // æ–°æ—§vnode children
  const oldCh = oldVnode.children;
  const ch = vnode.children;
  // dataä¸ä¸ºç©ºï¼Œå³èŠ‚ç‚¹ç›¸å…³çš„å±æ€§ä¸ä¸ºç©º
  // isPatchableç”¨äºåˆ¤æ–­vnodeçš„tagæ˜¯å¦ä¸ºç©º
  if (isDef(data) &amp;&amp; isPatchable(vnode)) {
    // æ›´æ–°å…ƒç´ ä¸Šç›¸å…³å„ç§å±æ€§
    for (i = 0; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode);
    // è°ƒç”¨updateé’©å­å‡½æ•°
    if (isDef(i = data.hook) &amp;&amp; isDef(i = i.update)) i(oldVnode, vnode);
  }
  // åˆ¤æ–­vnodeæ˜¯å¦ä¸ºæ–‡æœ¬èŠ‚ç‚¹
  if (isUndef(vnode.text)) {
    // æ–°æ—§èŠ‚ç‚¹éƒ½æœ‰å­å…ƒç´ 
    if (isDef(oldCh) &amp;&amp; isDef(ch)) {
      // å­å…ƒç´ ä¸ç›¸åŒ
      // è°ƒç”¨updateChildren
      if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly);
      // å¦‚æœæ–°çš„vnodeæœ‰å­å…ƒç´ ï¼Œæ—§çš„æ²¡æœ‰
    } else if (isDef(ch)) {
      // å¦‚æœæ—§èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œåˆ™ç½®ç©º
      if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, '');
      // addVnodesæŠŠchä¸­çš„å…ƒç´ ä¾æ¬¡æ·»åŠ åˆ°elmä¸­
      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue);
      // å¦‚æœæ–°èŠ‚ç‚¹vnodeæ²¡æœ‰å­å…ƒç´ 
    } else if (isDef(oldCh)) {
      // åˆ é™¤æ—§èŠ‚ç‚¹çš„å­å…ƒç´ 
      removeVnodes(elm, oldCh, 0, oldCh.length - 1);
      // ä»¥ä¸Šå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œå¦‚æœoldVnodeæ˜¯æ–‡æœ¬ç»“ç‚¹ï¼Œåˆ™ç›´æ¥å†…å®¹ç½®ç©º
    } else if (isDef(oldVnode.text)) {
      nodeOps.setTextContent(elm, '');
    }
    // å¦‚æœvnodeæ˜¯æ–‡æœ¬ç»“ç‚¹ï¼Œä¸”textæœ‰å˜åŒ–ï¼Œåˆ™ä¿®æ”¹elmçš„æ–‡æœ¬å†…å®¹
  } else if (oldVnode.text !== vnode.text) {
    nodeOps.setTextContent(elm, vnode.text);
  }
  // è°ƒç”¨postpatché’©å­å‡½æ•°
  if (isDef(data)) {
    if (isDef(i = data.hook) &amp;&amp; isDef(i = i.postpatch)) i(oldVnode, vnode);
  }
}
</code></pre>

<p>æ¥ä¸‹æ¥é‡ç‚¹æ˜¯<code>updateChildren</code></p>

<pre><code class="language-javascript">function updateChildren(parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
  // å®šä¹‰äº†ä¸€äº›ç´¢å¼•ä»¥åŠèµ·å§‹èŠ‚ç‚¹çš„ä¿¡æ¯
  let oldStartIdx = 0
  let newStartIdx = 0
  let oldEndIdx = oldCh.length - 1
  let oldStartVnode = oldCh[0]
  let oldEndVnode = oldCh[oldEndIdx]
  let newEndIdx = newCh.length - 1
  let newStartVnode = newCh[0]
  let newEndVnode = newCh[newEndIdx]
  let oldKeyToIdx, idxInOld, vnodeToMove, refElm

  // removeOnlyä¸ºfalseï¼Œtransition-groupä¸­ä¸ºtrue
  const canMove = !removeOnly

  if (process.env.NODE_ENV !== 'production') {
    checkDuplicateKeys(newCh)
  }
  // æ–°æ—§èŠ‚ç‚¹éƒ½æœªéå†å®Œ
  while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    // å¦‚æœoldStartVnodeæœªå®šä¹‰
    if (isUndef(oldStartVnode)) {
      // oldChå‘åç§»ä¸€ä½
      oldStartVnode = oldCh[++oldStartIdx]
      // å¦‚æœoldEndVnodeæœªå®šä¹‰
    } else if (isUndef(oldEndVnode)) {
      // oldChå°¾ç´¢å¼•å‘å‰ç§»åŠ¨ä¸€ä½
      oldEndVnode = oldCh[--oldEndIdx]
      // é¦–èŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœèƒ½å¤ç”¨
    } else if (sameVnode(oldStartVnode, newStartVnode)) {
      // è°ƒç”¨patchVnodeï¼Œæ›´æ–°oldStartVnodeã€newStartVnodeï¼Œä¹Ÿä¼šé€’å½’updateChildren
      patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
      // æ›´æ–°èŠ‚ç‚¹ä½ç½®
      oldStartVnode = oldCh[++oldStartIdx]
      newStartVnode = newCh[++newStartIdx]
      // å°¾èŠ‚ç‚¹æ¯”è¾ƒ
    } else if (sameVnode(oldEndVnode, newEndVnode)) {
      patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)
      oldEndVnode = oldCh[--oldEndIdx]
      newEndVnode = newCh[--newEndIdx]
      // é¦–å°¾èŠ‚ç‚¹æ¯”è¾ƒ
    } else if (sameVnode(oldStartVnode, newEndVnode)) {
      patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)
      canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))
      oldStartVnode = oldCh[++oldStartIdx]
      newEndVnode = newCh[--newEndIdx]
      // å°¾é¦–èŠ‚ç‚¹æ¯”è¾ƒ
    } else if (sameVnode(oldEndVnode, newStartVnode)) {
      patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
      canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)
      oldEndVnode = oldCh[--oldEndIdx]
      newStartVnode = newCh[++newStartIdx]
    } else {
      // ä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œè°ƒç”¨createKeyToOldIdx
      // createKeyToOldIdx æ–¹æ³•çš„ä½œç”¨ï¼Œéå†oldChï¼Œæ‰¾åˆ°é‡Œé¢è®¾ç½®keyçš„å¯¹è±¡
      // è¿”å›ä¸€ä¸ªmapï¼Œkeyä¸ºé”®ï¼Œindexä¸ºå€¼
      if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
      // æŸ¥è¯¢æ–°èŠ‚ç‚¹åœ¨oldChä¸­çš„ç´¢å¼•
      idxInOld = isDef(newStartVnode.key) ?
        oldKeyToIdx[newStartVnode.key] :
        findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
      // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜æ˜¯æ–°å»ºçš„èŠ‚ç‚¹
      if (isUndef(idxInOld)) {
        // åˆ›å»ºæ–°çš„DOMå…ƒç´ ï¼Œæ’å…¥åˆ°æŒ‡å®šèŠ‚ç‚¹
        createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
      } else {
        // å¦‚æœåœ¨oldChä¸­æ‰¾åˆ°äº†ç´¢å¼•
        vnodeToMove = oldCh[idxInOld]
        // å¯å¤ç”¨
        if (sameVnode(vnodeToMove, newStartVnode)) {
          // patchVnodeå¤ç”¨domå…ƒç´ é€’å½’å­å…ƒç´ 
          patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
          // vnodeå¤„ç†å®Œäº†ä¹‹åæ¸…æ¥šoldChå¯¹åº”çš„èŠ‚ç‚¹
          oldCh[idxInOld] = undefined
          canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
          // ä¸å¯å¤ç”¨ï¼Œç›´æ¥åˆ›å»ºæ–°å…ƒç´ 
        } else {
          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
        }
      }
      // newChå‘åç§»ä¸€ä½
      newStartVnode = newCh[++newStartIdx]
    }
  }
  //Â å¦‚æœoldChéå†å®Œäº†
  if (oldStartIdx &gt; oldEndIdx) {
    // åˆ›å»ºå‰©ä¸‹çš„domèŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°å¯¹åº”çš„ä½ç½®
    refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm
    addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)
    // å¦‚æœnewChéå†å®Œäº†ï¼ŒoldChæ²¡æœ‰ 
    // ç§»å‡ºå‰©ä¸‹çš„oldCh
  } else if (newStartIdx &gt; newEndIdx) {
    removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)
  }
}
</code></pre>

<p>è¿™å°±æ˜¯<code>diff</code>å¤„ç†<code>vnode children</code>å±æ€§çš„è¿‡ç¨‹</p>

<p>3.å¯¹äºè‡ªå®šä¹‰ç»„ä»¶ï¼Œåœ¨<code>createElm</code>æ–¹æ³•ä¸­ä¸­ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªæ–¹æ³•<code>createComponent</code>æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå®šä¹‰ç»„ä»¶</p>

<pre><code class="language-javascript">...
if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) {
	return
}
...

createComponent

function createComponent (vnode, insertedVnodeQueue, parentElm, refElm) {
  let i = vnode.data
  if (isDef(i)) {
    const isReactivated = isDef(vnode.componentInstance) &amp;&amp; i.keepAlive
    if (isDef(i = i.hook) &amp;&amp; isDef(i = i.init)) {
      i(vnode, false /* hydrating */, parentElm, refElm)
    }
    ......
  }
}
</code></pre>

<p>è°ƒç”¨<code>init</code>åˆå§‹åŒ–ï¼Œ<code>init</code>æ–¹æ³•å®šä¹‰åœ¨<code>componentVNodeHooks</code>ä¸­ï¼Œ<code>componentVNodeHooks</code>ä¸­å®šä¹‰çš„é’©å­å‡½æ•°ï¼Œä¼šåœ¨<code>patch</code>ä¸­è°ƒç”¨</p>

<pre><code class="language-javascript">const componentVNodeHooks = {
  init (
    vnode,
    hydrating,
    parentElm,
    refElm
  ) {
    // å¦‚æœå½“å‰vnodeä¸Šæ²¡æœ‰ç»„ä»¶å®ä¾‹æˆ–è€…å·²ç»é”€æ¯ï¼Œåˆ™åˆ›å»ºæ–°çš„æ–°çš„componentå®ä¾‹
    if (!vnode.componentInstance || vnode.componentInstance._isDestroyed) {
      // è°ƒç”¨createComponentInstanceForVnode
      // createComponentInstanceForVnodeæ–¹æ³•ä¸­ä¼šå¤„ç†ç»„ä»¶ä¸­çš„å„ç§å±æ€§
      // æ¯”å¦‚ Ctoræ˜¯è‡ªå®šä¹‰ç»„ä»¶çš„æ„é€ å‡½æ•°ï¼ŒpropsDataæ˜¯çˆ¶ç»„ä»¶é€šè¿‡propsä¼ é€’çš„æ•°æ®
      // listenersæ˜¯æ·»åŠ åœ¨å½“å‰ç»„ä»¶ä¸Šçš„äº‹ä»¶ï¼Œtagæ˜¯è‡ªå®šä¹‰çš„æ ‡ç­¾åï¼Œchildrenå³å½“å‰è‡ªå®šä¹‰ç»„ä»¶çš„å­å…ƒç´ 
      const child = vnode.componentInstance = createComponentInstanceForVnode(
        vnode,
        activeInstance,
        parentElm,
        refElm
      );
      // è°ƒç”¨$mount
      // å…¶å†…éƒ¨ä¾æ—§è°ƒç”¨__patch__
      // ç„¶åupdate
      child.$mount(hydrating ? vnode.elm : undefined, hydrating);
    } else if (vnode.data.keepAlive) {
      const mountedNode = vnode;
      componentVNodeHooks.prepatch(mountedNode, mountedNode);
    }
  },
  // patchVNodeä¸­è°ƒç”¨
  // ç»„ä»¶diffä¹‹å‰çš„æ“ä½œ
  prepatch (oldVnode: MountedComponentVNode, vnode: MountedComponentVNode) {
    const options = vnode.componentOptions
    const child = vnode.componentInstance = oldVnode.componentInstance
    // è°ƒç”¨updateChildComponentï¼Œé€šè¿‡ä¼ å…¥çš„å±æ€§ï¼Œæ›´æ–°å¯¹åº”çš„æ¨¡æ¿ï¼Œæ•°æ®ï¼Œäº‹ä»¶
    updateChildComponent(
      child,
      options.propsData, // updated props
      options.listeners, // updated listeners
      vnode, // new parent vnode
      options.children // new children
    )
  },

  // patch invokeInsertHookä¸­è°ƒç”¨
  // ç”Ÿæˆçš„domå…ƒç´ æ’å…¥é¡µé¢åè°ƒç”¨
  insert (vnode: MountedComponentVNode) {
    const { context, componentInstance } = vnode
    // è®¾ç½®_isMountedä¸ºtrueï¼Œè°ƒç”¨mountedé’©å­å‡½æ•°
    if (!componentInstance._isMounted) {
      componentInstance._isMounted = true
      callHook(componentInstance, 'mounted')
    }
    if (vnode.data.keepAlive) {
      // keepAliveç»„ä»¶ï¼Œå¦‚æœå·²ç»åŠ è½½å¥½äº†çš„
      // è°ƒç”¨queueActivatedComponentï¼Œæ”¾è¿›activatedChildren
      if (context._isMounted) {
        queueActivatedComponent(componentInstance)
      } else {
        // åä¹‹è°ƒç”¨activateChildComponentï¼Œè§¦å‘activatedé’©å­å‡½æ•°
        // è¿™åˆæ˜¯keepAliveä¸“æœ‰çš„ç”Ÿå‘½å‘¨æœŸ
        activateChildComponent(componentInstance, true /* direct */)
      }
    }
  },

  destroy (vnode: MountedComponentVNode) {
    const { componentInstance } = vnode
    if (!componentInstance._isDestroyed) {
      if (!vnode.data.keepAlive) {
        // é”€æ¯ç»„ä»¶
        componentInstance.$destroy()
      } else {
        // å¯¹äºkeepAliveç»„ä»¶ï¼Œè°ƒç”¨deactivateChildComponentï¼Œè§¦å‘deactivatedé’©å­å‡½æ•°
        deactivateChildComponent(componentInstance, true /* direct */)
      }
    }
  }
}
</code></pre>

<p>é”€æ¯ç»„ä»¶<code>destroy</code></p>

<pre><code class="language-javascript">Vue.prototype.$destroy = function () {
  const vm: Component = this
  if (vm._isBeingDestroyed) {
    return
  }
  // è°ƒç”¨beforeDestroyé’©å­å‡½æ•°
  callHook(vm, 'beforeDestroy')
  vm._isBeingDestroyed = true
  const parent = vm.$parent
  // ä»çˆ¶å…ƒç´ ä¸­åˆ é™¤å½“å‰å…ƒç´ 
  if (parent &amp;&amp; !parent._isBeingDestroyed &amp;&amp; !vm.$options.abstract) {
    remove(parent.$children, vm)
  }
  // é”€æ¯watcher
  if (vm._watcher) {
    vm._watcher.teardown()
  }
  // _watcherså‡ä¸€
  let i = vm._watchers.length
  while (i--) {
    vm._watchers[i].teardown()
  }
  // observeå‡ä¸€
  if (vm._data.__ob__) {
    vm._data.__ob__.vmCount--
  }
  vm._isDestroyed = true
  // ä¼ å…¥nullï¼Œé”€æ¯å½“å‰ç»„ä»¶
  vm.__patch__(vm._vnode, null)
  // è°ƒç”¨destroyedé’©å­å‡½æ•°
  callHook(vm, 'destroyed')
  // é”€æ¯äº‹ä»¶
  vm.$off()
  // æ¶ˆé™¤å„ç§å±æ€§
  if (vm.$el) {
    vm.$el.__vue__ = null
  }
  vm.$options._parentElm = vm.$options._refElm = null
}
</code></pre>

<p>ä»¥ä¸Šå°±æ˜¯<code>patch</code>çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€æ¬¡ç”Ÿæˆ<code>dom</code>å…ƒç´ ï¼Œ<code>diff</code>æ›´æ–°æ“ä½œï¼Œè¿˜æœ‰å¯¹äº<code>component</code>å…ˆè½¬æ¢ä¸º<code>vnode</code>å†è¿›è¡Œ<code>patch</code>ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›ç”Ÿå‘½å‘¨æœŸå‡½æ•°</p>

    </div>

    

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> Â· 
                <span><a href="https://xtid.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84vnode/" class="prev" rel="prev" title="Vueä¸­çš„VNode"><i class="iconfont icon-left"></i>&nbsp;Vueä¸­çš„VNode</a>
         
        
        <a href="https://xtid.github.io/2020/babel%E7%AE%80%E4%BB%8B/" class="next" rel="next" title="Babelç®€ä»‹">Babelç®€ä»‹&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
