<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  
  <link rel="next" href="https://xtid.github.io/2020/webpack%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/" />
  <link rel="canonical" href="https://xtid.github.io/2020/webpack%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Webpackç®€å•ç†è§£ | ğŸ˜³
       
  </title>
  <meta name="title" content="Webpackç®€å•ç†è§£ | ğŸ˜³">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xtid.github.io"
    },
    "articleSection" : "posts",
    "name" : "Webpackç®€å•ç†è§£",
    "headline" : "Webpackç®€å•ç†è§£",
    "description" : "webpackæ˜¯ä¸€ä¸ªæ¨¡å—æ‰“åŒ…å™¨ï¼Œè€ä¸€ç‚¹çš„è¿˜æœ‰gulpã€gruntç­‰ç­‰ï¼Œ ä»–æœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯å°†æ–‡ä»¶è§†ä¸ºä¸€ä¸ªä¸ªæ¨¡å—ï¼Œé€šè¿‡è®¾ç½®å…¥å£æ–‡ä»¶entryï¼ŒåŠ ",
    "inLanguage" : "zh-CN",
    "author" : "",
    "creator" : "",
    "publisher": "",
    "accountablePerson" : "",
    "copyrightHolder" : "",
    "copyrightYear" : "2020",
    "datePublished": "2020-08-23 21:36:20 \x2b0800 CST",
    "dateModified" : "2020-08-23 21:36:20 \x2b0800 CST",
    "url" : "https:\/\/xtid.github.io\/2020\/webpack%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3\/",
    "wordCount" : "3194",
    "keywords" : [  "ğŸ˜³"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ˜³</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ˜³</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Webpackç®€å•ç†è§£</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xtid.github.io" rel="author"></a> with â™¥ 
                <span class="post-time">
                on <time datetime=2020-08-23 itemprop="datePublished">August 23, 2020</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <p><code>webpack</code>æ˜¯ä¸€ä¸ªæ¨¡å—æ‰“åŒ…å™¨ï¼Œè€ä¸€ç‚¹çš„è¿˜æœ‰<code>gulp</code>ã€<code>grunt</code>ç­‰ç­‰ï¼Œ
ä»–æœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯å°†æ–‡ä»¶è§†ä¸ºä¸€ä¸ªä¸ªæ¨¡å—ï¼Œé€šè¿‡è®¾ç½®å…¥å£æ–‡ä»¶<code>entry</code>ï¼ŒåŠ è½½ä¸åŒç±»å‹çš„æ–‡ä»¶ç”¨ä¸åŒ<code>loader</code>è½¬æ¢æ–‡ä»¶ï¼Œ
ç„¶åä½¿ç”¨ä¸åŒ<code>plugin</code>å¯¹æ–‡ä»¶å¤„ç†ï¼Œæœ€åè¾“å‡ºå¤šä¸ªæ‰“åŒ…ã€åˆ†å‰²åçš„æ–‡ä»¶</p>

<p>é¦–å…ˆæœ‰å‡ ä¸ªæ¦‚å¿µ
1.entryï¼šå³<code>webpack</code>æ‰“åŒ…çš„å…¥å£ï¼Œå‘Šè¯‰å®ƒåº”è¯¥ä»é‚£ä¸ªæ–‡ä»¶å¼€å§‹è¿›è¡Œæ„å»º
2.outputï¼šè®¾ç½®æ‰“åŒ…åæ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ä»¥åŠå¦‚ä½•å‘½åè¿™äº›æ–‡ä»¶
3.loaderï¼šå¤„ç†é‚£äº›é<code>javaScript</code>æ–‡ä»¶ï¼Œé€šè¿‡æŒ‡å®šå¯¹åº”æ–‡ä»¶æ‰€éœ€çš„å¯¹åº”<code>loader</code>çš„å¤„ç†ï¼Œå°†æ–‡ä»¶è½¬æ¢ä¸º<code>webpack</code>èƒ½å¤Ÿå¤„ç†çš„æœ‰æ•ˆæ¨¡å—
4.pluginsï¼šè½¬æ¢æŸäº›ç±»å‹çš„æ¨¡å—ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥åšåˆ°æ‰“åŒ…ä¼˜åŒ–ï¼Œå‹ç¼©ä»¥åŠå„ç§å„æ ·çš„å…¶å®ƒä»»åŠ¡</p>

<p><code>bundle</code>ï¼šè§†ä¸º<code>webpack</code>æ‰“åŒ…æå–çš„æ¨¡å—ç”Ÿæˆçš„<code>js</code>æ–‡ä»¶ï¼Œå°†å…¶å®ƒå…·ä½“æ¨¡å—çš„ä»£ç ä¼ å…¥å…¶ä¸­æ‰§è¡Œï¼ŒåŸæœ¬ç‹¬ç«‹çš„æ¨¡å—æ–‡ä»¶ï¼Œé€šè¿‡è°ƒç”¨<code>__webpack_require__</code>ï¼Œåˆå¹¶åˆ°äº†<code>bundle</code>ä¸­</p>

<pre><code class="language-javascript">(function(modules) {
/******/    var installedModules = {};
/******/
/******/    var installedChunks = {
/******/        2: 0
/******/    };
/******/
/******/    function __webpack_require__(moduleId) {
/******/
/******/        if(installedModules[moduleId]) {
/******/            return installedModules[moduleId].exports;
/******/        }
/******/        var module = installedModules[moduleId] = {
/******/            i: moduleId,
/******/            l: false,
/******/            exports: {}
/******/        };
/******/
/******/        modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/        module.l = true;
/******/
/******/        return module.exports;
/******/    }
/******/ })
/************************************************************************/
/******/ ({
	// ä¼ å…¥çš„æ¨¡å—
	......
});
</code></pre>

<p>æ‰“åŒ…åçš„<code>bundle</code>æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼Œå…¶å‚æ•°å°±æ˜¯æ‰“åŒ…åçš„æ¨¡å—ï¼Œä¸Šé¢<code>__webpack_require__</code>æ–¹æ³•ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰æ¨¡å—<code>moduleId</code>æ˜¯å¦å·²ç»å­˜åœ¨ç¼“å­˜<code>installedModules</code>ä¸­ï¼Œè‹¥æ˜¯å­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚è‹¥æ˜¯ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ„é€ ä¸€ä¸ªå¯¹è±¡å¹¶å°†å…¶åŒæ—¶å­˜åˆ°<code>installedModules</code>ä¸­å’Œ<code>module</code>ä¸­</p>

<p><code>modules[moduleId].call(module.exports, module, module.exports, __webpack_require__)</code>
è¿™æ®µä»£ç é¦–å…ˆæ‰§è¡Œå½“å‰æ¨¡å—çš„å…·ä½“ä»£ç ï¼Œä¼ å…¥<code>module</code>ï¼Œ<code>module.exports</code>ï¼Œ<code>__webpack_require__</code>ï¼Œé€’å½’è°ƒç”¨<code>__webpack_require__</code>å¤„ç†æ¯ä¸ªæ¨¡å—ç§å¼•å…¥çš„å…¶å®ƒæ¨¡å—
å¦‚ä»¥ä¸‹å½¢å¼</p>

<pre><code class="language-javascript">/***/ 0:
/***/ (function(module, exports, __webpack_require__) {
	......
	__webpack_require__(1);
	module.exports = __webpack_require__(2);
	......

/***/ })
</code></pre>

<p>ä¸€ä¸ªç®€å•çš„bundleæ„å»ºè¿‡ç¨‹ï¼š</p>

<pre><code class="language-javascript">// å¼•å…¥ç›¸å…³ä¾èµ–ï¼Œå¯¹æ–‡ä»¶è¿›è¡Œç¼–è¯‘è½¬æ¢è¾“å‡ºå¤„ç†
const fs = require('fs');
const path = require('path');
const parse = require('@babel/parser');
const traverse = require('@babel/traverse').default;
const babel = require('@babel/core');


let ID = 0;
// è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼Œå¹¶è·å¾—å½“å‰jsæ–‡ä»¶çš„ä¾èµ–å…³ç³»
function createAsset(filename) {
  // è·å–æ–‡ä»¶ï¼Œè¿”å›å€¼æ˜¯å­—ç¬¦ä¸²
  const content = fs.readFileSync(filename, 'utf-8');

  // å°†å­—ç¬¦ä¸²è½¬ä¸ºast
  const ast = parse.parse(content, {
    sourceType: 'module'
  });

  //ç”¨æ¥å­˜å‚¨ æ–‡ä»¶æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œå½“å‰jsæ–‡ä»¶ import äº†å“ªäº›æ–‡ä»¶ï¼Œéƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªæ•°ç»„é‡Œ
  const dependencies = [];

  //éå†å½“å‰astï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰
  traverse(ast, {
    //æ‰¾åˆ°æœ‰ importè¯­æ³• çš„å¯¹åº”èŠ‚ç‚¹
    ImportDeclaration: ({ node }) =&gt; {
      //æŠŠå½“å‰ä¾èµ–çš„æ¨¡å—åŠ å…¥åˆ°æ•°ç»„ä¸­
      dependencies.push(node.source.value);
    }
  });

  //æ¨¡å—çš„id ä»0å¼€å§‹ï¼Œ ç›¸å½“ä¸€ä¸ªjsæ–‡ä»¶ å¯ä»¥çœ‹æˆä¸€ä¸ªæ¨¡å—
  const id = ID++;

  //è¿™è¾¹ä¸»è¦æŠŠES6 çš„ä»£ç è½¬æˆ ES5
  const { code } = babel.transformFromAstSync(ast, null, {
    presets: ['@babel/preset-env']
  });

  return {
    id,
    filename,
    dependencies,
    code
  };
}

// ä»å…¥å£å¼€å§‹åˆ†ææ‰€æœ‰ä¾èµ–é¡¹ï¼Œå½¢æˆä¾èµ–å›¾ï¼Œé‡‡ç”¨å¹¿åº¦éå†
function createGraph(entry) {
  const mainAsset = createAsset(entry);
    
  const queue = [mainAsset];

  for (const asset of queue) {
    const dirname = path.dirname(asset.filename);
    // æ–°å¢ä¸€ä¸ªå±æ€§æ¥ä¿å­˜å­ä¾èµ–é¡¹çš„æ•°æ®
    asset.mapping = {};
    asset.dependencies.forEach(relativePath =&gt; {
      const absolutePath = path.join(dirname, relativePath);
      //è·å¾—å­ä¾èµ–ï¼ˆå­æ¨¡å—ï¼‰çš„ä¾èµ–é¡¹ã€ä»£ç ã€æ¨¡å—idï¼Œæ–‡ä»¶å
      const child = createAsset(absolutePath);
      //ç»™å­ä¾èµ–é¡¹èµ‹å€¼ï¼Œ
      asset.mapping[relativePath] = child.id;
      //å°†å­ä¾èµ–ä¹ŸåŠ å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¿åº¦éå†
      queue.push(child);
    });
  }
  return queue;
}

//æ ¹æ®ç”Ÿæˆçš„ä¾èµ–å…³ç³»å›¾ï¼Œç”Ÿæˆå¯¹åº”ç¯å¢ƒèƒ½æ‰§è¡Œçš„ä»£ç ï¼Œç›®å‰æ˜¯ç”Ÿäº§æµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„
function bundle(graph) {
  let modules = '';

  //å¾ªç¯ä¾èµ–å…³ç³»ï¼Œå¹¶æŠŠæ¯ä¸ªæ¨¡å—ä¸­çš„ä»£ç å­˜åœ¨functionä½œç”¨åŸŸé‡Œ
  graph.forEach(mod =&gt; {
    modules += `${mod.id}:[
      function (require, module, exports){
        ${mod.code}
      },
      ${JSON.stringify(mod.mapping)},
    ],`;
  });

  //require, module, exports æ˜¯ cjsçš„æ ‡å‡†ä¸èƒ½å†æµè§ˆå™¨ä¸­ç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæ¨¡æ‹Ÿcjsæ¨¡å—åŠ è½½ï¼Œæ‰§è¡Œï¼Œå¯¼å‡ºæ“ä½œã€‚
  const result = `
    (function(modules){
      //åˆ›å»ºrequireå‡½æ•°ï¼Œ å®ƒæ¥å—ä¸€ä¸ªæ¨¡å—IDï¼ˆè¿™ä¸ªæ¨¡å—idæ˜¯æ•°å­—0ï¼Œ1ï¼Œ2ï¼‰ ï¼Œå®ƒä¼šåœ¨æˆ‘ä»¬ä¸Šé¢å®šä¹‰ modules ä¸­æ‰¾åˆ°å¯¹åº”æ˜¯æ¨¡å—.
      function __webpack_require__(id){
        const [fn, mapping] = modules[id];
        function localRequire(relativePath){
          //æ ¹æ®æ¨¡å—çš„è·¯å¾„åœ¨mappingä¸­æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—id
          return __webpack_require__(mapping[relativePath]);
        }
        const module = {exports:{}};
        //æ‰§è¡Œæ¯ä¸ªæ¨¡å—çš„ä»£ç ã€‚
        fn(localRequire,module,module.exports);
        return module.exports;
      }
      //æ‰§è¡Œå…¥å£æ–‡ä»¶ï¼Œ
      __webpack_require__(0);
    })({${modules}})
  `;

  return result;
}

// å…¥å£æ–‡ä»¶
const graph = createGraph('./entry.js');
// æ–‡ä»¶å†…å®¹
const ret = bundle(graph);

// æ‰“åŒ…ç”Ÿæˆæ–‡ä»¶
fs.writeFileSync('./bundle.js', ret);
</code></pre>

<p><code>loader</code>ï¼Œé€šè¿‡è®¾ç½®å¯¹åº”çš„<code>rule</code>ï¼Œä½¿ç”¨ä¸åŒçš„<code>loader</code>æ¥è½¬æ¢ã€å¤„ç†ä¸åŒçš„ç»„ä»¶ï¼Œæ¯”å¦‚<code>css</code>æ–‡ä»¶ä½¿ç”¨<code>css-loader</code>ä»¥åŠ<code>style-loader</code>æ¥å¤„ç†</p>

<pre><code class="language-javascript">{
  test: /\.css$/,
  loader: 'style-loader!css-loader'
}
</code></pre>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§å†…è”<code>loader</code>çš„å½¢å¼ï¼Œå³<code>import loader from '......'</code></p>

<p>ä¸¤ç§æ–¹å¼å¤„ç†çš„é¡ºåºä¹Ÿä¸åŒï¼Œå¤§è‡´æµç¨‹ä¸º
1.<code>webpack</code>å¯åŠ¨åï¼Œåˆ›å»ºæ–°çš„<code>compilation</code>
2.å®ä¾‹åŒ–<code>rules</code>
3.è§£æ<code>inline loaders</code>
4.è§£æ<code>config</code>é…ç½®é‡Œé¢çš„<code>loaders</code>
5.ç»„åˆè¿™ä¸¤ç§å½¢å¼çš„<code>loader</code>ï¼Œæœ€ç»ˆè¾“å‡ºä¸Šè¯‰ç¬¬ä¸€ç§å½¢å¼çš„é…ç½®
6.ä½¿ç”¨<code>Loader-runner</code>æŒ‰é…ç½®æ‰§è¡Œ<code>loader</code></p>

<p>ä»¥ä¸‹ç®€å•å†™ä¸€ä¸ª<code>loader</code>ï¼Œé¦–å…ˆå†™ä¸€ä¸ªæ–¹æ³•ç”¨äºåŠ è½½<code>loader</code>ï¼Œå¹¶å¤„ç†ä¼ å…¥çš„æ¨¡å—ï¼Œç„¶åè¿”å›å¤„ç†å®Œäº†ä¹‹åçš„ä»£ç </p>

<pre><code class="language-javascript">let source = ...... // sourceä¸ºè·å–åˆ°çš„æ¨¡å—çš„ä»£ç 
function loaderModule(loaderName) {
  // è·å–loaderè·¯å¾„
  const loaderPath = path.join(process.cwd(), loaderName)
  const loader = require(loaderPath)
  source = loader.call(_this, source)
}
</code></pre>

<p>å®šä¹‰ä¸€ä¸ªè§„åˆ™</p>

<pre><code class="language-javascript">rules: [{
  test:/\.js/,
  use:[
    './loaderModule.js', // loaderçš„è·¯å¾„
  ]
}]
</code></pre>

<p>æ‰§è¡Œçš„æ—¶å€™éå†<code>rules</code></p>

<pre><code class="language-javascript">for (let i = rules.length - 1; i &gt;= 0; i--) {
  const { test, use } = rules[i]
  if (test.test(modulePath)) {
    // ä½¿ç”¨å¤šä¸ªloader
    if (Array.isArray(use)) {
      for (let j = use.length - 1; j &gt;= 0; j--) {
        loaderModule(use[j])
      }
    } else if (typeof use === 'string') {
      loaderModule(use)
      // å¸¦å‚æ•°å‹çš„loader
    } else if (use instanceof Object) {
      loaderModule(use.loader, {
        query: use.options
      })
    }
  }
}

// loaderModule.jså†…å®¹
// loader-utilsæ˜¯webpackä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºè§£æloaderï¼Œè·å–é…ç½®çš„ä¸€äº›loaderå‚æ•°
const loaderUtils = require('loader-utils')

// è¿™ä¸ªç®€å•çš„loaderä¼šå°†jsæ–‡ä»¶é‡Œé¢çš„helloå­—ç¬¦ä¸²æ›¿æ¢æˆword
module.exports = function (source) {
  const optionsName = loaderUtils.getOptions(this) &amp;&amp; loaderUtils.getOptions(this).name || 'world'
  return source.replace(/hello/g, optionsName)
}
</code></pre>

<p>å‰é¢æ˜¯ä¸€ä¸ªåŒæ­¥çš„<code>loader</code>ï¼Œå¦‚æœæƒ³å†™ä¸€ä¸ªå¼‚æ­¥çš„<code>loader</code>ï¼Œå¯ä»¥åœ¨<code>loader</code>å†…éƒ¨è°ƒç”¨<code>async</code>æ–¹æ³•ï¼Œç„¶ååœ¨å¤„ç†ä¹‹åè°ƒç”¨å¯¹åº”çš„å›è°ƒæ–¹æ³•å¤„ç†</p>

<pre><code class="language-javascript">module.exports = function (source) {
  const optionsName = loaderUtils.getOptions(this) &amp;&amp; loaderUtils.getOptions(this).name || 'world'
  cosnt callback = this.async()

  // æ“ä½œå®Œäº†ä¹‹åï¼Œè°ƒç”¨callbackè¿”å›ç»“æœè¿›å…¥ä¸‹ä¸€ä¸ªloader
  asyncOperation(source, optionsName, function(err, result) {
    ifï¼ˆerrï¼‰return callback(err)
    callback(err, result)
  })
}
</code></pre>

<p>å¦‚æœä¸ç”¨ä¸Šé¢çš„æ–¹å¼ï¼Œè¿”å›ä¸€ä¸ª<code>promise</code>ä¹Ÿæ˜¯å¯ä»¥çš„</p>

<pre><code class="language-javascript">module.exports = function (source) {
  const optionsName = loaderUtils.getOptions(this) &amp;&amp; loaderUtils.getOptions(this).name || 'world'
  return new Promise(resolve =&gt; {
    asyncOperation(source, function(err, result) {
      if (err) resolve(err)
      resolve(err, result)
    })
  })
}
</code></pre>

<p><code>plugin</code>
<code>plugin</code>è¿›ä¸€æ­¥æ‹“å±•äº†<code>webpack</code>çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ‰“åŒ…ä¼˜åŒ–å’Œå‹ç¼©ï¼Œæ¸…ç©ºå½“å‰é¡¹ç›®çš„ç›®å½•ï¼Œé‡æ–°å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œå°†ä»£ç è¾“å‡ºåˆ°æŸä¸ªæ–‡ä»¶ï¼Œæå–åŠŸèƒ½æ¨¡å—ç­‰ç­‰</p>

<p>å®šä¹‰ä¸€ä¸ª<code>plugin</code>çš„æ—¶å€™ï¼Œé¦–å…ˆè¦æä¾›ä¸€ä¸ª<code>apply</code>æ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ª<code>compiler</code>å¯¹è±¡ï¼Œç„¶åæ³¨å†Œå¯¹åº”çš„é’©å­å‡½æ•°ï¼Œåœ¨å›è°ƒé‡Œé¢æ‹¿åˆ°å¯¹åº”å‚æ•°ï¼Œç„¶åå¤„ç†
ä»¥ä¸‹å®šä¹‰ä¸€ä¸ª<code>plugin</code></p>

<pre><code class="language-javascript">const path = require('path')
const fs = require('fs')
const cheerio = require('cheerio')

class BasePlugin {
  constructor(options){
    // æ’ä»¶çš„å‚æ•°ï¼Œfilenameã€templateç­‰
    this.options = options
  }
  apply(compiler) {
    // æ³¨å†ŒafterEmité’©å­å‡½æ•°
    compiler.hooks.afterEmit.tap('BasePlugin', (compilation) =&gt; {
      // 2. æ ¹æ®æ¨¡æ¿è¯»å–htmlæ–‡ä»¶å†…å®¹
      const result = fs.readFileSync(this.options.template, 'utf-8')
      
      // 3. ä½¿ç”¨ cheerio æ¥åˆ†æ HTML
      let $ = cheerio.load(result)
    
      // 4. åˆ›å»º script æ ‡ç­¾åæ’å…¥HTMLä¸­
      // compilation.assetsä»£è¡¨æ‰€æœ‰è¾“å‡ºçš„èµ„æºæ–‡ä»¶
      Object.keys(compilation.assets).forEach(item =&gt; {
        $(`&lt;script src=&quot;/${item}&quot;&gt;&lt;/script&gt;`).appendTo('body')
      })
    
      // 5. è½¬æ¢æˆæ–°çš„HTMLå¹¶å†™å…¥åˆ° dist ç›®å½•ä¸­
      fs.writeFileSync(path.join(process.cwd(), 'dist', this.options.filename), $.html())
    })
  } 
}
</code></pre>

<p><code>compiler</code>å¯¹è±¡åŒ…å«äº†<code>webpack</code>ç¯å¢ƒæ‰€æœ‰çš„çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«<code>options</code>ï¼Œ<code>loaders</code>ï¼Œ<code>plugins</code>è¿™äº›ä¿¡æ¯ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨<code>webpack</code>å¯åŠ¨æ—¶å€™è¢«å®ä¾‹åŒ–ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£ä¸º<code>webpack</code>å®ä¾‹ï¼Œ<code>compilation</code>å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ç­‰ã€‚å½“<code>webpack</code>ä»¥å¼€å‘æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œ<code>compilation</code>å°±ä¼šè¢«é‡æ–°æ„å»ºï¼Œå…¶å®ƒçš„ä¸€äº›<a href="https://www.webpackjs.com/api/compiler-hooks/#hooks" rel="nofollow noreferrer" target="_blank">é’©å­å‡½æ•°</a></p>

<p>é¡ºä¾¿æ€»ç»“ä¸€ä¸‹ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„<code>webpack</code>çš„æ­¥éª¤
1.å®šä¸€ä¸ªåŸºç¡€å¯¹è±¡ï¼Œæ„é€ æ–¹æ³•é‡Œé¢ä¼ å…¥<code>entry</code>ã€<code>output</code>ã€<code>rules</code>ã€<code>plugins</code>ç­‰å±æ€§
2.ç„¶åå®šä¹‰ä¸€ç³»åˆ—é’©å­å‡½æ•°ï¼Œåœ¨<code>webpack</code>æ‰§è¡Œä¸­å¯ä»¥è°ƒç”¨è¿™äº›é’©å­å‡½æ•°åšå¤„ç†ï¼Œ
3.å¼€å§‹æ‰§è¡Œï¼Œåˆå§‹åŒ–å¯¹åº”çš„é’©å­å‡½æ•°ï¼Œä¼ å…¥<code>entry</code>ç­‰ç›¸å…³ä¿¡æ¯
4.æ‹¿åˆ°æ–‡ä»¶æºç ä¿¡æ¯ï¼Œä½¿ç”¨<code>loader</code>å¤„ç†ï¼Œå°†ä»£ç è½¬æ¢æˆ<code>ast</code>å½¢å¼
5.<code>traverse</code>å°†<code>ast</code>ä»£ç ä¸­çš„<code>require</code>æ›¿æ¢ä¸º<code>__webpack_require__</code>ï¼Œæ·»åŠ æ–°çš„<code>module</code>ä¿¡æ¯
6.é€’å½’å¤„ç†æ¯ä¸€ä¸ªä¾èµ–ï¼Œé‡å¤ä¸Šé¢çš„æ­¥éª¤
7.åˆå§‹åŒ–<code>plugin</code>ï¼Œå¹¶å¯¹æ–‡ä»¶åšå¤„ç†
8.è¾“å…¥åˆ°æŒ‡å®šç›®å½•
9.å®¢æˆ·ç«¯/æµè§ˆå™¨è¿è¡Œæ—¶æ‰§è¡Œ</p>

<p>å‚è€ƒé“¾æ¥</p>

<p>1.<a href="https://juejin.im/post/6844903957769224206" rel="nofollow noreferrer" target="_blank">webpackåŸç†</a></p>

<p>2.<a href="https://www.webpackjs.com/" rel="nofollow noreferrer" target="_blank">webpackå®˜æ–¹æ–‡æ¡£</a></p>

    </div>

    

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> Â· 
                <span><a href="https://xtid.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
         
        
        <a href="https://xtid.github.io/2020/webpack%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/" class="next" rel="next" title="Webpackæ‰“åŒ…ä¼˜åŒ–">Webpackæ‰“åŒ…ä¼˜åŒ–&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
