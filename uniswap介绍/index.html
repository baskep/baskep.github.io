<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Uniswap介绍 - 早起的老年人の博客</title><meta name="Description" content="早起的老年人做的网站"><meta property="og:url" content="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/">
  <meta property="og:site_name" content="早起的老年人の博客">
  <meta property="og:title" content="Uniswap介绍">
  <meta property="og:description" content="1.Uniswap简介 Uniswap是以太坊的去中心化交易所(DEX)，自2018年发布以来，它已经成为了去中心化金融DeFi领域的重要组成">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-03-02T14:35:12+08:00">
    <meta property="article:modified_time" content="2023-03-02T14:35:12+08:00">
    <meta property="og:image" content="https://baskep.top/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://baskep.top/logo.png">
  <meta name="twitter:title" content="Uniswap介绍">
  <meta name="twitter:description" content="1.Uniswap简介 Uniswap是以太坊的去中心化交易所(DEX)，自2018年发布以来，它已经成为了去中心化金融DeFi领域的重要组成">
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/" /><link rel="prev" href="https://baskep.top/nft%E5%B8%82%E5%9C%BA%E7%9A%84%E6%A6%82%E5%86%B5/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Uniswap介绍",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/baskep.top\/uniswap%E4%BB%8B%E7%BB%8D\/"
        },"image": ["https:\/\/baskep.top\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  6957 ,
        "url": "https:\/\/baskep.top\/uniswap%E4%BB%8B%E7%BB%8D\/","datePublished": "2023-03-02T14:35:12+08:00","dateModified": "2023-03-02T14:35:12+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/baskep.top\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "早起的老年人"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="早起的老年人の博客"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"><i class='fa fa-book'></i> 文章 </a><a class="menu-item" href="/categories/"><i class='fa fa-th'></i> 分类 </a><a class="menu-item" href="/about/"><i class='fa fa-info-circle'></i> 关于 </a><a class="menu-item" href="/links/"><i class='fas fa-user-friends'></i> 友链 </a><a class="menu-item" href="https://github.com/baskep" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i> Github </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="早起的老年人の博客"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title=""><i class='fa fa-book'></i>文章</a><a class="menu-item" href="/categories/" title=""><i class='fa fa-th'></i>分类</a><a class="menu-item" href="/about/" title=""><i class='fa fa-info-circle'></i>关于</a><a class="menu-item" href="/links/" title=""><i class='fas fa-user-friends'></i>友链</a><a class="menu-item" href="https://github.com/baskep" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>Github</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Uniswap介绍</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>早起的老年人</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/"><i class="far fa-folder fa-fw"></i>日常学习</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-03-02">2023-03-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6957 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 14 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1uniswap简介">1.Uniswap简介</a></li>
    <li><a href="#2v1版本">2.V1版本</a>
      <ul>
        <li><a href="#21版本内容">2.1.版本内容</a></li>
        <li><a href="#22恒定乘积示例">2.2.恒定乘积示例</a></li>
        <li><a href="#23改变流动性">2.3.改变流动性</a></li>
        <li><a href="#23uniswap的实质">2.3.Uniswap的实质</a></li>
        <li><a href="#24无偿损失以及k值的变化">2.4.无偿损失以及K值的变化</a></li>
        <li><a href="#26交易路由">2.6.交易路由</a></li>
        <li><a href="#25v1的缺陷">2.5.V1的缺陷</a></li>
      </ul>
    </li>
    <li><a href="#3v2版本">3.V2版本</a>
      <ul>
        <li><a href="#31多代币交易">3.1.多代币交易</a></li>
        <li><a href="#32价格预言机oracle">3.2.价格预言机(Oracle)</a></li>
        <li><a href="#33flash-swaps闪电贷">3.3.Flash Swaps(闪电贷)</a></li>
        <li><a href="#34v2的缺陷">3.4.V2的缺陷</a></li>
      </ul>
    </li>
    <li><a href="#4v3版本">4.V3版本</a>
      <ul>
        <li><a href="#41集中流动性">4.1.集中流动性</a></li>
        <li><a href="#42费率选择">4.2.费率选择</a></li>
        <li><a href="#43nft作为lp-token凭证">4.3.NFT作为LP token凭证</a></li>
        <li><a href="#44价格预言机的优化">4.4.价格预言机的优化</a></li>
        <li><a href="#45v3版本集中流动性的使用场景">4.5.V3版本集中流动性的使用场景</a></li>
        <li><a href="#46v3的缺陷">4.6.V3的缺陷</a></li>
      </ul>
    </li>
    <li><a href="#5uniswap产品展望">5.Uniswap产品展望</a></li>
    <li><a href="#6参考链接">6.参考链接</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="1uniswap简介">1.Uniswap简介</h1>
<p><code>Uniswap</code>是以太坊的去中心化交易所<code>(DEX)</code>，自2018年发布以来，它已经成为了去中心化金融<code>DeFi</code>领域的重要组成部分</p>
<p><code>中心化交易所</code>：传统的<code>OKX</code>、<code>Binance</code>都是，中心化交易所需要你先注册个账号，然后还有一系列的认证，你的资产相当于托管到这个平台上。当需要交易时采用订单铺，以价格单的形式做市，交易速度较快，基本上也有交易所平台托底，这是它的优点</p>
<p><code>去中心化交易所</code>：交易所无法掌握你的个人数据及资产，这是你自己保管的，也不用实名认证，所有交易上链，不容易被攻击</p>
<p>回到Uniswap，它的交易核心逻辑实际就是以合约的形式部署在以太坊上面的，而它能满足以下需求：</p>
<p>1.通过交易ERC20币对的方式，提供流动性获得交易手续费分成</p>
<p>2.通过Uniswap自由兑换ETH和ERC20代币，<code>ERC20</code>代币指的是满足以太坊<code>ERC20</code>标准的代币，像<code>BTC</code>这种可以转为<code>WBTC</code>去交易，<code>BTC</code>和<code>WBTC</code>是1:1的兑换关系，所以理论上来说它支持所有代币的自由兑换</p>
<p>3.在多个NFT市场上交易NFT</p>
<p>4.为Uniswap上的交易池添加流动性，获取额外的交易手续费分成</p>
<p>它的特点：</p>
<p>1.无订单簿，无做市商。是基于“恒定乘积“模型的自动做市商(AMM)</p>
<p>2.兑换代币具有相对较低的gas费用</p>
<p>3.任何人可以提供流动性，并获得手续费奖励</p>
<p>4.项目方可以很自由的创建代币池，开始流动性玩法</p>
<p>截至目前来说，Uniswap已经经历了<code>V1、V2、V3</code>3个大的版本迭代，接下来将对其特点进行详细阐述：</p>
<h1 id="2v1版本">2.V1版本</h1>
<h2 id="21版本内容">2.1.版本内容</h2>
<p>2018年11月，Uniswap V1正式上线，它抛弃了传统的维护订单簿的方式，采用了自动化做市商机制——将所有人资产汇集到<strong>流动池</strong>中。并根据一种名为&quot;恒定乘积做市商模型”的算法进行做市商&quot;，这个算法直观上看就是一个数学函数：</p>
<p>$$
K = X * Y
$$</p>
<p>其中<code>X</code>、<code>Y</code>是指某次交易前后流动池里的两种代币<strong>数量</strong>，<code>K</code>即代表一个<strong>乘积常数</strong></p>
<p>而<code>流动池</code>则可以视为一个合约，创建者需要选择一对币对，比如说<code>ETH/WBTC</code>， 指定对应数量，也就是<code>X</code>、<code>Y</code>的值，然后就能得出<code>K</code>的值，这样就能生成一个流动池。创建流动池后再改变<code>X</code>、<code>Y</code>的值都要受到<code>K</code>值的约束，以保持<code>K</code>的恒定。当然在实际交易中，<code>K</code>不会一成不变，这个后面再说</p>
<p>以下用一个例子来说明如何用<code>K = X * Y</code>来进行交易</p>
<h2 id="22恒定乘积示例">2.2.恒定乘积示例</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">假如当前池子中有币对ETH/X，其中ETH数量为10，X数量为100，那么K =  10 * 100 = 1000，1个ETH可以兑换10个X
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">这时某个人用1个ETH去兑换池子中的X代币，ETH数量变为11，这个时候求得X的数量为1000 / 11 = 90.909 ，X减少的数量为9.09，即1个ETH可以买到9.09个X，
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">相对于原来1ETH = 10X的价格来说，价格误差为(10 - 9.09）/ 10 * 100% = 9.09%，这个值也被称为滑点
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">如果使用的是5个ETH去兑换X，那么可以算出5个ETH可以买到33.33个X，1个ETH只能够买到6.67个X，滑点为33.33%
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以看出&quot;恒定乘积&quot;的一些特点：</p>
<p>1.交易量大，但是流动池小，那么滑点就会很大</p>
<p>2.滑点也是随着交易的进行而变化</p>
<p>3.当有人用<code>X</code>代币兑换<code>Y</code>代币（即买<code>Y</code>）时，<code>Y</code>的价格就会上涨，反过来<code>Y</code>价格下跌，符合一般交易价格规律</p>
<p>4.无论流动池的资金规模如何，该算法均能提供流动性</p>
<h2 id="23改变流动性">2.3.改变流动性</h2>
<p>流动池有了，这个时候你可以选择向这个池子里<code>增加 or 赎回</code>你的币对资产，这也就被称为<code>改变流动性</code>。当你向池子里继续投入代币时，你就是<code>流动性提供商(LP)</code>，通俗点讲，你就是出资方，这个时候系统会返给你一个<code>ERC20</code>代币 <code>LP token</code></p>
<p><code>LP token</code>就代表你提供流动性的比例，实际上Uniswap V1在交易时是会收取<code>0.3%</code>的手续费的，然后你就可以根据<code>LP token</code>的比例去获取整个池子手续费的分成。当取消做市想要退出时，你可以把<code>LP token</code>置换回池子里面对应比例的币对，所以是比较方便的</p>
<p>而<code>LP token</code>数量的计算方式：</p>
<p>假如首次创建池子，币对<code>ETH/X</code>的数量分别为<code>X</code>、<code>Y</code>，那么首次铸造的<code>LP token</code>总数为：
$$
\sqrt{x \times y} - 1000 \times 10^-18，
$$
这个时候，再往里面添加<code>dx</code>、<code>dy</code>数量的<code>ETH/X</code>，那么获得的<code>LP token</code>数量为：</p>
<p><code>min(dx.mul(totalSupply) / reserve0, dy.mul(totalSupply) / reserve1)</code></p>
<p><code>totalsupply</code>：现在提供的<code>LP token</code>总量</p>
<p><code>dx/dy</code>：新增的<code>ETH/X</code>代币数量</p>
<p><code>reserve0/reserve1</code>：分别代表池子里已有的<code>ETH/X</code>数量</p>
<p>最外层的<code>min</code>函数，是因为网页中提交的表单可能跟区块中的实际数据有出入，多余的token会返回给你</p>
<p>获得<code>LP token</code>凭证后，你就可以获得池子里交易的手续费分红了</p>
<h2 id="23uniswap的实质">2.3.Uniswap的实质</h2>
<p>所以我们说Uniswap实质是什么：</p>
<p>1.兑换代币的交易所，去中心化的合约</p>
<p>2.创建池子后，向已有的池子添加流动性，兑换<code>LP token</code>后，你就是出资给别人兑换代币的人，凭比例获得池子里的交易所续费分成</p>
<p>3.其它用户在Uniswap兑换代币后，产生手续费</p>
<p>4.整个过程无订单簿，无做市商</p>
<p>5.因为可以获利，所以也就是用户愿意提供流动性的初始动力</p>
<h2 id="24无偿损失以及k值的变化">2.4.无偿损失以及K值的变化</h2>
<p>用户添加流动性获得<code>LP token</code>，然后依次获得分成，这个过程并不是没有损失的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">假如当前池子中有币对ETH/X，其中ETH数量为100，X数量为200000，那么K =  10 * 100 = 2000000，1个ETH可以兑换2000个X
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">同时假如用户是这个池子的流动性提供者，并且拥有1%的LP token，也就是拥有1%的资产1ETH/2000X，这个时候1ETH可以兑换2000X，也就是拥有的总资产为4000X
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">这个时候有人交易币对使得两种代币的比例为50ETH/400000X，那么拥有的1%资产就变为0.5ETH/4000X，这个时候1ETH可以兑换8000X，也就是拥有的总资产为8000X
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4000X到8000X一看其实我们拥有的资产还升值了，但是如果原来1ETH/2000X如果没有加到池子里，拿到现在，其总价值为10000X
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">10000X - 8000X = 2000X，这就是所谓的“无偿损失”，无偿损失并不是一种资产损失，更像是一种“机会损失”，即：假设我没做流动性，代币持有放到现在的价值变化
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">流动池里价格波动越大，无偿损失越大
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们也可以得出，<code>K</code>值的计算可以换算为：
$$
K = (X + X&rsquo;) \times (Y - Y&rsquo;)
$$
其含义为增加<code>X'</code>数量代币，就会减少<code>Y'</code>代币，注意当和池子进行交易时，还要额外支付<code>0.3%</code>手续费</p>
<p>由此可得，当我们增加<code>X'</code>数量代币时，<code>K</code>值为：
$$
K = [X + (1 - P)X&rsquo;] \times [(Y - Y&rsquo;)] = X \times Y
$$
其中<code>P</code>为手续费，当<code>P = 0.03</code>时那么此时的<code>Y'</code>：
$$
Y&rsquo; = \frac{0.997 \times X&rsquo; \times Y}{X + 0.997 \times X&rsquo;}
$$
对比没有手续费的情况：
$$
Y&rsquo; = \frac{X&rsquo; \times Y}{X + X&rsquo;}
$$
<code>Y'</code>的值是要少一些的，也就是说用相同数量的<code>X</code>币，在有手续费的情况下，所兑换出来的<code>Y</code>币数量会少一些</p>
<p>带入到<code>K = (X + X') * (Y - Y')</code>，这个时候<code>K</code>也就比没有手续费时大，所以<code>K</code>的结果不是一成不变，会略微增长</p>
<p>另外一种情况是如果随意添加代币到流动池中，代币的数量比例会改变，价格会产生较大的波动。<strong>为了保持当前的两种代币价格兑换比例不会被改变，用户需要按当前比例数量的两种代币同时注入流动池中。这样一来，乘积会被扩大</strong></p>
<h2 id="26交易路由">2.6.交易路由</h2>
<p>在Uniswap中，并不是任意两种币都有对应的流动性池。在Uniswap V1中，如果交易者想把U换成另一种代币X，但是没有直接的流动池，只有<code>ETH/USDT</code>、<code>ETH/X</code>的池子，那么交易者需先将<code>USDT</code>换成<code>ETH</code>，再使用<code>ETH</code>换成<code>X</code>。因为交易者需在每个池子中缴纳手续费，所以交易应该避免交易的路由过长</p>
<h2 id="25v1的缺陷">2.5.V1的缺陷</h2>
<p>明白了Uniswap的实质、流动性、以及如何获得手续费后，还需要说下Uniswap V1版本的缺陷：</p>
<p>1.不能直接创建两种ERC20代币的流动性池，只能创建ETH和ERC20代币的流动性池。这样两种ERC20代币就不能直接兑换，需要通过ETH转换</p>
<p>2.在实际的运行过程中，受制于以太坊吞吐量和速度的问题，Uniswap也遭遇过价格操纵的情况</p>
<p>3.因为很多空气币、山寨币的池子流动很小，所以交易兑换时滑点相当大。只要短时间有一批人涌入，很容易买飞，就造成一种价格翻了十多倍的景象</p>
<p>4.在实际的运行过程中，受制于以太坊吞吐量和速度的问题，Uniswap也遭遇过价格操纵的情况。刚开始起阶段，交易规模在整个加密世界还非常小，流动性深度不足，容易出现价格剧烈波动的情况</p>
<h1 id="3v2版本">3.V2版本</h1>
<p>2020年5月，Uniswap 推出V2版本，V2在V1的基础上增加了<strong>多代币对交易</strong>、<strong>升级了价格预言机</strong>、<strong>闪电贷</strong>功能，并且用<code>Solidity</code>重构合约，开源到了<code>Github</code>上</p>
<h2 id="31多代币交易">3.1.多代币交易</h2>
<p>Uniswap V1只有ETH和其他ERC20代币之间的交换，如果需要ERC20代币之间交换，则要以ETH作为中间代币来促进交换过程。在V2版本中，取消了这一要求，交易者可以使用ERC20和ERC20代币直接交换，不再需要ETH作为中间介质，交易次数减少，节省了gas费</p>
<h2 id="32价格预言机oracle">3.2.价格预言机(Oracle)</h2>
<p>在未引入<code>Oracle</code>之前，Uniswap链上交易时可能存在资产的偏差阈值较大，价格更新较慢等问题。Uniswap V2使用的价格预言机称为<strong>TWAP</strong>（<strong>Time-Weighted Average Price</strong>），即时间加权平均价格。<code>TWAP</code>的数据源来自于Uniswap自身的交易数据，价格的计算等操作都是在链上执行的</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://ice.frostsky.com/2024/12/21/066e813effd8ecec06bf01c06d566b5e.png"
        data-srcset="https://ice.frostsky.com/2024/12/21/066e813effd8ecec06bf01c06d566b5e.png, https://ice.frostsky.com/2024/12/21/066e813effd8ecec06bf01c06d566b5e.png 1.5x, https://ice.frostsky.com/2024/12/21/066e813effd8ecec06bf01c06d566b5e.png 2x"
        data-sizes="auto"
        alt="https://ice.frostsky.com/2024/12/21/066e813effd8ecec06bf01c06d566b5e.png"
        title="066e813effd8ecec06bf01c06d566b5e.png" /></p>
<p>由上图所知：</p>
<p><code>block 122</code>，此时的价格和时间差都为0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="n">priceCumulative</span> <span class="o">=</span> <span class="mi">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>block 123</code>，取自上个区块中最后一次交易的价格10.2，且时间差为7，所以可计算此时的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="n">priceCumulative</span> <span class="o">=</span> <span class="mi">10</span><span class="p">.</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">=</span> <span class="mi">71</span><span class="p">.</span><span class="mi">4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>block 124</code>，去上个区块中最后一笔交易10.3，且时间差为8，可计算出此时的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="n">priceCumulative</span> <span class="o">=</span> <span class="mi">71</span><span class="p">.</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">153</span><span class="p">.</span><span class="mi">8</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>block 125</code>同理可计算出此时的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">priceCumulative = 153.8 + (10.5 * 5) = 206.3
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://ice.frostsky.com/2024/12/21/10cd20b04c00286eb102d3164842622f.png"
        data-srcset="https://ice.frostsky.com/2024/12/21/10cd20b04c00286eb102d3164842622f.png, https://ice.frostsky.com/2024/12/21/10cd20b04c00286eb102d3164842622f.png 1.5x, https://ice.frostsky.com/2024/12/21/10cd20b04c00286eb102d3164842622f.png 2x"
        data-sizes="auto"
        alt="https://ice.frostsky.com/2024/12/21/10cd20b04c00286eb102d3164842622f.png"
        title="10cd20b04c00286eb102d3164842622f.png" /></p>
<p>所以<code>时间加权平均价格(TWAP)</code>，取结束与开始区块的价格之差，再取结束与开始的区块时间戳之差，两者相除就是<code>TWAP</code>价格</p>
<h2 id="33flash-swaps闪电贷">3.3.Flash Swaps(闪电贷)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">假设池子里有200个tokenA，1000tokenB，用户想要200个tokenB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">此时他可以不用预先支付40tokenA而得到B，用户可以先向合约借贷200tokenB，再去其他DeFi平台上使用200个tokenB换取60个tokenA，最后将获得的60个tokenA中40个还给流动性池中
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">这样，流动性池中的token数量不仅没有变化，用户还从中获利
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实现原理：</p>
<p>1.借贷方先向合约借贷<code>tokenB</code></p>
<p>2.借贷方指定借贷的数量，以及回调函数的参数，调用<code>flashswap</code>方法</p>
<p>3.合约会先将用户请求借贷的<code>tokenB</code>按照指定数量发给借贷方</p>
<p>4.发送完毕后，Uniswap Pair合约会向借贷方指定的合约地址 使用已经借贷的<code>tokenB</code> 去兑换<code>tokenA</code></p>
<p>5.然后将<code>tokenA</code>归还到池子中，多出来的作为盈利</p>
<p>这些操作都在一个合约中完成</p>
<h2 id="34v2的缺陷">3.4.V2的缺陷</h2>
<p>1.流动性的使用效率比较低</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">在V2中，X * Y = K，并没有特别限定X和Y的范围，那么X和Y的数量可以趋向于0或者无穷大，即说明X和Y代表的两种token的价格也可以趋向0或者无穷大
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">但实际情况是：在一定的时间里，某个代币的价格会在一个区间里波动，因此导致了LP提供的流动性中有很大一部分资金是没有利用起来的，无法为LP赚取交易费用
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.TWAP 是链上预言机，需要链下程序定时触发更新价格，存在维护成本</p>
<h1 id="4v3版本">4.V3版本</h1>
<p>2021年5月，为了解决以上问题，Uniswap又推出V3版本，V3版本提供了<strong>集中流动性</strong>、<strong>更多费率的选择</strong>、<strong>NFT作为流动性凭证</strong>等新功能，并且改进了<strong>价格预言机</strong></p>
<h2 id="41集中流动性">4.1.集中流动性</h2>
<p>由于 V2版本中LP向V2池提供流动性时，流动性会沿着价格曲线均匀分布，分散在0到无穷大之间的所有价格区间，如果大多数资产在一定的价格范围内交易，这意味着，99.5%的剩余资本几乎从未被使用，这使得资本的效率相当低下</p>
<p>以稳定币为例，在V2里 DAI/USDC 池中，绝大多数交易量都集中在0.99美元到1.01美元之间交易，那么流动池中只有0.5%左右资产被利用，剩余99.5%资产处于闲置状态</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://ice.frostsky.com/2024/12/22/4055b292a13de590298659283661938a.png"
        data-srcset="https://ice.frostsky.com/2024/12/22/4055b292a13de590298659283661938a.png, https://ice.frostsky.com/2024/12/22/4055b292a13de590298659283661938a.png 1.5x, https://ice.frostsky.com/2024/12/22/4055b292a13de590298659283661938a.png 2x"
        data-sizes="auto"
        alt="https://ice.frostsky.com/2024/12/22/4055b292a13de590298659283661938a.png"
        title="4055b292a13de590298659283661938a.png" /></p>
<p>比如现在 ETH 的价格是 1500 美金，而用户设置的价格区间为 1200～1600 美金，那么就意味着只有 ETH 的价格在这个区间内，用户提供的流动性才起作用，用户才有手续费的收益；如果 ETH 价格跑出了用户的区间（低于 1200 美金或者高于 1600 美金），用户提供的流动性就不起作用，用户便不再有手续费的收入。为了保证收益的最大化，<strong>积极仓位管理+及时的策略修正</strong>，是LP流动性提供者需要关注的</p>
<p>由于流动性集中，V3兑换的滑点远低于 V2，因此V3池中提供流动性的LP 可以收到更多的手续费奖励，这就是为什么 DeFi 的大多数人都认为新版本的 Uniswap 将吸引更多的「巨鲸」或大规模投资者的原因</p>
<p>以下是，添加流动性自定义价格区间示例：</p>
<img src="https://ice.frostsky.com/2024/12/22/d4676c2bc95b0069b2990cd8942206cd.jpeg" alt="d4676c2bc95b0069b2990cd8942206cd.jpeg" style="zoom:50%;" />
<p>上面的<code>Select Fee Tier</code>就是接下来要说的V3推出的额外的费率选择</p>
<h2 id="42费率选择">4.2.费率选择</h2>
<p>Uniswap V2中流动性提供者将赚取的标准0.3%交易手续费，V3支持不同级别的手续费率的选择，分别对应如：稳定币币对等不同类型的资金池，吸引LP做市。V3提供了3个独立的费用等级：<code>0.05%、0.3%、1%</code>。这使得流动性提供者可以根据他们愿意承担的风险来选择资金池，这对于流动性提供者可选择性更多及策略要求更高</p>
<h2 id="43nft作为lp-token凭证">4.3.NFT作为LP token凭证</h2>
<p>在V3的价格曲线上，因为每个流动性提供者的策略不同，导致每一段的分到的交易费都不一样，那么 Uniswap就没办法像 v2 一样把交易费记录到整个池子。而 NFT 描述能力强，适合于表达复杂多变的金融合同，因此，V3 的 LP token 使用 NFT 取代了原来用ERC20来表示流动性提供者的凭证。当然可不要把这个<code>NFT</code>拿去出售了，以下是添加流动性后获得的LP token凭证：</p>
<img src="https://ice.frostsky.com/2024/12/22/ac4bb3c7cc78e403b56796381dd2b18d.jpeg" alt="ac4bb3c7cc78e403b56796381dd2b18d.jpeg" style="zoom:50%;" />
<p>它看起来就像是一个反应价格曲线的图片</p>
<h2 id="44价格预言机的优化">4.4.价格预言机的优化</h2>
<p>Uniswap V3 对 TWAP 预言机进行了重大改进，使其可以在一次链上调用中计算过去约 <code>9天内</code>的任何TWAP</p>
<p>这是通过存储一个累积总和的数组来实现的，而不是只存储一个。这一系列的历史价格累积器使得创建更先进的预言机变得更加容易和便宜，包括简单移动平均线（SMA）、指数移动平均线（EMA）、异常值过滤等。</p>
<p>通过TWAP整体优化，Uniswap 交易员保持预言机更新的 Gas 成本相对于 V2 减少了约 50%，简单的交易将比V2的同等功能便宜30%左右。<code>外部智能合约</code>中计算 TWAP 的成本也大大降低</p>
<h2 id="45v3版本集中流动性的使用场景">4.5.V3版本集中流动性的使用场景</h2>
<p>V3提供的这个特性首先可以让用户确定他们的资产将在哪个价格区间内集中进行兑换交易，以此尽可能多的获取手续费，还有一个用途就是拿来<code>抄底、止盈</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">假设当前 ETH 的价格是 1500 美金，选择 ETH/USDC 交易对添加流动性
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">可以设置1000～1400 美金的价格区间，这个时候只需要注入USDC，然后在ETH下跌过程中，系统就会自动买入ETH，并且还能享受手续费收入，实现了抄底
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">若是设置一个 1800～2000 美金的价格区间，这个时候只需要注入ETH，然后在ETH上涨过程中，系统就会自动卖出ETH，并且还能享受手续费收入，实现了止盈
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="46v3的缺陷">4.6.V3的缺陷</h2>
<p>1.流动性聚集价格区间外，资金少滑点大，易被大资金套利</p>
<p>当大量流动性聚集在理论上合理的价格区间内时，这也意味着该区间之外的流动性深度将相对降低，大资金或可利用这一机制在价格接近区间边缘时“推一把”，触发短暂的流动性坍塌，在 Uniswap 池子里面的滑点就会非常高，扰乱预言机报价情况，进而实现套利</p>
<p>2.流动性聚集区间外，资产被置换为低价值的一端，容易造成亏损</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">当价格超过了流动性聚集区间后，Uniswap v3 会把用户的 LP 全部置换为流动性池的币对中低价值的一端
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">什么是低价值？在AMM的这个公式里面 X * Y = K 的这个公式里面，相对于数量更多的代币，它的价值就是更低的
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">举个例子：我的资金池是 ETH- DAI 的币对，那么 ETH 价格要增长，也就是不断的有 DAI 进池子里，ETH 就会出去。这时 ETH 相对于 DAI 的相对数量就会减少，那么表示它的价格在增加。在这种情况下，低价值的一端就是 DAI。相反，ETH 价格要跌，也就是不断的有用户抛 ETH 进池子，将 DAI 兑换走。那么这个时候 ETH 数量相对 DAI 来说，ETH 就是多的，也就是相对数量多，它的价格就会降低
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">实际上当 ETH 价格过高了以后，其实我们希望保有的应该是 ETH，但是根据 Uniswap V3 的设置，所有资产就会被换成 DAI，实际上就是它帮你止盈了
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">但是，当 ETH 价格往下跌的时候，Uniswap却并不会帮你止损。因为它会保留低价值的一端，因此所有资产被换成的是 ETH，导致浮动亏损
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.合约复杂度变高，手续费、收益计算复杂，不易理解</p>
<h1 id="5uniswap产品展望">5.Uniswap产品展望</h1>
<p>Uniswap从V1~V3，一直在优化的一件事就是<strong>为资金带来更大收益，提高交易的效率</strong>，这也是它的核心开发方向</p>
<p>Uniswap V3 给我们引入了一个可玩性更强的，一个 AMM 流动池的一个设计方式。由于它的这个流动性的拆分与聚合的设置，让玩法显得更加全面，也带了更复杂的计算方式。尤其是跟这个预言机结合的时候，就可能有很多策略在里面：根据不同的价格增加、减少哪一段的流动性。也许还会带动第三方的服务商发展，去实现定制化的一些策略</p>
<p>Uniswap作为目前最大的<code>DeFi</code>应用，相信未来它还会带来更新颖的功能</p>
<h1 id="6参考链接">6.参考链接</h1>
<p>1.<a href="https://mirror.xyz/web3rain.eth/cdflEAvm35H779nsvgHsGyjLAeu5uX9YDoKHMlLodW8" target="_blank" rel="noopener noreffer">Defi产品笔记-Dex项目Uniswap分析</a></p>
<p>2.<a href="https://medium.com/@frank.wang0131/%E7%99%BD%E8%AF%9D%E8%A7%A3%E8%AF%BBuniswap-lp%E7%9A%84%E9%A3%8E%E9%99%A9%E4%B8%8E%E6%94%B6%E7%9B%8A-024ce112f567" target="_blank" rel="noopener noreffer">白话解读Uniswap LP的风险与收益</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-03-02</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/" data-title="Uniswap介绍"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/" data-title="Uniswap介绍"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/" data-title="Uniswap介绍"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://baskep.top/uniswap%E4%BB%8B%E7%BB%8D/" data-title="Uniswap介绍"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/nft%E5%B8%82%E5%9C%BA%E7%9A%84%E6%A6%82%E5%86%B5/" class="prev" rel="prev" title="NFT市场的概况"><i class="fas fa-angle-left fa-fw"></i>NFT市场的概况</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">早起的老年人</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10000},"comment":{},"data":{"id-1":"今天就到这里，回去等通知吧","id-2":"今天就到这里，回去等通知吧"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
