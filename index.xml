<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>ğŸ‘¨ğŸ»â€ğŸ’» on ğŸ‘¨ğŸ»â€ğŸ’»</title>
    <link>https://xtid.github.io/</link>
    <description>Recent content in ğŸ‘¨ğŸ»â€ğŸ’» on ğŸ‘¨ğŸ»â€ğŸ’»</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <lastBuildDate>Sat, 28 Nov 2020 16:23:05 +0800</lastBuildDate>
    <atom:link href="/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Flutterè‡ªå®šä¹‰ç»„ä»¶</title>
      <link>https://xtid.github.io/2020/flutter%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6/</link>
      <pubDate>Sat, 28 Nov 2020 16:23:05 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/flutter%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6/</guid>
      <description>

&lt;h3 id=&#34;ç®€è¨€&#34;&gt;ç®€è¨€&lt;/h3&gt;

&lt;p&gt;åœ¨ä½¿ç”¨&lt;code&gt;Flutter&lt;/code&gt;å¼€å‘appçš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨å„ç§å„æ ·çš„&lt;code&gt;Widget&lt;/code&gt; ç»„åˆç»˜åˆ¶å‡ºçš„é¡µé¢ï¼Œä¸€äº›æœ€åŸºç¡€çš„å¦‚&lt;code&gt;Container&lt;/code&gt;ã€&lt;code&gt;Padding&lt;/code&gt;ã€&lt;code&gt;Text&lt;/code&gt; ç­‰ç­‰ï¼Œç”±å®˜æ–¹å°è£…å¥½çš„æ¯”è¾ƒå¤æ‚çš„ç»„ä»¶å¦‚&lt;code&gt;AppBar&lt;/code&gt;ã€&lt;code&gt;æ—¥å†é€‰æ‹©å™¨&lt;/code&gt;ç­‰ç­‰ã€‚ä»…ä»…ä½¿ç”¨è¿™äº›ç»„ä»¶ä¹Ÿç¡®å®èƒ½å†™å‡ºä¸€äº›appï¼Œä½†æ˜¯å®˜æ–¹å°è£…å¥½çš„æ‹“å±•æ€§æˆ‘è§‰å¾—ä¸å¤ªå¥½ï¼Œæœ‰äº›å±æ€§æ ¹æœ¬æ— æ³•æ”¹å˜ï¼›å¦å¤–ä¸€æ—¦å’Œè®¾è®¡ç¨¿å‡ºå…¥æ¯”è¾ƒå¤§ï¼Œé‚£æ ¹ä¸å°±ç©ä¸äº†äº†ï¼Œæ‰€ä»¥è¿™å°±æ¶‰åŠåˆ°è‡ªå®šä¹‰ç»„ä»¶ã€‚&lt;code&gt;Flutter&lt;/code&gt;è‡ªå®šä¹‰ç»„ä»¶çš„æ–¹å¼æˆ‘äº†è§£åˆ°æœ‰ä¸‰ç§ï¼Œä¸€æ˜¯é€šè¿‡ç»„åˆå…¶å®ƒç»„ä»¶æ¥è¾¾åˆ°ä½ æƒ³è¦çš„æ•ˆæœï¼›äºŒæ˜¯è‡ªç»˜ï¼Œè¿™å—ç‰µæ‰¯åˆ°&lt;code&gt;Canvas&lt;/code&gt;ï¼›ä¸‰æ˜¯å®ç°&lt;code&gt;RenderObject&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-åŸç†åŸºæœ¬ä»‹ç»&#34;&gt;1.åŸç†åŸºæœ¬ä»‹ç»&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;Flutter&lt;/code&gt;å¼•æ“ä¼šå°†æˆ‘ä»¬æ‰€å†™ç»„ä»¶ç”Ÿæˆä¸€ä¸ª&lt;code&gt;Widget Tree&lt;/code&gt;ï¼Œè€Œå®é™…æ¸²æŸ“å‡ºæ¥çš„ç»“æœåˆæœ‰ä¸€ä¸ª&lt;code&gt;RenderObject Tree&lt;/code&gt;ï¼Œ&lt;code&gt;RenderObject&lt;/code&gt;æ˜¯ç»§æ‰¿&lt;code&gt;Widget&lt;/code&gt;çš„ã€‚åœ¨é¡¹ç›®è¿è¡Œä¸­`&lt;code&gt;Widget Tree&lt;/code&gt;æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œå¦‚æœæ¯æ¬¡å˜åŒ–éƒ½è¦å¯¼è‡´æ•´ä¸ª&lt;code&gt;RenderObject Tree&lt;/code&gt;å˜åŒ–ï¼Œè¿™å¯¹æ€§èƒ½æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ¶ˆè€—ï¼Œäºæ˜¯å°±æœ‰äº†ä¸€ä¸ª&lt;code&gt;Element Trre&lt;/code&gt;ï¼Œè¿™å°±ç›¸å½“äºä¸€ä¸ªä¸­é—´å±‚ï¼Œç”±&lt;code&gt;Widget&lt;/code&gt;â†’&lt;code&gt;Elment&lt;/code&gt;â†’&lt;code&gt;RenderObject&lt;/code&gt;ã€‚æ¯æ¬¡&lt;code&gt;Widget&lt;/code&gt;å˜åŒ–æ—¶ï¼Œä¸&lt;code&gt;Element&lt;/code&gt;åšå¯¹æ¯”ï¼Œæ‰¾å‡ºæœ€å°æœ€ä¼˜çš„å˜åŒ–ï¼Œä½œç”¨äº&lt;code&gt;RenderObject&lt;/code&gt;ã€‚æˆ‘ä»¬åˆ›å»ºçš„&lt;code&gt;Widget&lt;/code&gt;åŸºæœ¬ç»§æ‰¿äº&lt;code&gt;StatelessWidget&lt;/code&gt;ã€&lt;code&gt;StatefulWidget&lt;/code&gt;ï¼Œä»–ä»¬ä»…è´Ÿè´£å±æ€§ã€ç”Ÿå‘½å‘¨æœŸç­‰çš„ç®¡ç†ï¼Œæœ€ç»ˆä¹Ÿè¿˜æ˜¯ä¼šç»§æ‰¿äº&lt;code&gt;RenderObjectWidget&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;RenderObjectWidget&lt;/code&gt;ä¸‹é¢åˆæœ‰ä¸‰ä¸ªå­ç±»&lt;/p&gt;

&lt;p&gt;&lt;code&gt;SngleChildRenderObjectWidget&lt;/code&gt;ï¼š&lt;code&gt;RenderObject&lt;/code&gt;åªæœ‰ä¸€ä¸ª &lt;code&gt;child&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;MultiChildRenderObjectWidget&lt;/code&gt;ï¼šå¯ä»¥æœ‰å¤šä¸ª &lt;code&gt;child&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;LeafRenderObjectWidget&lt;/code&gt; ï¼š&lt;code&gt;RenderObject&lt;/code&gt;æ˜¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œæ²¡æœ‰&lt;code&gt;child&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;å®˜æ–¹æ‰€æä¾›çš„ç»„ä»¶å¾ˆå¤šéƒ½æ˜¯ç»§æ‰¿&lt;code&gt;singleChildRenderObjectWidget&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸åªèƒ½ä¼ ä¸€ä¸ª&lt;code&gt;child&lt;/code&gt;ï¼Œæ‰¾åˆ°&lt;code&gt;singleChildRenderObjectWidget&lt;/code&gt;å®šä¹‰&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-dart&#34;&gt;abstract class SingleChildRenderObjectWidget extends RenderObjectWidget {
  const SingleChildRenderObjectWidget({ Key key, this.child }) : super(key: key);
  final Widget child;

  @override
  SingleChildRenderObjectElement createElement() =&amp;gt; SingleChildRenderObjectElement(this);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°æ¯æ¬¡åˆ›å»ºä¸€ä¸ª&lt;code&gt;SingleChildRenderObjectWidget&lt;/code&gt;å°±ä¼šè°ƒç”¨`&lt;code&gt;CreateElement&lt;/code&gt;ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„&lt;code&gt;Elment&lt;/code&gt;ï¼Œå½“ç„¶&lt;code&gt;MultiChildRenderObjectWidget&lt;/code&gt;ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œè¿™ä¹Ÿå°±è¯´æ˜äº†ä»–ä»¬ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚æ‰€ä»¥æˆ‘ä»¬å®ç°è‡ªå®šä¹‰ç»„ä»¶å¿…é¡»å¾—ç»§æ‰¿&lt;code&gt;SingleChildRenderObjectWidget&lt;/code&gt;æˆ–è€…&lt;code&gt;MultiChildRenderObjectWidget&lt;/code&gt;æˆ–è€…è°ƒç”¨å®˜æ–¹å®ç°å¥½çš„è‡ªç»˜ç±»ï¼Œè¿™ä¹Ÿæ˜¯&lt;code&gt;Flutter&lt;/code&gt;å¼•æ“æ¸²æŸ“çš„åŸºæœ¬ç»“æ„ã€‚&lt;/p&gt;

&lt;h4 id=&#34;2-ç»„åˆå…¶å®ƒç»„ä»¶&#34;&gt;2..ç»„åˆå…¶å®ƒç»„ä»¶&lt;/h4&gt;

&lt;p&gt;è¿™ç§æ–¹å¼æ˜¯æœ€åŸºæœ¬æœ€ç®€å•çš„æ–¹å¼ï¼Œè¯´ç™½äº†å°±æ˜¯å°†ä¸€äº›åŸæœ‰çš„ã€å°è£…å¥½çš„ç»„ä»¶åˆå¹¶å†å°è£…ä¸€æ¬¡ã€‚&lt;code&gt;Flutter&lt;/code&gt;æœ¬èº«å°±æœ‰å¾ˆå¤šç»„åˆç»„ä»¶ï¼Œæ¯”å¦‚å¸¸ç”¨çš„&lt;code&gt;Container&lt;/code&gt;ï¼ŒæŸ¥çœ‹å®ƒçš„æºç å°±çŸ¥é“ï¼Œå®ƒæ˜¯ç”±&lt;code&gt;DecoratedBox&lt;/code&gt;ã€&lt;code&gt;ConstrainedBox&lt;/code&gt;ã€&lt;code&gt;Transform&lt;/code&gt;ã€&lt;code&gt;Padding&lt;/code&gt;ã€&lt;code&gt;Align&lt;/code&gt;ç­‰ç»„ä»¶ç»„æˆï¼Œå…¶å†…éƒ¨åšäº†å¾ˆå¤šåˆ¤æ–­å¤„ç†ã€‚è¿™é‡Œå®ç°ä¸€ä¸ªè‡ªå®šä¹‰å®½åº¦çš„&lt;code&gt;drawer&lt;/code&gt;ç»„ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç±»&lt;code&gt;SmartDrawer&lt;/code&gt;ç»§æ‰¿&lt;code&gt;StatelessWidget&lt;/code&gt;ï¼Œå¹¶å®ç°å…¶å…·ä½“æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-dart&#34;&gt;class SmartDrawer extends StatelessWidget {
  final double elevation;
  final Widget child;
  final String semanticLabel;
  final double widthPercent;
  const SmartDrawer({
    Key key,
    this.elevation = 16.0,
    this.child,
    this.semanticLabel,
    this.widthPercent = 0.7,
  }) : 
   assert(widthPercent != null &amp;amp;&amp;amp; widthPercent &amp;lt; 1.0 &amp;amp;&amp;amp; widthPercent&amp;gt; 0.0)
   ,super(key: key);

  @override
  Widget build(BuildContext context) {
    assert(debugCheckHasMaterialLocalizations(context));
    String label = semanticLabel;
    final double _width = MediaQuery.of(context).size.width * widthPercent;
    
    return Semantics(
      scopesRoute: true,
      namesRoute: true,
      explicitChildNodes: true,
      label: label,
      child: ConstrainedBox(
        constraints: BoxConstraints.expand(width: _width),
        child: Material(
          elevation: elevation,
          child: child,
        ),
      ),
    );
  }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°ç»„ä»¶å°±æ˜¯å°†&lt;code&gt;ConstrainedBox&lt;/code&gt;ä»¥åŠä¼ å…¥çš„&lt;code&gt;child&lt;/code&gt;ç»„åˆæˆä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œå…¶ä»–å±æ€§åˆ™æ˜¯æ¥æ§åˆ¶æ ·å¼çš„ã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜çš„ï¼Œæœ€åè¿”å›çš„&lt;code&gt;Semantics&lt;/code&gt;ï¼Œå®ƒç»§æ‰¿&lt;code&gt;SingleChildRenderObjectWidget&lt;/code&gt;ï¼Œå®ƒä¸Šé¢å®šä¹‰çš„å±æ€§æœ‰ç‚¹å¸¦æœ‰è¯­ä¹‰åŒ–çš„æ„æ€ï¼Œè€Œå®ƒä¸Šé¢å®šä¹‰çš„&lt;code&gt;child&lt;/code&gt;å±æ€§åˆ™æ˜¯è¿”å›çš„ç»„ä»¶ï¼Œè¿™æ ·&lt;code&gt;return Semantices{}&lt;/code&gt;å®é™…å°±è¡¨ç¤ºè¿”å›äº†å¸¦æœ‰ä¸€äº›è¯­ä¹‰çš„ç»„ä»¶ã€‚&lt;/p&gt;

&lt;h4 id=&#34;4-è‡ªç»˜ç»„ä»¶&#34;&gt;4.è‡ªç»˜ç»„ä»¶&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;Flutter&lt;/code&gt;è·¨å¹³å°çš„å®ç°æ–¹å¼å°±æ˜¯åœ¨ä¸åŒæ“ä½œç³»ç»Ÿçš„ä¸Šå±‚ç»˜åˆ¶ä¸€ä¸ªä¸­é—´çš„UIç³»ç»Ÿï¼Œå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿçš„&lt;code&gt;API&lt;/code&gt;è¿›è¡Œé€‚é…ï¼Œé£æ ¼ç»Ÿä¸€ï¼Œè¿™æ ·å°±èƒ½å®ç°ä¸€ä¸ªè·¨å¹³å°åº”ç”¨äº†ï¼Œè¿™ä¹Ÿæ˜¯å’Œ&lt;code&gt;React Native&lt;/code&gt;çš„æœ€å¤§çš„å·®å¼‚ä»¥åŠä¼˜äº&lt;code&gt;React Native&lt;/code&gt;çš„åœ°æ–¹ã€‚å½“ä½ æ— æ³•ç”¨ç°æœ‰çš„ç»„ä»¶æ¥æç»˜ä½ æ‰€éœ€è¦UIæ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è‡ªç»˜ç»„ä»¶æ¥å®ç°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªç»˜çš„éªŒè¯ç ç»„ä»¶ç¤ºä¾‹&lt;/p&gt;

&lt;p&gt;é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º&lt;code&gt;CodeReview&lt;/code&gt;çš„&lt;code&gt;StatefulWidget&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-dart&#34;&gt;class CodeReview extends StatefulWidget {

  final String text;
  final callback;

  CodeReview({Key key, this.text, this.callback}) : super(key: key);

  _CodeReviewState createState() =&amp;gt; _CodeReviewState();

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå®ç°å…·ä½“ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-dart&#34;&gt;class _CodeReviewState extends State&amp;lt;CodeReview&amp;gt; {
	
  // å­˜æ”¾æ¯ä¸ªéªŒè¯ç å­—ç¬¦ä¸Šçš„æ¨ªçº¿çš„ä½ç½®
  List&amp;lt;Offset&amp;gt; _lineOffsets = &amp;lt;Offset&amp;gt;[];

  // éªŒè¯ç çš„é•¿åº¦ï¼Œç”±å¤–éƒ¨ä¼ å…¥
  int _textLength;
  // éªŒè¯ç å®½åº¦
  double _width;
  // éªŒè¯ç é«˜åº¦
  double _height;

  // ç”ŸæˆéªŒè¯ç ä¸Šçš„æ¨ªçº¿é®æŒ¡ç‰©çš„ä½ç½®
  void _randLines() {
    _lineOffsets.clear();
    for (var i = 0; i &amp;lt; _textLength; i++) {
      double fromX = randomBetween(10, 20).toDouble();
      double fromY = randomBetween(3, 33).toDouble();
      Offset from = Offset(fromX, fromY);
      _lineOffsets.add(from);

      double endX = randomBetween(60, _width.toInt() - 10).toDouble();
      double endY = randomBetween(3, 33).toDouble();
      Offset end = Offset(endX, endY);
      _lineOffsets.add(end);
    }
  }

  @override
  void initState() {
    super.initState();
    _textLength = widget.text.length ?? 4;
    _width = _textLength.toDouble() * 22;
    _height = 36;
    _randLines();
  }

  void _changeCode() {
    setState(() {
      _randLines();
    });
  }
	
  // å¯¹æ¯ä¸ªå­—ç¬¦è¿›è¡Œéšæœºrotateæ“ä½œ
  Container _subString(index) {
    return Container(
      padding: EdgeInsets.only(left: 2, right: 2, top: randomBetween(0, 14).toDouble()),
      child: Transform.rotate(
        angle: pi / randomBetween(3, 30) * randomBetween(0, 1),
        child: Text(widget.text[index], style: TextStyle(fontSize: randomBetween(20, 22).toDouble(), color: Color(0xFF4abdcc))),
      ),
    );
  }
	
 	// æç»˜éªŒè¯ç ä¸Šæ¨ªçº¿é®æŒ¡ç‰©
  Container _backLines() {
    return Container(
      width: _width,
      height: _height,
      child: CustomPaint(
        painter: CodePaint(_lineOffsets, Tool.randomColor()),
        foregroundPainter: CodePaint(_lineOffsets, Tool.randomColor()),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      width: _width,
      height: _height,
      color: Colors.grey[200],
      child: Stack(
        alignment: Alignment.center,
        children: &amp;lt;Widget&amp;gt;[
          _backLines(),
          _backLines(),
          GestureDetector(
            behavior: HitTestBehavior.opaque,
            onTap: () {
              _changeCode();
              widget.callback();
            },
            child: Container(
              width: _width,
              height: _height,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: List.generate(_textLength, (int index) {
                  return _subString(index);
                }),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ä¸Šé¢ç”¨åˆ°äº†&lt;code&gt;CustomPaint&lt;/code&gt;ï¼Œè¿™ä¸ªç±»ç»§æ‰¿&lt;code&gt;SingleChildRenderObjectWidget&lt;/code&gt;ï¼Œè¿™è®©æˆ‘ä»¬ç›´æ¥èƒ½ä½¿ç”¨&lt;code&gt;Canvas&lt;/code&gt;æ¥ç»˜åˆ¶ä½ æ‰€éœ€è¦çš„UI&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-dart&#34;&gt;class CustomPaint extends SingleChildRenderObjectWidget {
  /// Creates a widget that delegates its painting.
  const CustomPaint({
    Key key,
    this.painter,
    this.foregroundPainter,
    this.size = Size.zero,
    this.isComplex = false,
    this.willChange = false,
    Widget child,
  })......
    ......
    ......
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¼ å…¥&lt;code&gt;painter&lt;/code&gt; ã€&lt;code&gt;foregroundPainter&lt;/code&gt;å¯¹åº”ç±»ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªç±»çš„&lt;code&gt;CodePaint&lt;/code&gt;ç»§æ‰¿&lt;code&gt;CustomPainer&lt;/code&gt;ï¼Œé‡å†™&lt;code&gt;paint&lt;/code&gt;æ–¹æ³•ï¼Œç„¶åè®¾ç½®ç”»ç¬”çš„å±æ€§ï¼Œæœ€åè°ƒç”¨å¯¹åº”çš„&lt;code&gt;Canvas&lt;/code&gt;apiå³å¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯&lt;code&gt;drawPoints&lt;/code&gt;ï¼Œè¿˜æœ‰å…¶ä»–çš„ï¼Œå¦‚&lt;code&gt;drawCircle&lt;/code&gt;ã€&lt;code&gt;drawLine&lt;/code&gt;ç­‰ç­‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-dart&#34;&gt;class CodePaint extends CustomPainter {
  final List&amp;lt;Offset&amp;gt; lineOffsets;
  final Color ranColor;
  CodePaint(this.lineOffsets, this.ranColor);

  @override
  void paint(Canvas canvas, Size size) {
    // debugPrint(canvas.runtimeType.toString());
    canvas.save();
    Paint _paint = Paint()
      ..color = ranColor // ç”»ç¬”é¢œè‰²
      ..strokeCap = StrokeCap.round // ç”»ç¬”ç¬”è§¦ç±»å‹
      ..isAntiAlias = true // æ˜¯å¦å¯åŠ¨æŠ—é”¯é½¿
      ..blendMode = BlendMode.exclusion // é¢œè‰²æ··åˆæ¨¡å¼
      ..style = PaintingStyle.fill // ç»˜ç”»é£æ ¼ï¼Œé»˜è®¤ä¸ºå¡«å……
      ..colorFilter = ColorFilter.mode(ranColor, BlendMode.exclusion) // é¢œè‰²æ¸²æŸ“æ¨¡å¼ï¼Œä¸€èˆ¬æ˜¯çŸ©é˜µæ•ˆæœæ¥æ”¹å˜çš„,ä½†æ˜¯flutterä¸­åªèƒ½ä½¿ç”¨é¢œè‰²æ··åˆæ¨¡å¼
      ..maskFilter = MaskFilter.blur(BlurStyle.inner, 1.0) // æ¨¡ç³Šé®ç½©æ•ˆæœ
      ..filterQuality = FilterQuality.high // é¢œè‰²æ¸²æŸ“æ¨¡å¼çš„è´¨é‡
      // ..strokeWidth = randomBetween(1, 3).toDouble(); // æš‚æ—¶å›ºå®š
      ..strokeWidth = 1;

    final pointMode = PointMode.lines;
    canvas.drawPoints(pointMode, lineOffsets, _paint);
    canvas.restore();
  }

  @override
  bool shouldRepaint(CustomPainter oldDelegate) {
    return false;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»¼ä¸Šï¼Œè‡ªç»˜é€æ¸çš„æ ¸å¿ƒæ˜¯ç»§æ‰¿&lt;code&gt;CustomPaint&lt;/code&gt;ï¼Œç„¶åä½¿ç”¨&lt;code&gt;Canvas&lt;/code&gt;å®ç°UIçš„ç»˜åˆ¶&lt;/p&gt;

&lt;h4 id=&#34;5-å®ç°renderobject&#34;&gt;5.å®ç°RenderObject&lt;/h4&gt;

&lt;p&gt;å®ç°&lt;code&gt;RenderObject&lt;/code&gt;å³æ˜¯è‡ªå·±é‡å†™ä¸€æ•´å¥—æ¸²æŸ“æ ‘ï¼Œé¦–å…ˆå¾—ç»§æ‰¿ä¸€ä¸ª&lt;code&gt;RenderObject&lt;/code&gt;ï¼Œå®ç°å…¶å†…ç½®ä»¿ä½›ï¼Œè¿˜å¾—ç»§æ‰¿&lt;code&gt;Element&lt;/code&gt;ï¼Œå®ç°å…¶å†…ç½®æ–¹æ³•ï¼Œå¤æ‚çš„è‡ªå®šä¹‰ç»„ä»¶æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡&lt;code&gt;Canvas&lt;/code&gt; APIæ¥ç»˜åˆ¶çš„ï¼Œè€Œä¸Šé¢è¯´çš„&lt;code&gt;CustomPaint&lt;/code&gt;åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…å°è£…çš„ä¸€ä¸ªä»£ç†ç±»ï¼Œå®ƒç›´æ¥ç»§æ‰¿è‡ª&lt;code&gt;SingleChildRenderObjectWidget&lt;/code&gt;ï¼Œé€šè¿‡&lt;code&gt;RenderCustomPaint&lt;/code&gt;çš„&lt;code&gt;paint&lt;/code&gt;æ–¹æ³•å°†&lt;code&gt;Canvas&lt;/code&gt;å’Œç”»ç¬”&lt;code&gt;Painter&lt;/code&gt;è¿æ¥èµ·æ¥å®ç°è‡ªç»˜ç»„ä»¶ã€‚è¿™ç§æ–¹å¼æ“ä½œèµ·æ¥å®åœ¨æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä¹Ÿæ²¡æ€ä¹ˆç”¨è¿‡ï¼Œæ‰€ä»¥å°±ä¸æä¾›ç¤ºä¾‹å±•ç¤ºäº†ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>è¾“å…¥ä¸€ä¸ªURLåˆ°é¡µé¢å‘ˆç°çš„è¿‡ç¨‹</title>
      <link>https://xtid.github.io/2020/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAurl%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%91%88%E7%8E%B0%E7%9A%84%E8%BF%87%E7%A8%8B/</link>
      <pubDate>Sun, 15 Nov 2020 15:21:34 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAurl%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%91%88%E7%8E%B0%E7%9A%84%E8%BF%87%E7%A8%8B/</guid>
      <description>

&lt;h4 id=&#34;1-dnsè§£æ&#34;&gt;1.DNSè§£æ&lt;/h4&gt;

&lt;p&gt;å¹³æ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥çš„åŸŸåå¹¶éæ˜¯ç½‘å€æˆ–èµ„æºçœŸå®æ‰€åœ¨çš„æœåŠ¡å™¨åœ°å€æˆ–èµ„æºï¼ŒåŸŸååªæ˜¯ä¸&lt;code&gt;ip&lt;/code&gt;åœ°å€çš„ä¸€ä¸ªæ˜ å°„ã€‚åœ¨è¿›è¡Œæ­£å¼çš„è¯·æ±‚ä¹‹å‰ï¼Œå°±ä¼šå…ˆæœ‰è¿™ä¸ªè¿‡ç¨‹ï¼š&lt;code&gt;DNS&lt;/code&gt;æœåŠ¡å°†åŸŸåè§£ææˆå¯¹åº”çš„&lt;code&gt;ip&lt;/code&gt;åœ°å€ã€‚å…¶è§£æè¿‡ç¨‹ï¼š&lt;/p&gt;

&lt;p&gt;1.æ£€æŸ¥æœ¬æœº&lt;code&gt;host&lt;/code&gt;ä¸­æ˜¯å¦æœ‰é…ç½®ç›¸åº”çš„&lt;code&gt;ip&lt;/code&gt;æ˜ å°„å…³ç³»ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨è¿™ä¸ª&lt;code&gt;ip&lt;/code&gt;åœ°å€ï¼Œå®ŒæˆåŸŸåè§£æ
2.æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜ä¸­æ˜¯å¦ç¼“å­˜è¿‡è¯¥åŸŸåå¯¹åº”çš„&lt;code&gt;ip&lt;/code&gt;åœ°å€
3.æ£€æŸ¥æ‰¾æœ¬æœºç³»ç»Ÿä¸­æ˜¯å¦ç¼“å­˜è¿‡&lt;code&gt;ip&lt;/code&gt;
4.å‘æœ¬åœ°åŸŸåè§£ææœåŠ¡å‘èµ·åŸŸåè§£æçš„è¯·æ±‚
5.å‘æ ¹åŸŸåè§£ææœåŠ¡å™¨å‘èµ·åŸŸåè§£æè¯·æ±‚
6.æŒ‰ç…§æ ¹åŸŸå&lt;code&gt;(.)&lt;/code&gt; -&amp;gt; é¡¶çº§åŸŸ&lt;code&gt;(å¦‚ï¼š.com)&lt;/code&gt; -&amp;gt; ç¬¬äºŒå±‚åŸŸ&lt;code&gt;(å¦‚ï¼šxxx.com)&lt;/code&gt; -&amp;gt; å­åŸŸ&lt;code&gt;(å¦‚ï¼šwww.xxx.com)&lt;/code&gt;çš„é¡ºåºæŸ¥æ‰¾åˆ°ipåœ°å€
8.è¿”å›è§£æç»“æœç»™ç”¨æˆ·&lt;/p&gt;

&lt;h4 id=&#34;2-å»ºç«‹-tcp-è¿æ¥&#34;&gt;2.å»ºç«‹&lt;code&gt;TCP&lt;/code&gt;è¿æ¥&lt;/h4&gt;

&lt;p&gt;ç»å…¸çš„ä¸‰æ¬¡æ¡æ‰‹&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼š å»ºç«‹è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€synåŒ…ï¼ˆsyn=jï¼‰åˆ°æœåŠ¡å™¨ï¼Œå¹¶è¿›å…¥SYN_SENTçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ï¼›&lt;/p&gt;

&lt;p&gt;ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼š æœåŠ¡å™¨æ”¶åˆ°synåŒ…ï¼Œå¿…é¡»ç¡®è®¤å®¢æˆ·çš„SYNï¼ˆack=j+1ï¼‰ï¼ŒåŒæ—¶è‡ªå·±ä¹Ÿå‘é€ä¸€ä¸ªSYNåŒ…ï¼ˆsyn=kï¼‰ï¼Œå³SYN+ACKåŒ…ï¼Œæ­¤æ—¶æœåŠ¡å™¨è¿›å…¥SYN_RECVçŠ¶æ€ï¼›&lt;/p&gt;

&lt;p&gt;ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼š å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„SYN+ACKåŒ…ï¼Œå‘æœåŠ¡å™¨å‘é€ç¡®è®¤åŒ…ACK(ack=k+1ï¼‰ï¼Œæ­¤åŒ…å‘é€å®Œæ¯•ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿›å…¥ESTABLISHEDï¼ˆTCPè¿æ¥æˆåŠŸï¼‰çŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç®€å•æ¥è¯´å…¶æ­¥éª¤å°±æ˜¯ï¼Œå®¢æˆ·ç«¯å‘é€æ•°æ®åŒ…å‘Šè¯‰æœåŠ¡ç«¯è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¿”å›æ•°æ®åŒ…å“åº”è¡¨ç¤ºå¯ä»¥æ”¶åˆ°å»ºç«‹è¿æ¥è¯·æ±‚å¹¶ä¸”è¿”å›æ•°æ®åŒ…é€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æœç«¯å†æ¬¡å‘é€æ•°æ®åŒ…ç¡®è®¤å¹¶å»ºç«‹&lt;code&gt;TCP&lt;/code&gt;è¿æ¥&lt;/p&gt;

&lt;h4 id=&#34;3-å‘é€-http-è¯·æ±‚&#34;&gt;3.å‘é€&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚&lt;/h4&gt;

&lt;p&gt;ä¸€ä¸ª&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚åŒ…å«è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä¸»ä½“&lt;/p&gt;

&lt;h5 id=&#34;3-1è¯·æ±‚è¡Œ&#34;&gt;3.1è¯·æ±‚è¡Œ&lt;/h5&gt;

&lt;p&gt;å¸¸è§çš„ä¿¡æ¯æœ‰è¯·æ±‚åœ°å€ã€è¯·æ±‚æ–¹æ³•&lt;code&gt;GETã€POSTã€PUTã€DELETEã€PATCHã€HEADã€OPTIONSã€TRACE&lt;/code&gt;ã€&lt;code&gt;Http&lt;/code&gt;åè®®ä¿¡æ¯&lt;/p&gt;

&lt;h5 id=&#34;3-2è¯·æ±‚å¤´&#34;&gt;3.2è¯·æ±‚å¤´&lt;/h5&gt;

&lt;p&gt;å¸¸è§çš„è¯·æ±‚å¤´ä¿¡æ¯æœ‰&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Host&lt;/code&gt;ï¼šä¸»æœºå
&lt;code&gt;Connection&lt;/code&gt;ï¼š&lt;code&gt;HTTP/1.1&lt;/code&gt;å¢åŠ çš„ï¼Œä½¿ç”¨&lt;code&gt;keepalive&lt;/code&gt;ï¼Œä¸€ä¸ªè¿æ¥å¯ä»¥å‘å¤šä¸ªè¯·æ±‚
&lt;code&gt;User-Agent&lt;/code&gt;ï¼šå®¢æˆ·ç«¯ç¨‹åºçš„ä¿¡æ¯ï¼Œå°±æ˜¯å‘é€è¯·æ±‚çš„æµè§ˆå™¨ä¿¡æ¯ï¼Œå¯æ ¹æ®è¿™ä¸ªä¿¡æ¯æ¥å¯¹ä¸åŒè®¾å¤‡è¿›è¡Œå¤„ç†
&lt;code&gt;Accept&lt;/code&gt;ï¼šæµè§ˆå™¨å¯ä»¥æ¥æ”¶çš„åª’ä½“æ•°æ®ç±»å‹
&lt;code&gt;Accept-Encoding&lt;/code&gt;ï¼šæ˜¯æµè§ˆå™¨ç”¨æ¥å‘ŠçŸ¥æœåŠ¡å™¨å®ƒèƒ½å¤Ÿæ”¯æŒçš„å†…å®¹ç¼–ç åŠå†…å®¹ç¼–ç çš„ä¼˜å…ˆçº§é¡ºåºï¼Œå¯ä¸€æ¬¡æ€§æŒ‡å®šå¤šç§å†…å®¹ç¼–ç 
&lt;code&gt;Accept-Language&lt;/code&gt;ï¼šå‘Šè¯‰æœåŠ¡å™¨æµè§ˆå™¨èƒ½å¤Ÿå¤„ç†çš„è‡ªç„¶è¯­è¨€é›†
&lt;code&gt;Content-Type&lt;/code&gt;ï¼šè¯·æ±‚ä¸­çš„æ•°æ®çš„åª’ä½“ç±»å‹
&lt;code&gt;Cookie&lt;/code&gt;ï¼šæµè§ˆå™¨è®°å½•çš„ç”¨æˆ·ç›¸å…³ä¿¡æ¯&lt;/p&gt;

&lt;p&gt;å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ï¼Œè¿™é‡Œå°±ä¸ç½—åˆ—å®Œäº†ï¼Œå¦å¤–è¿˜å¯ä»¥è‡ªå·±æ·»åŠ ä¸€äº›è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œåœ¨æœåŠ¡ç«¯æ‰‹åŠ¨è·å–å¤„ç†å°±è¡Œäº†&lt;/p&gt;

&lt;h5 id=&#34;3-3è¯·æ±‚ä¸»ä½“&#34;&gt;3.3è¯·æ±‚ä¸»ä½“&lt;/h5&gt;

&lt;p&gt;ä¸»è¦æ˜¯è¯·æ±‚æ‰€å¸¦çš„ä¸€äº›å‚æ•°ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°&lt;/p&gt;

&lt;h4 id=&#34;4-ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜&#34;&gt;4.ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜&lt;/h4&gt;

&lt;p&gt;æµè§ˆå™¨ç¼“å­˜ä¸»è¦&lt;code&gt;å¼ºç¼“å­˜&lt;/code&gt;å’Œ&lt;code&gt;åå•†ç¼“å­˜&lt;/code&gt;ï¼Œå…·ä½“ä½¿ç”¨å“ªä¸€ç§ç¼“å­˜ï¼Œå¼ºç¼“å­˜çš„ä¼˜å…ˆçº§æ¯”åå•†ç¼“å­˜é«˜ï¼Œæ€ä¹ˆè®¾ç½®è¿˜æ˜¯å¾—ä»å®é™…å‡ºå‘&lt;/p&gt;

&lt;h5 id=&#34;4-1å¼ºç¼“å­˜&#34;&gt;4.1å¼ºç¼“å­˜&lt;/h5&gt;

&lt;p&gt;å¼ºç¼“å­˜å¯ä»¥ç”¨&lt;code&gt;Expires&lt;/code&gt;å’Œ&lt;code&gt;Cache-Control&lt;/code&gt;æ¥æ§åˆ¶ï¼Œå¼ºç¼“å­˜æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡æœåŠ¡å™¨è¿”å›çš„è¿‡æœŸæ—¶é—´æ¥åˆ¤æ–­ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œä¸ä¼šå†å»å’ŒæœåŠ¡ç«¯åšæ ¡éªŒçœ‹èµ„æºæ˜¯å¦çœŸæ­£æ›´æ–°äº†&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Expires&lt;/code&gt;ï¼šä¸»ç”±æœåŠ¡ç«¯è¿”ç»™å®¢æˆ·ç«¯ï¼Œåœ¨è¿‡æœŸæ—¶é—´å†…ï¼Œæµè§ˆå™¨å¯ç›´æ¥ä½¿ç”¨ç¼“å­˜è€Œä¸éœ€è¦é‡æ–°è¯·æ±‚ï¼Œä½†å®ƒä¹Ÿæœ‰ä¸å°‘å±€é™ï¼Œé¦–å…ˆå®ƒåªèƒ½ç²¾ç¡®åˆ°ç§’ï¼Œå¯¹äºé‚£ç§æ¯«ç§’çº§æ›´æ–°çš„èµ„æºå®ƒæ²¡åŠæ³•åˆ¤æ–­ï¼Œå…¶æ¬¡å®ƒå—é™äºæœ¬åœ°æ—¶é—´ï¼Œå¦‚æœä¿®æ”¹äº†æœ¬åœ°æ—¶é—´ï¼Œå¯èƒ½ä¼šé€ æˆç¼“å­˜å¤±æ•ˆã€‚&lt;code&gt;Expires&lt;/code&gt;æ˜¯&lt;code&gt;Http/1&lt;/code&gt;æ—¶å€™çš„è¯·æ±‚å¤´ï¼Œç°åœ¨è¿™æ ·è®¾ç½®é€šå¸¸ä¹Ÿæ˜¯ä¸ºäº†å…¼å®¹&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Cache-Control&lt;/code&gt;ï¼šæ˜¯ç°åœ¨ä¸»è¦ä½¿ç”¨çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨è¯·æ±‚å¤´ä»¥åŠå“åº”å¤´ä¸­è®¾ç½®ï¼Œå¸¸è§è®¾ç½®æœ‰&lt;code&gt;max-age(è¡¨ç¤ºç¼“å­˜åœ¨å¤šå°‘ç§’åè¿‡æœŸ)&lt;/code&gt;ï¼Œ&lt;code&gt;no-cache(è¡¨ç¤ºä½¿ç”¨Etagæˆ–è€…Last-Modifiedå­—æ®µæ¥æ§åˆ¶ç¼“å­˜ï¼Œå³åå•†ç¼“å­˜)&lt;/code&gt;ï¼Œé€šå¸¸æ¥è®²ï¼Œ&lt;code&gt;Cache-control&lt;/code&gt;çš„ä¼˜å…ˆçº§æ˜¯è¦é«˜äº&lt;code&gt;Expires&lt;/code&gt;çš„&lt;/p&gt;

&lt;h5 id=&#34;4-2åå•†ç¼“å­˜&#34;&gt;4.2åå•†ç¼“å­˜&lt;/h5&gt;

&lt;p&gt;åœ¨å¼ºç¼“å­˜å¤±æ•ˆåå°±ä¼šç”¨åå•†ç¼“å­˜ï¼Œåå•†ç¼“å­˜ä¸»è¦ä½¿ç”¨&lt;code&gt;Last-Modified å’Œ ETag&lt;/code&gt;è¯·æ±‚å¤´æ§åˆ¶ï¼Œè¿™ä¸¤ä¸ªå­—æ®µéƒ½æ˜¯ç”±æœåŠ¡ç«¯è¿”å›çš„ã€‚å¦‚æœè¯´ç¼“å­˜è¿˜ç”Ÿæ•ˆï¼Œé‚£ä¹ˆè¿™æ¬¡è¯·æ±‚çš„çŠ¶æ€ç ä¼šè¿”å›&lt;code&gt;304&lt;/code&gt;ï¼Œè¡¨ç¤ºèµ„æºæœªæ”¹åŠ¨ï¼Œå¦‚æœç¼“å­˜å¤±æ•ˆï¼Œè¿”å›æ–°çš„èµ„æºå¹¶è®¾ç½®ç¼“å­˜ï¼Œè¿”å›&lt;code&gt;200&lt;/code&gt;çŠ¶æ€ç &lt;/p&gt;

&lt;p&gt;&lt;code&gt;Last-Modified&lt;/code&gt;ï¼šåœ¨è®¾ç½®&lt;code&gt;Last-Modified&lt;/code&gt;åï¼Œä¸‹æ¬¡è¯·æ±‚æ—¶è¯·æ±‚å¤´ä¼šå¸¦ä¸Š&lt;code&gt;If-Modified-Since&lt;/code&gt;è¿™ä¸ªå­—æ®µï¼Œç„¶åæœåŠ¡å™¨ä¼šç”¨è¿™ä¸ªæ—¶é—´ä¸èµ„æºä¿®æ”¹æ—¶é—´åšå¯¹æ¯”ï¼Œç„¶åå°±æ˜¯è¿”å›&lt;code&gt;304&lt;/code&gt;è¿˜æ˜¯&lt;code&gt;200&lt;/code&gt;çš„é—®é¢˜äº†ï¼ŒåŒæ ·å®ƒä¹Ÿåªèƒ½ç²¾ç¡®åˆ°ç§’ï¼Œæ‰€ä»¥ä¸€äº›éœ€è¦æ¯«ç§’çº§æ›´æ–°çš„èµ„æºä½¿ç”¨è¿™ä¸ªå¹¶ä¸å‡†ç¡®&lt;/p&gt;

&lt;p&gt;&lt;code&gt;ETag&lt;/code&gt;ï¼šé€šå¸¸ä¸&lt;code&gt;If-None-Match&lt;/code&gt;é…åˆä½¿ç”¨ï¼Œ&lt;code&gt;Etag&lt;/code&gt;ä¸ºæœåŠ¡ç«¯ä¸ºè¿™èµ„æºç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ï¼Œä¸‹æ¬¡å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™ï¼Œå¸¦ä¸Šè¿™ä¸ªå€¼ï¼Œç”±æœåŠ¡ç«¯å†åšæ ¡éªŒï¼Œå¦‚æœèµ„æºæœªæ”¹åŠ¨ï¼Œè¿”å›&lt;code&gt;304&lt;/code&gt;ï¼Œä½¿ç”¨åŸæ¥çš„ç¼“å­˜ï¼Œåä¹‹è¿”å›&lt;code&gt;200&lt;/code&gt;ï¼Œè®¾ç½®ç¼“å­˜&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://i.loli.net/2020/10/28/O2gaJWm8jYPeI7c.png&#34; alt=&#34;æµè§ˆå™¨ç¼“å­˜.png&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å›¾å‡ºè‡ª&lt;a href=&#34;https://github.com/ljianshu/Blog&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;åšå®¢&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&#34;5-æµè§ˆå™¨æ¥æ”¶å“åº”&#34;&gt;5.æµè§ˆå™¨æ¥æ”¶å“åº”&lt;/h4&gt;

&lt;p&gt;å“åº”åˆ†ä¸ºçŠ¶æ€ç ï¼Œå“åº”å¤´ï¼Œå“åº”ä¸»ä½“ç»„æˆï¼Œå“åº”ä¸»ä½“é€šå¸¸æ˜¯ä¸€äº›æ–‡ä»¶&lt;code&gt;å¦‚(HTMLã€JSã€CSSæ–‡ä»¶)&lt;/code&gt;æˆ–è€…è¯´æ˜¯ä¸€äº›å“åº”æ•°æ®&lt;code&gt;(è¯·æ±‚çš„å“åº”æ•°æ®)&lt;/code&gt;ï¼ŒçŠ¶æ€ç å’Œå“åº”å¤´è¿™é‡Œå°±ä¸ç½—åˆ—äº†ã€‚æœ‰ä¸ªç‰¹åˆ«çš„é€šå¸¸ä¸ºäº†æå‡å“åº”çš„æ•ˆç‡ï¼ŒæœåŠ¡ç«¯ä¼šå°†ä¸€äº›è¿›è¡Œ&lt;code&gt;gzip&lt;/code&gt;å‹ç¼©ï¼Œç„¶åå“åº”å¤´é‡Œé¢ä¼šæœ‰ä¸ªå“åº”å¤´&lt;code&gt;content-encoding:gzip&lt;/code&gt;ï¼Œç„¶åæµè§ˆå™¨ä¼šå†è¿›è¡Œè§£å‹&lt;/p&gt;

&lt;h4 id=&#34;6-é¡µé¢æ¸²æŸ“&#34;&gt;6.é¡µé¢æ¸²æŸ“&lt;/h4&gt;

&lt;p&gt;åœ¨æ¥æ”¶å“åº”æˆåŠŸä¹‹åï¼Œæµè§ˆå™¨å°±å¼€å§‹æ¸²æŸ“é¡µé¢äº†ã€‚å…¶æ­¥éª¤åŒ…æ‹¬ï¼š1.è§£æ&lt;code&gt;HTML&lt;/code&gt;ä¸º&lt;code&gt;DOM&lt;/code&gt;æ ‘ã€2.è§£æ&lt;code&gt;CSS&lt;/code&gt;ä¸º&lt;code&gt;CSS&lt;/code&gt;æ ‘ã€3.åˆå¹¶&lt;code&gt;DOM&lt;/code&gt;æ ‘å·²ç»&lt;code&gt;CSS&lt;/code&gt;æ ‘ã€4.éå†æ•´ä¸ªèŠ‚ç‚¹ã€5.æŒ‰ç…§&lt;code&gt;CSS&lt;/code&gt;çš„ä¼˜å…ˆçº§æ¸²æŸ“æ¯ä¸ªèŠ‚ç‚¹çš„æ ·å¼ï¼Œå‘ˆç°åœ¨å±å¹•ä¸Šã€‚å½“æµè§ˆå™¨é‡åˆ°ä¸€ä¸ª&lt;code&gt;script&lt;/code&gt;æ ‡è®°æ—¶ï¼Œ&lt;code&gt;DOM&lt;/code&gt;æ„å»ºå°†æš‚åœï¼Œç›´è‡³è„šæœ¬å®Œæˆæ‰§è¡Œï¼Œç„¶åç»§ç»­æ„å»º&lt;code&gt;DOM&lt;/code&gt;ã€‚æ¯æ¬¡å»æ‰§è¡Œ&lt;code&gt;JS&lt;/code&gt;è„šæœ¬éƒ½ä¼šä¸¥é‡é˜»å¡&lt;code&gt;DOM&lt;/code&gt;æ ‘çš„æ„å»ºï¼Œå¦‚æœ&lt;code&gt;JS&lt;/code&gt;è„šæœ¬è¿˜æ“ä½œçš„&lt;code&gt;CSSOM&lt;/code&gt;ï¼Œè€Œæ­£å¥½è¿™ä¸ª&lt;code&gt;CSSOM&lt;/code&gt;è¿˜æ²¡æœ‰ä¸‹è½½å’Œæ„å»ºï¼Œæµè§ˆå™¨ç”šè‡³ä¼šå»¶è¿Ÿè„šæœ¬æ‰§è¡Œå’Œæ„å»º&lt;code&gt;DOM&lt;/code&gt;ï¼Œç›´è‡³å®Œæˆå…¶&lt;code&gt;CSSOM&lt;/code&gt;çš„ä¸‹è½½å’Œæ„å»ºã€‚æ‰€ä»¥è¿™é‡Œé€šå¸¸ä¼šæœ‰ä¸ªå¸¸è§çš„å°ä¼˜åŒ–ï¼Œ&lt;code&gt;CSS&lt;/code&gt;æ”¾åœ¨é¡¶éƒ¨ï¼Œ&lt;code&gt;JS&lt;/code&gt;æ”¾åœ¨åº•éƒ¨ï¼Œå¹¶ä¸”å‡å°‘ä½¿ç”¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­æ“ä½œ&lt;code&gt;DOM&lt;/code&gt;ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯æ¯”è¾ƒè€çš„åšæ³•äº†ã€‚åœ¨é¡µé¢åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€å†™çš„&lt;code&gt;CSS&lt;/code&gt;å’Œ&lt;code&gt;JS&lt;/code&gt;ä¹Ÿè¦å°½é‡é¿å…é‡ç»˜å’Œå›æµ&lt;/p&gt;

&lt;h4 id=&#34;7-å››æ¬¡æ¡æ‰‹&#34;&gt;7.å››æ¬¡æ¡æ‰‹&lt;/h4&gt;

&lt;p&gt;å››æ¬¡æ¡æ‰‹ç”¨äºæ–­å¼€&lt;code&gt;Tcp&lt;/code&gt;è¿æ¥ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚è¡¨ç¤ºè¦æ–­å¼€è¿æ¥ï¼ŒæœåŠ¡æ¥å—åˆ°è¯·æ±‚åå“åº”ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°å“åº”å‡†å¤‡æ–­å¼€è¿æ¥ï¼ŒæœåŠ¡ç«¯å°†å…¶ä½™æ•°æ®æˆ–æ²¡å“åº”çš„æ•°æ®å…¨éƒ¨è¿”ç»™å®¢æˆ·ç«¯(å³åˆä¸€æ¬¡æ¡æ‰‹)ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åå“åº”åå†å‘é€è¯·æ±‚ç¡®è®¤å…³é—­ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åæ–­å¼€è¿æ¥&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;1ï¼‰å®¢æˆ·ç«¯è¿›ç¨‹å‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡ï¼Œå¹¶ä¸”åœæ­¢å‘é€æ•°æ®ã€‚é‡Šæ”¾æ•°æ®æŠ¥æ–‡é¦–éƒ¨ï¼ŒFIN=1ï¼Œå…¶åºåˆ—å·ä¸ºseq=uï¼ˆç­‰äºå‰é¢å·²ç»ä¼ é€è¿‡æ¥çš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„åºå·åŠ 1ï¼‰ï¼Œæ­¤æ—¶ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN-WAIT-1ï¼ˆç»ˆæ­¢ç­‰å¾…1ï¼‰çŠ¶æ€ã€‚ TCPè§„å®šï¼ŒFINæŠ¥æ–‡æ®µå³ä½¿ä¸æºå¸¦æ•°æ®ï¼Œä¹Ÿè¦æ¶ˆè€—ä¸€ä¸ªåºå·ã€‚
2ï¼‰æœåŠ¡å™¨æ”¶åˆ°è¿æ¥é‡Šæ”¾æŠ¥æ–‡ï¼Œå‘å‡ºç¡®è®¤æŠ¥æ–‡ï¼ŒACK=1ï¼Œack=u+1ï¼Œå¹¶ä¸”å¸¦ä¸Šè‡ªå·±çš„åºåˆ—å·seq=vï¼Œæ­¤æ—¶ï¼ŒæœåŠ¡ç«¯å°±è¿›å…¥äº†CLOSE-WAITï¼ˆå…³é—­ç­‰å¾…ï¼‰çŠ¶æ€ã€‚TCPæœåŠ¡å™¨é€šçŸ¥é«˜å±‚çš„åº”ç”¨è¿›ç¨‹ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨çš„æ–¹å‘å°±é‡Šæ”¾äº†ï¼Œè¿™æ—¶å€™å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå³å®¢æˆ·ç«¯å·²ç»æ²¡æœ‰æ•°æ®è¦å‘é€äº†ï¼Œä½†æ˜¯æœåŠ¡å™¨è‹¥å‘é€æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¾ç„¶è¦æ¥å—ã€‚è¿™ä¸ªçŠ¶æ€è¿˜è¦æŒç»­ä¸€æ®µæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªCLOSE-WAITçŠ¶æ€æŒç»­çš„æ—¶é—´ã€‚
3ï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„ç¡®è®¤è¯·æ±‚åï¼Œæ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å°±è¿›å…¥FIN-WAIT-2ï¼ˆç»ˆæ­¢ç­‰å¾…2ï¼‰çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨å‘é€è¿æ¥é‡Šæ”¾æŠ¥æ–‡ï¼ˆåœ¨è¿™ä¹‹å‰è¿˜éœ€è¦æ¥å—æœåŠ¡å™¨å‘é€çš„æœ€åçš„æ•°æ®ï¼‰ã€‚
4ï¼‰æœåŠ¡å™¨å°†æœ€åçš„æ•°æ®å‘é€å®Œæ¯•åï¼Œå°±å‘å®¢æˆ·ç«¯å‘é€è¿æ¥é‡Šæ”¾æŠ¥æ–‡ï¼ŒFIN=1ï¼Œack=u+1ï¼Œç”±äºåœ¨åŠå…³é—­çŠ¶æ€ï¼ŒæœåŠ¡å™¨å¾ˆå¯èƒ½åˆå‘é€äº†ä¸€äº›æ•°æ®ï¼Œå‡å®šæ­¤æ—¶çš„åºåˆ—å·ä¸ºseq=wï¼Œæ­¤æ—¶ï¼ŒæœåŠ¡å™¨å°±è¿›å…¥äº†LAST-ACKï¼ˆæœ€åç¡®è®¤ï¼‰çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„ç¡®è®¤ã€‚
5ï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡åï¼Œå¿…é¡»å‘å‡ºç¡®è®¤ï¼ŒACK=1ï¼Œack=w+1ï¼Œè€Œè‡ªå·±çš„åºåˆ—å·æ˜¯seq=u+1ï¼Œæ­¤æ—¶ï¼Œå®¢æˆ·ç«¯å°±è¿›å…¥äº†TIME-WAITï¼ˆæ—¶é—´ç­‰å¾…ï¼‰çŠ¶æ€ã€‚æ³¨æ„æ­¤æ—¶TCPè¿æ¥è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå¿…é¡»ç»è¿‡2âˆ—âˆ—MSLï¼ˆæœ€é•¿æŠ¥æ–‡æ®µå¯¿å‘½ï¼‰çš„æ—¶é—´åï¼Œå½“å®¢æˆ·ç«¯æ’¤é”€ç›¸åº”çš„TCBåï¼Œæ‰è¿›å…¥CLOSEDçŠ¶æ€ã€‚
6ï¼‰æœåŠ¡å™¨åªè¦æ”¶åˆ°äº†å®¢æˆ·ç«¯å‘å‡ºçš„ç¡®è®¤ï¼Œç«‹å³è¿›å…¥CLOSEDçŠ¶æ€ã€‚åŒæ ·ï¼Œæ’¤é”€TCBåï¼Œå°±ç»“æŸäº†è¿™æ¬¡çš„TCPè¿æ¥ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡å™¨ç»“æŸTCPè¿æ¥çš„æ—¶é—´è¦æ¯”å®¢æˆ·ç«¯æ—©ä¸€äº›ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h6 id=&#34;å‚è€ƒé“¾æ¥&#34;&gt;å‚è€ƒé“¾æ¥&lt;/h6&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/ljianshu/Blog&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;åšå®¢&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>æµ…è°ˆå‰ç«¯ç»Ÿè®¡</title>
      <link>https://xtid.github.io/2020/%E6%B5%85%E8%B0%88%E5%89%8D%E7%AB%AF%E7%BB%9F%E8%AE%A1/</link>
      <pubDate>Wed, 28 Oct 2020 21:45:40 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/%E6%B5%85%E8%B0%88%E5%89%8D%E7%AB%AF%E7%BB%9F%E8%AE%A1/</guid>
      <description>&lt;p&gt;ç›‘æ§ç³»ç»Ÿåœ¨ç°åœ¨çš„é¡¹ç›®ä¸­æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå®ƒå…·æœ‰æ€§èƒ½ç›‘æ§ã€é”™è¯¯ç›‘æ§ä»¥åŠæ•°æ®ä¸ŠæŠ¥ç­‰åŠŸèƒ½ã€‚é€šè¿‡å¯¹çš„é”™è¯¯ç›‘æ§ã€ç”¨æˆ·æ­£å¸¸è¡Œä¸ºçš„æ”¶é›†ï¼Œä»è€ŒæŒ‡å®šå¯¹åº”çš„ä¼˜åŒ–æ–¹æ¡ˆã€è¥é”€ç­–ç•¥ä»¥åŠé¡¹ç›®çš„è¿­ä»£ã€‚ è¯•æƒ³ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›ç›‘æ§ç³»ç»Ÿï¼Œé‚£ä¹ˆçº¿ä¸Šçš„è¿è¡Œçš„é¡¹ç›®å‡ºé—®é¢˜äº†ï¼Œå®šä½æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œè¿™æ—¶å€™ä¿®å¤èµ·æ¥å°±æ¯”è¾ƒåŠ³ç¥äº†ã€‚æˆ‘è®°å½•ä¸‹æˆ‘æ‰€äº†è§£çš„ï¼Œå¸¸è§çš„æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;1.é”™è¯¯ç›‘æ§&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å¯¹äºé”™è¯¯çš„å¤„ç†ï¼Œåœ¨&lt;code&gt;js&lt;/code&gt;ä¸­å¾ˆå¸¸è§çš„é”™è¯¯æ•è·&lt;code&gt;try catch&lt;/code&gt;ã€&lt;code&gt;promiseä¸­çš„catch&lt;/code&gt;ç­‰ç­‰ã€‚åœ¨windowå¯¹è±¡ä¸Šæœ‰ä¸€ä¸ªæ–¹æ³•&lt;code&gt;onerror&lt;/code&gt;ï¼Œå¯ä»¥æ‹¿åˆ°å½“å‰æŠ¥é”™çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸ªä¿¡æ¯æ‹¿åˆ°ç„¶åæäº¤åˆ°æˆ‘ä»¬è‡ªå·±çš„ç›‘æ§ç³»ç»Ÿï¼Œè¿˜æœ‰ä¸ªå¾ˆé‡è¦çš„åŸå› ï¼Œä¸å¤„ç†è¿™äº›é”™è¯¯ï¼Œå¯¼è‡´é¡µé¢æŒ‚äº†åœæ­¢åŠ è½½ï¼Œé‚£æŸå¤±å¯å°±å¤§äº†ã€‚å¯¹äºæŠ›å‡ºçš„é”™è¯¯ï¼Œå®ƒæœ‰å‡ ä¸ªå±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// å®šä¹‰ä¸€ä¸ªé”™è¯¯å¯¹è±¡
const defaults = {
  msg: &#39;&#39;, // é”™è¯¯çš„å…·ä½“ä¿¡æ¯
  url: &#39;&#39;, // é”™è¯¯æ‰€åœ¨çš„url
  line: &#39;&#39;, // é”™è¯¯æ‰€åœ¨çš„è¡Œ
  col: &#39;&#39;, // é”™è¯¯æ‰€åœ¨çš„åˆ—
  nowTime: &#39;&#39; // æ—¶é—´
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå®ç°&lt;code&gt;window.onerror&lt;/code&gt;æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;window.onerror = function (msg, url, line, col, error) {
  col = col || (window.event &amp;amp;&amp;amp; window.event.errorCharacter) || 0

  defaults.url = url
  defaults.line = line
  defaults.col = col
  defaults.nowTime = new Date().getTime()

  if (error &amp;amp;&amp;amp; error.stack) {
    // å¦‚æœæµè§ˆå™¨æœ‰é”™è¯¯å †æ ˆä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
    defaults.msg = error.stack.toString()
  } else if (arguments.callee) {
    // é€šè¿‡calleeæ‹¿å †æ ˆä¿¡æ¯
    let ext = []
    let fn = arguments.callee.caller
    // æœ€å¤šæ‹¿åˆ°ä¸‰å±‚
    let floor = 3
    while (fn &amp;amp;&amp;amp; (--floor &amp;gt; 0)) {
      ext.push(fn.toString())
      if (fn === fn.caller) {
        break
      }
      fn = fn.caller
    }
    ext = ext.join(&#39;,&#39;)
    defaults.msg = error &amp;amp;&amp;amp; error.stack &amp;amp;&amp;amp; error.stack.toString()
  }
  let str = &#39;&#39;
  // æ ¼å¼åŒ–è¿™äº›é”™è¯¯ä¿¡æ¯
  for (const i in defaults) {
    if (!defaults[i]) {
      defaults[i] = &#39;null&#39;
    }
    str += &#39;&amp;amp;&#39; + i + &#39;=&#39; + defaults[i].toString()
  }
  // ç¡®å®šé”™è¯¯æ˜¯ç”±å“ªä½ç”¨æˆ·å¼•èµ·çš„ï¼Œè¿™ä¸€æ­¥æœ‰äº›æ—¶å€™å¯ä»¥ä¸ç”¨
  let userinfo = // æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯
  if (typeof userinfo === &#39;object&#39;) {
    userinfo = JSON.stringify(userinfo)
  }
  if (userinfo) userinfo = encodeURIComponent(userinfo)
  str = encodeURIComponent(str.replace(&#39;&amp;amp;&#39;, &#39;&#39;).replace(&#39;\n&#39;, &#39;&#39;).replace(/\s/g, &#39;&#39;))
	
  // é¿å…å‡ºç°è·¨åŸŸé”™è¯¯
  new Image().src = &#39;apiåœ°å€?msg=&#39; + str + &#39;&amp;amp;userinfo=&#39; + userinfo
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ç§æ–¹å¼çš„ç¼ºé™·åœ¨äºï¼Œæ²¡åŠæ³•å¤„ç†&lt;code&gt;promise&lt;/code&gt;ä¸­æœªå¤„ç†çš„é”™è¯¯ï¼Œå¯¹äº&lt;code&gt;promise&lt;/code&gt;ï¼Œæ¨èä½¿ç”¨&lt;code&gt;unhandledrejection&lt;/code&gt;äº‹æƒ…å¤„ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;window.addEventListener(&#39;unhandledrejection&#39;, event =&amp;gt; {
  let error = event.reason &amp;amp;&amp;amp; event.reason.message
  if (!error) {
    error = typeof event.reason === &#39;object&#39; ? JSON.stringify(event.reason) : event.reason
  }

  (new Image()).src = &#39;apiåœ°å€?msg=&#39; + encodeURIComponent(error)
})

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.åŸ‹ç‚¹&lt;/p&gt;

&lt;p&gt;åŸ‹ç‚¹æ˜¯ä¸€ç§å¸¸è§çš„ç»Ÿè®¡ç”¨æˆ·è¡Œä¸ºçš„æ–¹å¼æˆ–å·¥å…·ã€‚é€šè¿‡åœ¨é¡µé¢è®¾ç½®åŸ‹ç‚¹ï¼Œæ¥ç»Ÿè®¡ç”¨æˆ·å¯¹äºæŸä¸ªé¡µé¢ã€å¹¿å‘Šã€åŠŸèƒ½çš„ä½¿ç”¨é¢‘ç‡ã€å–œå¥½ï¼Œç„¶åé€šè¿‡å¯¹åŸ‹ç‚¹çš„æ•°æ®ç»Ÿè®¡ï¼Œç¡®å®šå¥½é¡µé¢æˆ–åŠŸèƒ½çš„è¿­ä»£ã€‚ç®€å•çš„åšæ³•ï¼Œè®¾ç½®ä¸€ä¸ªå…¨å±€æ–¹æ³•ç”¨æ¥æäº¤åŸ‹ç‚¹ç‚¹å‡»çš„è¡Œä¸ºï¼Œåœ¨éœ€è¦çš„åœ°æ–¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// å®šä¹‰ä¸€ä¸ªå…¨å±€æ–¹æ³•
// ä¼ å…¥çš„pointä¸ºåŸ‹ç‚¹æ•°æ®
function clickPoint(point = {}) {
  const { id, name } = point
  cosnt userInfo = // é€šè¿‡å¯¹åº”çš„æ“ä½œæ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯
  // åŸºç¡€å‚æ•°
  const basicParams = {
    id: id || &#39;&#39;,
    name: name || &#39;&#39;
  }
  // ç”¨æˆ·ä¿¡æ¯
 	const userParams = {
  	name: userInfo.name || &#39;&#39;
    ......
 	}
  // åˆå¹¶å‚æ•°
  const params = {
    ...basicParams,
    ...userParams
  }
  let str = &#39;&#39;
  for (const i in params) {
    if (!params[i]) {
      params[i] = &#39;null&#39;
    }
    str += &#39;&amp;amp;&#39; + i + &#39;=&#39; + params[i].toString()
  }
  new Image().src = &#39;apiåœ°å€?msg=&#39; + str
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šå¸¸è¿™æ ·æ¥ç»Ÿè®¡é¡µé¢ä¸ŠæŸä¸ªåŠŸèƒ½ã€æŸä¸ªå¹¿å‘Šçš„ç‚¹å‡»é‡ï¼Œè·å–å¯¹åº”çš„ç»Ÿè®¡æ•°æ®ã€‚è¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ï¼Œä¸ºéœ€è¦æ·»åŠ åŸ‹ç‚¹çš„&lt;code&gt;html&lt;/code&gt;æ ‡ç­¾ä¸ŠåŠ ä¸ŠæŸä¸ªçº¦å®šå¥½çš„è‡ªå®šä¹‰å±æ€§ï¼Œå¦‚&lt;code&gt;&amp;lt;div data-link=&amp;quot;111&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;&lt;/code&gt;ï¼Œè¿™ä¸ª&lt;code&gt;111&lt;/code&gt;å°±æ˜¯å°±æ˜¯å®ç°ç”Ÿæˆå¥½æˆ–è€…è§„åˆ’å¥½çš„åŸ‹ç‚¹ã€‚ç„¶åç»™è¿™ç§å±æ€§æ·»åŠ å…¨å±€çš„ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»ååŒæ ·çš„å°†å¯¹åº”çš„æ•°æ®æäº¤åˆ°è‡ªå·±çš„åå°ç³»ç»Ÿå»ã€‚æœ‰äº›æ—¶å€™ä¸ºäº†æ–¹ä¾¿æŸ¥é˜…æˆ–è€…ç›´è§‚çš„è§‚çœ‹ç»Ÿè®¡æ•°æ®ï¼Œè¿˜å¯ä»¥åœ¨é¡µé¢æ¸²æŸ“çš„æ—¶å€™ï¼Œä¸ºå«æœ‰&lt;code&gt;data-link&lt;/code&gt;å±æ€§çš„æ ‡ç­¾ç”Ÿæˆå¯¹åº”çš„ä¸€äº›å›¾æ ‡æˆ–è€…æ–‡å­—æ ‡ç­¾ï¼Œä½¿ç”¨&lt;code&gt;absolute&lt;/code&gt;å®šä½æ˜¾ç¤ºåœ¨å¯¹åº”çš„å…ƒç´ ä¸Šï¼Œå½“ç„¶è¿™ç§æ–¹å¼åœ¨ä½ æ·»åŠ ä¹°ç‚¹åŸ‹ç‚¹å±æ€§çš„æ—¶å€™ï¼Œéœ€è¦ç»™è¿™ä¸ªå…ƒç´ è®¾ç½®ç›¸åº”çš„&lt;code&gt;position css&lt;/code&gt;å±æ€§ï¼›å½“ç„¶ä¹Ÿå¯èƒ½è®¾ç½®ä¸€äº›çƒ­åŠ›å›¾å•Šç­‰å…¶å®ƒå½¢å¼ï¼Œåæ­£éƒ½æ˜¯å®ç°åŒä¸€ä¸ªæ•ˆæœçš„ã€‚&lt;/p&gt;

&lt;p&gt;3.ç™½å±æ—¶é—´&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªä¹‹å‰è¯´è¿‡ï¼Œå°±ä¸è¯´åºŸè¯äº†ï¼Œç™½å±æ—¶é—´çš„ç»Ÿè®¡æ˜¯éå¸¸é‡è¦çš„ã€‚æ¯”å¦‚æœ‰äº›æ—¶å€™ï¼Œåªæœ‰æŸä¸ªç”¨æˆ·çš„æŸä¸ªè®¾å¤‡å‡ºç°äº†é¡µé¢åŠ è½½è¿‡é•¿ï¼Œé¡µé¢æ²¡å†…å®¹ï¼Œå‘ç°è¿™ä¸ªé—®é¢˜åï¼Œé€šè¿‡åˆ¤æ–­é”™è¯¯æ—¥å¿—å’Œç™½å±æ—¶é—´æ‰èƒ½æ›´å¿«çš„å®šä½é—®é¢˜ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;window.logInfo = {}
window.logInfo.openTime = window.performance &amp;amp;&amp;amp; window.performance.timing.navigationStart || 0
window.logInfo.whiteScreenTime = +new Date() - window.logInfo.openTime
window.logInfo.mobile = mobileType()

// ä½¿ç”¨ DOMContentLoaded ç»Ÿè®¡é¡µé¢æœ‰å†…å®¹çš„æ—¶é—´
document.addEventListener(&#39;DOMContentLoaded&#39;, function () {
  window.logInfo.readyTime = +new Date() - window.logInfo.openTime
})
window.onload = function () {
  window.logInfo.allloadTime = +new Date() - window.logInfo.openTime
  window.logInfo.nowTime = new Date().getTime()
  let timname = {
    whiteScreenTime: &#39;ç™½å±æ—¶é—´&#39;,
    readyTime: &#39;ç”¨æˆ·å¯æ“ä½œæ—¶é—´&#39;,
    allloadTime: &#39;æ€»ä¸‹è½½æ—¶é—´&#39;,
    mobile: &#39;ä½¿ç”¨è®¾å¤‡&#39;,
    nowTime: &#39;æ—¶é—´&#39;,
  }
  let logStr = &#39;&#39;
  for (const i in timname) {
    if (i === &#39;mobile&#39;) {
      logStr += &#39;&amp;amp;&#39; + i + &#39;=&#39; + window.logInfo[i]
    } else {
      logStr += &#39;&amp;amp;&#39; + i + &#39;=&#39; + window.logInfo[i]
    }
  }
  // è¿™é‡Œå¦‚æœéœ€è¦çš„è¯ï¼Œè¿˜å¯ä»¥æŠŠç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯æ”¶é›†å‡ºæ¥
  (new Image()).src = &#39;apiåœ°å€?msg=&#39; + logStr
}

function mobileType() {
  const u = navigator.userAgent
  // ç§»åŠ¨ç»ˆç«¯æµè§ˆå™¨ç‰ˆæœ¬ä¿¡æ¯
  const type = {
    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), // iosç»ˆç«¯
    iPad: u.indexOf(&#39;iPad&#39;) &amp;gt; -1, // æ˜¯å¦iPad
    android: u.indexOf(&#39;Android&#39;) &amp;gt; -1 || u.indexOf(&#39;Linux&#39;) &amp;gt; -1, // androidç»ˆç«¯æˆ–è€…ucæµè§ˆå™¨
    iPhone: u.indexOf(&#39;iPhone&#39;) &amp;gt; -1 || u.indexOf(&#39;Mac&#39;) &amp;gt; -1, // æ˜¯å¦ä¸ºiPhoneæˆ–è€…QQHDæµè§ˆå™¨
    trident: u.indexOf(&#39;Trident&#39;) &amp;gt; -1, // IEå†…æ ¸
    presto: u.indexOf(&#39;Presto&#39;) &amp;gt; -1, // operaå†…æ ¸
    webKit: u.indexOf(&#39;AppleWebKit&#39;) &amp;gt; -1, // è‹¹æœã€è°·æ­Œå†…æ ¸
    gecko: u.indexOf(&#39;Gecko&#39;) &amp;gt; -1 &amp;amp;&amp;amp; u.indexOf(&#39;KHTML&#39;) === -1, // ç«ç‹å†…æ ¸
    mobile: !!u.match(/AppleWebKit.*Mobile/i) || !!u.match(/MIDP|SymbianOS|NOKIA|SAMSUNG|LG|NEC|TCL|Alcatel|BIRD|DBTEL|Dopod|PHILIPS|HAIER|LENOVO|MOT-|Nokia|SonyEricsson|SIE-|Amoi|ZTE/), // æ˜¯å¦ä¸ºç§»åŠ¨ç»ˆç«¯
    webApp: u.indexOf(&#39;Safari&#39;) === -1 // æ˜¯å¦webåº”è¯¥ç¨‹åºï¼Œæ²¡æœ‰å¤´éƒ¨ä¸åº•éƒ¨
  }
  const lists = Object.keys(type)
  for (const i = 0; i &amp;lt; lists.length; i++) {
    if (type[lists[i]]) {
      return lists[i]
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>ç™½å±æ—¶é—´</title>
      <link>https://xtid.github.io/2020/%E7%99%BD%E5%B1%8F%E6%97%B6%E9%97%B4/</link>
      <pubDate>Sat, 24 Oct 2020 23:45:12 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/%E7%99%BD%E5%B1%8F%E6%97%B6%E9%97%B4/</guid>
      <description>&lt;p&gt;ç™½å±æ—¶é—´æŒ‡çš„æ˜¯ä»ç”¨æˆ·è¿›å…¥ç½‘ç«™ï¼Œä¸€ç›´åˆ°é¡µé¢æœ‰å†…å®¹å±•ç¤ºå‡ºæ¥çš„æ—¶é—´èŠ‚ç‚¹ï¼Œåœ¨è¿™æœŸé—´ç”¨æˆ·ä»€ä¹ˆä¸œè¥¿éƒ½çœ‹ä¸åˆ°ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬dnsæŸ¥è¯¢ã€å»ºç«‹tcpè¿æ¥ã€å‘é€é¦–ä¸ªhttpè¯·æ±‚ã€è¿”å›htmlæ–‡æ¡£ã€htmlæ–‡æ¡£headè§£æå®Œæ¯•ã€‚ç™½å±æ—¶é—´çš„é•¿çŸ­ï¼Œå½±å“ç€ç”¨æˆ·çš„ä½“éªŒï¼Œç™½å±æ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·å¤±å»äº†è€å¿ƒç­‰å¾…ï¼Œä¹Ÿè®¸å°±å…³é—­äº†ç½‘é¡µ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸€ä»½æ˜¯ &lt;a href=&#34;http://www.akamai.com/html/about/press/releases/2009/press_091409.html&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;Akamai&lt;/a&gt; çš„ç ”ç©¶æŠ¥å‘Šï¼Œå½“æ—¶æ€»å…±é‡‡è®¿äº†å¤§çº¦ 1048 åç½‘ä¸Šè´­ç‰©è€…ï¼Œå¾—å‡ºäº†è¿™æ ·çš„ç»“è®ºï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¤§çº¦æœ‰ 47% çš„ç”¨æˆ·æœŸæœ›ä»–ä»¬çš„é¡µé¢åœ¨ä¸¤ç§’ä¹‹å†…åŠ è½½å®Œæˆã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœé¡µé¢åŠ è½½æ—¶é—´è¶…è¿‡ 3sï¼Œå¤§çº¦æœ‰ 40% çš„ç”¨æˆ·é€‰æ‹©ç¦»å¼€æˆ–å…³é—­é¡µé¢ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç™½å±æ—¶é—´çš„è®¡ç®—å°±å¦‚ä¸Šè¯‰å®šä¹‰è¯´çš„é‚£æ ·ï¼Œåªéœ€è¦è®°å½•ç”¨æˆ·è¿›å…¥é¡µé¢çš„å¼€å§‹æ—¶é—´ï¼Œè®°å½•headåŠ è½½å®Œæˆçš„æ—¶é—´ï¼Œè®°å½•ä¸¤è€…çš„å·®å€¼ï¼Œè¿™å°±æ˜¯æ‰€è¯´çš„ç™½å±æ—¶é—´ã€‚è®¡ç®—çš„æ—¶å€™å¯ä»¥åˆ†åˆ«è·å–ä¸¤ä¸ªæ—¶é—´ï¼Œè®¡ç®—ä»–ä»¬çš„å·®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/mark&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;performance.mark&lt;/a&gt;ï¼Œåœ¨å¼€å§‹åœ°ç‚¹æ ‡è®°æˆ–è€…è¯´æ‰“ç‚¹ï¼Œåœ¨ç»“æŸåœ°ç‚¹è·å–è¿™ä¸ª&lt;code&gt;entry&lt;/code&gt;ï¼Œæ‹¿åˆ°å®ƒçš„&lt;code&gt;duration&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html lang=&amp;quot;en&amp;quot;&amp;gt;
&amp;lt;head&amp;gt;
	&amp;lt;meta charset=&amp;quot;UTF-8&amp;quot;&amp;gt;
	&amp;lt;title&amp;gt;ç™½å±æ—¶é—´&amp;lt;/title&amp;gt;
	&amp;lt;script&amp;gt;
		window.startTime = Date.now();
    // performance.mark(&amp;quot;timeStr&amp;quot;);
	&amp;lt;/script&amp;gt;
	&amp;lt;link rel=&amp;quot;stylesheet&amp;quot; href=&amp;quot;&amp;quot;&amp;gt;
	&amp;lt;script src=&amp;quot;&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
	&amp;lt;script&amp;gt;
		window.endTime = Date.now()
    // const timeStrEntries = performance.getEntriesByName(&amp;quot;timeStrEntries&amp;quot;);
    // console.log(timeStrEntries[0].duration)
	&amp;lt;/script&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;

&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦å¤–è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨&lt;code&gt;window.performance&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;timing&lt;/code&gt;å¯¹è±¡ä¸­ï¼ŒåŒ…å«äº†å„ç§æ—¶é—´ç›¸å…³çš„å±æ€§ï¼Œå…¶ä¸­&lt;code&gt;domLoading&lt;/code&gt;å±æ€§ä»£è¡¨å¼€å§‹è§£æ&lt;code&gt;DOM&lt;/code&gt;å…ƒç´ çš„æ—¶é—´ï¼Œ&lt;code&gt;fetchStart&lt;/code&gt;å±æ€§ä»£è¡¨å‘é€è¯·æ±‚å‰çš„æ—¶é—´ï¼Œä¸¤è€…ä¹‹å·®ä¹Ÿå¯ä»¥è®¡ç®—ç™½å±æ—¶é—´&lt;/p&gt;

&lt;p&gt;å¯¹äºå…·ä½“çš„æ—¶é—´ä¼˜åŒ–ï¼Œå¯ä»¥é’ˆå¯¹æ•´ä¸ªé¡µé¢æ¸²æŸ“çš„è¿‡ç¨‹æ¥å¤„ç†ã€‚è¿™é‡Œè¯´ä¸€ä¸‹ï¼š&lt;code&gt;é¢„æ¸²æŸ“&lt;/code&gt;ã€&lt;code&gt;æœåŠ¡ç«¯æ¸²æŸ“&lt;/code&gt;ã€&lt;code&gt;ä½¿ç”¨éª¨æ¶å±&lt;/code&gt;ï¼Œè¿™ä¹Ÿå¯ä»¥è¯´æ˜¯ç”¨æˆ·çš„ä½“éªŒä¼˜åŒ–&lt;/p&gt;

&lt;p&gt;é¦–å…ˆé¢„æ¸²æŸ“ï¼Œä¸»è¦æ˜¯ç”¨&lt;code&gt;prerender-spa-plugin&lt;/code&gt;æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;prerender-spa-plugin åˆ©ç”¨äº† Puppeteer çš„çˆ¬å–é¡µé¢çš„åŠŸèƒ½ã€‚ Puppeteer æ˜¯ Google Chrome å›¢é˜Ÿå®˜æ–¹çš„æ— ç•Œé¢ï¼ˆHeadlessï¼‰Chrome å·¥å…·ï¼Œå®ƒæ˜¯ä¸€ä¸ª Node åº“ï¼Œæä¾›äº†ä¸€ä¸ªé«˜çº§çš„ API æ¥æ§åˆ¶ DevTools åè®®ä¸Šçš„æ— å¤´ç‰ˆ Chrome ã€‚prerender-spa-plugin åŸç†æ˜¯åœ¨ Webpack æ„å»ºé˜¶æ®µçš„æœ€åï¼Œåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª Puppeteer çš„æœåŠ¡ï¼Œè®¿é—®é…ç½®äº†é¢„æ¸²æŸ“çš„è·¯ç”±ï¼Œç„¶åå°† Puppeteer ä¸­æ¸²æŸ“çš„é¡µé¢è¾“å‡ºåˆ° HTML æ–‡ä»¶ä¸­ï¼Œå¹¶å»ºç«‹è·¯ç”±å¯¹åº”çš„ç›®å½•ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;é¦–å…ˆè¯·æ±‚åˆ°å¯¹åº”çš„è·¯ç”±æˆ–è€…é¡µé¢ä¹‹åï¼Œ&lt;code&gt;Puppeteer&lt;/code&gt;ä¼šè·å–æ¸²æŸ“çš„é¡µé¢çš„é™æ€éƒ¨åˆ†å†…å®¹å¹¶æ›¿æ¢æ‰“åŒ…å‡ºæ¥çš„&lt;code&gt;html&lt;/code&gt;æ–‡ä»¶ï¼Œè¾¾åˆ°é¢„æ¸²æŸ“çš„ç›®çš„ï¼Œé¡µé¢åŠ è½½å®Œæˆä¹‹å‰å‘ˆç°ç»™ç”¨æˆ·éƒ¨åˆ†å†…å®¹ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªç›¸å¯¹å¥½çš„ä½“éªŒã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯é¢„æ¸²æŸ“å‡ºçš„å†…å®¹å¾€å¾€ä¸æœ€ç»ˆæ¸²æŸ“çš„é¡µé¢å†…å®¹ä¸åŒï¼Œå› ä¸ºé¡µé¢ä¼šæœ‰ç›¸åº”çš„äº¤äº’æˆ–è€…æ•°æ®çš„å˜åŒ–ï¼Œæ‰€ä»¥æœ€å¥½å¯¹äºä¸€äº›é™æ€é¡µé¢æ‰ç”¨è¿™ç§æ–¹å¼å¤„ç†ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆåœ¨å¯¹åº”çš„&lt;code&gt;webpack&lt;/code&gt;é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸ªæ’ä»¶çš„é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const PrerenderSPAPlugin = require(&#39;prerender-spa-plugin&#39;);
const Renderer = PrerenderSPAPlugin.PuppeteerRenderer;
const path = require(&#39;path&#39;);

module.exports = {
  plugins: [new PrerenderSPAPlugin({
    staticDir: path.join(__dirname, &#39;dist&#39;),
    routes: [ &#39;/&#39; ], // éœ€è¦é¢„æ¸²æŸ“çš„è·¯ç”±,
    renderer: new Renderer({
        headless: true, // å¼€å¯æ— å¤´æµè§ˆå™¨
        renderAfterDocumentEvent: &#39;render-event&#39;, 
    }),
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶ååœ¨é¡µé¢è§¦å‘&lt;code&gt;render-event&lt;/code&gt;äº‹ä»¶ï¼Œå‘Šè¯‰&lt;code&gt;Puppeteer&lt;/code&gt;å»çˆ¬å–è¿™ä¸ªé¡µé¢ï¼Œè¿™é‡Œä»¥&lt;code&gt;vue&lt;/code&gt;ä¸ºä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export default {
  mounted() {
    document.dispatchEvent(new Event(&#39;render-event&#39;));
  }
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åè®¿é—®å¯¹åº”çš„&lt;code&gt;route&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;index.html&lt;/code&gt;ä¸­å°±å¯ä»¥çœ‹åˆ°ç›¸åº”çš„å†…å®¹äº†ã€‚å®é™…åº”ç”¨ä¸­åœ¨é™æ€é¡µé¢ä¸­çš„æ—¶å€™ï¼Œåº”å½“å¦å¤–æŒ‡å®šå¯¹åº”çš„&lt;code&gt;html&lt;/code&gt;æ–‡ä»¶ï¼Œå¦‚æœé…ç½®äº†&lt;code&gt;CDN&lt;/code&gt;ï¼Œé‚£ä¹ˆåœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œåº”è¯¥å°†&lt;code&gt;CDN&lt;/code&gt;åœ°å€æ›¿æ¢ä¸ºæœ¬åœ°åœ°å€ï¼Œè¿™ä¸ªæ’ä»¶ä¹Ÿæä¾›äº†&lt;code&gt;server&lt;/code&gt;é€‰é¡¹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;server: {
  port: 80,
  proxy: {
    ......
    target: &#39;http://localhost&#39;,
    changeOrigin: true,
    ......
  }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœåŠ¡ç«¯æ¸²æŸ“&lt;/p&gt;

&lt;p&gt;æœåŠ¡ç«¯æ¸²æŸ“æ˜¯ç”±æœåŠ¡ç«¯å°†æ¸²æŸ“å¥½çš„&lt;code&gt;html&lt;/code&gt;å­—ç¬¦ä¸²ç›´æ¥è¿”ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥å—åˆ°å¯¹åº”çš„&lt;code&gt;html&lt;/code&gt;å­—ç¬¦ä¸²åï¼Œè§£ææ¸²æŸ“å‘ˆç°å‡ºç›¸åº”çš„é¡µé¢ã€‚å®¢æˆ·ç«¯æ¸²æŸ“æ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦å»è¯·æ±‚ç›¸åº”çš„æ¥å£å–å¾—ç›¸åº”çš„æ•°æ®ç„¶åæ¸²æŸ“å‡º&lt;code&gt;html&lt;/code&gt;é¡µé¢ï¼Œå› æ­¤ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“ç™½å±æ—¶é—´ç›¸å¯¹è¾ƒçŸ­ã€‚è¿˜æœ‰ä¸ªé¢å¤–çš„å¥½å¤„å½“ç„¶æ˜¯åˆ©äºSEOï¼Œè¿™ä¸ªä½œç”¨ææ€•è¿˜åœ¨ç™½å±ä¼˜åŒ–ä¹‹ä¸Šã€‚å®¢æˆ·ç«¯æ¸²æŸ“ä¸€å¼€å§‹çš„é¡µé¢ä¸ºç©ºï¼Œåœ¨æŸäº›çˆ¬è™«æ¥çˆ¬çš„æ—¶å€™ä»€ä¹ˆä¸œè¥¿éƒ½è·å–ä¸åˆ°ï¼Œæ‰€ä»¥ä¸åˆ©äºSEOï¼Œå½“ç„¶è¿™æ˜¯åè¯äº†ã€‚ç°åœ¨æˆ‘ä»¬è¿™ç”¨çš„æ¯”è¾ƒå¤šçš„ï¼Œä¸€èˆ¬æ˜¯ä»¥&lt;code&gt;nodejs&lt;/code&gt;ä¸ºä¸­é—´å±‚ï¼Œæ¥å—åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå‘é€çœŸæ­£çš„è¯·æ±‚åˆ°åå°ï¼Œéšååœ¨&lt;code&gt;nodejs&lt;/code&gt;ä¸­å¤„ç†å®Œå¯¹åº”çš„æ•°æ®ï¼Œæ¸²æŸ“é¡µé¢ã€‚ç°åœ¨ä»¥&lt;code&gt;react&lt;/code&gt;ã€&lt;code&gt;vue&lt;/code&gt;ä¸ºåŸºç¡€ï¼Œä¹Ÿæœ‰å„è‡ªå¯¹åº”çš„æœåŠ¡ç«¯æ¸²æŸ“æ–¹æ¡ˆï¼Œå¦‚&lt;code&gt;next.js&lt;/code&gt;ã€&lt;code&gt;nuxt.js&lt;/code&gt;è¿™é‡Œå°±ä¸ä»‹ç»äº†&lt;/p&gt;

&lt;p&gt;éª¨æ¶å±&lt;/p&gt;

&lt;p&gt;éª¨æ¶å±å¯ä»¥çœ‹åšç”¨æ¥ä»£æ›¿é¡µé¢&lt;code&gt;loading&lt;/code&gt;æ•ˆæœçš„ä¸€ç§æ–¹æ¡ˆï¼Œåœ¨é¡µé¢åŠ è½½å®Œæˆä¹‹å‰ï¼Œå‘ˆç°å‡ºé¡µé¢çš„ä¸€ä¸ªå¤§è‡´ç»“æ„ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªè‰¯å¥½çš„ä½“éªŒï¼Œè®©ä»–è§‰å¾—è¿™ä¸ªé¡µé¢æ­£åœ¨ç¼“æ…¢åŠ è½½ï¼Œè¿™ç§æ•ˆæœçœ‹èµ·æ¥ä¹Ÿæ¯”å•çº¯çš„æ”¾ä¸€å¼ èŠèŠ±å›¾ã€ä¸€å¼ åŠ è½½åŠ¨ç”»å¥½ä¸€äº›ã€‚è¿™ä¸ªæ–¹æ¡ˆæ›´å¤šçš„æ˜¯å¸¦æ¥æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚æ‰‹å†™éª¨æ¶å±ï¼Œé¦–å…ˆç¡®å®šé¡µé¢çš„åŸºæœ¬ç»“æ„ï¼Œç„¶åæŒ‰ç…§è¿™ä¸ªç»“æ„å†™ä¸€ä¸ªç±»ä¼¼çš„åŠ è½½é¡µé¢ï¼Œè¿™ä¸ªç”±è®¾è®¡æ¥å®šã€‚ä»¥ä¸‹ä»‹ç»ä½¿ç”¨&lt;code&gt;webpack(4.0+)&lt;/code&gt;æ¥å†™ä¸€ä¸ªç®€å•çš„éª¨æ¶å±æ’ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå®šä¹‰ä¸€ä¸ªéª¨æ¶å±æ’ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const HtmlWebpackPlugin = require(&#39;html-webpack-plugin&#39;)

let Skeleton = function (options) {
  // æ¥æ”¶ä¼ å…¥çš„å‚æ•°
}

Skeleton.prototype.apply = function (compiler) {
  compiler.plugin(&#39;compilation&#39;, compilation =&amp;gt; {
    HtmlWebpackPlugin.getHooks(compilation).beforeEmit.tapAsync(
      &#39;Skeleton&#39;,
      (htmlData, cb) =&amp;gt; {
        htmlData.html = htmlData.html.replace(&#39;&amp;lt;div id=&amp;quot;root&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;&#39;, `éª¨æ¶å±ä»£ç `)
        cb(null, htmlData)
      }
    )
  })
}

module.exports = Skeleton
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶å&lt;code&gt;webpack&lt;/code&gt;é…ç½®æ–‡ä»¶ä¸­å¼•å…¥å³å¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;...
new HtmlWebPackPlugin({
  template: &#39;public/index.html&#39;,
  filename: &#39;index.html&#39;,
  inject: true
}),
new Skeleton({
  template: &#39;public/index.html&#39;
})
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1.ä»¥ä¸Šé¦–å…ˆå®šä¹‰ä¸€ä¸ªæ’ä»¶å¯¹è±¡&lt;code&gt;Skeleton&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;2.å¼•å…¥&lt;code&gt;html-webpack-plugin&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;html-webpack-plugin&lt;/code&gt;çš„é’©å­å‡½æ•°&lt;code&gt;beforeEmit&lt;/code&gt;ä¸­ï¼Œè°ƒç”¨è¿™ä¸ª&lt;code&gt;Skeleton&lt;/code&gt;å¯¹è±¡ï¼Œ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;beforeEmit&lt;/code&gt;è¿™ä¸ªé’©å­å‡½æ•°çš„ä½œç”¨åœ¨äº&lt;code&gt;html-webpack-plugin&lt;/code&gt;æ’ä»¶å°†ç”Ÿæˆçš„&lt;code&gt;html&lt;/code&gt;æ’å…¥æ¨¡æ¿æ–‡ä»¶å‰è¿›è¡Œçš„æ“ä½œã€‚è¿™é‡Œå°±ç›¸å½“äºåœ¨ç”ŸæˆçœŸæ­£çš„&lt;code&gt;html&lt;/code&gt;ä»£ç ä¹‹å‰è°ƒç”¨ç”Ÿæˆéª¨æ¶å±é¡µé¢ã€‚&lt;/p&gt;

&lt;p&gt;3.è°ƒç”¨&lt;code&gt;cb&lt;/code&gt;ï¼Œä¼ å›&lt;code&gt;html&lt;/code&gt;å†…å®¹&lt;/p&gt;

&lt;p&gt;4.éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ&lt;code&gt;replace&lt;/code&gt;ä¸­çš„éœ€è¦æ›¿æ¢çš„æ ¹å…ƒç´ ã€ç±»åä¸è¦æé”™äº†ã€‚&lt;/p&gt;

&lt;p&gt;å…¶ä½™çš„ï¼Œæ ¹æ®ä¸åŒçš„è·¯å¾„ï¼Œå…¥å£å¯ä»¥å°†å‚æ•°ä¼ å…¥è¿™ä¸ªæ„é€ å‡½æ•°ä¸­ï¼Œç„¶ååˆ¤æ–­æ˜¾ç¤ºä¸åŒçš„éª¨æ¶å±ã€‚æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯å¤ç”¨æ€§ä¸å¼ºï¼Œä¹Ÿè®¸ä¼šéšç€é¡µé¢çš„è¿­ä»£è€Œç»å¸¸å˜åŠ¨ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿå¾ˆéº»çƒ¦ã€‚&lt;/p&gt;

&lt;p&gt;è¿˜æœ‰äº›å…¶ä»–è‡ªåŠ¨ç”Ÿæˆéª¨æ¶å±çš„å¼€æºæ–¹æ¡ˆã€‚æ¯”å¦‚é¥¿äº†ä¹ˆå¼€æºçš„&lt;code&gt;page-skeleton-webpack-plugin&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;é€šè¿‡ &lt;a href=&#34;https://link.zhihu.com/?target=https%3A//github.com/GoogleChrome/puppeteer&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;puppeteer&lt;/a&gt; åœ¨æœåŠ¡ç«¯æ“æ§ &lt;a href=&#34;https://link.zhihu.com/?target=https%3A//developers.google.com/web/updates/2017/04/headless-chrome&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;headless Chrome&lt;/a&gt; æ‰“å¼€å¼€å‘ä¸­çš„éœ€è¦ç”Ÿæˆéª¨æ¶å±çš„é¡µé¢ï¼Œåœ¨ç­‰å¾…é¡µé¢åŠ è½½æ¸²æŸ“å®Œæˆä¹‹åï¼Œåœ¨ä¿ç•™é¡µé¢å¸ƒå±€æ ·å¼çš„å‰æä¸‹ï¼Œé€šè¿‡å¯¹é¡µé¢ä¸­å…ƒç´ è¿›è¡Œåˆ å‡æˆ–å¢æ·»ï¼Œå¯¹å·²æœ‰å…ƒç´ é€šè¿‡å±‚å æ ·å¼è¿›è¡Œè¦†ç›–ï¼Œè¿™æ ·è¾¾åˆ°åœ¨ä¸æ”¹å˜é¡µé¢å¸ƒå±€ä¸‹ï¼Œéšè—å›¾ç‰‡å’Œæ–‡å­—ï¼Œé€šè¿‡æ ·å¼è¦†ç›–ï¼Œä½¿å¾—å…¶å±•ç¤ºä¸ºç°è‰²å—ã€‚ç„¶åå°†ä¿®æ”¹åçš„ HTML å’Œ CSS æ ·å¼æå–å‡ºæ¥ï¼Œè¿™æ ·å°±æ˜¯éª¨æ¶å±äº†&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å®ƒçš„å¤§è‡´åŸç†ï¼Œå°±æ˜¯åˆ©ç”¨&lt;code&gt;puppeteer&lt;/code&gt;è·å–é¡µé¢ç»“æ„ï¼Œå°†ä¸åŒçš„èŠ‚ç‚¹åˆ†ç±»å¤„ç†ï¼Œå±•ç°ä¸åŒçš„&amp;rsquo;éª¨æ¶æ•ˆæœ&amp;rsquo;ï¼Œæœ€åå®é™…æ¸²æŸ“çš„æ—¶å€™ï¼Œè¿›è¡Œç›¸åº”çš„æ›¿æ¢ã€‚ä½†æ˜¯å°±é’ˆå¯¹äºè¿™ä¸ªé¡¹ç›®&lt;code&gt;page-skeleton-webpack-plugin&lt;/code&gt;æ¥è¯´ï¼Œå‘æ¯”è¾ƒå¤šï¼Œè€Œä¸”ä¸æ”¯æŒ&lt;code&gt;webpack4&lt;/code&gt;ï¼Œæ…é‡ä½¿ç”¨ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Webpackæ‰“åŒ…ä¼˜åŒ–</title>
      <link>https://xtid.github.io/2020/webpack%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/</link>
      <pubDate>Mon, 07 Sep 2020 22:03:34 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/webpack%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/</guid>
      <description>&lt;p&gt;ä¹‹å‰äº†è§£äº†&lt;code&gt;webpack&lt;/code&gt;çš„åŸºæœ¬æ‰“åŒ…æµç¨‹æˆ–è€…è¯´åŸç†ï¼Œå¦‚æœåªæ˜¯é…ç½®ä¸€ä¸ªåŸºæœ¬çš„&lt;code&gt;webpack&lt;/code&gt;æ‰“åŒ…é…ç½®ï¼Œ
æ‰“åŒ…åçš„æ–‡ä»¶ä¼šå˜å¾—å¾ˆå¤§ï¼Œå½“ä½ é¡¹ç›®éƒ¨ç½²åï¼Œç”¨æˆ·æ‰“å¼€å¯¹åº”çš„ç•Œé¢ï¼Œä¹Ÿè®¸ä¼šå¾ˆé•¿æ—¶é—´æ‰åŠ è½½å®Œ(å½“ç„¶å’Œç½‘ç»œç¯å¢ƒæˆ–ç¡¬ä»¶è®¾å¤‡ä¹Ÿæœ‰å…³ç³»)ï¼Œå°¤å…¶æ˜¯å•é¡µé¢åº”ç”¨æ•ˆæœå¾ˆæ˜æ˜¾ï¼Œè¿™æ ·çš„ç”¨æˆ·ä½“éªŒè‡ªç„¶æ˜¯ä¸å¥½çš„ï¼Œæ‰€ä»¥æ­¤æ–‡ç« ä¸»è¦æ˜¯å¯¹&lt;code&gt;webpack&lt;/code&gt;æ‰“åŒ…ä¼˜åŒ–çš„ä¸€ä¸ªå°å°æ€»ç»“&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæ­å»ºå¥½ä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®ï¼Œç›®å½•ç»“æ„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;â”œâ”€â”€ dist // æ‰“åŒ…ç›®å½•
â”‚Â Â  â”œâ”€â”€ bundle.js // æ‰“åŒ…åçš„js
â”‚Â Â  â””â”€â”€ index.html // å…¥å£htmlæ–‡ä»¶
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ public
â”‚Â Â  â””â”€â”€ index.html // htmlæ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ actions // redux actionsæ–‡ä»¶
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.js
â”‚Â Â  â”œâ”€â”€ app.js // webpackæ‰“åŒ…å…¥å£æ–‡ä»¶ï¼Œä¹Ÿæ˜¯é¡¹ç›®çš„å…¥å£æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ assets // scss
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ about.scss
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ title.scss
â”‚Â Â  â”‚Â Â  â””â”€â”€ user.scss
â”‚Â Â  â”œâ”€â”€ dev.js // å¼€å‘æ—¶çš„ä¸€äº›é…ç½®
â”‚Â Â  â”œâ”€â”€ pages // pageé¡µé¢
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ about.jsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.jsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ title.jsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ user.jsx
â”‚Â Â  â”œâ”€â”€ reducers // reduxä¸­çš„reducer
â”‚Â Â  â”‚Â Â  â””â”€â”€ index.js
â”‚Â Â  â””â”€â”€ store.js
â””â”€â”€ webpack.config.js
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;webpack&lt;/code&gt;åŸºæœ¬é…ç½®å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const path = require(&#39;path&#39;)
const HtmlWebPackPlugin = require(&#39;html-webpack-plugin&#39;)

module.exports = {
  entry: &#39;./src/app.js&#39;,
  output: {
    path: path.resolve(__dirname, &#39;./dist/&#39;),
    filename: &#39;bundle.js&#39;
  },
  resolve: {
    extensions: [&#39;.wasm&#39;, &#39;.mjs&#39;, &#39;.js&#39;, &#39;.json&#39;, &#39;.jsx&#39;]
  },

  devServer: {
    contentBase: path.join(__dirname, &#39;./src/&#39;),
    publicPath: &#39;/&#39;,
    host: &#39;127.0.0.1&#39;,
    port: 3000,
    hot: true,
    stats: {
      colors: true
    }
  },
  module: {
    rules: [{
      test: /\.jsx?$/,
      exclude: /node_modules/,
      use: {
        loader: &#39;babel-loader&#39;
      }
    }, {
      test: /\.scss$/,
      use: [&#39;style-loader&#39;, &#39;css-loader&#39;, &#39;sass-loader&#39;]
    }]
  },
  plugins: [
    new HtmlWebPackPlugin({
      template: &#39;public/index.html&#39;,
      filename: &#39;index.html&#39;,
      inject: true
    })
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¼˜åŒ–ï¼š&lt;/p&gt;

&lt;p&gt;1.åŸºç¡€ä¼˜åŒ–&lt;/p&gt;

&lt;p&gt;é…ç½®&lt;code&gt;loader&lt;/code&gt;ï¼Œæ·»åŠ &lt;code&gt;exclude&lt;/code&gt;ã€&lt;code&gt;include&lt;/code&gt;ç¼©å°æœç´¢èŒƒå›´ï¼Œæ¯”å¦‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  test: /\.jsx?$/,
    exclude: /node_modules/, // è¿‡æ»¤node_modules
      use: {
        loader: &#39;babel-loader&#39;
      }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.ä½¿ç”¨&lt;code&gt;DllPlugin&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;å°†ä¸€äº›å˜åŠ¨è¾ƒå°‘æˆ–è€…æ ¹æœ¬ä¸ä¼šå˜åŠ¨çš„åº“å…ˆæ‰“åŒ…ç”Ÿæˆå¯¹åº”çš„&lt;code&gt;.dll.js&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;webpack&lt;/code&gt;æ‰“åŒ…çš„æ—¶å€™ï¼Œå°†è¿™äº›èµ„æºå¼•å…¥&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæ–°å»ºä¸€ä¸ª&lt;code&gt;webpack.config.dll.js&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const path = require(&#39;path&#39;);
const DllPlugin = require(&#39;webpack/lib/DllPlugin&#39;);

module.exports = {
  entry: {
    react: [&#39;react&#39;, &#39;react-dom&#39;]
  },
  output: {
    filename: &#39;[name].dll.js&#39;,
    // ç”Ÿæˆçš„æ–‡ä»¶ç›®å½•
    path: path.resolve(__dirname, &#39;dist&#39;),
    // åŠ¨æ€é“¾æ¥åº“åç§°
    library: &#39;_dll_[name]&#39;
  },
  plugins: [
    new DllPlugin({
      name: &#39;_dll_[name]&#39;,
      path: path.join(__dirname, &#39;dist&#39;, &#39;[name].manifest.json&#39;),
      context: __dirname, 
    })
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶ååœ¨&lt;code&gt;package.json&lt;/code&gt;çš„&lt;code&gt;scripts&lt;/code&gt;ä¸­æ·»åŠ dllæ‰“åŒ…å‘½ä»¤&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;webpack --config webpack.config.dll.js
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åè¿è¡Œæ­¤å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ä¼šåœ¨&lt;code&gt;dist&lt;/code&gt;ç›®å½•ä¸‹é¢ç”Ÿæˆ&lt;code&gt;react.dll&lt;/code&gt;ï¼Œ&lt;code&gt;react.manifest.json&lt;/code&gt;ä¸¤ä¸ªæ–‡ä»¶ï¼Œè¿™å°±æ˜¯ç”Ÿæˆçš„&lt;code&gt;dll&lt;/code&gt;æ–‡ä»¶ï¼Œç„¶å&lt;code&gt;webpack.config.js&lt;/code&gt;é‡Œé¢æ·»åŠ é…ç½®ï¼Œæ‰“åŒ…æ—¶å¼•å…¥è¿™äº›çš„&lt;code&gt;dll&lt;/code&gt;æ–‡ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå®‰è£…æ’ä»¶&lt;code&gt;add-asset-html-webpack-plugin&lt;/code&gt;ï¼Œå¼•å…¥&lt;code&gt;DllReferencePlugin&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const DllReferencePlugin = require(&#39;webpack/lib/DllReferencePlugin&#39;)
const AddAssetHtmlPlugin = require(&#39;add-asset-html-webpack-plugin&#39;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ’ä»¶é‡Œé¢é…ç½®(webpack4+)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;new DllReferencePlugin({
  context: __dirname,
  manifest: require(&#39;./dist/react.manifest.json&#39;),
}),
new AddAssetHtmlPlugin({
  filepath: path.resolve(__dirname, &#39;./dist/react.dll.js&#39;)
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·æ‰“åŒ…æ—¶é¡µé¢å°±ä¼šå¼•å…¥&lt;code&gt;react.dll.js&lt;/code&gt;èµ„æºäº†ï¼Œä»è€Œå‡å°‘é‡å¤çš„èµ„æºæ‰“åŒ…ã€‚è¿™ç§æ–¹å¼å¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼ŒæŠ½å‡ºå…¬å…±æ¨¡å—æ‰“åŒ…ï¼Œç„¶åå¼•å…¥&lt;/p&gt;

&lt;p&gt;3.&lt;code&gt;splitChunks&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;ä»¥å‰&lt;code&gt;webpack&lt;/code&gt;æ‹†åˆ†æ¨¡å—è¿˜ä¼šç”¨&lt;code&gt;CommonsChunkPlugin&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;webpack4&lt;/code&gt;åï¼Œå¯ä»¥ç›´æ¥ç”¨&lt;code&gt;splitChunks&lt;/code&gt;æ¥ä»£æ›¿å®Œæˆè¿™é¡¹å·¥ä½œï¼Œåœ¨&lt;code&gt;optimization&lt;/code&gt;é‡Œé¢è®¾ç½®äº†&lt;code&gt;splitChunks&lt;/code&gt;åï¼Œæ‰“åŒ…åˆ†å‰²å‡ºæ¥çš„æ–‡ä»¶æ˜¯é»˜è®¤å‹ç¼©è¿‡çš„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;splitChunks: {
  chunks: &amp;quot;async&amp;quot;, // &amp;quot;initial&amp;quot; | &amp;quot;all&amp;quot; | &amp;quot;async&amp;quot;ï¼Œå¯¹å“ªç§ä»£ç è¿›è¡Œåˆ†å‰²
  minSize: 30000, // è¶…è¿‡minSizeçš„åŒ…æ‰åšä»£ç åˆ†å‰²
  minChunks: 1, // ä¸€ä¸ªåŒ…è‡³å°‘è¢«ç”¨äº†å¤šå°‘æ¬¡çš„æ—¶å€™æ‰è¿›è¡Œä»£ç åˆ†å‰²
  maxAsyncRequests: 5, // æŒ‰éœ€åŠ è½½æœ€å¤šèƒ½åŠ è½½å¤šå°‘ä¸ªæ¨¡å—
  maxInitialRequests: 3, // å¯¹äºentryé‡Œé¢çš„æ–‡ä»¶åšä»£ç åˆ†å‰²æœ€å¤šèƒ½ç”Ÿæˆå¤šå°‘ä¸ªjsæ–‡ä»¶
  automaticNameDelimiter: &#39;~&#39;, // æ–‡ä»¶ç”Ÿæˆæ—¶çš„è¿æ¥ç¬¦
  name: true, // ä¸ºtrueçš„æ—¶å€™ï¼Œæ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶åç”±cacheGroupsé‡Œé¢è®¾ç½®çš„ä¸ºå‡†
  cacheGroups: {
    vendors: {
      test: /[\\/]node_modules[\\/]/, // åŒ¹é…å“ªäº›éœ€è¦åˆ†å‰²çš„æ¨¡å—
      priority: -10, // ä¼˜å…ˆçº§
     	filename: &#39;vendors.js&#39;// æ‰“åŒ…åˆ°ä¸€ä¸ªå«vendors.jsçš„æ–‡ä»¶
    },
    default: {
      minChunks: 2,
      priority: -20,
      reuseExistingChunk: true
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4.&lt;code&gt;catch-loader&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;åœ¨ä¸€äº›æ€§èƒ½å¼€é”€è¾ƒå¤§çš„&lt;code&gt;loader&lt;/code&gt;ä¹‹å‰æ·»åŠ æ­¤ &lt;code&gt;loader&lt;/code&gt;ï¼Œä»¥å°†ç»“æœç¼“å­˜åˆ°ç£ç›˜é‡Œï¼Œä¸åšè¿‡å¤šä»‹ç»&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;module.exports = {
  module: {
    rules: [
      {
        test: /\.ext$/,
        use: [
          &#39;cache-loader&#39;,
          ...loaders
        ],
        include: path.resolve(&#39;src&#39;)
      }
    ]
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;5.&lt;code&gt;HappyPack&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;HappyPack&lt;/code&gt;ä½¿ç”¨&lt;code&gt;node&lt;/code&gt;å¤šçº¿ç¨‹è¿›è¡Œæ„å»ºæ¥æå‡æ„å»ºçš„é€Ÿåº¦ï¼Œä½¿ç”¨æƒ…å†µè¾ƒå°‘&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const HappyPack = require(&#39;happypack&#39;)
const os = require(&#39;os&#39;)
const happyThreadPool = HappyPack.ThreadPool({
  size: os.cpus().length
})

......
plugins: [
  new HtmlWebPackPlugin({
    template: &#39;public/index.html&#39;,
    filename: &#39;index.html&#39;,
    inject: true
  }),
  new HappyPack({
    id: &#39;happyBabel&#39;,
    loaders: [{
      loader: &#39;babel-loader?cacheDirectory=true&#39;,
    }],
    threadPool: happyThreadPool,
    verbose: true,
  })
],
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;6.&lt;code&gt;css&lt;/code&gt;çš„å‹ç¼©&lt;/p&gt;

&lt;p&gt;å¯¹äº&lt;code&gt;scss&lt;/code&gt;æ–‡ä»¶ï¼Œä¸€èˆ¬æ¥è®²ï¼Œä¾æ¬¡é…ç½®&lt;code&gt;sass-loader&lt;/code&gt;ã€&lt;code&gt;css-loader&lt;/code&gt;ã€&lt;code&gt;style-loader&lt;/code&gt;æ¥è¿›è¡Œå¤„ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  test: /\.scss$/,
  use: [&#39;style-loader&#39;, &#39;css-loader&#39;, &#39;sass-loader&#39;]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€ååŠ è½½å®Œåçš„é¡µé¢&lt;code&gt;css&lt;/code&gt;ä¼šä»¥å†…è”æ ·å¼çš„å½¢å¼ç­¾å…¥åˆ°é¡µé¢ä¸­ã€‚åœ¨&lt;code&gt;webpack4&lt;/code&gt;ä¸­ä½¿ç”¨&lt;code&gt;mini-css-extract-plugin&lt;/code&gt;æ’ä»¶æ¥æå–ã€å‹ç¼©&lt;code&gt;css&lt;/code&gt;ã€‚é¦–å…ˆå°†&lt;code&gt;style-loade&lt;/code&gt;ç”¨&lt;code&gt;MiniCssExtractPlugin.loader&lt;/code&gt;ä»£æ›¿ï¼Œç„¶åä½¿ç”¨&lt;code&gt;MiniCssExtractPlugin&lt;/code&gt;æ’ä»¶ï¼Œæ‰“åŒ…å‡ºå¯¹åº”çš„æ–‡ä»¶ï¼Œå¹¶åœ¨é¡µé¢ä¸­å¼•å…¥å¯¹åº”çš„&lt;code&gt;css&lt;/code&gt;æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const MiniCssExtractPlugin = require(&#39;mini-css-extract-plugin&#39;)

......

{
  test: /\.scss$/,
  use: [MiniCssExtractPlugin.loader, &#39;css-loader&#39;, &#39;sass-loader&#39;]
}

new MiniCssExtractPlugin({
  filename: &#39;[name].[hash:5].css&#39;,
  chunkFilename: &#39;[id].[hash:5].css&#39;
})

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;7.å›¾ç‰‡çš„å¤„ç†&lt;/p&gt;

&lt;p&gt;åŒæ ·çš„ï¼Œå…ˆç”¨&lt;code&gt;file-loader&lt;/code&gt;è§£æå›¾ç‰‡ä¿è¯webpackèƒ½å¤„ç†ï¼Œç„¶åå¯ä»¥ç”¨&lt;code&gt;image-webpack-loader&lt;/code&gt;å‹ç¼©å›¾ç‰‡ï¼Œæˆ–è€…è¯´ç”¨&lt;code&gt;url-loader&lt;/code&gt;å°†å›¾ç‰‡è½¬ä¸º&lt;code&gt;base64&lt;/code&gt;ç¼–ç çš„å½¢å¼ï¼Œä¸å¤šèµ˜è¿°&lt;/p&gt;

&lt;p&gt;8.CDNåŠ é€Ÿ
é€šå¸¸åœ¨æ‰“åŒ…ä¸­ï¼ŒæŠŠä¸å˜çš„ä¸€äº›é™æ€æ–‡ä»¶æ”¾åˆ°&lt;code&gt;CDN&lt;/code&gt;ä¸Šï¼Œå¯ä»¥ç›´è§‚åœ°å‡å°èµ„æºåŒ…å¤§å°ï¼Œæ¯”å¦‚é¡¹ç›®ä¸­ç”¨åˆ°äº†&lt;code&gt;clipboard.js&lt;/code&gt;ï¼Œç„¶ååœ¨æ¨¡æ¿&lt;code&gt;html&lt;/code&gt;ä¸­å¼•å…¥è¿™ä¸ªæ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;&amp;lt;script src=&amp;quot;https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.6/clipboard.min.js&amp;quot; defer&amp;gt;&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸€èˆ¬æ¥è®²ï¼Œè¿™ç§æ–¹å¼å¼•å…¥jsé™æ€æ–‡ä»¶ï¼Œé‚£ä¹ˆå…¨å±€å¯¹è±¡(å¦‚window)é‡Œé¢æ˜¯ä¼šæœ‰å¯¹åº”çš„å¯¹è±¡çš„ï¼Œå°±å¯ä»¥ç›´æ¥å¼•ç”¨å¯¹åº”çš„å¯¹è±¡ã€‚å½“ç„¶è¿˜å¯ä»¥åŠ ä¸Š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;externals: {
  clipboard: &#39;clipboard&#39;
},
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å°±ä¿è¯äº†æ‰“åŒ…æ—¶ä¸æ‰“åŒ…&lt;code&gt;clipboard&lt;/code&gt;ï¼Œä¼˜åŒ–æ‰“åŒ…åçš„æ–‡ä»¶ä½“ç§¯&lt;/p&gt;

&lt;p&gt;è¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯æŠŠæ‰€æœ‰çš„é™æ€èµ„æºï¼Œå¦‚&lt;code&gt;js&lt;/code&gt;ã€&lt;code&gt;css&lt;/code&gt;éƒ½æ”¾åœ¨ç›¸åº”çš„&lt;code&gt;CDN&lt;/code&gt;ä¸Šï¼Œåœ¨æ‰“åŒ…çš„&lt;code&gt;config&lt;/code&gt;ä¸­æŒ‡å®šå¯¹åº”èµ„æºçš„&lt;code&gt;CDN&lt;/code&gt;åŸŸåï¼ŒåŒæ ·é…ç½®&lt;code&gt;externals&lt;/code&gt;ã€‚ä½†å…¶å®è¿™ç§æ–¹å¼æœ‰ä¸ªå¾ˆå¤§çš„ç¼ºç‚¹å°±æ˜¯ï¼Œå¦‚æœå…¨éƒ¨è¿™æ ·åšçš„è¯ï¼Œä¸‡ä¸€&lt;code&gt;CDN&lt;/code&gt;æŒ‚äº†ï¼Œæ•´ä¸ªé¡µé¢ä¹Ÿå°±æŒ‚äº†&lt;/p&gt;

&lt;p&gt;9.æŒ‰éœ€åŠ è½½&lt;/p&gt;

&lt;p&gt;ä»¥&lt;code&gt;react&lt;/code&gt;ä¸ºä¾‹ï¼Œä½¿ç”¨&lt;code&gt;react-loadable&lt;/code&gt;æ¥åšæŒ‰éœ€åŠ è½½ï¼Œä»¥å‰è¿˜æœ‰äº›å…¶å®ƒæ–¹æ³•è¿™é‡Œå°±ä¸èµ˜è¿°ã€‚ä¸»è¦æ˜¯é’ˆå¯¹&lt;code&gt;react-router&lt;/code&gt;åšä¸€ä¸ªå¤„ç†ï¼Œé¦–å…ˆå®‰è£…ä¾èµ–&lt;code&gt;react-loadable&lt;/code&gt;ï¼Œå…¥å£æ–‡ä»¶ä¸­å°è£…ä¸€ä¸ª&lt;code&gt;loading&lt;/code&gt;ç»„ä»¶ï¼Œç”¨äºé¡µé¢åŠ è½½æ—¶ç»™ä¸€ä¸ªæç¤ºï¼Œç„¶åå°è£…ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¼‚æ­¥åŠ è½½è¿™äº›ç»„ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;import Loadable from &#39;react-loadable&#39;
const Loading = (props) =&amp;gt; {
  return &amp;lt;div&amp;gt;è¿™æ˜¯ä¸€ä¸ªloadingç»„ä»¶&amp;lt;/div&amp;gt;
};
const asyncLoad = loader =&amp;gt; Loadable({
  loader,
  loading: Loading
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸‹æœ‰ä¸‰ä¸ªé¡µé¢ï¼Œ&lt;code&gt;index&lt;/code&gt;ã€&lt;code&gt;about&lt;/code&gt;ã€&lt;code&gt;user&lt;/code&gt;ï¼Œè°ƒç”¨&lt;code&gt;asyncLoad&lt;/code&gt;ï¼Œå¼•å…¥è¿™äº›æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const Index = asyncLoad(() =&amp;gt; import(&#39;./pages/index&#39;))
const About = asyncLoad(() =&amp;gt; import(&#39;./pages/about&#39;))
const User = asyncLoad(() =&amp;gt; import(&#39;./pages/user&#39;))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å†é…ç½®å¥½è·¯ç”±ï¼Œè¿™æ ·æ‰“åŒ…å‡ºæ¥çš„&lt;code&gt;js&lt;/code&gt;æ–‡ä»¶å°±åªä¼šåœ¨å¯¹åº”é¡µé¢æˆ–è€…è¯´å¯¹åº”è·¯ç”±å‘½ä¸­æ—¶åŠ è½½äº†ï¼Œä»è€Œæå‡é¡µé¢çš„ä¸€ä¸ªåŠ è½½é€Ÿåº¦ï¼Œå½“ç„¶ä¹ŸæŠŠæ‰“åŒ…å‡ºæ¥çš„jsæ–‡ä»¶è¿›ä¸€æ­¥çš„åˆ†å‰²ï¼Œå‡å°ä½“ç§¯ï¼Œå½“ç„¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦åœ¨&lt;code&gt;webpack.config&lt;/code&gt;é‡Œé¢é…ç½®å¥½&lt;code&gt;chunFilename(æŒ‰éœ€åŠ è½½çš„chunkåå­—)&lt;/code&gt;ï¼Œèµ„æºçš„&lt;code&gt;publickPath&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;&amp;lt;Router&amp;gt;
  &amp;lt;Switch&amp;gt;
  	&amp;lt;Route path=&amp;quot;/&amp;quot; exact component={Index} /&amp;gt;
    &amp;lt;Route path=&amp;quot;/about/&amp;quot; component={About} /&amp;gt;
    &amp;lt;Route path=&amp;quot;/users/&amp;quot; component={User} /&amp;gt;
  &amp;lt;/Switch&amp;gt;
&amp;lt;/Router&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;webpack.config.js&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;output: {
  path: path.resolve(__dirname, &#39;./dist/&#39;),
  filename: &#39;[name].[hash:5].bundle.js&#39;,
  chunkFilename: &#39;[name].[hash:5].bundle.js&#39;,
  publicPath: &#39;/&#39;
},
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Webpackç®€å•ç†è§£</title>
      <link>https://xtid.github.io/2020/webpack%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/</link>
      <pubDate>Sun, 23 Aug 2020 21:36:20 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/webpack%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3/</guid>
      <description>&lt;p&gt;&lt;code&gt;webpack&lt;/code&gt;æ˜¯ä¸€ä¸ªæ¨¡å—æ‰“åŒ…å™¨ï¼Œè€ä¸€ç‚¹çš„è¿˜æœ‰&lt;code&gt;gulp&lt;/code&gt;ã€&lt;code&gt;grunt&lt;/code&gt;ç­‰ç­‰ï¼Œ
ä»–æœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯å°†æ–‡ä»¶è§†ä¸ºä¸€ä¸ªä¸ªæ¨¡å—ï¼Œé€šè¿‡è®¾ç½®å…¥å£æ–‡ä»¶&lt;code&gt;entry&lt;/code&gt;ï¼ŒåŠ è½½ä¸åŒç±»å‹çš„æ–‡ä»¶ç”¨ä¸åŒ&lt;code&gt;loader&lt;/code&gt;è½¬æ¢æ–‡ä»¶ï¼Œ
ç„¶åä½¿ç”¨ä¸åŒ&lt;code&gt;plugin&lt;/code&gt;å¯¹æ–‡ä»¶å¤„ç†ï¼Œæœ€åè¾“å‡ºå¤šä¸ªæ‰“åŒ…ã€åˆ†å‰²åçš„æ–‡ä»¶&lt;/p&gt;

&lt;p&gt;é¦–å…ˆæœ‰å‡ ä¸ªæ¦‚å¿µ
1.entryï¼šå³&lt;code&gt;webpack&lt;/code&gt;æ‰“åŒ…çš„å…¥å£ï¼Œå‘Šè¯‰å®ƒåº”è¯¥ä»é‚£ä¸ªæ–‡ä»¶å¼€å§‹è¿›è¡Œæ„å»º
2.outputï¼šè®¾ç½®æ‰“åŒ…åæ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ä»¥åŠå¦‚ä½•å‘½åè¿™äº›æ–‡ä»¶
3.loaderï¼šå¤„ç†é‚£äº›é&lt;code&gt;javaScript&lt;/code&gt;æ–‡ä»¶ï¼Œé€šè¿‡æŒ‡å®šå¯¹åº”æ–‡ä»¶æ‰€éœ€çš„å¯¹åº”&lt;code&gt;loader&lt;/code&gt;çš„å¤„ç†ï¼Œå°†æ–‡ä»¶è½¬æ¢ä¸º&lt;code&gt;webpack&lt;/code&gt;èƒ½å¤Ÿå¤„ç†çš„æœ‰æ•ˆæ¨¡å—
4.pluginsï¼šè½¬æ¢æŸäº›ç±»å‹çš„æ¨¡å—ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥åšåˆ°æ‰“åŒ…ä¼˜åŒ–ï¼Œå‹ç¼©ä»¥åŠå„ç§å„æ ·çš„å…¶å®ƒä»»åŠ¡&lt;/p&gt;

&lt;p&gt;&lt;code&gt;bundle&lt;/code&gt;ï¼šè§†ä¸º&lt;code&gt;webpack&lt;/code&gt;æ‰“åŒ…æå–çš„æ¨¡å—ç”Ÿæˆçš„&lt;code&gt;js&lt;/code&gt;æ–‡ä»¶ï¼Œå°†å…¶å®ƒå…·ä½“æ¨¡å—çš„ä»£ç ä¼ å…¥å…¶ä¸­æ‰§è¡Œï¼ŒåŸæœ¬ç‹¬ç«‹çš„æ¨¡å—æ–‡ä»¶ï¼Œé€šè¿‡è°ƒç”¨&lt;code&gt;__webpack_require__&lt;/code&gt;ï¼Œåˆå¹¶åˆ°äº†&lt;code&gt;bundle&lt;/code&gt;ä¸­&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;(function(modules) {
/******/    var installedModules = {};
/******/
/******/    var installedChunks = {
/******/        2: 0
/******/    };
/******/
/******/    function __webpack_require__(moduleId) {
/******/
/******/        if(installedModules[moduleId]) {
/******/            return installedModules[moduleId].exports;
/******/        }
/******/        var module = installedModules[moduleId] = {
/******/            i: moduleId,
/******/            l: false,
/******/            exports: {}
/******/        };
/******/
/******/        modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/        module.l = true;
/******/
/******/        return module.exports;
/******/    }
/******/ })
/************************************************************************/
/******/ ({
	// ä¼ å…¥çš„æ¨¡å—
	......
});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰“åŒ…åçš„&lt;code&gt;bundle&lt;/code&gt;æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼Œå…¶å‚æ•°å°±æ˜¯æ‰“åŒ…åçš„æ¨¡å—ï¼Œä¸Šé¢&lt;code&gt;__webpack_require__&lt;/code&gt;æ–¹æ³•ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰æ¨¡å—&lt;code&gt;moduleId&lt;/code&gt;æ˜¯å¦å·²ç»å­˜åœ¨ç¼“å­˜&lt;code&gt;installedModules&lt;/code&gt;ä¸­ï¼Œè‹¥æ˜¯å­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚è‹¥æ˜¯ä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ„é€ ä¸€ä¸ªå¯¹è±¡å¹¶å°†å…¶åŒæ—¶å­˜åˆ°&lt;code&gt;installedModules&lt;/code&gt;ä¸­å’Œ&lt;code&gt;module&lt;/code&gt;ä¸­&lt;/p&gt;

&lt;p&gt;&lt;code&gt;modules[moduleId].call(module.exports, module, module.exports, __webpack_require__)&lt;/code&gt;
è¿™æ®µä»£ç é¦–å…ˆæ‰§è¡Œå½“å‰æ¨¡å—çš„å…·ä½“ä»£ç ï¼Œä¼ å…¥&lt;code&gt;module&lt;/code&gt;ï¼Œ&lt;code&gt;module.exports&lt;/code&gt;ï¼Œ&lt;code&gt;__webpack_require__&lt;/code&gt;ï¼Œé€’å½’è°ƒç”¨&lt;code&gt;__webpack_require__&lt;/code&gt;å¤„ç†æ¯ä¸ªæ¨¡å—ç§å¼•å…¥çš„å…¶å®ƒæ¨¡å—
å¦‚ä»¥ä¸‹å½¢å¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;/***/ 0:
/***/ (function(module, exports, __webpack_require__) {
	......
	__webpack_require__(1);
	module.exports = __webpack_require__(2);
	......

/***/ })
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸€ä¸ªç®€å•çš„bundleæ„å»ºè¿‡ç¨‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// å¼•å…¥ç›¸å…³ä¾èµ–ï¼Œå¯¹æ–‡ä»¶è¿›è¡Œç¼–è¯‘è½¬æ¢è¾“å‡ºå¤„ç†
const fs = require(&#39;fs&#39;);
const path = require(&#39;path&#39;);
const parse = require(&#39;@babel/parser&#39;);
const traverse = require(&#39;@babel/traverse&#39;).default;
const babel = require(&#39;@babel/core&#39;);


let ID = 0;
// è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼Œå¹¶è·å¾—å½“å‰jsæ–‡ä»¶çš„ä¾èµ–å…³ç³»
function createAsset(filename) {
  // è·å–æ–‡ä»¶ï¼Œè¿”å›å€¼æ˜¯å­—ç¬¦ä¸²
  const content = fs.readFileSync(filename, &#39;utf-8&#39;);

  // å°†å­—ç¬¦ä¸²è½¬ä¸ºast
  const ast = parse.parse(content, {
    sourceType: &#39;module&#39;
  });

  //ç”¨æ¥å­˜å‚¨ æ–‡ä»¶æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼Œå½“å‰jsæ–‡ä»¶ import äº†å“ªäº›æ–‡ä»¶ï¼Œéƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªæ•°ç»„é‡Œ
  const dependencies = [];

  //éå†å½“å‰astï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰
  traverse(ast, {
    //æ‰¾åˆ°æœ‰ importè¯­æ³• çš„å¯¹åº”èŠ‚ç‚¹
    ImportDeclaration: ({ node }) =&amp;gt; {
      //æŠŠå½“å‰ä¾èµ–çš„æ¨¡å—åŠ å…¥åˆ°æ•°ç»„ä¸­
      dependencies.push(node.source.value);
    }
  });

  //æ¨¡å—çš„id ä»0å¼€å§‹ï¼Œ ç›¸å½“ä¸€ä¸ªjsæ–‡ä»¶ å¯ä»¥çœ‹æˆä¸€ä¸ªæ¨¡å—
  const id = ID++;

  //è¿™è¾¹ä¸»è¦æŠŠES6 çš„ä»£ç è½¬æˆ ES5
  const { code } = babel.transformFromAstSync(ast, null, {
    presets: [&#39;@babel/preset-env&#39;]
  });

  return {
    id,
    filename,
    dependencies,
    code
  };
}

// ä»å…¥å£å¼€å§‹åˆ†ææ‰€æœ‰ä¾èµ–é¡¹ï¼Œå½¢æˆä¾èµ–å›¾ï¼Œé‡‡ç”¨å¹¿åº¦éå†
function createGraph(entry) {
  const mainAsset = createAsset(entry);
    
  const queue = [mainAsset];

  for (const asset of queue) {
    const dirname = path.dirname(asset.filename);
    // æ–°å¢ä¸€ä¸ªå±æ€§æ¥ä¿å­˜å­ä¾èµ–é¡¹çš„æ•°æ®
    asset.mapping = {};
    asset.dependencies.forEach(relativePath =&amp;gt; {
      const absolutePath = path.join(dirname, relativePath);
      //è·å¾—å­ä¾èµ–ï¼ˆå­æ¨¡å—ï¼‰çš„ä¾èµ–é¡¹ã€ä»£ç ã€æ¨¡å—idï¼Œæ–‡ä»¶å
      const child = createAsset(absolutePath);
      //ç»™å­ä¾èµ–é¡¹èµ‹å€¼ï¼Œ
      asset.mapping[relativePath] = child.id;
      //å°†å­ä¾èµ–ä¹ŸåŠ å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¿åº¦éå†
      queue.push(child);
    });
  }
  return queue;
}

//æ ¹æ®ç”Ÿæˆçš„ä¾èµ–å…³ç³»å›¾ï¼Œç”Ÿæˆå¯¹åº”ç¯å¢ƒèƒ½æ‰§è¡Œçš„ä»£ç ï¼Œç›®å‰æ˜¯ç”Ÿäº§æµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„
function bundle(graph) {
  let modules = &#39;&#39;;

  //å¾ªç¯ä¾èµ–å…³ç³»ï¼Œå¹¶æŠŠæ¯ä¸ªæ¨¡å—ä¸­çš„ä»£ç å­˜åœ¨functionä½œç”¨åŸŸé‡Œ
  graph.forEach(mod =&amp;gt; {
    modules += `${mod.id}:[
      function (require, module, exports){
        ${mod.code}
      },
      ${JSON.stringify(mod.mapping)},
    ],`;
  });

  //require, module, exports æ˜¯ cjsçš„æ ‡å‡†ä¸èƒ½å†æµè§ˆå™¨ä¸­ç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæ¨¡æ‹Ÿcjsæ¨¡å—åŠ è½½ï¼Œæ‰§è¡Œï¼Œå¯¼å‡ºæ“ä½œã€‚
  const result = `
    (function(modules){
      //åˆ›å»ºrequireå‡½æ•°ï¼Œ å®ƒæ¥å—ä¸€ä¸ªæ¨¡å—IDï¼ˆè¿™ä¸ªæ¨¡å—idæ˜¯æ•°å­—0ï¼Œ1ï¼Œ2ï¼‰ ï¼Œå®ƒä¼šåœ¨æˆ‘ä»¬ä¸Šé¢å®šä¹‰ modules ä¸­æ‰¾åˆ°å¯¹åº”æ˜¯æ¨¡å—.
      function __webpack_require__(id){
        const [fn, mapping] = modules[id];
        function localRequire(relativePath){
          //æ ¹æ®æ¨¡å—çš„è·¯å¾„åœ¨mappingä¸­æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—id
          return __webpack_require__(mapping[relativePath]);
        }
        const module = {exports:{}};
        //æ‰§è¡Œæ¯ä¸ªæ¨¡å—çš„ä»£ç ã€‚
        fn(localRequire,module,module.exports);
        return module.exports;
      }
      //æ‰§è¡Œå…¥å£æ–‡ä»¶ï¼Œ
      __webpack_require__(0);
    })({${modules}})
  `;

  return result;
}

// å…¥å£æ–‡ä»¶
const graph = createGraph(&#39;./entry.js&#39;);
// æ–‡ä»¶å†…å®¹
const ret = bundle(graph);

// æ‰“åŒ…ç”Ÿæˆæ–‡ä»¶
fs.writeFileSync(&#39;./bundle.js&#39;, ret);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;loader&lt;/code&gt;ï¼Œé€šè¿‡è®¾ç½®å¯¹åº”çš„&lt;code&gt;rule&lt;/code&gt;ï¼Œä½¿ç”¨ä¸åŒçš„&lt;code&gt;loader&lt;/code&gt;æ¥è½¬æ¢ã€å¤„ç†ä¸åŒçš„ç»„ä»¶ï¼Œæ¯”å¦‚&lt;code&gt;css&lt;/code&gt;æ–‡ä»¶ä½¿ç”¨&lt;code&gt;css-loader&lt;/code&gt;ä»¥åŠ&lt;code&gt;style-loader&lt;/code&gt;æ¥å¤„ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  test: /\.css$/,
  loader: &#39;style-loader!css-loader&#39;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§å†…è”&lt;code&gt;loader&lt;/code&gt;çš„å½¢å¼ï¼Œå³&lt;code&gt;import loader from &#39;......&#39;&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;ä¸¤ç§æ–¹å¼å¤„ç†çš„é¡ºåºä¹Ÿä¸åŒï¼Œå¤§è‡´æµç¨‹ä¸º
1.&lt;code&gt;webpack&lt;/code&gt;å¯åŠ¨åï¼Œåˆ›å»ºæ–°çš„&lt;code&gt;compilation&lt;/code&gt;
2.å®ä¾‹åŒ–&lt;code&gt;rules&lt;/code&gt;
3.è§£æ&lt;code&gt;inline loaders&lt;/code&gt;
4.è§£æ&lt;code&gt;config&lt;/code&gt;é…ç½®é‡Œé¢çš„&lt;code&gt;loaders&lt;/code&gt;
5.ç»„åˆè¿™ä¸¤ç§å½¢å¼çš„&lt;code&gt;loader&lt;/code&gt;ï¼Œæœ€ç»ˆè¾“å‡ºä¸Šè¯‰ç¬¬ä¸€ç§å½¢å¼çš„é…ç½®
6.ä½¿ç”¨&lt;code&gt;Loader-runner&lt;/code&gt;æŒ‰é…ç½®æ‰§è¡Œ&lt;code&gt;loader&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹ç®€å•å†™ä¸€ä¸ª&lt;code&gt;loader&lt;/code&gt;ï¼Œé¦–å…ˆå†™ä¸€ä¸ªæ–¹æ³•ç”¨äºåŠ è½½&lt;code&gt;loader&lt;/code&gt;ï¼Œå¹¶å¤„ç†ä¼ å…¥çš„æ¨¡å—ï¼Œç„¶åè¿”å›å¤„ç†å®Œäº†ä¹‹åçš„ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;let source = ...... // sourceä¸ºè·å–åˆ°çš„æ¨¡å—çš„ä»£ç 
function loaderModule(loaderName) {
  // è·å–loaderè·¯å¾„
  const loaderPath = path.join(process.cwd(), loaderName)
  const loader = require(loaderPath)
  source = loader.call(_this, source)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®šä¹‰ä¸€ä¸ªè§„åˆ™&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;rules: [{
  test:/\.js/,
  use:[
    &#39;./loaderModule.js&#39;, // loaderçš„è·¯å¾„
  ]
}]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰§è¡Œçš„æ—¶å€™éå†&lt;code&gt;rules&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;for (let i = rules.length - 1; i &amp;gt;= 0; i--) {
  const { test, use } = rules[i]
  if (test.test(modulePath)) {
    // ä½¿ç”¨å¤šä¸ªloader
    if (Array.isArray(use)) {
      for (let j = use.length - 1; j &amp;gt;= 0; j--) {
        loaderModule(use[j])
      }
    } else if (typeof use === &#39;string&#39;) {
      loaderModule(use)
      // å¸¦å‚æ•°å‹çš„loader
    } else if (use instanceof Object) {
      loaderModule(use.loader, {
        query: use.options
      })
    }
  }
}

// loaderModule.jså†…å®¹
// loader-utilsæ˜¯webpackä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºè§£æloaderï¼Œè·å–é…ç½®çš„ä¸€äº›loaderå‚æ•°
const loaderUtils = require(&#39;loader-utils&#39;)

// è¿™ä¸ªç®€å•çš„loaderä¼šå°†jsæ–‡ä»¶é‡Œé¢çš„helloå­—ç¬¦ä¸²æ›¿æ¢æˆword
module.exports = function (source) {
  const optionsName = loaderUtils.getOptions(this) &amp;amp;&amp;amp; loaderUtils.getOptions(this).name || &#39;world&#39;
  return source.replace(/hello/g, optionsName)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‰é¢æ˜¯ä¸€ä¸ªåŒæ­¥çš„&lt;code&gt;loader&lt;/code&gt;ï¼Œå¦‚æœæƒ³å†™ä¸€ä¸ªå¼‚æ­¥çš„&lt;code&gt;loader&lt;/code&gt;ï¼Œå¯ä»¥åœ¨&lt;code&gt;loader&lt;/code&gt;å†…éƒ¨è°ƒç”¨&lt;code&gt;async&lt;/code&gt;æ–¹æ³•ï¼Œç„¶ååœ¨å¤„ç†ä¹‹åè°ƒç”¨å¯¹åº”çš„å›è°ƒæ–¹æ³•å¤„ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;module.exports = function (source) {
  const optionsName = loaderUtils.getOptions(this) &amp;amp;&amp;amp; loaderUtils.getOptions(this).name || &#39;world&#39;
  cosnt callback = this.async()

  // æ“ä½œå®Œäº†ä¹‹åï¼Œè°ƒç”¨callbackè¿”å›ç»“æœè¿›å…¥ä¸‹ä¸€ä¸ªloader
  asyncOperation(source, optionsName, function(err, result) {
    ifï¼ˆerrï¼‰return callback(err)
    callback(err, result)
  })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœä¸ç”¨ä¸Šé¢çš„æ–¹å¼ï¼Œè¿”å›ä¸€ä¸ª&lt;code&gt;promise&lt;/code&gt;ä¹Ÿæ˜¯å¯ä»¥çš„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;module.exports = function (source) {
  const optionsName = loaderUtils.getOptions(this) &amp;amp;&amp;amp; loaderUtils.getOptions(this).name || &#39;world&#39;
  return new Promise(resolve =&amp;gt; {
    asyncOperation(source, function(err, result) {
      if (err) resolve(err)
      resolve(err, result)
    })
  })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;plugin&lt;/code&gt;
&lt;code&gt;plugin&lt;/code&gt;è¿›ä¸€æ­¥æ‹“å±•äº†&lt;code&gt;webpack&lt;/code&gt;çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ‰“åŒ…ä¼˜åŒ–å’Œå‹ç¼©ï¼Œæ¸…ç©ºå½“å‰é¡¹ç›®çš„ç›®å½•ï¼Œé‡æ–°å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œå°†ä»£ç è¾“å‡ºåˆ°æŸä¸ªæ–‡ä»¶ï¼Œæå–åŠŸèƒ½æ¨¡å—ç­‰ç­‰&lt;/p&gt;

&lt;p&gt;å®šä¹‰ä¸€ä¸ª&lt;code&gt;plugin&lt;/code&gt;çš„æ—¶å€™ï¼Œé¦–å…ˆè¦æä¾›ä¸€ä¸ª&lt;code&gt;apply&lt;/code&gt;æ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ª&lt;code&gt;compiler&lt;/code&gt;å¯¹è±¡ï¼Œç„¶åæ³¨å†Œå¯¹åº”çš„é’©å­å‡½æ•°ï¼Œåœ¨å›è°ƒé‡Œé¢æ‹¿åˆ°å¯¹åº”å‚æ•°ï¼Œç„¶åå¤„ç†
ä»¥ä¸‹å®šä¹‰ä¸€ä¸ª&lt;code&gt;plugin&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const path = require(&#39;path&#39;)
const fs = require(&#39;fs&#39;)
const cheerio = require(&#39;cheerio&#39;)

class BasePlugin {
  constructor(options){
    // æ’ä»¶çš„å‚æ•°ï¼Œfilenameã€templateç­‰
    this.options = options
  }
  apply(compiler) {
    // æ³¨å†ŒafterEmité’©å­å‡½æ•°
    compiler.hooks.afterEmit.tap(&#39;BasePlugin&#39;, (compilation) =&amp;gt; {
      // 2. æ ¹æ®æ¨¡æ¿è¯»å–htmlæ–‡ä»¶å†…å®¹
      const result = fs.readFileSync(this.options.template, &#39;utf-8&#39;)
      
      // 3. ä½¿ç”¨ cheerio æ¥åˆ†æ HTML
      let $ = cheerio.load(result)
    
      // 4. åˆ›å»º script æ ‡ç­¾åæ’å…¥HTMLä¸­
      // compilation.assetsä»£è¡¨æ‰€æœ‰è¾“å‡ºçš„èµ„æºæ–‡ä»¶
      Object.keys(compilation.assets).forEach(item =&amp;gt; {
        $(`&amp;lt;script src=&amp;quot;/${item}&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;`).appendTo(&#39;body&#39;)
      })
    
      // 5. è½¬æ¢æˆæ–°çš„HTMLå¹¶å†™å…¥åˆ° dist ç›®å½•ä¸­
      fs.writeFileSync(path.join(process.cwd(), &#39;dist&#39;, this.options.filename), $.html())
    })
  } 
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;compiler&lt;/code&gt;å¯¹è±¡åŒ…å«äº†&lt;code&gt;webpack&lt;/code&gt;ç¯å¢ƒæ‰€æœ‰çš„çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«&lt;code&gt;options&lt;/code&gt;ï¼Œ&lt;code&gt;loaders&lt;/code&gt;ï¼Œ&lt;code&gt;plugins&lt;/code&gt;è¿™äº›ä¿¡æ¯ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨&lt;code&gt;webpack&lt;/code&gt;å¯åŠ¨æ—¶å€™è¢«å®ä¾‹åŒ–ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£ä¸º&lt;code&gt;webpack&lt;/code&gt;å®ä¾‹ï¼Œ&lt;code&gt;compilation&lt;/code&gt;å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ç­‰ã€‚å½“&lt;code&gt;webpack&lt;/code&gt;ä»¥å¼€å‘æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œ&lt;code&gt;compilation&lt;/code&gt;å°±ä¼šè¢«é‡æ–°æ„å»ºï¼Œå…¶å®ƒçš„ä¸€äº›&lt;a href=&#34;https://www.webpackjs.com/api/compiler-hooks/#hooks&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;é’©å­å‡½æ•°&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;é¡ºä¾¿æ€»ç»“ä¸€ä¸‹ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„&lt;code&gt;webpack&lt;/code&gt;çš„æ­¥éª¤
1.å®šä¸€ä¸ªåŸºç¡€å¯¹è±¡ï¼Œæ„é€ æ–¹æ³•é‡Œé¢ä¼ å…¥&lt;code&gt;entry&lt;/code&gt;ã€&lt;code&gt;output&lt;/code&gt;ã€&lt;code&gt;rules&lt;/code&gt;ã€&lt;code&gt;plugins&lt;/code&gt;ç­‰å±æ€§
2.ç„¶åå®šä¹‰ä¸€ç³»åˆ—é’©å­å‡½æ•°ï¼Œåœ¨&lt;code&gt;webpack&lt;/code&gt;æ‰§è¡Œä¸­å¯ä»¥è°ƒç”¨è¿™äº›é’©å­å‡½æ•°åšå¤„ç†ï¼Œ
3.å¼€å§‹æ‰§è¡Œï¼Œåˆå§‹åŒ–å¯¹åº”çš„é’©å­å‡½æ•°ï¼Œä¼ å…¥&lt;code&gt;entry&lt;/code&gt;ç­‰ç›¸å…³ä¿¡æ¯
4.æ‹¿åˆ°æ–‡ä»¶æºç ä¿¡æ¯ï¼Œä½¿ç”¨&lt;code&gt;loader&lt;/code&gt;å¤„ç†ï¼Œå°†ä»£ç è½¬æ¢æˆ&lt;code&gt;ast&lt;/code&gt;å½¢å¼
5.&lt;code&gt;traverse&lt;/code&gt;å°†&lt;code&gt;ast&lt;/code&gt;ä»£ç ä¸­çš„&lt;code&gt;require&lt;/code&gt;æ›¿æ¢ä¸º&lt;code&gt;__webpack_require__&lt;/code&gt;ï¼Œæ·»åŠ æ–°çš„&lt;code&gt;module&lt;/code&gt;ä¿¡æ¯
6.é€’å½’å¤„ç†æ¯ä¸€ä¸ªä¾èµ–ï¼Œé‡å¤ä¸Šé¢çš„æ­¥éª¤
7.åˆå§‹åŒ–&lt;code&gt;plugin&lt;/code&gt;ï¼Œå¹¶å¯¹æ–‡ä»¶åšå¤„ç†
8.è¾“å…¥åˆ°æŒ‡å®šç›®å½•
9.å®¢æˆ·ç«¯/æµè§ˆå™¨è¿è¡Œæ—¶æ‰§è¡Œ&lt;/p&gt;

&lt;p&gt;å‚è€ƒé“¾æ¥&lt;/p&gt;

&lt;p&gt;1.&lt;a href=&#34;https://juejin.im/post/6844903957769224206&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;webpackåŸç†&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2.&lt;a href=&#34;https://www.webpackjs.com/&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;webpackå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Babelç®€ä»‹</title>
      <link>https://xtid.github.io/2020/babel%E7%AE%80%E4%BB%8B/</link>
      <pubDate>Sun, 23 Aug 2020 21:32:52 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/babel%E7%AE%80%E4%BB%8B/</guid>
      <description>

&lt;h3 id=&#34;1-babel-ç®€ä»‹&#34;&gt;1.babel ç®€ä»‹&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;Babelæ˜¯ç°ä»£JavaScriptè¯­æ³•è½¬æ¢å™¨ï¼Œä¸»è¦ç”¨äºå°† ECMAScript 2015+ ç‰ˆæœ¬çš„ä»£ç è½¬æ¢ä¸ºå‘åå…¼å®¹çš„ JavaScript è¯­æ³•ï¼Œä»¥ä¾¿èƒ½å¤Ÿè¿è¡Œåœ¨å½“å‰å’Œæ—§ç‰ˆæœ¬çš„æµè§ˆå™¨æˆ–å…¶ä»–ç¯å¢ƒä¸­ï¼ŒåŒ…æ‹¬ä¸é™äº: eslint jsx vue-templateç­‰ç­‰ã€‚ä»–èƒ½ä¸ºä½ åšçš„ï¼šè¯­æ³•è½¬æ¢ã€é€šè¿‡ Polyfill æ–¹å¼åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ·»åŠ ç¼ºå¤±çš„ç‰¹æ€§ã€æºç è½¬æ¢ã€‚å¯ä»¥è¯´ï¼Œé€šè¿‡babelï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€æ–°çš„è¯­æ³•æˆ–è€…ç‰¹æ€§ä¸“æ³¨çš„å¼€å‘ä¸šåŠ¡ï¼Œè€Œä¸ç”¨å°†ç²¾åŠ›èŠ±åœ¨ä»£ç çš„å…¼å®¹ä¸Š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;2-babelçš„è§£ææµç¨‹&#34;&gt;2.babelçš„è§£ææµç¨‹&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/xtid/blog/blob/master/static/img/deal_process.png&#34; alt=&#34;babelå¤„ç†æµç¨‹&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;2-1è¯æ³•è§£æ&#34;&gt;2.1è¯æ³•è§£æ&lt;/h4&gt;

&lt;p&gt;é¦–å…ˆç”±å…¥å£æ–‡ä»¶&lt;code&gt;@babel/core&lt;/code&gt;å¼•å…¥å„ç§é…ç½®æ–‡ä»¶ä»¥åŠè§£æçš„æ¨¡å—ï¼Œå…¶ä¸­è´Ÿè´£è§£æåŸºæœ¬è¯­æ³•çš„ä¸º&lt;code&gt;parse&lt;/code&gt;æ¨¡å—ï¼Œå…¶ä¸­å°±å®šä¹‰äº†&lt;code&gt;è¯æ³•è§£æå™¨Tokenizer&lt;/code&gt;ï¼Œå¯ä»¥çœ‹å‡ºåˆå§‹åŒ–æ—¶ä¼šæœ‰ä¸€ä¸ª&lt;code&gt;tokens&lt;/code&gt;æ•°ç»„ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¼šæŠŠå­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œ&lt;code&gt;tokenså¯ä»¥è§†ä¸ºç”±æ‹†åˆ†ä¸ºå„ä¸ªç‰‡æ®µç»„æˆçš„æ•°ç»„&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;class Tokenizer extends LocationParser {
  constructor(options, input) {
    super();
    this.tokens = [];
    this.state = new State();
    this.state.init(options);
    this.input = input;
    this.length = input.length;
    this.isLookahead = false;
  }
	
  ....
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;Tokenizer&lt;/code&gt;å®šä¹‰ä¸­è¿˜æœ‰ä¸€äº›å…¶å®ƒçš„æ–¹æ³•ï¼Œä»–ä»¬ä¼šå¯¹å„ç§è¯­æ³•å­—ç¬¦ä¸²è¿›è¡Œä¸€ä¸ªéå†è¿‡æ»¤ï¼Œæ¯”å¦‚è·³è¿‡ç©ºæ ¼å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚è·³è¿‡æ³¨é‡Šç­‰ç­‰&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;skipSpace() {
  loop: while (this.state.pos &amp;lt; this.length) {
    const ch = this.input.charCodeAt(this.state.pos);
    .
    .
    .
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åä¼šæŠŠç¬¦åˆè§„åˆ™çš„è¯­æ³•å­—ç¬¦ä¸²åŠ å…¥åˆ°&lt;code&gt;tokens&lt;/code&gt;æ•°ç»„ä¸­ï¼Œä¹Ÿå°±ç”Ÿæˆä»£ç æ‹†åˆ†ä¸ºå„ä¸ªç‰‡æ®µç»„æˆçš„æ•°ç»„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;pushToken(token) {
  this.tokens.length = this.state.tokensLength;
  this.tokens.push(token);
  ++this.state.tokensLength;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;console.log(&#39;æˆ‘æ˜¯ä¸€æ®µè¯­æ³•&#39;) =&amp;gt; [&#39;console&#39;, &#39;log&#39;, &#39;(&#39;, &#39;&amp;quot;æˆ‘æ˜¯ä¸€æ®µè¯­æ³•&amp;quot;&#39;, &#39;)&#39;]
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;2-2è¯­æ³•è§£æ&#34;&gt;2.2è¯­æ³•è§£æ&lt;/h4&gt;

&lt;p&gt;å½“ç”Ÿæˆå®Œ&lt;code&gt;tokens&lt;/code&gt;ï¼Œåˆ™è¿›å…¥åˆ°è¯­æ³•è§£æé˜¶æ®µï¼ŒåŒæ ·å¯ä»¥çœ‹è§åœ¨&lt;code&gt;parse&lt;/code&gt;æ¨¡å—ä¸­å®šä¸€ä¸ªäº†ä¸€ä¸ª&lt;code&gt;Node&lt;/code&gt;å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€äº›å±æ€§ï¼Œå½“ç„¶è¿˜æœ‰ä¸ªç§æœ‰çš„&lt;code&gt;_clone&lt;/code&gt;æ–¹æ³•ï¼Œç”¨äºè¡¨ç¤ºå°†è¦ç”Ÿæˆçš„&lt;code&gt;AST&lt;/code&gt;ä¸­èŠ‚ç‚¹çš„ä½ç½®ã€åç§°ã€ç±»å‹ç­‰ç­‰ä¿¡æ¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;class Node {
  constructor(parser, pos, loc) {
    this.type = &amp;quot;&amp;quot;;
    this.start = pos;
    this.end = 0;
    this.loc = new SourceLocation(loc);
    if (parser &amp;amp;&amp;amp; parser.options.ranges) this.range = [pos, 0];
    if (parser &amp;amp;&amp;amp; parser.filename) this.loc.filename = parser.filename;
  }

  __clone() {
    .
    .
    .
  }

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åä¼šå®šä¹‰ç›¸åº”çš„&lt;code&gt;Parse&lt;/code&gt;ï¼Œéå†å¤„ç†ä¸åŒçš„&lt;code&gt;tokens&lt;/code&gt;å­—æ®µï¼Œæ¯”å¦‚&lt;code&gt;ImportDeclaration&lt;/code&gt;ç”¨äºimportè¯­æ³•ï¼Œå¯¼å…¥æ¨¡å—ï¼›&lt;code&gt;VariableDeclarator&lt;/code&gt;ç”¨äºå¤„ç†è¡¨ç¤ºæ˜¯ä»€ä¹ˆç±»å‹çš„å˜é‡å£°æ˜ï¼Œæ¯”å¦‚&lt;code&gt;varã€letã€const&lt;/code&gt;ï¼›&lt;code&gt;FunctionDeclaration&lt;/code&gt;ç”¨äºå¤„ç†å‡½æ•°å£°æ˜ï¼Œéå‡½æ•°è¡¨è¾¾å¼ï¼Œå…¶å®ƒçš„å°±ä¸å¤šèµ˜è¿°ã€‚æœ€ååˆ™ä¼šå°†è¿™ä¸ªè¯æ³•æ•°ç»„è½¬æ¢ä¸º&lt;code&gt;AST(æŠ½è±¡è¯­æ³•æ ‘)&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;var add = function(a, b) {
  return  a + b
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åç”Ÿæˆçš„&lt;code&gt;AST&lt;/code&gt;ç®€æ˜“ç‰ˆæœ¬å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  &amp;quot;type&amp;quot;: &amp;quot;Program&amp;quot;,
  &amp;quot;body&amp;quot;: [{
    &amp;quot;type&amp;quot;: &amp;quot;VariableDeclaration&amp;quot;,
    &amp;quot;identifierName&amp;quot;: &amp;quot;add&amp;quot;,
    &amp;quot;init&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;ArrowFunctionExpression&amp;quot;,
      &amp;quot;params&amp;quot;: [{
          &amp;quot;type&amp;quot;: &amp;quot;identifier&amp;quot;,
          &amp;quot;identifierName&amp;quot;: &amp;quot;a&amp;quot;
        },
        {
          &amp;quot;type&amp;quot;: &amp;quot;identifier&amp;quot;,
          &amp;quot;identifierName&amp;quot;: &amp;quot;b&amp;quot;
        }
      ],
      &amp;quot;body&amp;quot;: {
        &amp;quot;type&amp;quot;: &amp;quot;BinaryExpression&amp;quot;,
        &amp;quot;left&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;identifier&amp;quot;,
          &amp;quot;identifierName&amp;quot;: &amp;quot;a&amp;quot;
        },
        &amp;quot;operator&amp;quot;: &amp;quot;+&amp;quot;,
        &amp;quot;right&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;identifier&amp;quot;,
          &amp;quot;identifierName&amp;quot;: &amp;quot;b&amp;quot;
        }
      }
    }
  }]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºè¿™ä¸ªè¯­æ³•æ ‘åŒ…å«äº†æ•´ä¸ªè¯­æ³•çš„ä¸€ä¸ªå±‚çº§å…³ç³»ï¼Œå¹¶ä¸”æ ‡æ³¨äº†ä»–ä»¬çš„åç§°ã€ç±»å‹ä»¥åŠä½ç½®&lt;/p&gt;

&lt;h4 id=&#34;2-3traverser&#34;&gt;2.3Traverser&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;Traverser&lt;/code&gt;ä¼šå¯¹ç”Ÿæˆå¥½&lt;code&gt;AST&lt;/code&gt;è¿›è¡Œä¸€ä¸ªéå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€åˆ é™¤ç­‰ç­‰æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯å…¶ä»–æ’ä»¶å°†è¦å¤„ç†çš„åœ°æ–¹ï¼Œé€šè¿‡è¿™äº›æ’ä»¶ï¼Œä¹Ÿå¯ä»¥å¤„ç†ä¸åŒçš„&lt;code&gt;AST&lt;/code&gt;è¯­æ³•æ ‘ï¼Œç„¶åè½¬æ¢ç¬¦åˆç›¸åº”è§„åˆ™çš„ä»£ç ï¼Œæ¯”å¦‚&lt;code&gt;Taro&lt;/code&gt;ï¼Œå°±å¯ä»¥è§†ä¸ºå°†&lt;code&gt;React&lt;/code&gt;ä»£ç è½¬æ¢æˆå°ç¨‹åºå¯¹åº”ä»£ç çš„ä¸€ä¸ªæ’ä»¶ã€‚&lt;code&gt;Traverser&lt;/code&gt;ä¸­ä¼šå¼•å…¥&lt;code&gt;visitors&lt;/code&gt;ï¼Œç”¨å®ƒæ¥è¿›è¡Œä¸€ä¸ªæ·±åº¦éå†æ“ä½œï¼›&lt;code&gt;Path&lt;/code&gt;ç”¨äºå…³è”å„ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ ·ä½¿å¾—èŠ‚ç‚¹æ“ä½œç®€å•ï¼Œä¾‹å¦‚ï¼š&lt;/p&gt;

&lt;p&gt;ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä¸‹é¢è¿™æ ·ä¸€ä¸ªèŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ï¸°&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  type: &amp;quot;ArrowFunctionExpression&amp;quot;,
  id: {
    type: &amp;quot;Identifier&amp;quot;,
    name: &amp;quot;a&amp;quot;
  },
  ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†å­èŠ‚ç‚¹ &lt;code&gt;Identifier&lt;/code&gt; è¡¨ç¤ºä¸ºä¸€ä¸ªè·¯å¾„ï¼ˆPathï¼‰çš„è¯ï¼Œçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  &amp;quot;parent&amp;quot;: {
    &amp;quot;type&amp;quot;: &amp;quot;ArrowFunctionExpression&amp;quot;,
    &amp;quot;id&amp;quot;: {...},
    ....
  },
  &amp;quot;node&amp;quot;: {
    &amp;quot;type&amp;quot;: &amp;quot;Identifier&amp;quot;,
    &amp;quot;name&amp;quot;: &amp;quot;a&amp;quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;Scope&lt;/code&gt;ç”¨æ¥è¡¨ç¤ºæ ‘ä¸­å„ä¸ªèŠ‚ç‚¹çš„ä¸€ä¸ªä½œç”¨åŸŸå…³ç³»ï¼Œå°±å¥½åƒ&lt;code&gt;js&lt;/code&gt;è¯­æ³•ä¸­ï¼Œåˆ›å»ºå˜é‡ã€å‡½æ•°æ—¶æ‰€å‘ˆç°çš„ä¸€ä¸ªä½œç”¨åŸŸæ•ˆæœï¼Œåœ¨&lt;code&gt;babel&lt;/code&gt;ä¸­ï¼Œæ–°æ·»åŠ çš„å¼•ç”¨æˆ–è€…å˜é‡åï¼Œ&lt;code&gt;Scope&lt;/code&gt;è¡¨ç¤ºçš„æ—¶å€™éœ€è¦ä½“ç°å‡ºèŠ‚ç‚¹çš„è·¯å¾„ï¼ŒèŠ‚ç‚¹é—´çš„å…³ç³»ï¼Œå¦‚ä»¥ä¸‹å½¢å¼:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;{
  path: path,
  block: path.node,
  parentBlock: path.parent,
  parent: parentScope,
  bindings: [...]
  .
  .
  .
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿˜æœ‰ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µ&lt;code&gt;Bindings&lt;/code&gt;ï¼Œ&lt;code&gt;Bindings&lt;/code&gt;å¯ä»¥è·å–å½“å‰ä½œç”¨åŸŸä¸‹æ‰€æœ‰çš„æ ‡è¯†ç¬¦ï¼Œå…¶è¿”å›çš„ä¿¡æ¯åŒ…æ‹¬èŠ‚ç‚¹çš„&lt;code&gt;æ ‡è¯†ç¬¦&lt;/code&gt;ã€&lt;code&gt;scope&lt;/code&gt;ã€&lt;code&gt;path&lt;/code&gt;ã€&lt;code&gt;å¼•ç”¨&lt;/code&gt;ç­‰ç­‰ä¿¡æ¯ï¼Œé€šè¿‡å¯¹è¿™äº›å±æ€§çš„æ“ä½œï¼Œè¾¾åˆ°å¯¹èŠ‚ç‚¹ä¿¡æ¯çš„ä¸€ä¸ªæ›´æ”¹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export class Binding {
  identifier: t.Identifier;
  scope: Scope;
  path: NodePath;
  kind: &amp;quot;var&amp;quot; | &amp;quot;let&amp;quot; | &amp;quot;const&amp;quot; | &amp;quot;module&amp;quot;;
  referenced: boolean;
  references: number;              // è¢«å¼•ç”¨çš„æ•°é‡
  referencePaths: NodePath[];      // è·å–æ‰€æœ‰åº”ç”¨è¯¥æ ‡è¯†ç¬¦çš„èŠ‚ç‚¹è·¯å¾„
  constant: boolean;               // æ˜¯å¦æ˜¯å¸¸é‡
  constantViolations: NodePath[];
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;2-4transform&#34;&gt;2.4Transform&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;transform&lt;/code&gt;ä¼šå¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œåˆä¸€æ¬¡éå†ï¼Œé’ˆå¯¹å·²ç»å¤„ç†å¥½çš„&lt;code&gt;AST&lt;/code&gt;åšè¿›ä¸€æ­¥å¤„ç†ï¼Œå¦‚å¯¹ä»£ç çš„æ›´æ”¹ï¼Œå¯¹èŠ‚ç‚¹çš„æ“ä½œã€èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥ã€å‹ç¼©ä»£ç ã€åˆ é™¤æ³¨é‡Šç­‰ç­‰ã€‚å¾—åˆ°æœ€ç»ˆçš„ä¸€ä¸ª&lt;code&gt;AST&lt;/code&gt;&lt;/p&gt;

&lt;h4 id=&#34;2-5ç”Ÿæˆä»£ç &#34;&gt;2.5ç”Ÿæˆä»£ç &lt;/h4&gt;

&lt;p&gt;å¾—åˆ°ä¸Šä¸€æ­¥ç”Ÿæˆçš„&lt;code&gt;AST&lt;/code&gt;ä¹‹åï¼Œä¼šè°ƒç”¨å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ä»£ç ï¼Œé€šè¿‡é€’å½’éå†ç”Ÿæˆæœ€ç»ˆçš„ä»£ç ï¼Œå…¶ä¸­é‡åˆ°ä¸åŒçš„èŠ‚ç‚¹ç±»å‹æ—¶ï¼Œä¼šåšä¸åŒçš„å¤„ç†ï¼Œæ¯”å¦‚å‡½æ•°ç±»å‹ã€å‚æ•°å®šä¹‰ç±»å‹ã€ä»£ç å—ç±»å‹ç­‰ç­‰&lt;/p&gt;

&lt;h3 id=&#34;3-babelé‡Œé¢çš„ä¸€äº›ä¾èµ–åŒ…&#34;&gt;3.babelé‡Œé¢çš„ä¸€äº›ä¾èµ–åŒ…&lt;/h3&gt;

&lt;h4 id=&#34;3-1-babel-core&#34;&gt;3.1@babel/core&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;@babel/core&lt;/code&gt;æ•´ä¸ª&lt;code&gt;babel&lt;/code&gt;çš„ä¸€ä¸ªæ ¸å¿ƒï¼Œä¹Ÿç®—æ˜¯&lt;code&gt;babel&lt;/code&gt;çš„ä¸€ä¸ªå…¥å£ï¼Œå®ƒä¼šåŠ è½½å’Œå¤„ç†ç”¨æˆ·å®šä¹‰çš„é…ç½®ï¼ŒåŠ è½½å„ç§å„æ ·çš„æ’ä»¶ï¼›è°ƒç”¨&lt;code&gt;Parser&lt;/code&gt;è¿›è¡Œè¯­æ³•è§£æï¼Œç”Ÿæˆ&lt;code&gt;Tokens&lt;/code&gt;ä»¥åŠ&lt;code&gt;AST&lt;/code&gt;ï¼›è°ƒç”¨&lt;code&gt;Traverser&lt;/code&gt;éå†&lt;code&gt;AST&lt;/code&gt;ï¼Œè¿›è¡Œä¸€ä¸ªè½¬æ¢ï¼›æœ€å&lt;code&gt;generator&lt;/code&gt;ç”Ÿæˆæºä»£ç &lt;/p&gt;

&lt;h4 id=&#34;3-2æ’ä»¶&#34;&gt;3.2æ’ä»¶&lt;/h4&gt;

&lt;p&gt;è¯­æ³•æ’ä»¶ï¼š&lt;code&gt;babel&lt;/code&gt;æœ‰å¾ˆå¤šè¯­æ³•æ’ä»¶ï¼Œç”¨äºæ”¯æŒ&lt;code&gt;JavaScript&lt;/code&gt;çš„å„ç§è¯­æ³•ç‰¹æ€§ï¼Œåœ¨è§£æçš„æ—¶å€™ä¼šç”¨çš„åˆ°ï¼Œé€šå¸¸å…¶å½¢å¼ä¸º&lt;code&gt;@babel/plugin-syntax-*&lt;/code&gt;ï¼Œæ¯”å¦‚&lt;code&gt;babel-plugin-syntax-dynamic-import&lt;/code&gt;å°±æ˜¯ç”¨æ¥å¤„ç†&lt;code&gt;import&lt;/code&gt;è¯­æ³•çš„ä¸€ä¸ªæ’ä»¶&lt;/p&gt;

&lt;p&gt;è½¬æ¢æ’ä»¶ï¼š ç”¨äºå¯¹ &lt;code&gt;AST&lt;/code&gt; è¿›è¡Œè½¬æ¢, å®ç°è½¬æ¢ä¸º&lt;code&gt;ES5&lt;/code&gt;ä»£ç ã€å‹ç¼©ã€åŠŸèƒ½å¢å¼ºç­‰ç›®çš„ï¼Œ&lt;code&gt;babel&lt;/code&gt;ä»“åº“å°†è½¬æ¢æ’ä»¶åˆ’åˆ†ä¸ºä¸¤ç§(åªæ˜¯å‘½åä¸Šçš„åŒºåˆ«)ï¼š&lt;/p&gt;

&lt;p&gt;å¦‚&lt;code&gt;@babel/plugin-transform-*&lt;/code&gt;ï¼š &lt;code&gt;babel&lt;/code&gt;ä¸­çš„ä¸€ä¸ªè½¬æ¢æ’ä»¶&lt;/p&gt;

&lt;p&gt;é¢„å®šä¹‰çš„æ’ä»¶ï¼šæ’ä»¶é›†åˆæˆ–è€…åˆ†ç»„ï¼Œå¯è®¾ç½®é¡¹ç›®å†…æ‰€ç”¨æ’ä»¶çš„ä½¿ç”¨åœºæ™¯ï¼Œä¸»è¦æ–¹ä¾¿ç”¨æˆ·å¯¹æ’ä»¶è¿›è¡Œç®¡ç†å’Œä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;@babel/preset-env&lt;/code&gt;ï¼š&lt;code&gt;preset-env&lt;/code&gt;æ˜¯ESè¯­æ³•æ’ä»¶çš„åˆé›†ï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º&lt;code&gt;.babelrc&lt;/code&gt;é…ç½®æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt; {
   &amp;quot;presets&amp;quot;: [
     [&amp;quot;@babel/preset-env&amp;quot;, {
       &amp;quot;modules&amp;quot;: false,
       &amp;quot;targets&amp;quot;: {
         &amp;quot;browsers&amp;quot;: [&amp;quot;&amp;gt; 1%&amp;quot;, &amp;quot;last 2 versions&amp;quot;, &amp;quot;not ie &amp;lt;= 8&amp;quot;]
       },
       &amp;quot;useBuiltIns&amp;quot;: false,
       &amp;quot;corejs&amp;quot;: false
     }]
   ]
 }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;targets&lt;/code&gt;ç”ŸæˆæŒ‡å®šç¯å¢ƒçš„ä»£ç ï¼Œ&lt;code&gt;useBuiltIns&lt;/code&gt;é…åˆ&lt;code&gt;@babel/polyfill&lt;/code&gt;ä½¿ç”¨ï¼Œå½“ç„¶æœ€æ–°ç‰ˆçš„&lt;code&gt;babel&lt;/code&gt;å¯ç›´æ¥ä½¿ç”¨&lt;code&gt;corejs&lt;/code&gt;ï¼Œå¡«ä¸Šå¯¹åº”çš„æ•°å€¼å°±è¡Œï¼Œ&lt;code&gt;modules&lt;/code&gt;è¡¨ç¤ºæ˜¯å¦å°†ä»£ç ES6çš„æ¨¡å—è¯­æ³•è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹æˆ–æ ‡å‡†ï¼Œæ¯”å¦‚&lt;code&gt;amd&lt;/code&gt;ã€&lt;code&gt;commonjs&lt;/code&gt;ç­‰&lt;/p&gt;

&lt;p&gt;&lt;code&gt;@babel/polyfill&lt;/code&gt;é¡¾åæ€ä¹‰ï¼Œåœ¨&lt;code&gt;babel&lt;/code&gt;è½¬åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹äºä¸€äº›æ— æ³•å¤„ç†çš„ç‰¹æ€§æˆ–è€…å±æ€§ï¼Œä½¿ç”¨&lt;code&gt;@babel/polyfill&lt;/code&gt;æ¥å¯¹è¿™äº›åŠŸèƒ½è¿›è¡Œå¤„ç†ï¼›&lt;/p&gt;

&lt;p&gt;&lt;code&gt;@babel/runtime&lt;/code&gt;ä¸€èˆ¬åº”ç”¨äºä¸¤ç§åœºæ™¯ï¼šå¼€å‘ç±»åº“/å·¥å…·ï¼ˆç”Ÿæˆä¸æ±¡æŸ“å…¨å±€ç©ºé—´å’Œå†…ç½®å¯¹è±¡åŸå‹çš„ä»£ç ï¼‰ã€å€ŸåŠ© &lt;code&gt;@babel/runtime&lt;/code&gt; ä¸­å¸®åŠ©å‡½æ•°ï¼ˆhelper functionï¼‰ç§»é™¤å†—ä½™å·¥å…·å‡½æ•°ï¼Œåœ¨æœ€æ–°çš„ç‰ˆæœ¬ä¸­ï¼Œå®Œå…¨å¯ä»¥ç”¨&lt;code&gt;@babel/runtime&lt;/code&gt;ä»£æ›¿&lt;code&gt;@babel/polyfill&lt;/code&gt;&lt;/p&gt;

&lt;h4 id=&#34;3-3è¾…åŠ©å¼€å‘å·¥å…·&#34;&gt;3.3è¾…åŠ©å¼€å‘å·¥å…·&lt;/h4&gt;

&lt;p&gt;&lt;code&gt;@babel/template&lt;/code&gt;ï¼š æŸäº›åœºæ™¯ç›´æ¥æ“ä½œ&lt;code&gt;AST&lt;/code&gt;å¤ªéº»çƒ¦ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬ç›´æ¥æ“ä½œ&lt;code&gt;DOM&lt;/code&gt;ä¸€æ ·ï¼Œæ‰€ä»¥&lt;code&gt;babel&lt;/code&gt;å®ç°äº†è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ¨¡æ¿å¼•æ“ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²ä»£ç è½¬æ¢ä¸º&lt;code&gt;AST&lt;/code&gt;ã€‚æ¯”å¦‚åœ¨ç”Ÿæˆä¸€äº›è¾…åŠ©ä»£ç &lt;code&gt;(helper)&lt;/code&gt;æ—¶ä¼šç”¨åˆ°è¿™ä¸ªåº“&lt;/p&gt;

&lt;p&gt;&lt;code&gt;@babel/types&lt;/code&gt;ï¼š ä¸»è¦ç”¨é€”æ˜¯åœ¨åˆ›å»º&lt;code&gt;AST&lt;/code&gt;çš„è¿‡ç¨‹ä¸­åˆ¤æ–­å„ç§è¯­æ³•çš„ç±»å‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;@babel/helper-*&lt;/code&gt;ï¼š ä¸€äº›è¾…åŠ©å™¨ï¼Œç”¨äºè¾…åŠ©æ’ä»¶å¼€å‘ï¼Œä¾‹å¦‚ç®€åŒ–&lt;code&gt;AST&lt;/code&gt;æ“ä½œ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;@babel/helper&lt;/code&gt;ï¼š è¾…åŠ©ä»£ç ï¼Œå•çº¯çš„è¯­æ³•è½¬æ¢å¯èƒ½æ— æ³•è®©ä»£ç è¿è¡Œèµ·æ¥ï¼Œæ¯”å¦‚ä½ç‰ˆæœ¬æµè§ˆå™¨æ— æ³•è¯†åˆ«&lt;code&gt;class&lt;/code&gt;å…³é”®å­—ï¼Œè¿™æ—¶å€™éœ€è¦æ·»åŠ è¾…åŠ©ä»£ç ï¼Œå¯¹&lt;code&gt;class&lt;/code&gt;è¿›è¡Œæ¨¡æ‹Ÿã€‚&lt;/p&gt;

&lt;h4 id=&#34;4-å‚è€ƒé“¾æ¥&#34;&gt;4.å‚è€ƒé“¾æ¥&lt;/h4&gt;

&lt;p&gt;1.&lt;a href=&#34;https://juejin.im/post/5d94bfbf5188256db95589be&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;æ·±å…¥æµ…å‡ºBabel&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2.&lt;a href=&#34;https://www.babeljs.cn/&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;babelä¸­æ–‡ç½‘&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;3.&lt;a href=&#34;https://github.com/jamiebuilds/babel-handbook&#34; rel=&#34;nofollow noreferrer&#34; target=&#34;_blank&#34;&gt;babel-handbook&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Vueä¸­çš„patch</title>
      <link>https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84patch/</link>
      <pubDate>Thu, 13 Aug 2020 00:12:17 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84patch/</guid>
      <description>&lt;p&gt;åœ¨ç”Ÿæˆ&lt;code&gt;vnode&lt;/code&gt;ä¹‹åï¼Œå¯ä»¥é€šè¿‡&lt;code&gt;patch&lt;/code&gt;æ–¹æ³•åˆ›å»º&lt;code&gt;DOM&lt;/code&gt;å…ƒç´ ã€è¿›è¡Œ&lt;code&gt;diff&lt;/code&gt;æ›´æ–°&lt;code&gt;DOM&lt;/code&gt;å…ƒç´ ã€é”€æ¯&lt;code&gt;DOM&lt;/code&gt;å…ƒç´ &lt;/p&gt;

&lt;p&gt;1.é¦–å…ˆæ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶ï¼Œç”Ÿæˆäº†&lt;code&gt;vnode&lt;/code&gt;åï¼Œåœ¨&lt;code&gt;_update&lt;/code&gt;æ–¹æ³•ä¸­è°ƒç”¨&lt;code&gt;patch&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;vm.$el = vm.__patch__(
  vm.$el, vnode, hydrating, false
  // undefined
  vm.$options._parentElm,
  // undefined
  vm.$options._refElm
);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ­¤æ—¶&lt;code&gt;vm.$el&lt;/code&gt;æ˜¯æŒ‚è½½çš„æ ¹å…ƒç´ ï¼Œ&lt;code&gt;vnode&lt;/code&gt;æ˜¯æ ¹å…ƒç´ å¯¹åº”çš„è™šæ‹Ÿ&lt;code&gt;Dom&lt;/code&gt;å…ƒç´ &lt;/p&gt;

&lt;p&gt;&lt;code&gt;patch&lt;/code&gt;æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;  return function patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {
    // å¦‚æœæ›´æ–°åçš„VNodeä¸å­˜åœ¨
    // ç›´æ¥é”€æ¯æ—§çš„èŠ‚ç‚¹
    if (isUndef(vnode)) {
      if (isDef(oldVnode)) { invokeDestroyHook(oldVnode); }
      return
    }

    var isInitialPatch = false;
    var insertedVnodeQueue = [];
		
    if (isUndef(oldVnode)) {
      // å¦‚æœæ—§èŠ‚ç‚¹ä¸å­˜åœ¨
      // åˆ›å»ºVNodeå¯¹åº”çš„å…ƒç´ 
      isInitialPatch = true;
      createElm(vnode, insertedVnodeQueue, parentElm, refElm);
    } else {
      // oldValueæ˜¯å¦æ˜¯çœŸå®çš„DOMå…ƒç´ 
      var isRealElement = isDef(oldVnode.nodeType);
      // æ–°æ—§èŠ‚ç‚¹ç›¸åŒ
      if (!isRealElement &amp;amp;&amp;amp; sameVnode(oldVnode, vnode)) {
        patchVnode(oldVnode, vnode, insertedVnodeQueue, removeOnly);
      } else {
        if (isRealElement) {
          // oldVNodeç±»å‹ä¸ºå…ƒç´ ç±»å‹
          if (oldVnode.nodeType === 1 &amp;amp;&amp;amp; oldVnode.hasAttribute(SSR_ATTR)) {
            oldVnode.removeAttribute(SSR_ATTR);
            hydrating = true;
          }
      		......
          // åˆ›å»ºä¸€ä¸ªdivç©ºå…ƒç´ 
          oldVnode = emptyNodeAt(oldVnode);
        }
				// oldElmä»£è¡¨çœŸå®çš„DOMå…ƒç´ 
        var oldElm = oldVnode.elm;
        var parentElm$1 = nodeOps.parentNode(oldElm);

        createElm(
          vnode,
          insertedVnodeQueue,
          oldElm._leaveCb ? null : parentElm$1,
          nodeOps.nextSibling(oldElm)
        );
				......
        if (isDef(parentElm$1)) {
          removeVnodes(parentElm$1, [oldVnode], 0, 0);
        } else if (isDef(oldVnode.tag)) {
          invokeDestroyHook(oldVnode);
        }
      }
    }

    invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);
    return vnode.elm
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­è°ƒç”¨äº†ä¸€ä¸ªé‡è¦çš„æ–¹æ³•&lt;code&gt;createElm&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;  function createElm (
    vnode,
    insertedVnodeQueue,
    parentElm,
    refElm,
    nested,
    ownerArray,
    index
  ) {
		......
    // VNodeå¦‚æœæ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œè°ƒç”¨createComponent
    if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) {
      return
    }

    var data = vnode.data;
    var children = vnode.children;
    var tag = vnode.tag;
    // å¦‚æœtagæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†éå¹³å°æ ‡ç­¾ï¼Œä¹Ÿéè‡ªå®šä¹‰ç»„ä»¶ï¼ŒæŠ›é”™
    if (isDef(tag)) {
      if (process.env.NODE_ENV !== &#39;production&#39;) {
        if (data &amp;amp;&amp;amp; data.pre) {
          creatingElmInVPre++;
        }
        if (isUnknownElement$$1(vnode, creatingElmInVPre)) {
          warn(
            &#39;Unknown custom element: &amp;lt;&#39; + tag + &#39;&amp;gt; - did you &#39; +
            &#39;register the component correctly? For recursive components, &#39; +
            &#39;make sure to provide the &amp;quot;name&amp;quot; option.&#39;,
            vnode.context
          );
        }
      }
			
      // setScopeç”¨æˆ·è®¾ç½®scoped CSS
      vnode.elm = vnode.ns
        ? nodeOps.createElementNS(vnode.ns, tag)
        : nodeOps.createElement(tag, vnode);
      setScope(vnode);

        var appendAsTree = isDef(data) &amp;amp;&amp;amp; isTrue(data.appendAsTree);
        if (!appendAsTree) {
          if (isDef(data)) {
            // è°ƒç”¨invokeCreateHooks
            // æ­¤æ–¹æ³•ä¼šå¤„ç†directivesã€refã€attrsã€classã€domPropsã€onã€styleå’Œshowç­‰ä¸€äº›å±æ€§
            // å¦‚æœVNodeä¸Šæœ‰å¯¹åº”çš„ç‹—å­å‡½æ•°åˆ™ä¼šç›´æ¥æ‰§è¡Œ
            // å¦‚æœæœ‰insertæ–¹æ³•ï¼Œåˆ™æŠŠVNodeæ·»åŠ åˆ°insertedVnodeQueueæ•°ç»„
            invokeCreateHooks(vnode, insertedVnodeQueue);
          }
          insert(parentElm, vnode.elm, refElm);
        }
      	// é€’å½’å¤„ç†å­èŠ‚ç‚¹
        createChildren(vnode, children, insertedVnodeQueue);
        if (appendAsTree) {
          if (isDef(data)) {
            invokeCreateHooks(vnode, insertedVnodeQueue);
          }
          insert(parentElm, vnode.elm, refElm);
        }
      }

      if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; data &amp;amp;&amp;amp; data.pre) {
        creatingElmInVPre--;
      }
    } else if (isTrue(vnode.isComment)) {
      // å¦‚æœéä¿ç•™æ ‡ç­¾ï¼Œéè‡ªå®šä¹‰ç»„ä»¶ï¼Œå¹¶ä¸”æ˜¯æ³¨é‡ŠèŠ‚ç‚¹
      vnode.elm = nodeOps.createComment(vnode.text);
      insert(parentElm, vnode.elm, refElm);
    } else {
      // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
      vnode.elm = nodeOps.createTextNode(vnode.text);
      insert(parentElm, vnode.elm, refElm);
    }
  }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨åˆå§‹åŒ–æ—¶ï¼Œ&lt;code&gt;parentElm&lt;/code&gt;æŒ‡çš„æ˜¯&lt;code&gt;body&lt;/code&gt;ï¼Œ&lt;code&gt;refElm&lt;/code&gt;æ˜¯å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ &lt;/p&gt;

&lt;p&gt;2.ä¸Šé¢è¯´çš„æ˜¯&lt;code&gt;Vue&lt;/code&gt;ç¬¬ä¸€æ¬¡åŠ è½½é¡µé¢æ—¶patchçš„æ“ä½œï¼Œè¿˜æœ‰å½“é¡µé¢ç»‘å®šçš„æ•°æ®ä¿®æ”¹åï¼Œ&lt;code&gt;Vue&lt;/code&gt;å¯¹é¡µé¢çš„æ›´æ–°ï¼Œå…¶æ ¸å¿ƒä¹Ÿå°±æ˜¯&lt;code&gt;diff&lt;/code&gt;ç®—æ³•äº†
åœ¨é¡µé¢ç»‘å®šçš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œ&lt;code&gt;watcher&lt;/code&gt;ä¼šè°ƒç”¨&lt;code&gt;updateComponent&lt;/code&gt;ï¼Œç„¶åè°ƒç”¨&lt;code&gt;vm._render&lt;/code&gt;ç”Ÿæˆæœ€æ–°çš„&lt;code&gt;vnode&lt;/code&gt;ï¼Œ
ç„¶å&lt;code&gt;vm._update&lt;/code&gt;ä¼šè®²æ–°æ—§&lt;code&gt;vnode&lt;/code&gt;ä¼ å…¥&lt;code&gt;patch&lt;/code&gt;æ–¹æ³•ä¸­è¿›è¡Œdiffå¤„ç†ï¼Œå…¶å®æ€»ä½“æµç¨‹è¿˜æ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ä¼ å…¥çš„å‚æ•°ä¸åŒ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;return function patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {
  ......

  let isInitialPatch = false;
  const insertedVnodeQueue = [];

  if (isUndef(oldVnode)) {
    isInitialPatch = true;
    createElm(vnode, insertedVnodeQueue, parentElm, refElm);
  } else {
     // oldValueæ˜¯ä¸æ˜¯vnodeçœŸå®çš„domå…ƒç´ 
    const isRealElement = isDef(oldVnode.nodeType);
    // åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€vnode
    // å¦‚æœæ˜¯ç»Ÿä¸€vnodeï¼Œè°ƒç”¨patchVnode
    // sameVnodeåˆ¤æ–­ä¾æ®ä¸ºä¸¤ä¸ªvnodeçš„keyç›¸åŒï¼Œtagåç›¸åŒï¼Œtypeï¼Œdataï¼Œattrså¦‚æœæœ‰çš„è¯å¿…é¡»ç›¸åŒ
    // å¦‚æœå¯ä»¥å¤ç”¨ï¼ŒpatchVnode
    if (!isRealElement &amp;amp;&amp;amp; sameVnode(oldVnode, vnode)) {
      patchVnode(oldVnode, vnode, insertedVnodeQueue, removeOnly);
    } else {
      ......
    }
  }

  invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);
  return vnode.elm
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;patchVnode&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
function patchVnode (oldVnode, vnode, insertedVnodeQueue, removeOnly) {
  // å¦‚æœæ–°æ—§vnodeç›¸åŒï¼Œreturn
  if (oldVnode === vnode) {
    return
  }                           
  // vnodeåº”çš„domæŒ‡å‘oldVnodeçš„dom             
  const elm = vnode.elm = oldVnode.elm;

  ......

  // å¦‚æœæ–°æ—§èŠ‚ç‚¹éƒ½æ˜¯é™æ€æ ¹èŠ‚ç‚¹
  // keyä¹Ÿç›¸åŒ
  // å¦‚æœrenderStaticæˆ–è€…markOnce
  if (isTrue(vnode.isStatic) &amp;amp;&amp;amp;
    isTrue(oldVnode.isStatic) &amp;amp;&amp;amp;
    vnode.key === oldVnode.key &amp;amp;&amp;amp;
    (isTrue(vnode.isCloned) || isTrue(vnode.isOnce))
  ) {
    vnode.componentInstance = oldVnode.componentInstance;
    return
  }

  let i;
  const data = vnode.data;
  // è°ƒç”¨prepatché’©å­å‡½æ•°
  if (isDef(data) &amp;amp;&amp;amp; isDef(i = data.hook) &amp;amp;&amp;amp; isDef(i = i.prepatch)) {
    i(oldVnode, vnode);
  }

  // æ–°æ—§vnode children
  const oldCh = oldVnode.children;
  const ch = vnode.children;
  // dataä¸ä¸ºç©ºï¼Œå³èŠ‚ç‚¹ç›¸å…³çš„å±æ€§ä¸ä¸ºç©º
  // isPatchableç”¨äºåˆ¤æ–­vnodeçš„tagæ˜¯å¦ä¸ºç©º
  if (isDef(data) &amp;amp;&amp;amp; isPatchable(vnode)) {
    // æ›´æ–°å…ƒç´ ä¸Šç›¸å…³å„ç§å±æ€§
    for (i = 0; i &amp;lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode);
    // è°ƒç”¨updateé’©å­å‡½æ•°
    if (isDef(i = data.hook) &amp;amp;&amp;amp; isDef(i = i.update)) i(oldVnode, vnode);
  }
  // åˆ¤æ–­vnodeæ˜¯å¦ä¸ºæ–‡æœ¬èŠ‚ç‚¹
  if (isUndef(vnode.text)) {
    // æ–°æ—§èŠ‚ç‚¹éƒ½æœ‰å­å…ƒç´ 
    if (isDef(oldCh) &amp;amp;&amp;amp; isDef(ch)) {
      // å­å…ƒç´ ä¸ç›¸åŒ
      // è°ƒç”¨updateChildren
      if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly);
      // å¦‚æœæ–°çš„vnodeæœ‰å­å…ƒç´ ï¼Œæ—§çš„æ²¡æœ‰
    } else if (isDef(ch)) {
      // å¦‚æœæ—§èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œåˆ™ç½®ç©º
      if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, &#39;&#39;);
      // addVnodesæŠŠchä¸­çš„å…ƒç´ ä¾æ¬¡æ·»åŠ åˆ°elmä¸­
      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue);
      // å¦‚æœæ–°èŠ‚ç‚¹vnodeæ²¡æœ‰å­å…ƒç´ 
    } else if (isDef(oldCh)) {
      // åˆ é™¤æ—§èŠ‚ç‚¹çš„å­å…ƒç´ 
      removeVnodes(elm, oldCh, 0, oldCh.length - 1);
      // ä»¥ä¸Šå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œå¦‚æœoldVnodeæ˜¯æ–‡æœ¬ç»“ç‚¹ï¼Œåˆ™ç›´æ¥å†…å®¹ç½®ç©º
    } else if (isDef(oldVnode.text)) {
      nodeOps.setTextContent(elm, &#39;&#39;);
    }
    // å¦‚æœvnodeæ˜¯æ–‡æœ¬ç»“ç‚¹ï¼Œä¸”textæœ‰å˜åŒ–ï¼Œåˆ™ä¿®æ”¹elmçš„æ–‡æœ¬å†…å®¹
  } else if (oldVnode.text !== vnode.text) {
    nodeOps.setTextContent(elm, vnode.text);
  }
  // è°ƒç”¨postpatché’©å­å‡½æ•°
  if (isDef(data)) {
    if (isDef(i = data.hook) &amp;amp;&amp;amp; isDef(i = i.postpatch)) i(oldVnode, vnode);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥é‡ç‚¹æ˜¯&lt;code&gt;updateChildren&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function updateChildren(parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
  // å®šä¹‰äº†ä¸€äº›ç´¢å¼•ä»¥åŠèµ·å§‹èŠ‚ç‚¹çš„ä¿¡æ¯
  let oldStartIdx = 0
  let newStartIdx = 0
  let oldEndIdx = oldCh.length - 1
  let oldStartVnode = oldCh[0]
  let oldEndVnode = oldCh[oldEndIdx]
  let newEndIdx = newCh.length - 1
  let newStartVnode = newCh[0]
  let newEndVnode = newCh[newEndIdx]
  let oldKeyToIdx, idxInOld, vnodeToMove, refElm

  // removeOnlyä¸ºfalseï¼Œtransition-groupä¸­ä¸ºtrue
  const canMove = !removeOnly

  if (process.env.NODE_ENV !== &#39;production&#39;) {
    checkDuplicateKeys(newCh)
  }
  // æ–°æ—§èŠ‚ç‚¹éƒ½æœªéå†å®Œ
  while (oldStartIdx &amp;lt;= oldEndIdx &amp;amp;&amp;amp; newStartIdx &amp;lt;= newEndIdx) {
    // å¦‚æœoldStartVnodeæœªå®šä¹‰
    if (isUndef(oldStartVnode)) {
      // oldChå‘åç§»ä¸€ä½
      oldStartVnode = oldCh[++oldStartIdx]
      // å¦‚æœoldEndVnodeæœªå®šä¹‰
    } else if (isUndef(oldEndVnode)) {
      // oldChå°¾ç´¢å¼•å‘å‰ç§»åŠ¨ä¸€ä½
      oldEndVnode = oldCh[--oldEndIdx]
      // é¦–èŠ‚ç‚¹æ¯”è¾ƒï¼Œå¦‚æœèƒ½å¤ç”¨
    } else if (sameVnode(oldStartVnode, newStartVnode)) {
      // è°ƒç”¨patchVnodeï¼Œæ›´æ–°oldStartVnodeã€newStartVnodeï¼Œä¹Ÿä¼šé€’å½’updateChildren
      patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
      // æ›´æ–°èŠ‚ç‚¹ä½ç½®
      oldStartVnode = oldCh[++oldStartIdx]
      newStartVnode = newCh[++newStartIdx]
      // å°¾èŠ‚ç‚¹æ¯”è¾ƒ
    } else if (sameVnode(oldEndVnode, newEndVnode)) {
      patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)
      oldEndVnode = oldCh[--oldEndIdx]
      newEndVnode = newCh[--newEndIdx]
      // é¦–å°¾èŠ‚ç‚¹æ¯”è¾ƒ
    } else if (sameVnode(oldStartVnode, newEndVnode)) {
      patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)
      canMove &amp;amp;&amp;amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))
      oldStartVnode = oldCh[++oldStartIdx]
      newEndVnode = newCh[--newEndIdx]
      // å°¾é¦–èŠ‚ç‚¹æ¯”è¾ƒ
    } else if (sameVnode(oldEndVnode, newStartVnode)) {
      patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
      canMove &amp;amp;&amp;amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)
      oldEndVnode = oldCh[--oldEndIdx]
      newStartVnode = newCh[++newStartIdx]
    } else {
      // ä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œè°ƒç”¨createKeyToOldIdx
      // createKeyToOldIdx æ–¹æ³•çš„ä½œç”¨ï¼Œéå†oldChï¼Œæ‰¾åˆ°é‡Œé¢è®¾ç½®keyçš„å¯¹è±¡
      // è¿”å›ä¸€ä¸ªmapï¼Œkeyä¸ºé”®ï¼Œindexä¸ºå€¼
      if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
      // æŸ¥è¯¢æ–°èŠ‚ç‚¹åœ¨oldChä¸­çš„ç´¢å¼•
      idxInOld = isDef(newStartVnode.key) ?
        oldKeyToIdx[newStartVnode.key] :
        findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
      // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜æ˜¯æ–°å»ºçš„èŠ‚ç‚¹
      if (isUndef(idxInOld)) {
        // åˆ›å»ºæ–°çš„DOMå…ƒç´ ï¼Œæ’å…¥åˆ°æŒ‡å®šèŠ‚ç‚¹
        createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
      } else {
        // å¦‚æœåœ¨oldChä¸­æ‰¾åˆ°äº†ç´¢å¼•
        vnodeToMove = oldCh[idxInOld]
        // å¯å¤ç”¨
        if (sameVnode(vnodeToMove, newStartVnode)) {
          // patchVnodeå¤ç”¨domå…ƒç´ é€’å½’å­å…ƒç´ 
          patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
          // vnodeå¤„ç†å®Œäº†ä¹‹åæ¸…æ¥šoldChå¯¹åº”çš„èŠ‚ç‚¹
          oldCh[idxInOld] = undefined
          canMove &amp;amp;&amp;amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
          // ä¸å¯å¤ç”¨ï¼Œç›´æ¥åˆ›å»ºæ–°å…ƒç´ 
        } else {
          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
        }
      }
      // newChå‘åç§»ä¸€ä½
      newStartVnode = newCh[++newStartIdx]
    }
  }
  //Â å¦‚æœoldChéå†å®Œäº†
  if (oldStartIdx &amp;gt; oldEndIdx) {
    // åˆ›å»ºå‰©ä¸‹çš„domèŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°å¯¹åº”çš„ä½ç½®
    refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm
    addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)
    // å¦‚æœnewChéå†å®Œäº†ï¼ŒoldChæ²¡æœ‰ 
    // ç§»å‡ºå‰©ä¸‹çš„oldCh
  } else if (newStartIdx &amp;gt; newEndIdx) {
    removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™å°±æ˜¯&lt;code&gt;diff&lt;/code&gt;å¤„ç†&lt;code&gt;vnode children&lt;/code&gt;å±æ€§çš„è¿‡ç¨‹&lt;/p&gt;

&lt;p&gt;3.å¯¹äºè‡ªå®šä¹‰ç»„ä»¶ï¼Œåœ¨&lt;code&gt;createElm&lt;/code&gt;æ–¹æ³•ä¸­ä¸­ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªæ–¹æ³•&lt;code&gt;createComponent&lt;/code&gt;æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå®šä¹‰ç»„ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;...
if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) {
	return
}
...

createComponent

function createComponent (vnode, insertedVnodeQueue, parentElm, refElm) {
  let i = vnode.data
  if (isDef(i)) {
    const isReactivated = isDef(vnode.componentInstance) &amp;amp;&amp;amp; i.keepAlive
    if (isDef(i = i.hook) &amp;amp;&amp;amp; isDef(i = i.init)) {
      i(vnode, false /* hydrating */, parentElm, refElm)
    }
    ......
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è°ƒç”¨&lt;code&gt;init&lt;/code&gt;åˆå§‹åŒ–ï¼Œ&lt;code&gt;init&lt;/code&gt;æ–¹æ³•å®šä¹‰åœ¨&lt;code&gt;componentVNodeHooks&lt;/code&gt;ä¸­ï¼Œ&lt;code&gt;componentVNodeHooks&lt;/code&gt;ä¸­å®šä¹‰çš„é’©å­å‡½æ•°ï¼Œä¼šåœ¨&lt;code&gt;patch&lt;/code&gt;ä¸­è°ƒç”¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const componentVNodeHooks = {
  init (
    vnode,
    hydrating,
    parentElm,
    refElm
  ) {
    // å¦‚æœå½“å‰vnodeä¸Šæ²¡æœ‰ç»„ä»¶å®ä¾‹æˆ–è€…å·²ç»é”€æ¯ï¼Œåˆ™åˆ›å»ºæ–°çš„æ–°çš„componentå®ä¾‹
    if (!vnode.componentInstance || vnode.componentInstance._isDestroyed) {
      // è°ƒç”¨createComponentInstanceForVnode
      // createComponentInstanceForVnodeæ–¹æ³•ä¸­ä¼šå¤„ç†ç»„ä»¶ä¸­çš„å„ç§å±æ€§
      // æ¯”å¦‚ Ctoræ˜¯è‡ªå®šä¹‰ç»„ä»¶çš„æ„é€ å‡½æ•°ï¼ŒpropsDataæ˜¯çˆ¶ç»„ä»¶é€šè¿‡propsä¼ é€’çš„æ•°æ®
      // listenersæ˜¯æ·»åŠ åœ¨å½“å‰ç»„ä»¶ä¸Šçš„äº‹ä»¶ï¼Œtagæ˜¯è‡ªå®šä¹‰çš„æ ‡ç­¾åï¼Œchildrenå³å½“å‰è‡ªå®šä¹‰ç»„ä»¶çš„å­å…ƒç´ 
      const child = vnode.componentInstance = createComponentInstanceForVnode(
        vnode,
        activeInstance,
        parentElm,
        refElm
      );
      // è°ƒç”¨$mount
      // å…¶å†…éƒ¨ä¾æ—§è°ƒç”¨__patch__
      // ç„¶åupdate
      child.$mount(hydrating ? vnode.elm : undefined, hydrating);
    } else if (vnode.data.keepAlive) {
      const mountedNode = vnode;
      componentVNodeHooks.prepatch(mountedNode, mountedNode);
    }
  },
  // patchVNodeä¸­è°ƒç”¨
  // ç»„ä»¶diffä¹‹å‰çš„æ“ä½œ
  prepatch (oldVnode: MountedComponentVNode, vnode: MountedComponentVNode) {
    const options = vnode.componentOptions
    const child = vnode.componentInstance = oldVnode.componentInstance
    // è°ƒç”¨updateChildComponentï¼Œé€šè¿‡ä¼ å…¥çš„å±æ€§ï¼Œæ›´æ–°å¯¹åº”çš„æ¨¡æ¿ï¼Œæ•°æ®ï¼Œäº‹ä»¶
    updateChildComponent(
      child,
      options.propsData, // updated props
      options.listeners, // updated listeners
      vnode, // new parent vnode
      options.children // new children
    )
  },

  // patch invokeInsertHookä¸­è°ƒç”¨
  // ç”Ÿæˆçš„domå…ƒç´ æ’å…¥é¡µé¢åè°ƒç”¨
  insert (vnode: MountedComponentVNode) {
    const { context, componentInstance } = vnode
    // è®¾ç½®_isMountedä¸ºtrueï¼Œè°ƒç”¨mountedé’©å­å‡½æ•°
    if (!componentInstance._isMounted) {
      componentInstance._isMounted = true
      callHook(componentInstance, &#39;mounted&#39;)
    }
    if (vnode.data.keepAlive) {
      // keepAliveç»„ä»¶ï¼Œå¦‚æœå·²ç»åŠ è½½å¥½äº†çš„
      // è°ƒç”¨queueActivatedComponentï¼Œæ”¾è¿›activatedChildren
      if (context._isMounted) {
        queueActivatedComponent(componentInstance)
      } else {
        // åä¹‹è°ƒç”¨activateChildComponentï¼Œè§¦å‘activatedé’©å­å‡½æ•°
        // è¿™åˆæ˜¯keepAliveä¸“æœ‰çš„ç”Ÿå‘½å‘¨æœŸ
        activateChildComponent(componentInstance, true /* direct */)
      }
    }
  },

  destroy (vnode: MountedComponentVNode) {
    const { componentInstance } = vnode
    if (!componentInstance._isDestroyed) {
      if (!vnode.data.keepAlive) {
        // é”€æ¯ç»„ä»¶
        componentInstance.$destroy()
      } else {
        // å¯¹äºkeepAliveç»„ä»¶ï¼Œè°ƒç”¨deactivateChildComponentï¼Œè§¦å‘deactivatedé’©å­å‡½æ•°
        deactivateChildComponent(componentInstance, true /* direct */)
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é”€æ¯ç»„ä»¶&lt;code&gt;destroy&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;Vue.prototype.$destroy = function () {
  const vm: Component = this
  if (vm._isBeingDestroyed) {
    return
  }
  // è°ƒç”¨beforeDestroyé’©å­å‡½æ•°
  callHook(vm, &#39;beforeDestroy&#39;)
  vm._isBeingDestroyed = true
  const parent = vm.$parent
  // ä»çˆ¶å…ƒç´ ä¸­åˆ é™¤å½“å‰å…ƒç´ 
  if (parent &amp;amp;&amp;amp; !parent._isBeingDestroyed &amp;amp;&amp;amp; !vm.$options.abstract) {
    remove(parent.$children, vm)
  }
  // é”€æ¯watcher
  if (vm._watcher) {
    vm._watcher.teardown()
  }
  // _watcherså‡ä¸€
  let i = vm._watchers.length
  while (i--) {
    vm._watchers[i].teardown()
  }
  // observeå‡ä¸€
  if (vm._data.__ob__) {
    vm._data.__ob__.vmCount--
  }
  vm._isDestroyed = true
  // ä¼ å…¥nullï¼Œé”€æ¯å½“å‰ç»„ä»¶
  vm.__patch__(vm._vnode, null)
  // è°ƒç”¨destroyedé’©å­å‡½æ•°
  callHook(vm, &#39;destroyed&#39;)
  // é”€æ¯äº‹ä»¶
  vm.$off()
  // æ¶ˆé™¤å„ç§å±æ€§
  if (vm.$el) {
    vm.$el.__vue__ = null
  }
  vm.$options._parentElm = vm.$options._refElm = null
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸Šå°±æ˜¯&lt;code&gt;patch&lt;/code&gt;çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸€æ¬¡ç”Ÿæˆ&lt;code&gt;dom&lt;/code&gt;å…ƒç´ ï¼Œ&lt;code&gt;diff&lt;/code&gt;æ›´æ–°æ“ä½œï¼Œè¿˜æœ‰å¯¹äº&lt;code&gt;component&lt;/code&gt;å…ˆè½¬æ¢ä¸º&lt;code&gt;vnode&lt;/code&gt;å†è¿›è¡Œ&lt;code&gt;patch&lt;/code&gt;ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›ç”Ÿå‘½å‘¨æœŸå‡½æ•°&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Vueä¸­çš„VNode</title>
      <link>https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84vnode/</link>
      <pubDate>Tue, 04 Aug 2020 23:28:03 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/vue%E4%B8%AD%E7%9A%84vnode/</guid>
      <description>&lt;p&gt;ç»è¿‡&lt;code&gt;compile&lt;/code&gt;ç¼–è¯‘æ¨¡æ¿å­—ç¬¦ä¸²å˜æˆäº†&lt;code&gt;render&lt;/code&gt;å‡½æ•°ï¼Œåœ¨&lt;code&gt;src/core/instance/render.js&lt;/code&gt;ä¸­ï¼Œé€šè¿‡&lt;code&gt;vnode = render.call(vm._renderProxy, vm.$createElement)&lt;/code&gt;è°ƒç”¨äº†&lt;code&gt;render&lt;/code&gt;æ–¹æ³•å¹¶æœ€ç»ˆè¿”å›äº†ä¸€ä¸ª&lt;code&gt;VNode&lt;/code&gt;å¯¹è±¡å®ä¾‹ï¼Œå³&lt;code&gt;Vue&lt;/code&gt;ä¸­çš„è™šæ‹Ÿ&lt;code&gt;Dom&lt;/code&gt;ï¼ŒåŸºæœ¬å®šä¹‰å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export default class VNode {
  constructor (
    tag?: string,
    data?: VNodeData,
    children?: ?Array&amp;lt;VNode&amp;gt;,
    text?: string,
    elm?: Node,
    context?: Component,
    componentOptions?: VNodeComponentOptions,
    asyncFactory?: Function
  ) {
    this.tag = tag v // æ ‡ç­¾å
    this.data = data // ç»“ç‚¹ç›¸å…³å±æ€§æ•°æ®
    this.children = children // å­èŠ‚ç‚¹
    this.text = text // æ–‡æœ¬
    this.elm = elm // domå…ƒç´  
    this.ns = undefined // å‘½åç©ºé—´
    this.context = context // VNodeä¸Šä¸‹æ–‡å¯¹è±¡
    ...... 
    this.key = data &amp;amp;&amp;amp; data.key // key
    this.componentOptions = componentOptions // VNodeå¯¹è±¡å¦‚æœå¯¹åº”çš„æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç»„ä»¶ï¼ŒcomponentOptionsä¿å­˜ç»„ä»¶ç›¸å…³äº‹ä»¶ã€propsæ•°æ®ç­‰
    this.componentInstance = undefined // VNodeå¯¹è±¡å¦‚æœå¯¹åº”çš„æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç»„ä»¶ï¼ŒcomponentInstanceä¿å­˜ç›¸å¯¹åº”çš„vueå®ä¾‹
    this.parent = undefined // å½“å‰è‡ªå®šä¹‰ç»„ä»¶åœ¨çˆ¶ç»„ä»¶ä¸­çš„vnode
    this.raw = false
    this.isStatic = false // æ˜¯å¦é™æ€èŠ‚ç‚¹
    .....
    this.isOnce = false // æ˜¯å¦ä¸ºv-onceå…ƒç´ çš„VNodeå¯¹è±¡
  }

  get child (): Component | void {
    return this.componentInstance
  }

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åé¢è¿˜å®šä¹‰äº†ä¸€äº›åˆ›å»ºç®€å•çš„VNodeçš„æ–¹æ³•ï¼Œå¦‚&lt;code&gt;createEmptyVNode&lt;/code&gt;ã€&lt;code&gt;reateEmptyVNode&lt;/code&gt;ã€&lt;code&gt;createTextVNode&lt;/code&gt;ã€&lt;code&gt;cloneVNode&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;å‰é¢è¯´è¿‡ï¼Œè°ƒç”¨_initæ–¹æ³•çš„æœ€åï¼Œä¼šè°ƒç”¨vm._renderæ¥ç”ŸæˆVNodeèŠ‚ç‚¹ï¼Œåœ¨&lt;code&gt;src/core/instance/render.js&lt;/code&gt;å¯ä»¥æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œ
åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œå°±ä¼šè°ƒç”¨&lt;code&gt;vnode = render.call(vm._renderProxy, vm.$createElement)&lt;/code&gt;æ¥ç”Ÿæˆ&lt;code&gt;VNode&lt;/code&gt;ï¼Œå…¶ä¸­åœ¨è¿™æ–‡ä»¶æœ‰ä¸¤ä¸ª&lt;code&gt;createElement&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;vm._c = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, false)
vm.$createElement = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, true)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;vm._c = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, false)&lt;/code&gt;æ˜¯ç¼–è¯‘æ¨¡æ¿ç”Ÿæˆçš„renderå‡½æ•°æ‰§è¡Œæ—¶è°ƒç”¨çš„ï¼Œ
&lt;code&gt;vm.$createElement&lt;/code&gt;æ˜¯è‡ªå·±æ·»åŠ &lt;code&gt;render&lt;/code&gt;å‡½æ•°æ—¶ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™renderå‡½æ•°&lt;/p&gt;

&lt;p&gt;&lt;code&gt;src/core/vdom/create-element.js&lt;/code&gt;ä¸­&lt;code&gt;createElement&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function createElement (
  context: Component, // å½“å‰çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå“ªä¸€ä¸ªvm
  tag: any, //  æ ‡ç­¾å
  data: any, // èŠ‚ç‚¹ç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚keyï¼Œrefï¼Œattrsç­‰ç­‰å±æ€§
  children: any, // children
  normalizationType: any, // å­å…ƒç´ æ‰å¹³åŒ–å¤„ç†çš„çº§åˆ«
  alwaysNormalize: boolean // æ€»æ˜¯æ‰å¹³åŒ–å¤„ç†
): VNode | Array&amp;lt;VNode&amp;gt; {
  // å¦‚æœåˆ¤å®šä¸ºtrueï¼Œè¯´æ˜è¯¥å…ƒç´ æ²¡æœ‰ç›¸å…³å±æ€§
  if (Array.isArray(data) || isPrimitive(data)) {
    normalizationType = children
    children = data
    data = undefined
  }
  if (isTrue(alwaysNormalize)) {
    // æœ€é«˜çº§åˆ«çš„æ‰å¹³åŒ–å¤„ç†
    normalizationType = ALWAYS_NORMALIZE
  }
  return _createElement(context, tag, data, children, normalizationType)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è°ƒç”¨&lt;code&gt;_createElement&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function _createElement (
  context: Component,
  tag?: string | Class&amp;lt;Component&amp;gt; | Function | Object,
  data?: VNodeData,
  children?: any,
  normalizationType?: number
): VNode | Array&amp;lt;VNode&amp;gt; {
	......
  if (!tag) {
    // å¦‚æœtagä¸ºç©ºï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„VNode
    return createEmptyVNode()
  }
  // åœ¨Vueä¸­ï¼Œå¦‚æœè®¾ç½®å¯¹è±¡æˆ–è€…æ•°ç»„ä¸ºkeyçš„æ—¶å€™ï¼Œä¼šæŠ¥é”™
  if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp;
    isDef(data) &amp;amp;&amp;amp; isDef(data.key) &amp;amp;&amp;amp; !isPrimitive(data.key)
  ) {
    if (!__WEEX__ || !(&#39;@binding&#39; in data.key)) {
      warn(
        &#39;Avoid using non-primitive value as key, &#39; +
        &#39;use string/number value instead.&#39;,
        context
      )
    }
  }
  // å¦‚æœåªæœ‰ä¸€ä¸ªchildrenï¼Œåˆ™å½“æˆslotè§£æ
  if (Array.isArray(children) &amp;amp;&amp;amp;
    typeof children[0] === &#39;function&#39;
  ) {
    data = data || {}
    data.scopedSlots = { default: children[0] }
    children.length = 0
  }
  // æ‰å¹³åŒ–å¤„ç†
  if (normalizationType === ALWAYS_NORMALIZE) {
    children = normalizeChildren(children)
  } else if (normalizationType === SIMPLE_NORMALIZE) {
    children = simpleNormalizeChildren(children)
  }
  let vnode, ns
  if (typeof tag === &#39;string&#39;) {
    let Ctor
    ns = (context.$vnode &amp;amp;&amp;amp; context.$vnode.ns) || config.getTagNamespace(tag)
    if (config.isReservedTag(tag)) {
      // å¦‚æœtagä¸ºStringï¼Œä¸”ä¸ºå¹³å°ä¿ç•™çš„æ ‡ç­¾ï¼Œç›´æ¥åˆ›å»ºVNode
      vnode = new VNode(
        config.parsePlatformTagName(tag), data, children,
        undefined, undefined, context
      )
    } else if ((!data || !data.pre) &amp;amp;&amp;amp; isDef(Ctor = resolveAsset(context.$options, &#39;components&#39;, tag))) {
      // å¦‚æœä¸æ˜¯ä¿ç•™æ ‡ç­¾ï¼Œå¹¶ä¸”æœ‰æ•°æ®ï¼Œæ²¡æœ‰è®¾ç½®è·³è¿‡ï¼Œä¸”æ˜¯è‡ªå®šä¹‰ç»„ä»¶
      vnode = createComponent(Ctor, data, context, children, tag)
    } else {
      // å¦åˆ™ï¼Œåˆ›å»ºVNodeå¯¹è±¡
      vnode = new VNode(
        tag, data, children,
        undefined, undefined, context
      )
    }
  } else {
    // å¦‚æœtabä¸æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿæ˜¯ç›´æ¥createComponent
    vnode = createComponent(tag, data, context, children)
  }
  if (Array.isArray(vnode)) {
    return vnode
  } else if (isDef(vnode)) {
    if (isDef(ns)) applyNS(vnode, ns)
    if (isDef(data)) registerDeepBindings(data)
    return vnode
  } else {
    return createEmptyVNode()
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;createComponent&lt;/code&gt;å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function createComponent (
  Ctor: Class&amp;lt;Component&amp;gt; | Function | Object | void,
  data: ?VNodeData,
  context: Component,
  children: ?Array&amp;lt;VNode&amp;gt;,
  tag?: string
): VNode | Array&amp;lt;VNode&amp;gt; | void {
  // å¦‚æœCtorä¸ºç©ºï¼Œè·³è¿‡æ­¤æ­¥éª¤ï¼Œå¯¹åº”çš„å®é™…æƒ…å†µå°±æ˜¯ä¼ å…¥çš„å‚æ•°å¹¶ä¸æ˜¯å­—ç¬¦ä¸²æˆ–è€…è‡ªå®šä¹‰ç»„ä»¶
  if (isUndef(Ctor)) {
    return
  }
	
	// baseCtorå…¶å®å°±æ˜¯æŒ‡çš„Vueå¯¹è±¡
  const baseCtor = context.$options._base

  if (isObject(Ctor)) {
    Ctor = baseCtor.extend(Ctor)
  }
	......
  data = data || {}
	
	// é€’å½’åˆå¹¶çˆ¶å¯¹è±¡ä¸Šçš„options
  resolveConstructorOptions(Ctor)

	// å¤„ç†v-modelæŒ‡ä»¤
  if (isDef(data.model)) {
    transformModel(Ctor.options, data)
  }
	
	// æŠ½å–propså±æ€§
  const propsData = extractPropsFromVNodeData(data, Ctor, tag)

  if (isTrue(Ctor.options.functional)) {
    return createFunctionalComponent(Ctor, propsData, data, context, children)
  }
	
	// å¤„ç†ç»„ä»¶.nativeçš„äº‹ä»¶ï¼Œè¡¨ç¤ºç»„ä»¶ä¸Šçš„äº‹ä»¶
  const listeners = data.on
  data.on = data.nativeOn
		
	// å¤„ç†æŠ½è±¡ç»„ä»¶ä¸­çš„slotï¼Œå¦‚keep-alive
  if (isTrue(Ctor.options.abstract)) {
    const slot = data.slot
    data = {}
    if (slot) {
      data.slot = slot
    }
  }
	
	// åˆå¹¶ä¸€äº›é’©å­å‡½æ•°
  installComponentHooks(data)

  const name = Ctor.options.name || tag
  
  // ç”ŸæˆVNode
  const vnode = new VNode(
    `vue-component-${Ctor.cid}${name ? `-${name}` : &#39;&#39;}`,
    data, undefined, undefined, undefined, context,
    { Ctor, propsData, listeners, tag, children },
    asyncFactory
  )
	
  ......

  return vnode
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;extractPropsFromVNodeData&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function extractProps (data: VNodeData, Ctor: Class&amp;lt;Component&amp;gt;, tag?: string): ?Object {
  const propOptions = Ctor.options.props
  // ç»„ä»¶æ²¡æœ‰propsï¼Œreturn
  if (!propOptions) {
    return
  }
  const res = {}
  // domPropsè¡¨ç¤ºinputçš„valueã€optionçš„selectedç­‰å±æ€§
  // attrsè¡¨çˆ¶ç»„ä»¶ç»‘å®šåœ¨å­å…ƒç´ ä¸Šçš„å±æ€§å€¼
  const { attrs, props, domProps } = data
  if (attrs || props || domProps) {
    for (const key in propOptions) {
      // å°†é©¼å³°å‘½åè½¬åŒ–ä¸ºè¿çº¿å‘½å
			// aB -&amp;gt; a-b
      const altKey = hyphenate(key)
      .....
      
      // éå†æ‰¾åˆ°propsã€attrsã€domPropsä¸­çš„å±æ€§
      // å¦‚æœæ²¡æœ‰ä¼ é€’preserveå‚æ•°ï¼Œåˆ™è¡¨ç¤ºæ‰¾åˆ°è¯¥keyçš„å€¼æ—¶åˆ é™¤å¯¹åº”çš„å±æ€§
      // æœ€åè¿”å›resï¼Œå¹¶ä¸”åªç•™ä¸‹propsä¸Šçš„å±æ€§
      checkProp(res, props, key, altKey, true) ||
      checkProp(res, attrs, key, altKey) ||
      checkProp(res, domProps, key, altKey)
    }
  }
  return res
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åï¼Œå¯¹äºè‡ªå®šä¹‰ç»„ä»¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª&lt;code&gt;vnode&lt;/code&gt;å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ ‡ç­¾åä¸º&lt;code&gt;vue-component-cid-name&lt;/code&gt;æ ¼å¼çš„&lt;code&gt;VNode&lt;/code&gt;å¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;ä¸Šé¢è¯´çš„æ‰å¹³åŒ–å¤„ç†å…¶å®å°±æ˜¯å°†å¤šç»´çš„æ•°ç»„ï¼Œåˆå¹¶è½¬æ¢æˆä¸€ä¸ªä¸€ç»´çš„æ•°ç»„&lt;/p&gt;

&lt;p&gt;&lt;code&gt;simpleNormalizeChildren&lt;/code&gt;ç®€å•çš„æ‰å¹³åŒ–å¤„ç†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function simpleNormalizeChildren (children: any) {
  for (let i = 0; i &amp;lt; children.length; i++) {
    if (Array.isArray(children[i])) {
      return Array.prototype.concat.apply([], children)
    }
  }
  return children
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;normalizeChildren&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function normalizeChildren (children: any): ?Array&amp;lt;VNode&amp;gt; {
  return isPrimitive(children)
  	// å¦‚æœä¼ å…¥çš„childrenæ˜¯å­—ç¬¦ä¸²æˆ–è€…æ•°å­—ï¼Œåˆ™ç›´æ¥è¿”å›æ–‡æœ¬ç»“ç‚¹æ•°ç»„
    ? [createTextVNode(children)]
    : Array.isArray(children)
			// å¦‚æœä¼ å…¥çš„childrenæ˜¯æ•°ç»„ï¼Œè°ƒç”¨normalizeArrayChildren
      ? normalizeArrayChildren(children)
      : undefined
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;normalizeArrayChildren&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function normalizeArrayChildren (children: any, nestedIndex?: string): Array&amp;lt;VNode&amp;gt; {
  const res = []
  let i, c, lastIndex, last
  for (i = 0; i &amp;lt; children.length; i++) {
    c = children[i]
    // å¦‚æœè¯¥å…ƒç´ ä¸ºundefinedæˆ–nullæˆ–Booleanç±»å‹çš„å€¼,continue
    if (isUndef(c) || typeof c === &#39;boolean&#39;) continue
    lastIndex = res.length - 1
    last = res[lastIndex]
    if (Array.isArray(c)) {
      if (c.length &amp;gt; 0) {
        // cæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™é€’å½’çš„æ‰§è¡ŒnormalizeArrayChildrenæ–¹æ³•
        c = normalizeArrayChildren(c, `${nestedIndex || &#39;&#39;}_${i}`)
        if (isTextNode(c[0]) &amp;amp;&amp;amp; isTextNode(last)) {
          res[lastIndex] = createTextVNode(last.text + (c[0]: any).text)
          c.shift()
        }
        res.push.apply(res, c)
      }
    } else if (isPrimitive(c)) {
      // å¦‚æœæœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹
      if (isTextNode(last)) {
        // åˆå¹¶last.textå’Œc
        res[lastIndex] = createTextVNode(last.text + c)
      } else if (c !== &#39;&#39;) {
        // å¦‚æœæœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸”ä¸ä¸ºç©º
        // åˆ›å»ºä¸€ä¸ªç©ºæ–‡æœ¬èŠ‚ç‚¹
        res.push(createTextVNode(c))
      }
    } else {
      // å¦‚æœcæ˜¯ä¸€ä¸ªæ–‡æœ¬VNodeå¯¹è±¡ï¼Œä¸”resä¸­æœ€åä¸€ä¸ªå…ƒç´ ä¹Ÿæ˜¯æ–‡æœ¬ç»“ç‚¹
      // åˆå¹¶ä¸¤ä¸ªVNodeä¸ºä¸€ä¸ª
      if (isTextNode(c) &amp;amp;&amp;amp; isTextNode(last)) {
        res[lastIndex] = createTextVNode(last.text + c.text)
      } else {
        // è®¾ç½®VNodeçš„key
        if (isTrue(children._isVList) &amp;amp;&amp;amp;
          isDef(c.tag) &amp;amp;&amp;amp;
          isUndef(c.key) &amp;amp;&amp;amp;
          isDef(nestedIndex)) {
          c.key = `__vlist${nestedIndex}_${i}__`
        }
        res.push(c)
      }
    }
  }
  return res
}

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Vueé‡Œé¢compileæ¨¡æ¿ç¼–è¯‘</title>
      <link>https://xtid.github.io/2020/vue%E9%87%8C%E9%9D%A2compile%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/</link>
      <pubDate>Thu, 30 Jul 2020 22:16:42 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/vue%E9%87%8C%E9%9D%A2compile%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/</guid>
      <description>&lt;p&gt;1.complieç®€è¿°&lt;/p&gt;

&lt;p&gt;&lt;code&gt;complie&lt;/code&gt;é˜¶æ®µä¸»è¦æ˜¯å°†&lt;code&gt;Vue&lt;/code&gt;ä»£ç é€šè¿‡ä¸€ç³»åˆ—è½¬æ¢ï¼Œæœ€ç»ˆç”Ÿæˆå¯¹åº”çš„&lt;code&gt;render&lt;/code&gt;å­—ç¬¦ä¸²ï¼Œç„¶å&lt;code&gt;Vue&lt;/code&gt;é€šè¿‡&lt;code&gt;render&lt;/code&gt;å­—ç¬¦ä¸²é‡Œé¢çš„å…³é”®è¯æˆ–è€…è¯´å®šä¹‰ï¼Œå¯¹é¡µé¢å†…å®¹è¿›è¡Œå¢åˆ æ”¹ï¼Œ&lt;code&gt;Vue&lt;/code&gt;å¯¹è±¡ä¸Šæœ‰ä¸€ä¸ªå…¨å±€å‡½æ•°&lt;code&gt;compile&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;import { compileToFunctions } from &#39;./compiler/index&#39;
......
Vue.compile = compileToFunctions
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œä»–æ˜¯å¼•ç”¨çš„&lt;code&gt;./compiler/index&lt;/code&gt;æ¨¡å—å¯¼å‡ºçš„&lt;code&gt;compileToFunctions&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;import { baseOptions } from &#39;./options&#39;
import { createCompiler } from &#39;compiler/index&#39;
const { compile, compileToFunctions } = createCompiler(baseOptions)
export { compile, compileToFunctions }

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;baseOptions&lt;/code&gt;ï¼Œå¯¹è§£ææ¨¡æ¿çš„ä¸€äº›é€‰é¡¹è¿›è¡ŒåŸºæœ¬çš„å®šä¹‰ï¼Œè§„å®šå¦‚æœè§£ææ¨¡æ¿ä¸­çš„å„ç§æ ‡ç­¾æˆ–ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export const baseOptions: CompilerOptions = {
  expectHTML: true,
  modules,
  directives,
  isPreTag,
  isUnaryTag,
  mustUseProp,
  canBeLeftOpenTag,
  isReservedTag,
  getTagNamespace,
  staticKeys: genStaticKeys(modules)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;expectHTML&lt;/code&gt;ï¼šä¸º&lt;code&gt;true&lt;/code&gt;æ—¶ï¼Œè§£æ&lt;code&gt;HTML&lt;/code&gt;çš„ç»“æŸæ ‡ç­¾&lt;/p&gt;

&lt;p&gt;&lt;code&gt;modules&lt;/code&gt;ï¼šåŒ…æ‹¬&lt;code&gt;klass&lt;/code&gt;å’Œ&lt;code&gt;style&lt;/code&gt;ï¼Œå¯¹æ¨¡æ¿ä¸­ç±»å’Œæ ·å¼çš„è§£æã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;directives&lt;/code&gt;ï¼šè¿™é‡ŒåŒ…æ‹¬&lt;code&gt;model&lt;/code&gt;ï¼ˆ&lt;code&gt;v-model&lt;/code&gt;ï¼‰ã€&lt;code&gt;html&lt;/code&gt;ï¼ˆ&lt;code&gt;v-html&lt;/code&gt;ï¼‰ã€&lt;code&gt;text&lt;/code&gt;(&lt;code&gt;v-text&lt;/code&gt;)ä¸‰ä¸ªæŒ‡ä»¤&lt;/p&gt;

&lt;p&gt;&lt;code&gt;isPreTag&lt;/code&gt;ï¼šæ˜¯å¦æ˜¯&lt;code&gt;pre&lt;/code&gt;æ ‡ç­¾&lt;/p&gt;

&lt;p&gt;&lt;code&gt;isUnaryTag&lt;/code&gt;ï¼šæ˜¯å¦æ˜¯å•æ ‡ç­¾ï¼Œæ¯”å¦‚&lt;code&gt;img&lt;/code&gt;ã€&lt;code&gt;input&lt;/code&gt;ã€&lt;code&gt;iframe&lt;/code&gt;ç­‰&lt;/p&gt;

&lt;p&gt;&lt;code&gt;mustUseProp&lt;/code&gt;ï¼šéœ€è¦ä½¿ç”¨&lt;code&gt;props&lt;/code&gt;ç»‘å®šçš„å±æ€§ï¼Œæ¯”å¦‚&lt;code&gt;value&lt;/code&gt;ã€&lt;code&gt;selected&lt;/code&gt;ç­‰&lt;/p&gt;

&lt;p&gt;&lt;code&gt;canBeLeftOpenTag&lt;/code&gt;ï¼šå¯ä»¥ä¸é—­åˆçš„æ ‡ç­¾ï¼Œæ¯”å¦‚&lt;code&gt;tr&lt;/code&gt;ã€&lt;code&gt;td&lt;/code&gt;ç­‰&lt;/p&gt;

&lt;p&gt;&lt;code&gt;isReservedTag&lt;/code&gt;ï¼šæ˜¯å¦æ˜¯ä¿ç•™æ ‡ç­¾ï¼Œ&lt;code&gt;html&lt;/code&gt;æ ‡ç­¾å’Œ&lt;code&gt;SVG&lt;/code&gt;æ ‡ç­¾&lt;/p&gt;

&lt;p&gt;&lt;code&gt;getTagNamespace&lt;/code&gt;ï¼šè·å–å‘½åç©ºé—´ï¼Œ&lt;code&gt;svg&lt;/code&gt;å’Œ&lt;code&gt;math&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;staticKeys&lt;/code&gt;ï¼šé™æ€å…³é”®è¯ï¼ŒåŒ…æ‹¬&lt;code&gt;staticClass,staticStyle&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;ç„¶åæ˜¯&lt;code&gt;createCompiler&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function createCompilerCreator (baseCompile: Function): Function {
  // æ¥å—ä¸€ä¸ªåŸºæœ¬çš„CompilerOptions
  return function createCompiler (baseOptions: CompilerOptions) {
    function compile (
      template: string,
      options?: CompilerOptions
    ): CompiledResult {
      // finalOptionsç»§æ‰¿è‡ªbaseOptions
      const finalOptions = Object.create(baseOptions)
      const errors = []
      const tips = []

      let warn = (msg, range, tip) =&amp;gt; {
        (tip ? tips : errors).push(msg)
      }

      if (options) {
        if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; options.outputSourceRange) {
          // $flow-disable-line
          const leadingSpaceLength = template.match(/^\s*/)[0].length

          warn = (msg, range, tip) =&amp;gt; {
            const data: WarningMessage = { msg }
            if (range) {
              if (range.start != null) {
                data.start = range.start + leadingSpaceLength
              }
              if (range.end != null) {
                data.end = range.end + leadingSpaceLength
              }
            }
            (tip ? tips : errors).push(data)
          }
        }
        // åˆå¹¶modules
        if (options.modules) {
          finalOptions.modules =
            (baseOptions.modules || []).concat(options.modules)
        }
        // åˆå¹¶directives
        if (options.directives) {
          finalOptions.directives = extend(
            Object.create(baseOptions.directives || null),
            options.directives
          )
        }
        
        // é¢å¤–ä¼ å…¥çš„optionsï¼Œåˆå¹¶
        for (const key in options) {
          if (key !== &#39;modules&#39; &amp;amp;&amp;amp; key !== &#39;directives&#39;) {
            finalOptions[key] = options[key]
          }
        }
      }
	
      // æ”¶é›†åˆ°çš„é”™è¯¯æ—¥å¿—
      finalOptions.warn = warn

      const compiled = baseCompile(template.trim(), finalOptions)
      if (process.env.NODE_ENV !== &#39;production&#39;) {
        detectErrors(compiled.ast, warn)
      }
      compiled.errors = errors
      compiled.tips = tips
      // è¿”å›renderå­—ç¬¦ä¸²
      return compiled
    }

    return {
      compile,
      compileToFunctions: createCompileToFunctionFn(compile)
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¼å‡ºçš„æ¨¡å—&lt;code&gt;compileToFunctions&lt;/code&gt;ä¸º&lt;code&gt;createCompileToFunctionFn&lt;/code&gt;æ‰§è¡Œè¿”å›çš„ç»“æœ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;createCompileToFunctionFn&lt;/code&gt;ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function createCompileToFunctionFn (compile: Function): Function {
  const cache = Object.create(null)

  return function compileToFunctions (
    template: string,
    options?: CompilerOptions,
    vm?: Component
  ): CompiledFunctionResult {
    // æ‹¿åˆ°optionsï¼Œå¹¶ä¸”åˆ é™¤é”™è¯¯æ—¥å¿—ç­‰æ•°æ®
    options = extend({}, options)
    const warn = options.warn || baseWarn
    delete options.warn
		
    ......

		// å¦‚æœæœ‰ç¼“å­˜ï¼Œæ‹¿åˆ°ç¼“å­˜ä¸­çš„ç¼–è¯‘ç»“æœ
    const key = options.delimiters
      ? String(options.delimiters) + template
      : template
    if (cache[key]) {
      return cache[key]
    }

    // ç¼–è¯‘çš„ç»“æœ
    const compiled = compile(template, options)

 		......

    const res = {}
    const fnGenErrors = []
    // renderå­—ç¬¦ä¸²
    res.render = createFunction(compiled.render, fnGenErrors)
    // å°†renderå­—ç¬¦ä¸²ä¸­çš„æ ‡è¯†ç¬¦è½¬ä¸ºå‡½æ•°ï¼Œå¦‚_cã€_m
    res.staticRenderFns = compiled.staticRenderFns.map(code =&amp;gt; {
      return createFunction(code, fnGenErrors)
    })

		......

    return (cache[key] = res)
  }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.ç”Ÿæˆast&lt;/p&gt;

&lt;p&gt;åœ¨&lt;code&gt;src/compiler/parser/index.js&lt;/code&gt;ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†å„ç§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// åŒ¹é…@æˆ–v-onå¼€å¤´çš„å±æ€§
export const onRE = /^@|^v-on:/
// æ˜¯åŒ¹é…v-æˆ–@æˆ–:å¼€å¤´çš„å±æ€§
export const dirRE = /^v-|^@|^:|^\./ 
// åŒ¹é…v-forä¸­çš„å±æ€§å€¼ï¼Œæ¯”å¦‚item in itemsã€(item, index) of items
export const forAliasRE = /([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/ 
// æ˜¯å¯¹forAliasREä¸­æ•è·çš„ç¬¬ä¸€éƒ¨åˆ†å†…å®¹ï¼Œè¿›è¡Œæ‹†è§£ï¼Œv-forä¸­in|ofå‰æœ€åå¯ä»¥æœ‰ä¸‰ä¸ªé€—å·åˆ†éš”çš„å‚æ•°
export const forIteratorRE = /,([^,\}\]]*)(?:,([^,\}\]]*))?$/
// å»æ‰å­—ç¬¦ä¸² &#39;(item, index)&#39; ä¸­çš„å·¦å³æ‹¬å·
const stripParensRE = /^\(|\)$/g
// ç”¨æ¥åŒ¹é…æŒ‡ä»¤ç¼–å†™ä¸­çš„å‚æ•°
const argRE = /:(.*)$/
// åŒ¹é…ä»¥å­—ç¬¦:æˆ–å­—ç¬¦ä¸² v-bind: å¼€å¤´çš„å­—ç¬¦ä¸²
export const bindRE = /^:|^\.|^v-bind:/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;parse&lt;/code&gt;ï¼Œé‡Œé¢è§£æçš„æ–¹æ³•ä¸»è¦æ˜¯&lt;code&gt;parseHTML&lt;/code&gt;ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function parse (
	template: string,
	options: CompilerOptions
  ): ASTElement | void {
	warn = options.warn || baseWarn
  
	......
	parseHTML()
  return root
}

// src/compiler/parser/html-parser.js

export function parseHTML (html, options) {
  const stack = []
  const expectHTML = options.expectHTML
  const isUnaryTag = options.isUnaryTag || no
  const canBeLeftOpenTag = options.canBeLeftOpenTag || no
  let index = 0
  let last, lastTag
  while (html) {}

  function advance (n) {
    ...
  }

  function parseStartTag () {
    ...
  }

  function handleStartTag (match) {
    ...
  }

	function parseEndTag (tagName, start, end) {
  	...
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;parseHTML&lt;/code&gt;çš„&lt;code&gt;while&lt;/code&gt;å¾ªç¯é‡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// advanceè¿™ä¸ªæ–¹æ³•ï¼Œç”¨äºæˆªå–ä¼ å…¥çš„å­—ç¬¦ä¸²
// è¿‡æ»¤æ‰æ³¨é‡Šï¼Œdoctypeç­‰
if (comment.test(html)) {
  const commentEnd = html.indexOf(&#39;--&amp;gt;&#39;)

  if (commentEnd &amp;gt;= 0) {
    advance(commentEnd + 3)
    continue
  }
}

// è¿‡æ»¤æ–‡æ¡£ç±»å‹æ ‡ç¤ºçš„å­—ç¬¦ä¸²
const doctypeMatch = html.match(doctype)
if (doctypeMatch) {
  advance(doctypeMatch[0].length)
  continue
}

// åŒ¹é…ç»“æŸçš„æ ‡ç­¾
const endTagMatch = html.match(endTag)
if (endTagMatch) {
  const curIndex = index
  advance(endTagMatch[0].length)
  parseEndTag(endTagMatch[1], curIndex, index)
  continue
}

// åŒ¹é…å¼€å§‹æ ‡ç­¾
// ä¼ å…¥handleStartTagå¤„ç†å®Œåï¼Œä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«æ ‡ç­¾å„ç§å±æ€§çš„å¯¹è±¡
const startTagMatch = parseStartTag()
if (startTagMatch) {
  handleStartTag(startTagMatch)
  continue
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åç»­ä¼šè°ƒç”¨&lt;code&gt;parse&lt;/code&gt;é‡Œè°ƒç”¨&lt;code&gt;parseHTML&lt;/code&gt;ä¼ å…¥çš„&lt;code&gt;start&lt;/code&gt;çš„æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;start () {
  // å®šä¹‰åŸºæœ¬çš„astç»“æ„
  createASTElement()
  // è§£æv-preã€v-ifã€v-forã€v-onceã€slotã€keyã€refç­‰æŒ‡ä»¤
  processPre()
  processFor()
  ......
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¤„ç†å®Œåä¼šè°ƒç”¨&lt;code&gt;parse&lt;/code&gt;é‡Œè°ƒç”¨&lt;code&gt;parseHTML&lt;/code&gt;ä¼ å…¥çš„&lt;code&gt;end&lt;/code&gt;çš„æ–¹æ³•&lt;/p&gt;

&lt;p&gt;1ã€å–å‡º&lt;code&gt;stack&lt;/code&gt;ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚&lt;/p&gt;

&lt;p&gt;2ã€å–å‡ºè¯¥å…ƒç´ çš„æœ€åä¸€ä¸ªå­å…ƒç´ ã€‚&lt;/p&gt;

&lt;p&gt;3ã€å¦‚æœæœ€åä¸€ä¸ªå­å…ƒç´ æ˜¯çº¯æ–‡æœ¬&lt;code&gt;&#39; &#39;&lt;/code&gt;åˆ™åˆ é™¤ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ¨¡æ¿ä¸€èˆ¬éƒ½ä¼šç¼©è¿›ï¼Œéƒ½ä¼šæœ‰æ¢è¡Œï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ¸…é™¤æ¢è¡Œç­‰æ·»åŠ çš„å†…å®¹ã€‚&lt;/p&gt;

&lt;p&gt;4ã€&lt;code&gt;stack&lt;/code&gt;é•¿åº¦å‡ä¸€&lt;/p&gt;

&lt;p&gt;5ã€&lt;code&gt;currentParent&lt;/code&gt;å˜ä¸ºæ ˆä¸­æœ€åä¸€ä¸ªå…ƒç´ &lt;/p&gt;

&lt;p&gt;6ã€ å¤„ç†&lt;code&gt;v-pre&lt;/code&gt;æˆ–&lt;code&gt;pre&lt;/code&gt;çš„ç»“æŸæ ‡ç­¾&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;end (tag, start, end) {
  const element = stack[stack.length - 1]
  if (!inPre) {
    const lastNode = element.children[element.children.length - 1]
    if (lastNode &amp;amp;&amp;amp; lastNode.type === 3 &amp;amp;&amp;amp; lastNode.text === &#39; &#39;) {
      element.children.pop()
    }
  }
  stack.length -= 1
  currentParent = stack[stack.length - 1]
  if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; options.outputSourceRange) {
    element.end = end
  }
  closeElement(element)
},
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«åç§°ã€ç±»å‹ã€å±æ€§ã€çˆ¶å­èŠ‚ç‚¹ä¿¡æ¯çš„ä¸€ä¸ª&lt;code&gt;ast&lt;/code&gt;è¯­æ³•æ ‘ï¼Œå¦‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const element = {
  type: 1,
  tag: &#39;&#39;,
  attrsList: [],
  attrsMap: {},
  parent: {},
  children: []
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3.ä¼˜åŒ–é™æ€å†…å®¹ï¼Œæ‰“å¼€&lt;code&gt;src/compiler/index&lt;/code&gt;ï¼Œçœ‹åˆ°è°ƒç”¨&lt;code&gt;const ast = parse(template.trim(), options)&lt;/code&gt;ç”Ÿæˆ&lt;code&gt;ast&lt;/code&gt;åï¼Œè°ƒç”¨&lt;code&gt;optimize&lt;/code&gt;ï¼Œä¼ å…¥&lt;code&gt;ast&lt;/code&gt; ï¼Œæ‰“å¼€&lt;code&gt;optimisze&lt;/code&gt;æºç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// è·å–åŸºæœ¬é™æ€keyçš„ä¸€ä¸ªé›†åˆ
const genStaticKeysCached = cached(genStaticKeys)
export function optimize (root: ?ASTElement, options: CompilerOptions) {
  if (!root) return
  // å¦‚æœastä¸Šæœ‰staticKeysé€‰é¡¹
  isStaticKey = genStaticKeysCached(options.staticKeys || &#39;&#39;)
  // æ˜¯ä¸æ˜¯å¹³å°ä¿ç•™tagï¼Œå¦‚HTML æ ‡ç­¾
  isPlatformReservedTag = options.isReservedTag || no
  // æ ‡è®°æ‰€æœ‰é™æ€å’Œéé™æ€èŠ‚ç‚¹
  markStatic(root)
  // æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹
  markStaticRoots(root, false)
}

function genStaticKeys (keys: string): Function {
  return makeMap(
    &#39;type,tag,attrsList,attrsMap,plain,parent,children,attrs,start,end,rawAttrsMap,has$Slot&#39; +
    (keys ? &#39;,&#39; + keys : &#39;&#39;)
  )
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;markStatic&lt;/code&gt;æ ‡è®°æ‰€æœ‰é™æ€å’Œéé™æ€èŠ‚ç‚¹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function markStatic (node: ASTNode) {
  // åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºé™æ€èŠ‚ç‚¹
  // é™æ€èŠ‚ç‚¹åŒ…æ‹¬æ™®é€šå…ƒç´ ã€çº¯æ–‡æœ¬å…ƒç´ ã€v-preã€v-once
  node.static = isStatic(node)
 	// å¦‚æœtypeä¸º1ï¼Œä»£è¡¨å½“å‰èŠ‚ç‚¹ä¸ºå…ƒç´ èŠ‚ç‚¹
  if (node.type === 1) {
    if (
      // å¦‚æœä¸æ˜¯ä¿ç•™æ ‡ç­¾ï¼Œå³è‡ªå®šä¹‰æ ‡ç­¾æ—¶
      !isPlatformReservedTag(node.tag) &amp;amp;&amp;amp;
      // å¦‚æœä¸æ˜¯componentæ ‡ç­¾
      !node.component &amp;amp;&amp;amp;
      // å¦‚æœæ ‡ç­¾ä¸æ˜¯slot
      node.tag !== &#39;slot&#39; &amp;amp;&amp;amp;
      // ä¸æ˜¯ä¸€ä¸ªå†…è”æ¨¡æ¿å®¹å™¨ï¼Ÿï¼Ÿ
      node.attrsMap[&#39;inline-template&#39;] == null
    ) {
      // ç›´æ¥returnï¼Œä¸å¯¹å­èŠ‚ç‚¹åšå¤„ç†ï¼Œåä¹‹ï¼Œé€’å½’å¯¹å­èŠ‚ç‚¹åšæ ‡è®°
      return
    }
  	......
  }
}
  
function isStatic (node: ASTNode): boolean {
  // è¡¨è¾¾å¼
  if (node.type === 2) {
    return false
  }
  // text
  if (node.type === 3) { 
    return true
  }
  return !!(node.pre || (
    // æ²¡æœ‰ä»»ä½•æŒ‡ä»¤æˆ–äº‹ä»¶ç»‘å®š
    !node.hasBindings &amp;amp;&amp;amp; 
    // æ²¡æœ‰if å’Œ for æŒ‡ä»¤
    !node.if &amp;amp;&amp;amp; !node.for &amp;amp;&amp;amp; 
    // ä¸æ˜¯å†…ç½®æ ‡ç­¾ï¼Œå¦‚slot
    !isBuiltInTag(node.tag) &amp;amp;&amp;amp;
    // å¹³å°ä¿ç•™æ ‡ç­¾ï¼Œå¦‚HTML
    isPlatformReservedTag(node.tag) &amp;amp;&amp;amp; 
    // ä¸æ˜¯templateæ ‡ç­¾çš„ç›´æ¥å­å…ƒç´ ä¸”æ²¡æœ‰åŒ…å«åœ¨forå¾ªç¯ä¸­
    !isDirectChildOfTemplateFor(node) &amp;amp;&amp;amp;
    // ç»“ç‚¹åŒ…å«çš„å±æ€§åªèƒ½æœ‰isStaticKeyä¸­æŒ‡å®šçš„å‡ ä¸ª
    Object.keys(node).every(isStaticKey)
  ))
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;markStaticRoots&lt;/code&gt;æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function markStaticRoots (node: ASTNode, isInFor: boolean) {
  // åªå¤„ç†å…ƒç´ èŠ‚ç‚¹ç±»å‹
  if (node.type === 1) {
    if (node.static || node.once) {
      node.staticInFor = isInFor
    }
    // æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹çš„æ¡ä»¶ä¸ºæœ¬èº«staticæ ‡è®°ä¸ºtrue
    // å¹¶ä¸”è¯¥ç»“ç‚¹ä¸æ˜¯åªæœ‰ä¸€ä¸ªé™æ€æ–‡æœ¬å­èŠ‚ç‚¹
    if (node.static &amp;amp;&amp;amp; node.children.length &amp;amp;&amp;amp; !(
      node.children.length === 1 &amp;amp;&amp;amp;
      node.children[0].type === 3
    )) {
      node.staticRoot = true
      return
    } else {
      node.staticRoot = false
    }
		......
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4.ç”Ÿæˆrenderå­—ç¬¦ä¸²&lt;/p&gt;

&lt;p&gt;åœ¨æ ‡è®°å®Œé™æ€èŠ‚ç‚¹ä¹‹åï¼Œä¼šè°ƒç”¨&lt;code&gt;generate&lt;/code&gt;æ–¹æ³•æ¥ç”Ÿæˆrenderå­—ç¬¦ä¸²ï¼Œç”Ÿæˆçš„å­—ç¬¦ä¸²ä¸­&lt;/p&gt;

&lt;p&gt;&lt;code&gt;_c&lt;/code&gt; è¯¥æ–¹æ³•å¯¹åº”çš„æ˜¯&lt;code&gt;createElement&lt;/code&gt;æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒçš„å«ä¹‰æ˜¯åˆ›å»ºä¸€ä¸ªå…ƒç´ ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦å®šä¹‰çš„å…ƒç´ æ ‡ç­¾åã€ç¬¬äºŒä¸ªå‚æ•°æ˜¯å…ƒç´ ä¸Šæ·»åŠ çš„å±æ€§ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å­å…ƒç´ æ•°ç»„ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å­å…ƒç´ æ•°ç»„è¿›è¡Œå½’ä¸€åŒ–å¤„ç†çš„çº§åˆ«ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;_v&lt;/code&gt; è¯¥æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡æœ¬ç»“ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;_s&lt;/code&gt; æ˜¯æŠŠä¸€ä¸ªå€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;_m&lt;/code&gt; æ˜¯æ¸²æŸ“é™æ€å†…å®¹ï¼Œå®ƒæ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘æœ€ç»ˆç”Ÿæˆçš„&lt;code&gt;staticRenderFns&lt;/code&gt;æ•°ç»„ä¸­å¯¹åº”çš„å†…å®¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ ‡è¯†å…ƒç´ æ˜¯å¦åŒ…è£¹åœ¨&lt;code&gt;for&lt;/code&gt;å¾ªç¯å†…ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function generate (
  ast: ASTElement | void,
  options: CompilerOptions
): CodegenResult {
  const state = new CodegenState(options)
  // å¦‚æœastä¸ºç©ºï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºçš„divèŠ‚ç‚¹
  // æœ‰è¿‡æœ‰å€¼ï¼Œè°ƒç”¨genElement
  const code = ast ? genElement(ast, state) : &#39;_c(&amp;quot;div&amp;quot;)&#39;
  // è¿”å›renderå­—ç¬¦ä¸²
  return {
    render: `with(this){return ${code}}`,
    staticRenderFns: state.staticRenderFns
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;genElement&lt;/code&gt;ä¼šé€šè¿‡èŠ‚ç‚¹ä¸Šçš„æ ‡å¿—æ¥åˆ¤æ–­ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•æ¥ç”Ÿæˆrenderå­—ç¬¦ä¸²ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹&lt;code&gt;genStatic&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function genElement (el: ASTElement, state: CodegenState): string {
  // preçš„çŠ¶æ€ç”¨æ¥åˆ¤æ–­æ˜¯å¦è·³è¿‡å½“å‰è§£æ
  if (el.parent) {
    el.pre = el.pre || el.parent.pre
  }
	
  if (el.staticRoot &amp;amp;&amp;amp; !el.staticProcessed) {
    return genStatic(el, state)
  } 
  ...... 
		else {
      let data
      // å¦‚æœèŠ‚ç‚¹æ²¡å…¶ä»–å±æ€§æˆ–è€…è·³è¿‡è§£æï¼Œç›´æ¥genData
      // genDataè¿™ä¸ªæ–¹æ³•ä¼šç»™èŠ‚ç‚¹æ·»åŠ å„ç§å±æ€§
      if (!el.plain || (el.pre &amp;amp;&amp;amp; state.maybeComponent(el))) {
        data = genData(el, state)
      }
			
      // å¦‚æœä¸æ˜¯å†…éƒ¨æ¨¡æ¿ï¼Œè°ƒç”¨genChildrenï¼Œè¿”å›å¯¹åº”çš„å­—ç¬¦ä¸²
      const children = el.inlineTemplate ? null : genChildren(el, state, true)
      code = `_c(&#39;${el.tag}&#39;${
        data ? `,${data}` : &#39;&#39; 
      }${
        children ? `,${children}` : &#39;&#39; 
      })`
    }
    for (let i = 0; i &amp;lt; state.transforms.length; i++) {
      code = state.transforms[i](el, code)
    }
    return code
  }
}

function genStatic (el: ASTElement, state: CodegenState): string {
  el.staticProcessed = true
  // æš‚å­˜pre
  const originalPreState = state.pre
  // å¦‚æœå½“å‰èŠ‚ç‚¹preä¸ºtrueï¼Œæ›´æ”¹preçš„çŠ¶æ€
  if (el.pre) {
    state.pre = el.pre
  }
  // é€šè¿‡é€’å½’å¤„ç†é™æ€æ ¹èŠ‚ç‚¹åŠå…¶å­å†…å®¹ï¼Œæ·»åŠ åˆ°staticRenderFns
  state.staticRenderFns.push(`with(this){return ${genElement(el, state)}}`)
  // æ¢å¤preçŠ¶æ€
  state.pre = originalPreState
  return `_m(${
    state.staticRenderFns.length - 1
  }${
    el.staticInFor ? &#39;,true&#39; : &#39;&#39;
  })`
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åè¿”å›çš„ç»“æœå°±åŒ…å«&lt;code&gt;render&lt;/code&gt;å­—ç¬¦ä¸²ä»¥åŠ&lt;code&gt;staticRenderFns&lt;/code&gt;é™æ€èŠ‚ç‚¹&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Vue2.xé‡Œé¢çš„åŒå‘æ•°æ®ç»‘å®š</title>
      <link>https://xtid.github.io/2020/vue2.x%E9%87%8C%E9%9D%A2%E7%9A%84%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A/</link>
      <pubDate>Wed, 29 Jul 2020 22:13:21 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/vue2.x%E9%87%8C%E9%9D%A2%E7%9A%84%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A/</guid>
      <description>&lt;p&gt;Vue2.xçš„æ•°æ®ç»‘å®šæ˜¯é€šè¿‡æ•°æ®åŠ«æŒçš„æ–¹å¼æ¥å®ç°çš„ï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„ä¾¿æ˜¯&lt;code&gt;Object.defineProperty()&lt;/code&gt;ï¼Œè€ŒVue3.0é‡Œé¢æ•°æ®ç»‘å®šæ˜¯é€šè¿‡&lt;code&gt;Proxy&lt;/code&gt;å®ç°çš„&lt;/p&gt;

&lt;p&gt;Vue2.xçš„åŒå‘æ•°æ®ç»‘å®šï¼Œæœ‰ä¸‰ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„éƒ¨åˆ†&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Observer&lt;/code&gt;ï¼šé€šè¿‡&lt;code&gt;Object.defineProperty&lt;/code&gt;æ¥åšæ•°æ®åŠ«æŒï¼Œé€’å½’åœ°ç›‘å¬å¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§ï¼Œåœ¨å±æ€§å€¼æ”¹å˜çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”çš„&lt;code&gt;Watcher&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Watcher&lt;/code&gt;ï¼šè®¢é˜…è€…ï¼Œå½“ç›‘å¬çš„æ•°æ®å€¼ä¿®æ”¹æ—¶ï¼Œæ‰§è¡Œé€šçŸ¥&lt;code&gt;Dep&lt;/code&gt;æ‰§è¡Œå¯¹åº”çš„å“åº”çš„å›è°ƒå‡½æ•°&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Dep&lt;/code&gt;ï¼šå°†&lt;code&gt;Observer&lt;/code&gt;å’Œ&lt;code&gt;Watcher&lt;/code&gt;å…³è”èµ·æ¥ï¼Œè¿™ä¸ªåŒå‘æ•°æ®ç»‘å®šå®ç°çš„è®¾è®¡æ¨¡å¼ä¸ºå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œ&lt;code&gt;Dep&lt;/code&gt;å°±ç›¸å½“äºå‘å¸ƒè®¢é˜…æ¨¡å¼çš„ä¸­é—´å¯¹è±¡&lt;/p&gt;

&lt;p&gt;Observer&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export class Observer {
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that have this object as root $data

  constructor (value: any) {
    this.value = value
    this.dep = new Dep()
    this.vmCount = 0
    // é€šè¿‡Object.definePropertyè®¾ç½®_ob_å€¼ï¼Œä½¿ç”¨_ob_å¯ä»¥ç›´æ¥æ‹¿åˆ°Observerå¯¹è±¡
    def(value, &#39;__ob__&#39;, this)
    if (Array.isArray(value)) {
      if (hasProto) {
        protoAugment(value, arrayMethods)
      } else {
        copyAugment(value, arrayMethods, arrayKeys)
      }
      // å¦‚æœæ˜¯æ•°ç»„ï¼Œè°ƒç”¨observeArrayå¤„ç†
      this.observeArray(value)
    } else {
      // å¦‚æœæ˜¯å…¶ä»–å¯¹è±¡è°ƒç”¨walkå¤„ç†
      this.walk(value)
    }
  }

  walk (obj: Object) {
    const keys = Object.keys(obj)
    // éå†å¯¹è±¡å±æ€§ï¼Œå¯¹æ¯ä¸ªå±æ€§æ·»åŠ æ•°æ®é‚¦æ•°æ®ç»‘å®š
    for (let i = 0; i &amp;lt; keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }

  observeArray (items: Array&amp;lt;any&amp;gt;) {
    // å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™å¾ªç¯éå†æ•°ç»„ï¼Œè°ƒç”¨observe
    for (let i = 0, l = items.length; i &amp;lt; l; i++) {
      observe(items[i])
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;defineReactive&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  const dep = new Dep()
	
  // è·å–objä¸Šå¯¹åº”å±æ€§keyçš„æè¿°ç¬¦ï¼Œå¦‚æœconfigurableä¸ºfalseï¼Œå±æ€§ä¸èƒ½æ”¹å˜ï¼Œreturn
  const property = Object.getOwnPropertyDescriptor(obj, key)
  if (property &amp;amp;&amp;amp; property.configurable === false) {
    return
  }

  const getter = property &amp;amp;&amp;amp; property.get
  const setter = property &amp;amp;&amp;amp; property.set
  if ((!getter || setter) &amp;amp;&amp;amp; arguments.length === 2) {
    val = obj[key]
  }

  let childOb = !shallow &amp;amp;&amp;amp; observe(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      // è·å–è¿™ä¸ªå€¼
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        // å°†å½“å‰depæ·»åŠ åˆ°targetä¸­ï¼Œç„¶åå°†depæ·»åŠ åˆ°subsä¸­	
        dep.depend()
        if (childOb) 
          childOb.dep.depend()
          if (Array.isArray(value)) {
						// å¦‚æœä¼ å…¥çš„å€¼ä¸ºæ•°ç»„ï¼Œéå†è¿™ä¸ªæ•°ç»„ï¼Œå¯¹æ¯ä¸€ä¸ªå…ƒç´ depend
            dependArray(value)
          }
        }
      }
      return value
    },
    set: function reactiveSetter (newVal) {
    	// è·å–å¯¹è±¡åŸæ¥çš„å€¼
      const value = getter ? getter.call(obj) : val
      // å¦‚æœæ–°è®¾ç½®çš„å€¼å’ŒåŸæ¥çš„å€¼ä¸€æ ·ï¼Œç›´æ¥return
      if (newVal === value || (newVal !== newVal &amp;amp;&amp;amp; value !== value)) {
        return
      }
    	// æ‰“å°é”™è¯¯
      if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; customSetter) {
        customSetter()
      }
    	// è‹¥å±æ€§ä¸Šè®¾ç½®äº†getteræ²¡è®¾ç½®setterï¼Œreturn
      if (getter &amp;amp;&amp;amp; !setter) return
      if (setter) {
        setter.call(obj, newVal)
      } else {
        // è®¾ç½®æ–°çš„å€¼
        val = newVal
      }
    	// åˆ›å»ºä¸€ä¸ªæ–°çš„observeï¼Œå¹¶è§¦å‘å¯¹åº”çš„æ›´æ–°äº‹ä»¶
      childOb = !shallow &amp;amp;&amp;amp; observe(newVal)
      dep.notify()
    }
  })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;observe&lt;/code&gt;è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯è¿”å›ä¸å¯¹è±¡ç›¸å…³çš„&lt;code&gt;Observer&lt;/code&gt;å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ª&lt;code&gt;Observer&lt;/code&gt;å¯¹è±¡å¹¶è¿”å›&lt;/p&gt;

&lt;p&gt;defineReactiveä¸­è¿˜æœ‰å‡ ä¸ªæ–¹æ³•ï¼Œ&lt;code&gt;protoAugment&lt;/code&gt;å’Œ&lt;code&gt;copyAugment&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;var arrayProto = Array.prototype
var arrayMethods = Object.create(arrayProto)
function protoAugment (target, src) {
  target.__proto__ = src;
}
protoAugment(value, arrayMethods)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¹äºæ•°ç»„å¯¹è±¡æ¥è¯´åœ¨å½“å‰ç¯å¢ƒå¦‚æœèƒ½ä½¿ç”¨&lt;code&gt;__proto__&lt;/code&gt;å¯¹è±¡(&lt;code&gt;__proto__ in {}&lt;/code&gt;)ï¼Œåˆ™è°ƒç”¨&lt;code&gt;protoAugment&lt;/code&gt;ï¼Œå…¶å®å°±æ˜¯å°†å½“å‰çš„æ•°ç»„å¯¹è±¡&lt;code&gt;__proto__&lt;/code&gt;æŒ‡å‘æ•°ç»„åŸå‹å¯¹è±¡ï¼Œç„¶åå¯¹äº&lt;code&gt;push&lt;/code&gt;ã€&lt;code&gt;pop&lt;/code&gt;ã€&lt;code&gt;shift&lt;/code&gt;ã€&lt;code&gt;unshift&lt;/code&gt;ã€&lt;code&gt;splice&lt;/code&gt;ã€&lt;code&gt;sort&lt;/code&gt;ã€&lt;code&gt;reverse&lt;/code&gt;è¿™äº›æ“ä½œæ•°ç»„çš„æ–¹æ³•ï¼Œéå†ï¼Œæ·»åŠ åˆ°&lt;code&gt;arrayMethods&lt;/code&gt;ä¸Šï¼Œæ“ä½œä¹‹åï¼Œè°ƒç”¨&lt;code&gt;ob.dep.notify()&lt;/code&gt;è§¦å‘æ›´æ–°&lt;/p&gt;

&lt;p&gt;&lt;code&gt;copyAugment&lt;/code&gt;åˆ™æ˜¯åœ¨å¾ªç¯ä¸­æŠŠ&lt;code&gt;arrayMethods&lt;/code&gt;ä¸Šçš„&lt;code&gt;arrayKeys&lt;/code&gt;æ–¹æ³•æ·»åŠ åˆ°&lt;code&gt;value&lt;/code&gt;ä¸Š&lt;/p&gt;

&lt;p&gt;Dep&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Dep&lt;/code&gt;çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç®€å•çš„ä¿å­˜äº†ä¸€ä¸ª&lt;code&gt;Wacher&lt;/code&gt;æ•°ç»„ï¼Œæœ‰ä¸€äº›å¢åˆ çš„æ–¹æ³•ï¼Œæœ€å&lt;code&gt;notify&lt;/code&gt;è°ƒç”¨å¯¹åº”&lt;code&gt;Wacher&lt;/code&gt;æ›´æ–°çš„æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array&amp;lt;Watcher&amp;gt;;

  constructor () {
    this.id = uid++
    this.subs = []
  }

  addSub (sub: Watcher) {
    this.subs.push(sub)
  }

  removeSub (sub: Watcher) {
    remove(this.subs, sub)
  }

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    const subs = this.subs.slice()
    if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; !config.async) {
      subs.sort((a, b) =&amp;gt; a.id - b.id)
    }
    for (let i = 0, l = subs.length; i &amp;lt; l; i++) {
      subs[i].update()
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Watcher&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export default class Watcher {
	......
  constructor (
    vm: Component,
    expOrFn: string | Function,
    cb: Function,
    options?: ?Object,
    isRenderWatcher?: boolean
  ) {
    this.vm = vm
    if (isRenderWatcher) {
      vm._watcher = this
    }
    vm._watchers.push(this)
    // åˆ›å»ºWatcheræ—¶ä¼ çš„options
    // å¦‚ä¹‹å‰è°ƒç”¨updateComponetæ–¹æ³•æ—¶ï¼Œä¼ å…¥beforeæ¥è°ƒç”¨beforeUpdateé’©å­å‡½æ•°
    if (options) {
      this.deep = !!options.deep
      this.user = !!options.user
      this.lazy = !!options.lazy
      this.sync = !!options.sync
      this.before = options.before
    } else {
      this.deep = this.user = this.lazy = this.sync = false
    }
    this.cb = cb
    this.id = ++uid 
    this.active = true
    this.dirty = this.lazy 
    this.deps = []
    this.newDeps = []
    this.depIds = new Set()
    this.newDepIds = new Set()
    this.expression = process.env.NODE_ENV !== &#39;production&#39;
      ? expOrFn.toString()
      : &#39;&#39;
    
    // è®¾ç½®getter
    // å¦‚æœä¼ å…¥expOrFnæ˜¯ä¸€ä¸ªå‡½æ•°
    if (typeof expOrFn === &#39;function&#39;) {
      this.getter = expOrFn
    } else {
      // å¦‚æœä¼ å…¥çš„ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡parsePathè§£æï¼Œèµ‹å€¼ç»™getter
      this.getter = parsePath(expOrFn)
      if (!this.getter) {
        // å¦‚æœè§£æå‡ºæ¥çš„getterä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè®¾ç½®ä¸ºç©º noopï¼Œå¹¶æ‰“å°é”™è¯¯
        this.getter = noop
        process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; warn(
          `Failed watching path: &amp;quot;${expOrFn}&amp;quot; ` +
          &#39;Watcher only accepts simple dot-delimited paths. &#39; +
          &#39;For full control, use a function instead.&#39;,
          vm
        )
      }
    }
    this.value = this.lazy
      ? undefined
      : this.get()
  }

  /**
   * Evaluate the getter, and re-collect dependencies.
   */
  get () {
    // è®¾ç½®Dep.tartgetä¸ºå½“å‰watcherï¼Œè¿™æ ·å®ƒå°±æœ‰addSubã€removeSubç­‰æ–¹æ³•
    pushTarget(this)
    let value
    const vm = this.vm
    try {
      // å¾—åˆ°è°ƒç”¨getterçš„value
      value = this.getter.call(vm, vm)
    } catch (e) {
      if (this.user) {
        handleError(e, vm, `getter for watcher &amp;quot;${this.expression}&amp;quot;`)
      } else {
        throw e
      }
    } finally {
      if (this.deep) {
        traverse(value)
      }
      // æ¸…æ¥šDepï¼Œç§»å‡ºtargeté˜Ÿåˆ—ï¼Œé‡æ–°è®¾ç½®Dep.targetå€¼
      popTarget()
      this.cleanupDeps()
    }
    
    // åœ¨è¿›è¡Œæ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ï¼Œvalueä¸ºundefined
    return value
  }
	
	......
	
  // åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œè°ƒç”¨dep.notifyï¼Œä¼šè§¦å‘updateæ–¹æ³•
  update () {
    if (this.lazy) {
      this.dirty = true
    } else if (this.sync) {
      // è‹¥ç”ŸæˆWatcherä¼ å…¥é…ç½®sync
      // åœ¨æ›´æ–°çš„æ—¶å€™ç›´æ¥è°ƒç”¨runæ–¹æ³•ï¼Œè°ƒç”¨å›æ‰æ–¹æ³•
      this.run()
    } else {
      // å¦‚æœä¸æ˜¯syncé…ç½®ï¼Œå¤„ç†Watcheré˜Ÿåˆ—
      // queueWatcheræ–¹æ³•é‡Œä¼šä½¿ç”¨ä¸€ä¸ªidæ¥è¡¨ç¤ºWatcherçš„ä¼˜å…ˆçº§ï¼Œä¾æ¬¡æ‰§è¡Œä¸Šé¢çš„runæ–¹æ³•
      // æ›´æ–°çš„æ—¶å€™å¦‚æœwatcheråˆ—è¡¨æ­£åœ¨æ›´æ–°ï¼Œåˆ™æŠŠæ–°çš„watcheræ·»åŠ åˆ°å¯¹åº”çš„ä½ç½®ï¼Œå¹¶æ›´æ–°
      // å¦åˆ™ï¼Œåœ¨ä¸‹ä¸€ä¸ªnextTickä¸­æ‰§è¡ŒflushSchedulerQueue
      queueWatcher(this)
    }
  }

  run () {
    if (this.active) {
      const value = this.get()
      if (
        value !== this.value ||
        isObject(value) ||
        this.deep
      ) {
        const oldValue = this.value
        this.value = value
        if (this.user) {
          try {
            this.cb.call(this.vm, value, oldValue)
          } catch (e) {
            handleError(e, this.vm, `callback for watcher &amp;quot;${this.expression}&amp;quot;`)
          }
        } else {
          // å›è°ƒ
          this.cb.call(this.vm, value, oldValue)
        }
      }
    }
  }
	
	......
}

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Vueçš„åˆå§‹åŒ–æ¸²æŸ“è¿‡ç¨‹ç®€ä»‹</title>
      <link>https://xtid.github.io/2020/vue%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E7%AE%80%E4%BB%8B/</link>
      <pubDate>Mon, 27 Jul 2020 22:25:56 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/vue%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E7%AE%80%E4%BB%8B/</guid>
      <description>&lt;p&gt;é¦–å…ˆè¿›å…¥åˆ°&lt;code&gt;src/core/instance/index.js&lt;/code&gt;ï¼Œå¯ä»¥çœ‹åˆ°å®šä¹‰äº†ä¸€ä¸ª&lt;code&gt;Vue&lt;/code&gt;æ„é€ å‡½æ•°ï¼Œå†…å®¹å¾ˆç®€å•ï¼Œå¦‚æœä¸æ˜¯ç”Ÿäº§ç¯å¢ƒå¹¶ä¸”ä¸æ˜¯é€šè¿‡&lt;code&gt;new&lt;/code&gt;å…³é”®å­—åˆ›å»ºå¯¹è±¡çš„è¯ï¼Œå°±åœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸ª&lt;code&gt;warn&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function Vue (options) {
  if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp;
    !(this instanceof Vue)
  ) {
    warn(&#39;Vue is a constructor and should be called with the `new` keyword&#39;)
  }
  this._init(options)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åé¢è°ƒç”¨äº†å‡ ä¸ªå‡½æ•°ï¼Œç”¨æ¥åœ¨&lt;code&gt;Vue&lt;/code&gt;å¯¹è±¡ä¸Šåˆ›å»ºå„ç§å±æ€§æˆ–è€…æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;initMixin(Vue)
stateMixin(Vue)
eventsMixin(Vue)
lifecycleMixin(Vue)
renderMixin(Vue)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;1.initMixin&lt;/h2&gt;

&lt;p&gt;åˆå§‹åŒ–æ–¹æ³•ï¼Œé¦–å…ˆä¸ºå½“å‰&lt;code&gt;vm&lt;/code&gt;è®¾ç½®ä¸€ä¸ª&lt;code&gt;_uid&lt;/code&gt;ï¼Œç„¶åæ·»åŠ å±æ€§&lt;code&gt;_isVue&lt;/code&gt;ï¼Œå…¶ç›®çš„åœ¨äºç›‘å¬æ•°æ®å˜åŒ–æ—¶è¿‡æ»¤&lt;code&gt;vm&lt;/code&gt;ï¼Œ&lt;code&gt;_isComponent&lt;/code&gt;æ˜¯å†…éƒ¨åˆ›å»ºå­ç»„ä»¶æ—¶æ‰ä¼šæ·»åŠ ä¸º&lt;code&gt;true&lt;/code&gt;çš„å±æ€§ï¼Œç„¶åèµ°åˆ°&lt;code&gt;else&lt;/code&gt;åˆ†æ”¯ï¼Œè°ƒç”¨&lt;code&gt;resolveConstructorOptions&lt;/code&gt;ä¼šè·å–æ„é€ å™¨çˆ¶çº§çš„&lt;code&gt;options&lt;/code&gt;ï¼Œç„¶åè°ƒç”¨&lt;code&gt;mergeOptions&lt;/code&gt;åˆå¹¶çˆ¶çº§çš„&lt;code&gt;options&lt;/code&gt;ä»¥åŠæœ¬èº«ä¼ å…¥çš„&lt;code&gt;options&lt;/code&gt;ï¼Œæœ€åç”Ÿæˆçš„&lt;code&gt;options&lt;/code&gt;åŒ…å«&lt;code&gt;componentsã€directives&lt;/code&gt;ç­‰å±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function initMixin (Vue: Class&amp;lt;Component&amp;gt;) {
  Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
    // a uid
    vm._uid = uid++

    let startTag, endTag
    /* istanbul ignore if */
    if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; config.performance &amp;amp;&amp;amp; mark) {
      startTag = `vue-perf-start:${vm._uid}`
      endTag = `vue-perf-end:${vm._uid}`
      mark(startTag)
    }

    // a flag to avoid this being observed
    vm._isVue = true
    // merge options
    if (options &amp;amp;&amp;amp; options._isComponent) {
      // optimize internal component instantiation
      // since dynamic options merging is pretty slow, and none of the
      // internal component options needs special treatment.
      initInternalComponent(vm, options)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
    /* istanbul ignore else */
    if (process.env.NODE_ENV !== &#39;production&#39;) {
      initProxy(vm)
    } else {
      vm._renderProxy = vm
    }
    // expose real self
    vm._self = vm
    initLifecycle(vm)
    initEvents(vm)
    initRender(vm)
    callHook(vm, &#39;beforeCreate&#39;)
    initInjections(vm) // resolve injections before data/props
    initState(vm)
    initProvide(vm) // resolve provide after data/props
    callHook(vm, &#39;created&#39;)

    /* istanbul ignore if */
    if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; config.performance &amp;amp;&amp;amp; mark) {
      vm._name = formatComponentName(vm, false)
      mark(endTag)
      measure(`vue ${vm._name} init`, startTag, endTag)
    }

    if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt; 1.1initLifecycle &lt;/h3&gt;

&lt;p&gt;è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šè®¾ç½®&lt;code&gt;vm&lt;/code&gt;çš„ä¸€ä¸ªçˆ¶å­èŠ‚ç‚¹ã€æ ¹èŠ‚ç‚¹ä¿¡æ¯ï¼Œç„¶åä¼šå®šä¹‰ä¸€äº›ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚&lt;code&gt;_isMountedã€_isDestroyedã€_isBeingDestroyed&lt;/code&gt;ç­‰&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function initLifecycle (vm: Component) {
  const options = vm.$options

  // locate first non-abstract parent
  let parent = options.parent
  if (parent &amp;amp;&amp;amp; !options.abstract) {
    while (parent.$options.abstract &amp;amp;&amp;amp; parent.$parent) {
      parent = parent.$parent
    }
    parent.$children.push(vm)
  }

  vm.$parent = parent
  vm.$root = parent ? parent.$root : vm

  vm.$children = []
  vm.$refs = {}

  vm._watcher = null
  vm._inactive = null
  vm._directInactive = false
  vm._isMounted = false
  vm._isDestroyed = false
  vm._isBeingDestroyed = false
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt; 1.2initEvents &lt;/h3&gt;

&lt;p&gt;é€šè¿‡åå­—å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ä¸ªåˆå§‹åŒ–äº‹ä»¶ç›¸å…³çš„æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function initEvents (vm: Component) {
  // eventsè¡¨ç¤ºçˆ¶ç»„ä»¶ç»‘å®šåœ¨å½“å‰ç»„ä»¶ä¸Šçš„äº‹ä»¶
  vm._events = Object.create(null)
  // å±æ€§è¡¨ç¤ºçˆ¶ç»„ä»¶æ˜¯å¦é€šè¿‡&amp;quot;@hook:&amp;quot;æŠŠé’©å­å‡½æ•°ç»‘å®šåœ¨å½“å‰ç»„ä»¶ä¸Š
  vm._hasHookEvent = false
  // init parent attached events
  // åŒæ ·æ˜¯æ¥è¡¨ç¤ºçˆ¶ç»„ä»¶ç»‘å®šåœ¨å½“å‰ç»„ä»¶ä¸Šçš„äº‹ä»¶
  const listeners = vm.$options._parentListeners
  if (listeners) {
    updateComponentListeners(vm, listeners)
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœ&lt;code&gt;listeners&lt;/code&gt;æœ‰å€¼ï¼Œåˆ™è°ƒç”¨&lt;code&gt;updateComponentListeners&lt;/code&gt;è¿™ä¸ªæ–¹æ³•ï¼Œå…¶å†…éƒ¨è°ƒç”¨äº†&lt;code&gt;updateListeners&lt;/code&gt;ï¼Œå…¶ä¸­çš„&lt;code&gt;add&lt;/code&gt;æ–¹æ³•ä¼šè°ƒç”¨&lt;code&gt;vm.$on&lt;/code&gt;ï¼Œ&lt;code&gt;vm.$on&lt;/code&gt;ä¼šç›‘å¬å½“å‰å®ä¾‹ä¸Šçš„è‡ªå®šä¹‰äº‹ä»¶ï¼Œ&lt;code&gt;remove&lt;/code&gt;ä¼šè°ƒç”¨&lt;code&gt;vm.$off&lt;/code&gt;ï¼Œç§»å‡ºè¿™ä¸ªäº‹ä»¶ç›‘å¬&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function add (event, fn) {
  target.$on(event, fn)
}

function remove (event, fn) {
  target.$off(event, fn)
}

export function updateComponentListeners (
  vm: Component,
  listeners: Object,
  oldListeners: ?Object
) {
  // ä¿å­˜å½“å‰çš„vmå¼•ç”¨
  target = vm
  // ä¼ å…¥listenersï¼Œçˆ¶ç»„ä»¶ç»‘å®šåœ¨å½“å‰ç»„ä»¶ä¸Šçš„äº‹ä»¶ï¼ŒoldListenersåŒç†ï¼Œä¸è¿‡åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–çš„æ—¶å€™ä¸ºç©º
  // å…¶å†…éƒ¨ä¼šéå†listenersè°ƒç”¨addæ–¹æ³•æ·»åŠ ç›‘å¬äº‹ä»¶ï¼ŒåŒæ—¶ç§»å‡ºoldListeners
  updateListeners(listeners, oldListeners || {}, add, remove, createOnceHandler, vm)
  target = undefined
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt; 1.3initRender &lt;/h3&gt;

&lt;p&gt;ä¸»è¦æ˜¯æ·»åŠ äº†ä¸€äº›è™šæ‹Ÿdomã€&lt;code&gt;slot&lt;/code&gt;ç­‰ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function initRender (vm: Component) {
  // è¡¨ç¤ºè™šæ‹ŸdomèŠ‚ç‚¹
  vm._vnode = null 
  // è¡¨ç¤ºå½“å‰å®ä¾‹renderå¾—åˆ°çš„Vnode
  vm._staticTrees = null 
  const options = vm.$options
  const parentVnode = vm.$vnode = options._parentVnode  tree
  const renderContext = parentVnode &amp;amp;&amp;amp; parentVnode.context
  // ç”Ÿæˆæ’æ§½å†…å®¹
  vm.$slots = resolveSlots(options._renderChildren, renderContext)
  // ä½œç”¨åŸŸæ’æ§½ï¼Œæ­¤æ—¶ä¸ºç©º
  vm.$scopedSlots = emptyObject
  vm._c = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, false)
  vm.$createElement = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, true)
  const parentData = parentVnode &amp;amp;&amp;amp; parentVnode.data
	......
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;resolveSlots&lt;/code&gt;æ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function resolveSlots (
  children: ?Array&amp;lt;VNode&amp;gt;,
  context: ?Component
): { [key: string]: Array&amp;lt;VNode&amp;gt; } {
  if (!children || !children.length) {
    return {}
  }
  const slots = {}
  // éå†å½“å‰èŠ‚ç‚¹chilren
  for (let i = 0, l = children.length; i &amp;lt; l; i++) {
    const child = children[i]
    // è·å–data
    const data = child.data
    if (data &amp;amp;&amp;amp; data.attrs &amp;amp;&amp;amp; data.attrs.slot) {
      delete data.attrs.slot
    }
    if ((child.context === context || child.fnContext === context) &amp;amp;&amp;amp;
      data &amp;amp;&amp;amp; data.slot != null
    ) {
      // æ‹¿åˆ°æ’æ§½åç§°
      const name = data.slot
      const slot = (slots[name] || (slots[name] = []))
      if (child.tag === &#39;template&#39;) {
        slot.push.apply(slot, child.children || [])
      } else {
        slot.push(child)
      }
    } else {
      // å¦‚æœ data.slot ä¸å­˜åœ¨ï¼Œåˆ™æ˜¯é»˜è®¤æ’æ§½çš„å†…å®¹ï¼Œåˆ™æŠŠå¯¹åº”çš„ child æ·»åŠ åˆ° slots.defaults ä¸­
      (slots.default || (slots.default = [])).push(child)
    }
  }
  // æœ€åè¿‡æ»¤ä¸€äº›ç©ºå†…å®¹
  for (const name in slots) {
    if (slots[name].every(isWhitespace)) {
      delete slots[name]
    }
  }
  return slots
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è°ƒç”¨é’©å­å‡½æ•°&lt;code&gt;beforeCreate&lt;/code&gt;&lt;/p&gt;

&lt;h3&gt; 1.4initProvideå’ŒinitInjection &lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function initProvide (vm) {
  var provide = vm.$options.provide;
  if (provide) {
    vm._provided = typeof provide === &#39;function&#39;
      ? provide.call(vm)
    : provide;
  }
}
function initInjections (vm) {
  // è·å–å½“å‰èŠ‚ç‚¹ä¸Šçš„injectå±æ€§
  var result = resolveInject(vm.$options.inject, vm);
  if (result) {
    toggleObserving(false);
    // éå†è¿™äº›å±æ€§ï¼ŒdefineReactiveï¼Œå°†è¿™äº›å±æ€§å˜æˆå“åº”å¼çš„
    Object.keys(result).forEach(function (key) {
      /* istanbul ignore else */
      {
        defineReactive$$1(vm, key, result[key], function () {
          warn(
            &amp;quot;Avoid mutating an injected value directly since the changes will be &amp;quot; +
            &amp;quot;overwritten whenever the provided component re-renders. &amp;quot; +
            &amp;quot;injection being mutated: \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot;&amp;quot;,
            vm
          );
        });
      }
    });
    toggleObserving(true);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt; 1.5initState &lt;/h3&gt;

&lt;p&gt;ä¸»è¦æ˜¯åˆå§‹åŒ–ä¸€äº›æ•°æ®å’Œå±æ€§ï¼Œæ¯”å¦‚&lt;code&gt;props&lt;/code&gt;ã€&lt;code&gt;methods&lt;/code&gt;ã€&lt;code&gt;data&lt;/code&gt;ã€&lt;code&gt;computed&lt;/code&gt;ã€&lt;code&gt;watch&lt;/code&gt;,&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function initState (vm) {
  vm._watchers = [];
  var opts = vm.$options;
  if (opts.props) { initProps(vm, opts.props); }
  if (opts.methods) { initMethods(vm, opts.methods); }
  if (opts.data) {
    initData(vm);
  } else {
    observe(vm._data = {}, true /* asRootData */);
  }
  if (opts.computed) { initComputed(vm, opts.computed); }
  if (opts.watch &amp;amp;&amp;amp; opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆå§‹åŒ–&lt;code&gt;props&lt;/code&gt;å±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function initProps (vm, propsOptions) {
  // è·å–å½“å‰èŠ‚ç‚¹çš„propså±æ€§å€¼
  var propsData = vm.$options.propsData || {};
  var props = vm._props = {};
  var isRoot = !vm.$parent;
  // ç”¨äºä¿å­˜å½“å‰ç»„ä»¶çš„propsé‡Œçš„keyï¼Œä»¥ä¾¿ä¹‹ååœ¨çˆ¶ç»„ä»¶æ›´æ–°propsæ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨æ•°ç»„è¿­ä»£
  var keys = vm.$options._propKeys = [];
  var isRoot = !vm.$parent;
  if (!isRoot) {
    toggleObserving(false);
  }
  var loop = function ( key ) {
    keys.push(key);
    // validatePropéªŒè¯å½“å‰prop[key]æ˜¯å¦propsOptionså®šä¹‰çš„è¦æ±‚
    var value = validateProp(key, propsOptions, propsData, vm);
    {
      var hyphenatedKey = hyphenate(key);
      if (isReservedAttribute(hyphenatedKey) ||
          config.isReservedAttr(hyphenatedKey)) {
        warn(
          (&amp;quot;\&amp;quot;&amp;quot; + hyphenatedKey + &amp;quot;\&amp;quot; is a reserved attribute and cannot be used as component prop.&amp;quot;),
          vm
        );
      }
      // æ·»åŠ å“åº”å¼å±æ€§ï¼Œè¿™æ ·propsé‡Œé¢çš„å€¼æ”¹å˜ä¹‹åï¼Œç»„ä»¶ä¼šè‡ªåŠ¨æ›´æ–°è§†å›¾
      defineReactive$$1(props, key, value, function () {
        if (!isRoot &amp;amp;&amp;amp; !isUpdatingChildComponent) {
          warn(
            &amp;quot;Avoid mutating a prop directly since the value will be &amp;quot; +
            &amp;quot;overwritten whenever the parent component re-renders. &amp;quot; +
            &amp;quot;Instead, use a data or computed property based on the prop&#39;s &amp;quot; +
            &amp;quot;value. Prop being mutated: \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot;&amp;quot;,
            vm
          );
        }
      });
    }
    // static props are already proxied on the component&#39;s prototype
    // during Vue.extend(). We only need to proxy props defined at
    // instantiation here.
    if (!(key in vm)) {
      proxy(vm, &amp;quot;_props&amp;quot;, key);
    }
  };
	// å¾ªç¯éå†key
  for (var key in propsOptions) loop( key );
  toggleObserving(true);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆå§‹åŒ–&lt;code&gt;methods&lt;/code&gt;å±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function initMethods (vm, methods) {
  // propså±æ€§ç”¨äºåˆ¤æ–­methodsä¸­çš„æ–¹æ³•åæ˜¯å¦å’Œpropsçš„å±æ€§é‡å
  var props = vm.$options.props;
  for (var key in methods) {
    {
      if (typeof methods[key] !== &#39;function&#39;) {
        warn(
          &amp;quot;Method \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; has type \&amp;quot;&amp;quot; + (typeof methods[key]) + &amp;quot;\&amp;quot; in the component definition. &amp;quot; +
          &amp;quot;Did you reference the function correctly?&amp;quot;,
          vm
        );
      }
      // å¦‚æœpropsä¸­æœ‰åŒåå±æ€§ï¼Œåˆ™æŠ¥é”™
      if (props &amp;amp;&amp;amp; hasOwn(props, key)) {
        warn(
          (&amp;quot;Method \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; has already been defined as a prop.&amp;quot;),
          vm
        );
      }
      // å¦‚æœkeyæ˜¯ä»¥$æˆ–_å¼€å¤´åˆ™ï¼Œä¹ŸæŠ¥é”™
      if ((key in vm) &amp;amp;&amp;amp; isReserved(key)) {
        warn(
          &amp;quot;Method \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; conflicts with an existing Vue instance method. &amp;quot; +
          &amp;quot;Avoid defining component methods that start with _ or $.&amp;quot;
        );
      }
    }
    vm[key] = typeof methods[key] !== &#39;function&#39; ? noop : bind(methods[key], vm);
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆå§‹åŒ–&lt;code&gt;data&lt;/code&gt;å±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function initData (vm) {
  // è·å–dataå±æ€§
  var data = vm.$options.data;
  // å¦‚æœdataæ˜¯ä¸€ä¸ªfunctionï¼Œåˆ™è°ƒç”¨getDataè¿”å›é‡Œé¢çš„å€¼ï¼Œå¦åˆ™ç›´æ¥å°†dataå±æ€§èµ‹ç»™_data
  data = vm._data = typeof data === &#39;function&#39;
    ? getData(data, vm)
  : data || {};
  // å¦‚æœdataå±æ€§ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè®¾ç½®dataä¸ºç©ºå¯¹è±¡ï¼Œå¹¶æ‰“å°ä¸€ä¸ªwarn
  if (!isPlainObject(data)) {
    data = {};
    warn(
      &#39;data functions should return an object:\n&#39; +
      &#39;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#39;,
      vm
    );
  }
  // è·å–data keysï¼Œpropså±æ€§ï¼Œmethodså±æ€§
  var keys = Object.keys(data);
  var props = vm.$options.props;
  var methods = vm.$options.methods;
  var i = keys.length;
  while (i--) {
    var key = keys[i];
    {
      // å½“å‰dataçš„keyå¦‚æœå’Œmethodsä¸­çš„æ–¹æ³•é‡åï¼ŒæŠ›å‡ºè­¦å‘Š
      if (methods &amp;amp;&amp;amp; hasOwn(methods, key)) {
        warn(
          (&amp;quot;Method \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; has already been defined as a data property.&amp;quot;),
          vm
        );
      }
    }
    // å½“å‰dataçš„keyå¦‚æœå’Œpropsä¸­çš„å±æ€§é‡åï¼ŒæŠ›å‡ºè­¦å‘Š
    if (props &amp;amp;&amp;amp; hasOwn(props, key)) {
      warn(
        &amp;quot;The data property \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; is already declared as a prop. &amp;quot; +
        &amp;quot;Use prop default value instead.&amp;quot;,
        vm
      );
    } else if (!isReserved(key)) {
      proxy(vm, &amp;quot;_data&amp;quot;, key);
    }
  }
  // åŒå‘æ•°æ®ç»‘å®šdata
  observe(data, true /* asRootData */);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆå§‹åŒ–&lt;code&gt;computed&lt;/code&gt;å±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function initComputed (vm, computed) {
  // $flow-disable-line
  var watchers = vm._computedWatchers = Object.create(null);
  // computed properties are just getters during SSR
  var isSSR = isServerRendering();

  for (var key in computed) {
    // æ¯ä¸ªcomputed keyæ‰€å®šä¹‰çš„æ–¹æ³•
    var userDef = computed[key];
    // å°†è¯¥æ–¹æ³•èµ‹å€¼ç»™getterå˜é‡
    var getter = typeof userDef === &#39;function&#39; ? userDef : userDef.get;
    if (getter == null) {
			// å¦‚æœä¸ºç©ºï¼Œæ‰“å°é”™è¯¯
      warn(
        (&amp;quot;Getter is missing for computed property \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot;.&amp;quot;),
        vm
      );
    }

    if (!isSSR) {
      // create internal watcher for the computed property.
      watchers[key] = new Watcher(
        vm,
        getter || noop,
        noop,
        computedWatcherOptions
      );
    }

    // å¦‚æœå½“å‰èŠ‚ç‚¹computedä¸Šæœªæœ‰keyè¿™ä¸ªæ–¹æ³•
    if (!(key in vm)) {
      // defineComputedæ–¹æ³•ä¸»è¦æ˜¯ä¸ºå½“å‰èŠ‚ç‚¹çš„computedå±æ€§æ·»åŠ å“åº”å¼æ›´æ–°æ–¹æ³•
      // å¯ä»¥åœ¨defineComputedå®šä¹‰æœ€åçœ‹åˆ° Object.defineProperty(target, key, sharedPropertyDefinition) 
      defineComputed(vm, key, userDef);
    } else {
      if (key in vm.$data) {
        warn((&amp;quot;The computed property \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; is already defined in data.&amp;quot;), vm);
      } else if (vm.$options.props &amp;amp;&amp;amp; key in vm.$options.props) {
        warn((&amp;quot;The computed property \&amp;quot;&amp;quot; + key + &amp;quot;\&amp;quot; is already defined as a prop.&amp;quot;), vm);
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åˆå§‹åŒ–&lt;code&gt;watch&lt;/code&gt;å±æ€§æ¯”è¾ƒç®€å•ï¼Œåœ¨åšäº†ç›¸åº”çš„åˆ¤æ–­åç›´æ¥æ·»åŠ ä¸€ä¸ªå“åº”å¼æ›´æ–°å±æ€§ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ï¼Œè°ƒç”¨å®Œ&lt;code&gt;initState&lt;/code&gt;ä¹‹åï¼Œä¼šè°ƒç”¨&lt;code&gt;created&lt;/code&gt;é’©å­å‡½æ•°ï¼Œæ­¤æ—¶&lt;code&gt;vm&lt;/code&gt;ä¸Šçš„å±æ€§&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// _init
vm._uid = 0
vm._isVue = true
vm.$options = {
  components: {
    KeepAlive,
    Transition,
    TransitionGroup
  },
  directives: {
    model,
    show
  },
  methods: {},
  computed: {},
  watch: {},
  filters: {},
  _base: Vue,
  el: &#39;#app&#39;,
  data: function mergedInstanceDataFn(){}
}
vm._renderProxy = vm
vm._self = vm

// initLifecycle
vm.$parent = parent
vm.$root = parent ? parent.$root : vm

vm.$children = []
vm.$refs = {}

vm._watcher = null
vm._inactive = null
vm._directInactive = false
vm._isMounted = false
vm._isDestroyed = false
vm._isBeingDestroyed = false

// initEvents	
vm._events = Object.create(null)
vm._hasHookEvent = false

// initRender
vm.$vnode = null  
vm._vnode = null
vm._staticTrees = null
vm.$slots = resolveSlots(vm.$options._renderChildren, renderContext)
vm.$scopedSlots = emptyObject

vm._c = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, false)

vm.$createElement = (a, b, c, d) =&amp;gt; createElement(vm, a, b, c, d, true)
// åœ¨ initState ä¸­æ·»åŠ çš„å±æ€§
vm._watchers = []
vm._data
vm.message
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰§è¡Œå®Œä¸Šé¢æ­¥éª¤åï¼Œä¼šè°ƒç”¨&lt;code&gt;vm.$mount&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// ä¿å­˜ä¹‹å‰å®šä¹‰çš„$mountæ–¹æ³•ï¼Œç„¶åé‡å†™Vue.prototype.$mount
const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  // æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹
  el = el &amp;amp;&amp;amp; query(el)

 	// å¦‚æœäº‹bodyå…ƒç´ æˆ–è€…documentElementå…ƒç´ åˆ™æŠ›é”™
  if (el === document.body || el === document.documentElement) {
    process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; warn(
      `Do not mount Vue to &amp;lt;html&amp;gt; or &amp;lt;body&amp;gt; - mount to normal elements instead.`
    )
    return this
  }
	
  // æ‹¿åˆ°options
  const options = this.$options
  // å¦‚æœèŠ‚ç‚¹ä¸Šæ²¡æœ‰renderå‡½æ•°
  if (!options.render) {
    // è·å–templateï¼Œtemplateå¯ä»¥æ˜¯#idã€æ¨¡æ¿å­—ç¬¦ä¸²ã€domå…ƒç´ 
    let template = options.template
    if (template) {
      if (typeof template === &#39;string&#39;) {
        if (template.charAt(0) === &#39;#&#39;) {
          // è·å–templatge innerHTML
          template = idToTemplate(template)
          /* istanbul ignore if */
          if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; !template) {
            warn(
              `Template element not found or is empty: ${options.template}`,
              this
            )
          }
        }
      } else if (template.nodeType) {
        // å¦‚æœä¸æ˜¯#idã€æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œç›´æ¥è·å–å…¶innerHTML
        template = template.innerHTML
      } else {
        if (process.env.NODE_ENV !== &#39;production&#39;) {
          warn(&#39;invalid template option:&#39; + template, this)
        }
        return this
      }
    } else if (el) {
      // å¦‚æœæ²¡æœ‰templateï¼Œåˆ™è·å–elä»¥åŠå…¶å­å†…å®¹ä½œä¸ºæ¨¡æ¿
      template = getOuterHTML(el)
    }
    if (template) {
      ......
    }
  }
  // æœ‰renderå‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œmount.call(this, el, hydrating)
  return mount.call(this, el, hydrating)
}

function getOuterHTML (el: Element): string {
  if (el.outerHTML) {
    return el.outerHTML
  } else {
    const container = document.createElement(&#39;div&#39;)
    container.appendChild(el.cloneNode(true))
    return container.innerHTML
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šé¢æœ€åè°ƒç”¨äº†&lt;code&gt;mount.call(this, el, hydrating)&lt;/code&gt;ï¼Œå…¶æ–¹æ³•å¯¹åº”äº&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el &amp;amp;&amp;amp; inBrowser ? query(el) : undefined
  return mountComponent(this, el, hydrating)
}

  vm: Component,
  el: ?Element,
  hydrating?: boolean
): Component {
  vm.$el = el
	......
  // è°ƒç”¨beforeMounté’©å­å‡½æ•°
  callHook(vm, &#39;beforeMount&#39;)

  let updateComponent
	
  ......
  
  // æ›´æ–°å½“å‰èŠ‚ç‚¹çš„æ–¹æ³•
  updateComponent = () =&amp;gt; {
    // vm._renderä¼šè¿”å›ä¸€ä¸ªrenderå­—ç¬¦ä¸²ï¼Œ_updateå…¶å†…éƒ¨ä¼šè°ƒç”¨patchæ–¹æ³•æ¥è¿›è¡ŒèŠ‚ç‚¹çš„å¢åˆ æ”¹
    vm._update(vm._render(), hydrating)
  }

	// åˆ›å»ºä¸€ä¸ªwatchå¯¹è±¡ï¼Œåœ¨è°ƒç”¨updateComponentä¹‹å‰ä¼šå…ˆè°ƒç”¨beforeæ–¹æ³•
  new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted &amp;amp;&amp;amp; !vm._isDestroyed) {
        // å¦‚æœæ˜¯æ›´æ–°èŠ‚ç‚¹ï¼Œè°ƒç”¨beforeUpdateé’©å­å‡½æ•°
        callHook(vm, &#39;beforeUpdate&#39;)
      }
    }
  }, true /* isRenderWatcher */)
  hydrating = false

   // å½“é¡µé¢æ¸²æŸ“å®Œæˆåï¼Œè°ƒç”¨é’©å­å‡½æ•°mounted
  if (vm.$vnode == null) {
    vm._isMounted = true
    callHook(vm, &#39;mounted&#39;)
  }
  return vm
}
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Vueè‡ªå®šä¹‰æŒ‡ä»¤</title>
      <link>https://xtid.github.io/2020/vue%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4/</link>
      <pubDate>Sun, 26 Jul 2020 22:35:47 +0800</pubDate>
      
      <guid>https://xtid.github.io/2020/vue%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4/</guid>
      <description>&lt;p&gt;Vueè‡ªå®šä¹‰æŒ‡ä»¤ä¹Ÿåˆ†å…¨å±€æŒ‡ä»¤å’Œå±€éƒ¨æŒ‡ä»¤ä¸¤ç§ï¼Œå…¨å±€æŒ‡ä»¤å’Œå±€éƒ¨æŒ‡ä»¤çš„ä½¿ç”¨æ–¹æ³•åˆ†åˆ«ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// å…¨å±€æŒ‡ä»¤ä½¿ç”¨æ–¹æ³•
Vue.directive(&#39;test&#39;, {
  bind: function(){
    ...
  }
})

// å±€éƒ¨æŒ‡ä»¤ä½¿ç”¨æ–¹æ³•
Vue({
  directives: {
    test: {
      bind: function(){
    	...
  	  }
    }
  } 
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šé¢å†™çš„&lt;code&gt;bind&lt;/code&gt;æ–¹æ³•å…¶å®å°±æ˜¯è‡ªå®šä¹‰æŒ‡ä»¤çš„å‡ ä¸ªé’©å­å‡½æ•°ä¹‹ä¸€ï¼Œå¯ä»¥è§†æƒ…å†µæ·»åŠ å…¶ä»–çš„é’©å­å‡½æ•°ï¼Œå®˜æ–¹çš„ä»‹ç»ï¼š&lt;/p&gt;

&lt;p&gt;&lt;code&gt;bind&lt;/code&gt;ï¼šåªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ç¬¬ä¸€æ¬¡ç»‘å®šåˆ°å…ƒç´ æ—¶è°ƒç”¨ã€‚åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œä¸€æ¬¡æ€§çš„åˆå§‹åŒ–è®¾ç½®&lt;/p&gt;

&lt;p&gt;&lt;code&gt;inserted&lt;/code&gt;ï¼šè¢«ç»‘å®šå…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹æ—¶è°ƒç”¨ (ä»…ä¿è¯çˆ¶èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†ä¸ä¸€å®šå·²è¢«æ’å…¥æ–‡æ¡£ä¸­)ï¼Œå®é™…åº”ç”¨åœºæ™¯ï¼šè¢«ç»‘å®šå…ƒç´ æ’å…¥çˆ¶èŠ‚ç‚¹åï¼Œåšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œæ¯”å¦‚æ”¹å˜é¢œè‰²ï¼Œå­—ä½“å¤§å°ç­‰ç­‰&lt;/p&gt;

&lt;p&gt;&lt;code&gt;update&lt;/code&gt;ï¼šæ‰€åœ¨ç»„ä»¶çš„&lt;code&gt;VNode&lt;/code&gt; æ›´æ–°æ—¶è°ƒç”¨ï¼Œä½†æ˜¯å¯èƒ½å‘ç”Ÿåœ¨å…¶å­ &lt;code&gt;VNode&lt;/code&gt; æ›´æ–°ä¹‹å‰ï¼Œå®é™…åº”ç”¨åœºæ™¯ï¼šè¢«ç»‘å®šå…ƒç´ çŠ¶æ€/æ ·å¼ã€å†…å®¹å‘ç”Ÿæ”¹å˜æ—¶è§¦å‘&lt;/p&gt;

&lt;p&gt;&lt;code&gt;componentUpdated&lt;/code&gt;ï¼šæŒ‡ä»¤æ‰€åœ¨ç»„ä»¶çš„ &lt;code&gt;VNode&lt;/code&gt;åŠå…¶å­&lt;code&gt;VNode&lt;/code&gt;å…¨éƒ¨æ›´æ–°åè°ƒç”¨&lt;/p&gt;

&lt;p&gt;&lt;code&gt;unbind&lt;/code&gt;ï¼šåªè°ƒç”¨ä¸€æ¬¡ï¼ŒæŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘æ—¶è°ƒç”¨ï¼Œå®é™…åº”ç”¨åœºæ™¯ï¼šå½“æŒ‡ä»¤ç»‘å®šçš„å…ƒç´ ä» dom ä¸­åˆ é™¤æ—¶è§¦å‘ï¼Œå¯åœ¨è¿™ä¸ªæ—¶å€™åšä¸€äº›éœ€è¦çš„æ“ä½œ&lt;/p&gt;

&lt;p&gt;æŒ‡ä»¤é’©å­å‡½æ•°ä¼šè¢«ä¼ å…¥ä»¥ä¸‹å‚æ•°ï¼š&lt;/p&gt;

&lt;p&gt;&lt;code&gt;el&lt;/code&gt;ï¼šæŒ‡ä»¤æ‰€ç»‘å®šçš„å…ƒç´ ï¼Œå¯ä»¥ç”¨æ¥ç›´æ¥æ“ä½œ DOM ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;binding&lt;/code&gt;ï¼šä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;name&lt;/code&gt;ï¼šæŒ‡ä»¤åï¼Œä¸åŒ…æ‹¬ &lt;code&gt;v-&lt;/code&gt; å‰ç¼€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;value&lt;/code&gt;ï¼šæŒ‡ä»¤çš„ç»‘å®šå€¼ï¼Œä¾‹å¦‚ï¼š&lt;code&gt;v-my-directive=&amp;quot;1 + 1&amp;quot;&lt;/code&gt; ä¸­ï¼Œç»‘å®šå€¼ä¸º &lt;code&gt;2&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;oldValue&lt;/code&gt;ï¼šæŒ‡ä»¤ç»‘å®šçš„å‰ä¸€ä¸ªå€¼ï¼Œä»…åœ¨ &lt;code&gt;update&lt;/code&gt; å’Œ &lt;code&gt;componentUpdated&lt;/code&gt; é’©å­ä¸­å¯ç”¨ã€‚æ— è®ºå€¼æ˜¯å¦æ”¹å˜éƒ½å¯ç”¨ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;expression&lt;/code&gt;ï¼šå­—ç¬¦ä¸²å½¢å¼çš„æŒ‡ä»¤è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ &lt;code&gt;v-my-directive=&amp;quot;1 + 1&amp;quot;&lt;/code&gt; ä¸­ï¼Œè¡¨è¾¾å¼ä¸º &lt;code&gt;&amp;quot;1 + 1&amp;quot;&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;arg&lt;/code&gt;ï¼šä¼ ç»™æŒ‡ä»¤çš„å‚æ•°ï¼Œå¯é€‰ã€‚ä¾‹å¦‚ &lt;code&gt;v-my-directive:foo&lt;/code&gt; ä¸­ï¼Œå‚æ•°ä¸º &lt;code&gt;&amp;quot;foo&amp;quot;&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;modifiers&lt;/code&gt;ï¼šä¸€ä¸ªåŒ…å«ä¿®é¥°ç¬¦çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š&lt;code&gt;v-my-directive.foo.bar&lt;/code&gt; ä¸­ï¼Œä¿®é¥°ç¬¦å¯¹è±¡ä¸º &lt;code&gt;{ foo: true, bar: true }&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code&gt;vnode&lt;/code&gt;ï¼šVue ç¼–è¯‘ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹&lt;/p&gt;

&lt;p&gt;&lt;code&gt;oldVnode&lt;/code&gt;ï¼šä¸Šä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œä»…åœ¨ &lt;code&gt;update&lt;/code&gt; å’Œ &lt;code&gt;componentUpdated&lt;/code&gt; é’©å­ä¸­å¯ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨æ–‡ä»¶&lt;code&gt;src/core/global-api/index.js&lt;/code&gt;ä¸­å¯ä»¥çœ‹åˆ°&lt;code&gt;initAssetRegisters&lt;/code&gt;ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šç”¨æ¥åˆå§‹åŒ–&lt;code&gt;component&lt;/code&gt;ä»¥åŠ&lt;code&gt;directive&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;export function initGlobalAPI (Vue: GlobalAPI) {
  .
  .
  .

  initUse(Vue)
  initMixin(Vue)
  initExtend(Vue)
  initAssetRegisters(Vue)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;initGlobalAPI&lt;/code&gt;ä¼šæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨æŒ‡ä»¤çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°å¦‚æœæ˜¯å‡½æ•°ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ª&lt;/p&gt;

&lt;p&gt;&lt;code&gt;{ bind: definition, update: definition}&lt;/code&gt;å¯¹è±¡ï¼Œå¹¶å°†ä»–èµ‹å€¼ç»™&lt;code&gt;definition&lt;/code&gt;ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šåœ¨ç”Ÿæˆ&lt;code&gt;Vue&lt;/code&gt;å®ä¾‹çš„æ—¶å€™ä¼šåˆå¹¶åˆ°&lt;code&gt;vm.$options.directives&lt;/code&gt;ä¸Šã€‚é¡ºä¾¿è¯´ä¸€ä¸‹è¿™é‡Œé¢ä¹Ÿå¯¹è‡ªå®šä¹‰&lt;code&gt;component&lt;/code&gt;è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œä»–ä¼šæ ¹æ®ä¼ å…¥çš„ç»„ä»¶å®šä¹‰åˆ›å»ºä¸€ä¸ª&lt;code&gt;Vue&lt;/code&gt;å­ç±»ï¼Œè®¾ç½®å¥½&lt;code&gt;name&lt;/code&gt;æˆ–è€…&lt;code&gt;id&lt;/code&gt;ï¼Œæœ€åè¿”å›ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;  ASSET_TYPES.forEach(type =&amp;gt; {
    Vue[type] = function (
      id: string,
      definition: Function | Object
    ): Function | Object | void {
      if (!definition) {
        return this.options[type + &#39;s&#39;][id]
      } else {
        /* istanbul ignore if */
        if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; type === &#39;component&#39;) {
          validateComponentName(id)
        }
        if (type === &#39;component&#39; &amp;amp;&amp;amp; isPlainObject(definition)) {
          definition.name = definition.name || id
          definition = this.options._base.extend(definition)
        }
        if (type === &#39;directive&#39; &amp;amp;&amp;amp; typeof definition === &#39;function&#39;) {
          definition = { bind: definition, update: definition }
        }
        this.options[type + &#39;s&#39;][id] = definition
        return definition
      }
    }
  })
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŒ‡ä»¤çš„è§£æåœ¨&lt;code&gt;src/compiler/parser/index.js&lt;/code&gt;ä¸­å®Œæˆï¼Œç”¨æ­£åˆ™åŒ¹é…æŒ‡ä»¤ï¼Œåœ¨è§£æå®Œ&lt;code&gt;v-bind&lt;/code&gt;ã€&lt;code&gt;v-on&lt;/code&gt;ç­‰ç­‰åŸç”Ÿçš„æŒ‡ä»¤åï¼Œè°ƒç”¨&lt;code&gt;addDirective&lt;/code&gt;ï¼Œå°†æŒ‡ä»¤å±æ€§æ·»åŠ åˆ°å½“å‰èŠ‚ç‚¹çš„&lt;code&gt;directives&lt;/code&gt;ä¸Šã€‚å…¶ä¸­çš„æ­£åˆ™&lt;code&gt;modifierRE&lt;/code&gt;ä¼šå»æ‰ä¿®é¥°ç¬¦ï¼Œ&lt;code&gt;dirRE&lt;/code&gt;æ˜¯å»æ‰å‰é¢çš„&lt;code&gt;v-&lt;/code&gt;ï¼Œ&lt;code&gt;argRE&lt;/code&gt;åŒ¹é…å†’å·åŠåé¢çš„å€¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt; else { // normal directives
   name = name.replace(dirRE, &#39;&#39;)
   // parse arg
   const argMatch = name.match(argRE)
   const arg = argMatch &amp;amp;&amp;amp; argMatch[1]
   if (arg) {
     name = name.slice(0, -(arg.length + 1))
   }
   addDirective(el, name, rawName, value, arg, modifiers, list[i])
   if (process.env.NODE_ENV !== &#39;production&#39; &amp;amp;&amp;amp; name === &#39;model&#39;) {
     checkForAliasModel(el, value)
   }
 }


export function addDirective (
  el: ASTElement,
  name: string,
  rawName: string,
  value: string,
  arg: ?string,
  modifiers: ?ASTModifiers,
  range?: Range
) {
  (el.directives || (el.directives = [])).push(rangeSetItem({ name, rawName, value, arg, modifiers }, range))
  el.plain = false
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¼–è¯‘é˜¶æ®µï¼Œåœ¨&lt;code&gt;src/compiler/codegen/index.js&lt;/code&gt;ä¸­ï¼Œè°ƒç”¨&lt;code&gt;genDirectives&lt;/code&gt;ï¼Œå¾ªç¯éå†&lt;code&gt;directives&lt;/code&gt;å¯¹è±¡ï¼Œæœ€ç»ˆç”Ÿæˆå¯¹åº”çš„å±æ€§ï¼Œç”Ÿæˆçš„å½¢å¼ä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;directives:[{
  name: &#39;&#39;,
  rawName: &#39;&#39;,
  value: &#39;&#39;,
  expression: &#39;&#39;,
  arg: &#39;&#39;,
  modifiers: {}
}
...
]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä»£ç ä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;...      
res += `{name:&amp;quot;${dir.name}&amp;quot;,rawName:&amp;quot;${dir.rawName}&amp;quot;${
        dir.value ? `,value:(${dir.value}),expression:${JSON.stringify(dir.value)}` : &#39;&#39;
      }${
        dir.arg ? `,arg:&amp;quot;${dir.arg}&amp;quot;` : &#39;&#39;
      }${
        dir.modifiers ? `,modifiers:${JSON.stringify(dir.modifiers)}` : &#39;&#39;
      }},`
...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ€åï¼Œä¼šåœ¨&lt;code&gt;src/core/vdom/modules/directives.js&lt;/code&gt;ä¸­è°ƒç”¨&lt;code&gt;_update&lt;/code&gt;ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨éå†æŒ‡ä»¤å¯¹è±¡ï¼Œå°†ä¸Šé¢çš„å±æ€§é€šè¿‡å›è°ƒå‡½æ•°è°ƒç”¨å¯¹åº”çš„é’©å­å‡½æ•°ï¼Œç„¶åå¤„ç†ï¼Œé’©å­å‡½æ•°å³ä¸Šé¢æåˆ°çš„&lt;code&gt;bind&lt;/code&gt;ã€&lt;code&gt;update&lt;/code&gt;ã€&lt;code&gt;inserted&lt;/code&gt;ç­‰&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function _update (oldVnode, vnode) {
  // ç¬¬ä¸€æ¬¡å®ä¾‹åŒ–ç»„ä»¶æ—¶ï¼ŒoldVnodeæ˜¯emptyNode
  const isCreate = oldVnode === emptyNode
  // é”€æ¯ç»„ä»¶æ—¶ï¼Œvnodeæ˜¯emptyNode
  const isDestroy = vnode === emptyNode
  //normalizeDirectiveså‡½æ•°æ˜¯ä»ç»„ä»¶çš„vm.$options.directivesä¸­è·å–æŒ‡ä»¤çš„å®šä¹‰
  const oldDirs = normalizeDirectives(oldVnode.data.directives, oldVnode.context)
  const newDirs = normalizeDirectives(vnode.data.directives, vnode.context)

  const dirsWithInsert = []
  const dirsWithPostpatch = []

  let key, oldDir, dir
  for (key in newDirs) {
    //å¾ªç¯æ–°vnodeä¸Šç»‘å®šçš„æŒ‡ä»¤
    oldDir = oldDirs[key]
    dir = newDirs[key]
    if (!oldDir) {
      // new directive, bind   =&amp;gt; å¦‚æœç¬¬ä¸€æ¬¡ç»‘å®šï¼Œåˆ™ç›´æ¥è°ƒç”¨bindé’©å­å‡½æ•°
      callHook(dir, &#39;bind&#39;, vnode, oldVnode)
      if (dir.def &amp;amp;&amp;amp; dir.def.inserted) {
        //è‹¥åŒæ—¶è¿˜æ·»åŠ äº†insertedé’©å­ï¼Œåˆ™ä¼šå…ˆæŠŠå®ƒæ·»åŠ åˆ°dirsWithInsertæ•°ç»„ä¸­ã€‚
        dirsWithInsert.push(dir)
      }
    } else {
      // existing directive, update   =&amp;gt;  å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡ç»‘å®šï¼Œåˆ™è°ƒç”¨updateé’©å­å‡½æ•°
      dir.oldValue = oldDir.value
      dir.oldArg = oldDir.arg
      callHook(dir, &#39;update&#39;, vnode, oldVnode)
      if (dir.def &amp;amp;&amp;amp; dir.def.componentUpdated) {
         //è‹¥åŒæ—¶å®šä¹‰äº†componentUpdatedé’©å­ï¼Œåˆ™ä¼šå…ˆæŠŠå®ƒæ·»åŠ åˆ°dirsWithPostpatchæ•°ç»„ä¸­ã€‚
        dirsWithPostpatch.push(dir)
      }
    }
  }

  if (dirsWithInsert.length) {
    const callInsert = () =&amp;gt; {
      for (let i = 0; i &amp;lt; dirsWithInsert.length; i++) {
        callHook(dirsWithInsert[i], &#39;inserted&#39;, vnode, oldVnode)
      }
    }
    if (isCreate) {
       //å¦‚æœæ˜¯vnodeæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œ
      //åˆ™ä¼šæŠŠdirsWithInsertæ•°ç»„ä¸­çš„å›è°ƒè¿½åŠ åˆ°vnode.data.hook.insertä¸­æ‰§è¡Œ
      mergeVNodeHook(vnode, &#39;insert&#39;, callInsert)
    } else {
      callInsert()
    }
  }

  if (dirsWithPostpatch.length) {
    mergeVNodeHook(vnode, &#39;postpatch&#39;, () =&amp;gt; {
      for (let i = 0; i &amp;lt; dirsWithPostpatch.length; i++) {
        callHook(dirsWithPostpatch[i], &#39;componentUpdated&#39;, vnode, oldVnode)
      }
    })
  }

  if (!isCreate) {
    for (key in oldDirs) {
      if (!newDirs[key]) {
        // no longer present, unbind  
        // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œå°±è°ƒç”¨æ—§vnodeä¸­æ–°vnodeä¸å­˜åœ¨çš„æŒ‡ä»¤çš„unbindé’©å­å‡½æ•°
        callHook(oldDirs[key], &#39;unbind&#39;, oldVnode, oldVnode, isDestroy)
      }
    }
  }
}

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>ä½¿ç”¨Canvaså®ç°ä¸€ä¸ªçº¢åŒ…é›¨çš„æ•ˆæœ</title>
      <link>https://xtid.github.io/2020/%E4%BD%BF%E7%94%A8canvas%E5%81%9A%E4%B8%80%E4%B8%AA%E7%BA%A2%E5%8C%85%E9%9B%A8%E7%9A%84%E6%95%88%E6%9E%9C/</link>
      <pubDate>Mon, 15 Jun 2020 18:12:19 +0700</pubDate>
      
      <guid>https://xtid.github.io/2020/%E4%BD%BF%E7%94%A8canvas%E5%81%9A%E4%B8%80%E4%B8%AA%E7%BA%A2%E5%8C%85%E9%9B%A8%E7%9A%84%E6%95%88%E6%9E%9C/</guid>
      <description>

&lt;p&gt;ä¹‹å‰ä½¿ç”¨jQueryåšäº†ä¸€ä¸ªçº¢åŒ…é›¨çš„æ•ˆæœï¼Œæ„Ÿè§‰ä¸æ˜¯å¾ˆç†æƒ³ï¼Œåˆ›å»ºè¿‡å¤šDOMå…ƒç´ é€ æˆæ€§èƒ½ä¸Šçš„æµªè´¹ï¼Œæ•´ä¸ªé¡µé¢ä¹Ÿä¸å¤Ÿä¸æ»‘æµç•…ï¼Œè¿™æ¬¡è¯¥ç”¨Canvasåšä¸€ä¸ªçº¢åŒ…é›¨çš„æ•ˆæœ&lt;/p&gt;

&lt;h3 id=&#34;1-æ ¸å¿ƒåŸç†&#34;&gt;1.æ ¸å¿ƒåŸç†&lt;/h3&gt;

&lt;p&gt;1.ç”Ÿæˆçº¢åŒ…ï¼Œè®¾ç½®å¥½é»˜è®¤çš„èƒŒæ™¯å›¾åƒï¼Œä¼ å…¥é¡µé¢ä¸Šæ‰€éœ€çš„çº¢åŒ…æ•°é‡&lt;/p&gt;

&lt;p&gt;2.ä¿å­˜çŠ¶æ€ï¼Œåˆ©ç”¨Canvasçš„åŸç”ŸAPIå®ç°é¡µé¢çš„æ¸²æŸ“ï¼Œæ¯æ¬¡ç§»åŠ¨å„ä¸ªçº¢åŒ…åˆ°ä¸åŒä½ç½®ï¼Œåˆ©ç”¨&lt;code&gt;window.requestAnimationFrame&lt;/code&gt;å®ç°æ¯ä¸€å¸§çš„åŠ¨ç”»ç»˜åˆ¶ï¼Œä½¿æ•´ä¸ªé¡µé¢ä¸ä¼šå¡é¡¿&lt;/p&gt;

&lt;p&gt;3.ç‚¹å‡»çº¢åŒ…ï¼Œè®¡ç®—æ˜¯å¦ç‚¹ä¸­çº¢åŒ…ï¼Œå¦‚æœç‚¹ä¸­ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„äº‹ä»¶å¤„ç†&lt;/p&gt;

&lt;h3 id=&#34;2-å…·ä½“å®ç°&#34;&gt;2.å…·ä½“å®ç°&lt;/h3&gt;

&lt;p&gt;2.1å®šä¹‰ä¸€äº›åŸºæœ¬å˜é‡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;redEnvelopeArr: [], // å½“å‰æ•´ä¸ªçº¢åŒ…å¯¹è±¡æ•°ç»„
itemSpeed: [], // æ¯ä¸ªçº¢åŒ…å¯¹è±¡å¯¹åº”çš„ä¸€äº›å±æ€§ï¼Œå¦‚ä¸‹è½é€Ÿåº¦ï¼Œé¡µé¢ä¸Šæ‰€åœ¨çš„ä½ç½®
count: 0, // åŠ è½½å¥½çš„çº¢åŒ…å›¾ç‰‡çš„æ•°é‡
ctx: null, // Canvas contextå¯¹è±¡
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.2åŠ è½½çº¢åŒ…å›¾ç‰‡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;loadImgs(totalCount) {
  const self = this
  const canvas = document.getElementById(&#39;canvas&#39;)
  if (canvas.width &amp;lt; window.innerWidth) {
    canvas.width = window.innerWidth
  }
  if (canvas.height &amp;lt; window.innerHeight) {
    canvas.height = window.innerHeight
  }
  return new Promise(resolve =&amp;gt; {
    for (let index = 0; index &amp;lt; totalCount; index++) {
      const image = new Image()
      image.src = &#39;&#39; // å›¾ç‰‡åœ°å€
      image.onload = () =&amp;gt; {
        self.count++
        self.itemSpeed.push({
          speed: 0, // å¼€å§‹ä¸‹è½çš„ä½ç½®
          step: self.randomFloat(2, 6) // æ¯ä¸ªçº¢åŒ…ä¸‹è½çš„é€Ÿåº¦
        })
        self.redEnvelopeArr.push({
          x: self.randomFloat(0, window.innerWidth - 100),
          y: 0,
          img: image
        })
        if (self.count === totalCount) resolve() // æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆè·³å‡º
      }
    }
  })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.2ç”Ÿæˆéšæœºæ•°çš„ä¸€ä¸ªæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;randomFloat(low, high) {
  return low + Math.random() * (high - low)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.3ç»˜åˆ¶çº¢åŒ…å›¾ç‰‡ä¸‹è½ï¼Œè¿™é‡Œåšäº†ä¸€ä¸ªæ—‹è½¬ä¸‹è½çš„æ•ˆæœï¼Œä¸»è¦åŸç†æ˜¯åˆ©ç”¨&lt;code&gt;translate&lt;/code&gt;ç§»åŠ¨contextä½ç½®ï¼Œæ—‹è½¬ä¸€å®šè§’åº¦åï¼Œå°†åŸç‚¹ç§»åŠ¨åˆ°ä¹‹å‰ä½ç½®ï¼Œåšä¸€ä¸ªæ—‹è½¬çš„æ•ˆæœï¼Œæ¯æ¬¡æ“ä½œçš„æ—¶å€™è®°å¾—&lt;code&gt;sava&lt;/code&gt;ã€&lt;code&gt;restore&lt;/code&gt;ã€‚å½“ç„¶å¦‚æœä¸æƒ³åšæ—‹è½¬æ•ˆæœï¼Œé‚£ç›´æ¥ç”¨&lt;code&gt;drawImage&lt;/code&gt;æ¯æ¬¡ç”»ä¸åŒä½ç½®çš„çº¢åŒ…å°±è¡Œäº†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;drawRedEnvelope() {
  const self = this
  self.ctx.width = 100 // çº¢åŒ…çš„å®½åº¦
  self.ctx.height = 120 // çº¢åŒ…çš„é«˜åº¦
  self.redEnvelopeArr.forEach((item, index) =&amp;gt; {
    const newRedEnvelope = {
      x: item.x, // çº¢åŒ…æ‰€åœ¨çš„xè½´ä½ç½®
      y: item.y + self.itemSpeed[index].step, // çº¢åŒ…æ‰€åœ¨çš„yè½´ä½ç½®ï¼Œä¸»è¦ç”±ä¸‹è½é€Ÿåº¦å†³å®š
      img: item.img,
      speed: item.speed
    }
    self.ctx.save()
    self.redEnvelopeArr.splice(index, 1, newRedEnvelope)
    self.ctx.translate(item.x + 50, 60 + self.itemSpeed[index].speed)
    self.ctx.rotate(self.itemSpeed[index].speed * Math.PI / 180)
    self.ctx.translate(-item.x - 50, -60 - self.itemSpeed[index].speed)
    self.ctx.drawImage(item.img, item.x, self.itemSpeed[index].speed)
    self.ctx.restore()
    self.itemSpeed[index].speed += self.itemSpeed[index].step
    // self.ctx.drawImage(item.img, item.x, item.y, self.ctx.width, self.ctx.height)
  })
},
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.4ä½¿ç”¨&lt;code&gt;clearRect&lt;/code&gt;æ¸…é™¤ä¸Šä¸€å¸§çš„æ•ˆæœï¼Œåœ¨è°ƒç”¨&lt;code&gt;drawRedEnvelope&lt;/code&gt;ç»˜åˆ¶æ–°ä¸€å¸§çš„æ•ˆæœï¼Œä½¿ç”¨&lt;code&gt;requestAnimationFrame&lt;/code&gt;é‡å¤æ‰§è¡Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;moveRedEnvelope() {
  const self = this
  self.ctx.clearRect(0, 0, window.innerWidth, window.innerHeight)
  self.drawRedEnvelope()
  window.requestAnimationFrame(self.moveRedEnvelope.bind(this))
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.5ç‚¹å‡»çº¢åŒ…æ—¶ï¼Œå¾ªç¯éå†åˆ¤æ–­å½“å‰ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨æŸä¸ªçº¢åŒ…å†…ï¼Œå¦‚æœé‡åˆ°å¤šä¸ªçº¢åŒ…é‡å çš„æƒ…å†µï¼Œåªéœ€å–æœ€ä¸Šé¢ä¸€ä¸ªå°±è¡Œäº†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;redEnvelopeClick() {
  const self = this
  const canvas = document.getElementById(&#39;canvas&#39;)
  canvas.addEventListener(&#39;click&#39;, e =&amp;gt; {
    let result = {}
    this.redEnvelopeArr.forEach((item, index) =&amp;gt; {
      const distanceX = e.clientX - item.x
      const distanceY = e.clientY - item.y
      const withinX = distanceX &amp;gt; 0
      const withinY = distanceY &amp;gt; 0
      if (withinX &amp;amp;&amp;amp; withinY) {
        result = item // æœ€åçš„resultè¿”å›ï¼Œç„¶ååšä¸€äº›å¤„ç†
      }
    })
  })
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;åè¨€&#34;&gt;åè¨€&lt;/h3&gt;

&lt;p&gt;ä»¥ä¸Šå°±æ˜¯ä¸»è¦å†…å®¹ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œç‚¹å‡»å®Œäº†æŸä¸ªçº¢åŒ…éœ€è¦æ‰¾ä¸ªæ—¶é—´ç‚¹æ¸…ç©ºæ•´ä¸ªé¡µé¢ä¸Šçš„åŠ¨ç”»ï¼Œè¿˜æœ‰å°±æ˜¯å…·ä½“çš„ç‚¹å‡»å®ç°çš„ä¸šåŠ¡é€»è¾‘éœ€è‡ªå·±å»å¤„ç†&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>nodejså®ç°excelå¯¼å‡ºæ•°æ®çš„åŠŸèƒ½</title>
      <link>https://xtid.github.io/2019/nodejs%E5%AE%9E%E7%8E%B0excel%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8A%9F%E8%83%BD/</link>
      <pubDate>Sun, 10 Nov 2019 22:42:19 +0915</pubDate>
      
      <guid>https://xtid.github.io/2019/nodejs%E5%AE%9E%E7%8E%B0excel%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8A%9F%E8%83%BD/</guid>
      <description>&lt;p&gt;1.å¯¹äºä¸€äº›ä¸šåŠ¡ç³»ç»Ÿï¼Œå¾ˆå¸¸è§çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯å°†æ•°æ®ç”Ÿæˆexcelå¯¼å‡ºï¼Œå…¶å®åœ¨&lt;code&gt;nodejs&lt;/code&gt;ä¸­å·²ç»å¾ˆå¤šä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯&lt;code&gt;node-xlsx&lt;/code&gt;è¿™ä¸ªæ¨¡å—ï¼Œå…¶å®å®ƒçš„æœ¬è´¨ä¹Ÿæ˜¯ä¾èµ–çš„&lt;code&gt;xlsx&lt;/code&gt;è¿™ä¸ªæ¨¡å—ã€‚&lt;/p&gt;

&lt;p&gt;2.é¦–å…ˆå¾—å°†ä½ éœ€è¦çš„å¯¼å‡ºçš„æ•°æ®ç»„è£…å¥½ï¼Œå¹¶ä¸”è®¾ç½®å¥½æ²¡ä¸€ä¸ªåˆ—è¡¨çš„å®½åº¦ï¼Œå¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// åå°æ‰€è¿”å›çš„æ•°æ®
let result = data || [];
// éå†ç»„è£…æ•°æ®
result.map(item =&amp;gt; {
    xlsxData.push([1, 2, 3]);
});
// è®¾ç½®æ¯ä¸€åˆ—çš„å®½åº¦
let option = { 
    &#39;!cols&#39;: [{
        wch: 30
    }, {
        wch: 20
    }, {
        wch: 20
    }]
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3.è°ƒç”¨&lt;code&gt;node-xlsx&lt;/code&gt;æ¨¡å—çš„&lt;code&gt;build&lt;/code&gt;æ–¹æ³•ï¼Œå°†æ•°æ®è½¬æ¢ä¸ºå­—èŠ‚æµæ•°æ®ï¼Œå¹¶è®¾ç½®è¯·æ±‚çš„å“åº”å¤´ï¼Œä¸‹è½½ä¿å­˜ï¼Œå¤§è‡´ä»£ç å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;// åå°æ‰€è¿”å›çš„æ•°æ®
let result = data || [];

// éå†ç»„è£…æ•°æ®
result.map(item =&amp;gt; {
    xlsxData.push([1, 2, 3]);
});

// è®¾ç½®æ¯ä¸€åˆ—çš„å®½åº¦
let option = { 
    &#39;!cols&#39;: [{
        wch: 30
    }, {
        wch: 20
    }, {
        wch: 20
    }]
};

// resä¸ºexpressæˆ–koa2è¯·æ±‚çš„ç›¸åº”ç»“æœï¼Œæ­¤æ–¹æ³•éœ€åœ¨expressæˆ–koa2æ¡†æ¶ä¸‹è¿è¡Œ
getXlsxInfo(xlsxData, &#39;æ¸ é“ç²‰ä¸ç»Ÿè®¡æ•°æ®&#39;, option, res);

// ç”ŸæˆExcelè¡¨æ ¼å¹¶ä¸‹è½½
function getXlsxInfo(xlsxData, name, option, res) {
    const buffer = xlsx.build([{
        name: &#39;sheet&#39;,
        data: xlsxData
    }], option);
    res.setHeader(&#39;Content-Type&#39;, &#39;application/vnd.openxmlformats&#39;);
    res.setHeader(&#39;Content-Disposition&#39;, &#39;attachment; filename=&#39; + encodeURIComponent(name) + &#39;.xlsx&#39;);
    res.end(buffer, &#39;binary&#39;);
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4.æœ‰ä¸ªå‘å°±æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ä¸‹è½½ï¼Œå¿…é¡»æ˜¯ç›´æ¥è®¿é—®ä½ æ‰€å†™çš„&lt;code&gt;nodejsæ¥å£åœ°å€&lt;/code&gt;æ‰èƒ½æ‰“å¼€ä¸‹è½½åŠŸèƒ½ï¼Œè‹¥ä½¿ç”¨&lt;code&gt;ajax&lt;/code&gt;æˆ–&lt;code&gt;fetch&lt;/code&gt;ç­‰æ–¹å¼è¿”å›çš„ä¼šæ˜¯ä¹±ç çš„å½¢å¼ã€‚å…¶åŸå› åœ¨äºï¼Œè¿™ä¸¤ç§æ–¹å¼çš„è¯·æ±‚å‘é€çš„æ•°æ®ä¸ä¸€æ ·ï¼Œåç«¯è§£æè¿”å›å¤´ä¹Ÿä¸ä¸€æ ·ï¼Œå¼‚æ­¥è¯·æ±‚æ˜¯ä¸èƒ½è§¦å‘ä¸‹è½½è¿”å›å¤´çš„ã€‚&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>