<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  <link rel="prev" href="https://xtid.github.io/2019/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%BA%A2%E5%8C%85%E9%9B%A8%E7%9A%84%E6%95%88%E6%9E%9C/" />
  <link rel="next" href="https://xtid.github.io/2019/%E6%9C%80%E8%BF%91%E4%B8%80%E4%BA%9B%E6%95%88%E6%9E%9C%E7%9A%84%E5%AE%9E%E7%8E%B0/" />
  <link rel="canonical" href="https://xtid.github.io/2019/%E6%96%87%E6%9C%AC%E8%BF%87%E6%BB%A4%E7%9A%84%E6%96%B9%E5%BC%8F%E9%98%B2%E5%BE%A1xss/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon.ico">
  <link rel="icon" sizes="16x16" href="/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           ä½¿ç”¨æ–‡æœ¬è¿‡æ»¤çš„æ–¹å¼é˜²å¾¡XSS | ğŸ‘¨ğŸ»â€ğŸ’»
       
  </title>
  <meta name="title" content="ä½¿ç”¨æ–‡æœ¬è¿‡æ»¤çš„æ–¹å¼é˜²å¾¡XSS | ğŸ‘¨ğŸ»â€ğŸ’»">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xtid.github.io"
    },
    "articleSection" : "posts",
    "name" : "ä½¿ç”¨æ–‡æœ¬è¿‡æ»¤çš„æ–¹å¼é˜²å¾¡XSS",
    "headline" : "ä½¿ç”¨æ–‡æœ¬è¿‡æ»¤çš„æ–¹å¼é˜²å¾¡XSS",
    "description" : "â€‹ è·¨ç«™è„šæœ¬æ”»å‡»(Cross Site Scripting)ï¼Œç¼©å†™ä¸ºXSSã€‚æ¶æ„æ”»å‡»è€…å¾€Webé¡µé¢é‡Œæ’å…¥æ¶æ„Scriptä»£ç ï¼Œå½“ç”¨æˆ·æµè§ˆè¯¥é¡µä¹‹æ—¶ï¼ŒåµŒå…¥å…¶",
    "inLanguage" : "zh-CN",
    "author" : "",
    "creator" : "",
    "publisher": "",
    "accountablePerson" : "",
    "copyrightHolder" : "",
    "copyrightYear" : "2019",
    "datePublished": "2019-07-15 19:12:19 \x2b0700 \x2b0700",
    "dateModified" : "2019-07-15 19:12:19 \x2b0700 \x2b0700",
    "url" : "https:\/\/xtid.github.io\/2019\/%E6%96%87%E6%9C%AC%E8%BF%87%E6%BB%A4%E7%9A%84%E6%96%B9%E5%BC%8F%E9%98%B2%E5%BE%A1xss\/",
    "wordCount" : "1070",
    "keywords" : [  "ğŸ‘¨ğŸ»â€ğŸ’»"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ‘¨ğŸ»â€ğŸ’»</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/links/" title="">Links</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://xtid.github.io">ğŸ‘¨ğŸ»â€ğŸ’»</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/links/" title="">Links</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">ä½¿ç”¨æ–‡æœ¬è¿‡æ»¤çš„æ–¹å¼é˜²å¾¡XSS</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://xtid.github.io" rel="author"></a> with â™¥ 
                <span class="post-time">
                on <time datetime=2019-07-15 itemprop="datePublished">July 15, 2019</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://xtid.github.io/categories/%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/"> å®é™…åº”ç”¨ </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          

<p>â€‹   è·¨ç«™è„šæœ¬æ”»å‡»(Cross Site Scripting)ï¼Œç¼©å†™ä¸ºXSSã€‚æ¶æ„æ”»å‡»è€…å¾€Webé¡µé¢é‡Œæ’å…¥æ¶æ„Scriptä»£ç ï¼Œå½“ç”¨æˆ·æµè§ˆè¯¥é¡µä¹‹æ—¶ï¼ŒåµŒå…¥å…¶ä¸­Webé‡Œé¢çš„Scriptä»£ç ä¼šè¢«æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ¶æ„æ”»å‡»ç”¨æˆ·çš„ç›®çš„ã€‚</p>

<h4 id="2-xssçš„åŸç†">2. XSSçš„åŸç†</h4>

<p>â€‹   è€…å¯¹å«æœ‰æ¼æ´çš„æœåŠ¡å™¨å‘èµ·XSSæ”»å‡»ï¼ˆæ³¨å…¥JSä»£ç ï¼‰ã€‚</p>

<p>â€‹   è¯±ä½¿å—å®³è€…æ‰“å¼€å—åˆ°æ”»å‡»çš„æœåŠ¡å™¨URLã€‚</p>

<p>â€‹   å—å®³è€…åœ¨Webæµè§ˆå™¨ä¸­æ‰“å¼€URLï¼Œæ¶æ„è„šæœ¬æ‰§è¡Œã€‚</p>

<h4 id="3-é˜²å¾¡æ–¹å¼">3.é˜²å¾¡æ–¹å¼</h4>

<p>â€‹   è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ–‡æœ¬è¿‡æ»¤çš„ä¸€ç§æ–¹å¼æ¥é˜²å¾¡XSSï¼Œè¿™ä¹Ÿæ˜¯ç°åœ¨æˆ‘æ¯”è¾ƒå¸¸ç”¨çš„ã€‚</p>

<p>â€‹   3.1é¦–å…ˆå®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œè§„å®šå“ªäº›è¯·æ±‚éœ€è¦è¿›è¡Œæ–‡æœ¬è¿‡æ»¤ï¼Œå¦‚ï¼š</p>

<pre><code class="language-javascript">{
    &quot;xss&quot;: {
        &quot;post:/api/test/&quot;: {
            &quot;content&quot;: &quot;close&quot;
        }
    }
}
</code></pre>

<p>â€‹   3.2å¼•å…¥æ­¤é…ç½®æ–‡ä»¶ï¼Œè¯·æ±‚æ—¶ï¼ŒæŸ¥çœ‹å½“å‰è¯·æ±‚æ˜¯å¦åœ¨è¿›è¡Œæ–‡æœ¬è¿‡æ»¤çš„åˆ—è¡¨é‡Œï¼Œå¦‚æœæ˜¯ï¼Œå°†å½“å‰å‚æ•°é‡Œé¢çš„æ•æ„Ÿå­—ç¬¦ã€å¸¦æœ‰htmlå­—ç¬¦çš„è¿›è¡Œè½¬ä¹‰ï¼Œå¹¶é‡æ–°ç”Ÿæˆå‚æ•°ã€‚</p>

<pre><code class="language-javascript">'use strict';

/**
 * XSSè¿‡æ»¤æ–¹æ³•
 */

const xss = require('xss'); // xssæ¨¡å—
const url = require('url'); // urlæ¨¡å—
const safeConfig = require('./config'); // ä¸Šé¢çš„éœ€è¦è¿‡æ»¤çš„é…ç½®æ–‡ä»¶

//é»˜è®¤é…ç½®ï¼Œåˆ é™¤ä¸åœ¨ç™½åå•ä¸­çš„æ ‡ç­¾å’Œå±æ€§
const DEFAULT_CONFIG = {
  stripIgnoreTag: true,
  stripIgnoreTagBody: true
};

/**
 * ç”¨js-xss å¯¹htmlè¿‡æ»¤
 *
 * @param  {String} str  è¿‡æ»¤å‰å­—ç¬¦ä¸²
 * @return {String} str  è¿‡æ»¤åå­—ç¬¦ä¸²
 */
function filterHtml(str) {
  const xssObj = new xss.FilterXSS(DEFAULT_CONFIG);
  return xssObj.process(str);
}

exports.filterHtml = filterHtml;

/**
 * å‚æ•°è¿‡æ»¤ï¼Œå¯¹æ•æ„Ÿå­—ç¬¦è¿›è¡Œè½¬ä¹‰
 *
 * @param {String} str        è¿‡æ»¤å‰å­—ç¬¦ä¸²
 * @return {object}
 *   - {Boolean} isMatched    æ˜¯å¦åŒ¹é…åˆ°æ•æ„Ÿå­—ç¬¦
 *   - {String}  value        è¿‡æ»¤åçš„å­—ç¬¦ä¸²
 *   - {String}  matchedChar  æ•æ„Ÿå­—ç¬¦
 */
function escapeParams(str) {
  let isMatched = false;
  let matchedChar = '';
  let replacedStr = str.trim(); // å»é™¤å‰åç©ºæ ¼
  replacedStr = str.replace(/[&lt;&gt;'&quot;\\]/g, function (e) {
    isMatched = true;
    matchedChar = e;
    return '&amp;#' + e.charCodeAt() + ';';
  });

  return {
    isMatched: isMatched,
    value: replacedStr,
    matchedChar: matchedChar
  };
}

exports.escapeParams = escapeParams;

/**
 * åˆ¤æ–­æ˜¯å¦æ˜¯htmlç»“å°¾çš„å‚æ•°å
 *
 * @param {String} param
 * @return         {Boolean}
 */
function isHtmlParam(param) {
  const REGEXP_HTML = /(HTML)$/i;
  return REGEXP_HTML.test(param);
}

/**
 * é‡ç½®è·¯ç”±å‚æ•°
 * @param  {Object} req     è¯·æ±‚å¯¹è±¡
 * @param  {Object} ruleMap è§„åˆ™ç´¢å¼•
 */
function rebuildReq(req, rule) {
  // è¿‡æ»¤query
  Object.keys(req.query).forEach(function (key) {
    req.query[key] = rebuildParam(req.query[key], rule[key] || isHtmlParam(key));
  });
  // è¿‡æ»¤body
  if (Array.isArray(req.body)) {
    req.body.forEach(function (item, index) {
      Object.keys(item).forEach(function (key) {
        req.body[index][key] = rebuildParam(req.body[index][key], rule[key] || isHtmlParam(key));
      });
    });
  } else {
    Object.keys(req.body).forEach(function (key) {
      req.body[key] = rebuildParam(req.body[key], rule[key] || isHtmlParam(key));
    });
  }
}

/**
 * é‡ç½®å‚æ•°
 * @param  {String} data [description]
 * @param  {String} rule [description]
 * @return {String}      [description]
 */
function rebuildParam(data, rule) {
  if (!data) return data;
  // Check array
  if (Array.isArray(data)) {
    return data.map(function (item) {
      return rebuildParam(item);
    });
  }
  switch (typeof data) {
    case 'object': {
      Object.keys(data).forEach((key) =&gt; {
        data[key] = rebuildParam(data[key]);
      });
    }
    break;
  case 'string': {
    // é‡è®¾è§„åˆ™åŒ¹é…
    let ruleMatch = 'normal';
    if (rule === 'close') ruleMatch = 'close';
    else if (rule) ruleMatch = 'xss';
    switch (ruleMatch) {
      case 'xss':
        return filterHtml(data);
      case 'close':
        return data;
      default:
        return escapeParams(data).value;
    }
  }
  }
  return data;
}

/**
 * XSSè¿‡æ»¤
 * @param  {Object}   req  è¯·æ±‚å¯¹è±¡
 * @param  {Object}   res  è¿”å›å¯¹è±¡
 * @param  {Function} next ä¸‹ä¸€æ­¥
 */
module.exports = function (req, res, next) {
  //è¿‡æ»¤è·¯ç”±å‚æ•°params
  if (req.url) {
    const pathname = url.parse(req.url).pathname; //è·å–req.urlçš„è·¯å¾„ï¼Œä¸åŒ…å«query
    const decodePathname = decodeURI(pathname); //è§£ç pathname
    const escapedParams = escapeParams(decodePathname); //è½¬ä¹‰å­—ç¬¦
    if (escapedParams.isMatched) {
      let securityError = new Error('éªŒè¯é”™è¯¯');
      securityError.status = 110;
      next(securityError);
      return;
    }
    req.url = encodeURI(escapedParams.value);
  }
  // è·å–å½“å‰è¯·æ±‚åœ°å€
  const curPath = req.originalUrl.split('?')[0].replace(/\/$/, '');
  const method = req.method.toLowerCase();
  let xssRule;
  // æ£€æµ‹åœ¨xssé…ç½®ä¸­æ˜¯å¦æœ‰ç‰¹ä¾‹method
  if (xssConfig[method + ':' + curPath]) {
    xssRule = xssConfig[method + ':' + curPath];
  }
  // æ£€æµ‹æ˜¯å¦æœ‰é€šç”¨é…ç½®
  if (!xssRule &amp;&amp; xssConfig[curPath]) {
    xssRule = xssConfig[curPath];
  }
  // å¦‚æœæ£€æµ‹åˆ°å…³é—­è§„åˆ™,åˆ™ç›´æ¥å…³é—­æ£€æµ‹
  if (xssRule === 'close') return next();
  // é‡è®¾è¯·æ±‚å¯¹è±¡
  rebuildReq(req, xssRule || {});
  return next();
};
</code></pre>

    </div>

    

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> Â· 
                <span><a href="https://xtid.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xtid.github.io/2019/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%BA%A2%E5%8C%85%E9%9B%A8%E7%9A%84%E6%95%88%E6%9E%9C/" class="prev" rel="prev" title="å®ç°ä¸€ä¸ªçº¢åŒ…é›¨çš„æ•ˆæœ"><i class="iconfont icon-left"></i>&nbsp;å®ç°ä¸€ä¸ªçº¢åŒ…é›¨çš„æ•ˆæœ</a>
         
        
        <a href="https://xtid.github.io/2019/%E6%9C%80%E8%BF%91%E4%B8%80%E4%BA%9B%E6%95%88%E6%9E%9C%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="next" rel="next" title="æœ€è¿‘ä¸€äº›æ•ˆæœçš„å®ç°">æœ€è¿‘ä¸€äº›æ•ˆæœçš„å®ç°&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2021</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
